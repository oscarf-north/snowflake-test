OBJECT_TYPE,SCHEMA_NAME,OBJECT_NAME,DDL
VIEW,DATAADMIN,CHECKCASHPAYMENTLEDGER_FACT,"create or replace view CHECKCASHPAYMENTLEDGER_FACT(
	CHECKCASHPAYMENTLEDGER_FACT_PK,
	CHECKCASHPAYMENTLEDGER_FACT_NK,
	PAYMENT,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	CHEQUE_FACT_FK,
	SHIFT_DIM_FK,
	PAYMENTMETHOD_DIM_FK,
	PAYMENTS_FACT_FK,
	IS_VOID,
	CREATED_AT,
	UPDATED_AT,
	AMOUNT_TENDERED,
	AMOUNT_CHANGED
) as
-- --===============================================================================================
SELECT 
--primary keys-------------------------------------------------------------------------------------
  CCP.ID    
                                                                 AS CHECKCASHPAYMENTLEDGER_FACT_PK
--natural keys------------------------------------------------------------------------------
  ,CCP.ID  
                                                                 AS CHECKCASHPAYMENTLEDGER_FACT_NK
--name---------------------------------------------------------------------------------------
  ,CCP.ID                                                        AS PAYMENT
--data warehouse rows------------------------------------------------------------------------
,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(CCP.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY CCP.ID ORDER BY CCP.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,CCP.MTLN_CDC_SEQUENCE_NUMBER,CCP.MTLN_CDC_SRC_VERSION
      ,CCP.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(CCP.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY CCP.ID ORDER BY CCP.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,CCP.MTLN_CDC_SEQUENCE_NUMBER,CCP.MTLN_CDC_SRC_VERSION,CCP.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY CCP.ID ORDER BY 
    CCP.MTLN_CDC_LAST_COMMIT_TIMESTAMP,CCP.MTLN_CDC_SEQUENCE_NUMBER,CCP.MTLN_CDC_SRC_VERSION
   ,CCP.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          
  
  ,CASE WHEN CCP.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED            
  ,CASE WHEN RANK() OVER(PARTITION BY CCP.ID ORDER BY  
    CCP.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,CCP.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,CCP.MTLN_CDC_SRC_VERSION DESC
   ,CCP.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW      
--CDC Meta data-------------------------------------------------------------------------------
  ,CCP.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE
  ,CCP.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,CCP.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER
  ,CCP.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID
  ,CCP.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP
  ,CCP.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,CCP.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION
  ,CCP.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME
  ,CCP.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH
  ,CCP.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE
  ,CCP.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA
  ,CCP.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE
--foreign keys-------------------------------------------------------------------------------
  ,IFNULL(CCP.CHECK_id,-1)             AS CHEQUE_FACT_FK     
  ,IFNULL(CCP.SHIFT_ID,-1)             AS SHIFT_DIM_FK 
  ,IFNULL(CCP.PAYMENT_METHOD_ID,-1)    AS PAYMENTMETHOD_DIM_FK  
  ,IFNULL(CCP.CHECK_id || '.' || CCP.CHECK_PAYMENT_UID,'-1')  
                                       AS PAYMENTS_FACT_FK
--flags---------------------------------------------------------------------------------------
  ,CCP.IS_VOIDED                       AS IS_VOID
--Dates--------------.------------------------------------------------------------------------
  ,to_timestamp_tz(CCP.CREATED_AT)     AS CREATED_AT   
  ,to_timestamp_tz(CCP.UPDATED_AT)     AS UPDATED_AT
--names, options, etc-------------------------------------------------------------------------
--Counts and Amounts--------------------------------------------------------------------------
  ,CCP.AMOUNT_TENDERED/1000000         AS AMOUNT_TENDERED 
  ,CCP.AMOUNT_CHANGED/1000000          AS AMOUNT_CHANGED  
  -------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_CHECK_CASH_PAYMENT_LEDGER  CCP
;"
VIEW,DATAADMIN,CHEQUE_FACT,"create or replace view CHEQUE_FACT(
	CHEQUE_FACT_PK,
	CHEQUE_FACT_NK,
	CHEQUENUMBER,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	DAYPART_DIM_FK,
	EMPLOYEE_DIM_FK,
	LOCATION_DIM_FK,
	ORDERTYPE_DIM_FK,
	ORGANIZATION_DIM_FK,
	SHIFT_DIM_FK,
	TAXSETTINGS_DIM_FK,
	REVENUECENTER_DIM_FK,
	VOIDREASON_DIM_FK,
	HAS_DISCOUNT,
	IS_TRAINING,
	IS_VOID,
	HAS_TRACKTAXESONCOMP,
	FISCAL_DATE_INT,
	FISCAL_DATE,
	OPENED_AT,
	BEGIN_PREP_AT,
	CLOSED_AT,
	SCHEDULED_AT,
	CREATED_AT,
	UPDATED_AT,
	UUID,
	AUDIT,
	STATUS,
	ROUNDINGMETHOD,
	COMBINEDRECEIPTNAME,
	RECEIPTOPTION,
	TAXTRACKING,
	REVENUECENTERNAME,
	REVENUECENTERID,
	STATUS_REASON_ID,
	CHECK_ID,
	TABLE_NAME,
	FEES,
	GIFTCARDS,
	GRATUITIES,
	PARTY_COUNT,
	DISCOUNT_COUNT,
	PAYMENT_COUNT,
	DISCOUNT,
	DISCOUNTCHECK,
	DISCOUNTITEM,
	GROSS,
	INCLUSIVETAX,
	NET,
	PAID,
	SURCHARGE,
	TAX,
	TIP,
	TOTAL,
	UNPAID
) as
--============================================================================================
SELECT 
--primary keys--------------------------------------------------------------------------------
  CHK.ID                                                     AS CHEQUE_FACT_PK
--natural keys--------------------------------------------------------------------------------
  ,CHK.ID                                                    AS CHEQUE_FACT_NK
--name----------------------------------------------------------------------------------------
  ,CHK.NUMBER                                                AS CHEQUENUMBER
--data warehouse rows-------------------------------------------------------------------------            
 ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(row_number() OVER (
      PARTITION BY CHK.ID ORDER BY CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION
      ,CHK.MTLN_CDC_FILENAME)),6))
                                                            AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY CHK.ID ORDER BY CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION,CHK.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(row_number() OVER (PARTITION BY CHK.ID ORDER BY 
    CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION
   ,CHK.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN CHK.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN row_number() OVER(PARTITION BY CHK.ID ORDER BY  
    CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,CHK.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,CHK.MTLN_CDC_SRC_VERSION DESC
   ,CHK.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     --REQUIRED
--CDC Meta data---------------------------------------------------------------------------------
  ,CHK.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE
  ,CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,CHK.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER
  ,CHK.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID
  ,CHK.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP
  ,CHK.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,CHK.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION
  ,CHK.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME
  ,CHK.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH
  ,CHK.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE
  ,CHK.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA
  ,CHK.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE
--foreign keys-------------------------------------------------------------------------------
  ,IFNULL(CHK.day_part_id,-1)                     AS Daypart_DIM_FK       
  ,IFNULL(CHK.employee_id,-1)                     AS Employee_DIM_FK      
  ,IFNULL(CHK.location_id,-1)                     AS Location_DIM_FK     
  ,IFNULL(CHK.order_type_id,-1)                   AS Ordertype_DIM_FK  
  ,IFNULL(TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.info):orgId),38,0),-1)   
                                                  AS Organization_DIM_FK  
  ,IFNULL(TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.info):shiftId),38,0),-1)
                                                  AS Shift_DIM_FK
  ,IFNULL(TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.info):taxSettings:taxSettingsId),38,4),-1)
                                                  AS Taxsettings_DIM_FK
  ,IFNULL(TO_NUMBER(replace(TRY_PARSE_JSON(CHK.info):revenueCenterId,'""','')),-1)        
                                                  AS REVENUECENTER_DIM_FK 
                                                                   
   ,IFNULL(CASE WHEN CHK.status = 'Voided' 
     THEN CHK.status_reason_id ELSE -1 
     END,-1)                                      AS VoidReason_DIM_FK
--flags---------------------------------------------------------------------------------------
  ,CASE WHEN TRY_PARSE_JSON(CHK.balance):discount > 0 
      THEN TRUE ELSE FALSE END         AS HAS_DISCOUNT 
  ,CHK.IS_TRAINING                     AS IS_TRAINING 
  ,CASE WHEN CHK.STATUS = 'Voided'
      THEN TRUE ELSE FALSE END         AS IS_VOID      
  ,CASE UPPER(TO_CHAR(TRY_PARSE_JSON(CHK.info):taxSettings:trackTaxesOnComps)) 
    WHEN 'TRUE'
    THEN TRUE WHEN 'FALSE' THEN FALSE END

                                       AS HAS_TRACKTAXESONCOMP 
 
--Dates--------------.------------------------------------------------------------------------
  ,CHK.FISCAL_DATE_INT                 AS FISCAL_DATE_INT
  ,TO_CHAR(max(TRY_PARSE_JSON(CHK.info):fiscalDate) over (partition by chk.id))::DATE  
                                       AS FISCAL_DATE                                    
  ,To_timestamp_tz(CHK.opened_at)      AS OPENED_AT
  ,To_timestamp_tz(CHK.begin_prep_at)  AS BEGIN_PREP_AT
  ,To_timestamp_tz(CHK.closed_at)      AS CLOSED_AT
  ,To_timestamp_tz(CHK.scheduled_at)   AS SCHEDULED_AT
  ,To_timestamp_tz(CHK.created_at)     AS CREATED_AT
  ,To_timestamp_tz(CHK.updated_at)     AS UPDATED_AT
--names, options, etc-------------------------------------------------------------------------
  ,CHK.UUID                                                                   AS UUID
  ,CHK.AUDIT                                                                  AS AUDIT
  ,CHK.STATUS                                                                 AS STATUS
  ,replace(TRY_PARSE_JSON(CHK.info):taxSettings:roundingMethod,'""','')        AS ROUNDINGMETHOD
  ,replace(TRY_PARSE_JSON(CHK.info):taxSettings:combinedReceiptName,'""','')   AS COMBINEDRECEIPTNAME
  ,replace(TRY_PARSE_JSON(CHK.info):taxSettings:receiptOption,'""','')         AS RECEIPTOPTION
  ,replace(TRY_PARSE_JSON(CHK.info):taxSettings:taxTracking,'""','')           AS TAXTRACKING  
  ,replace(TRY_PARSE_JSON(CHK.info):revenueCenterName,'""','')                 AS REVENUECENTERNAME
  ,TO_NUMBER(replace(TRY_PARSE_JSON(CHK.info):revenueCenterId,'""',''))        AS REVENUECENTERID
  ,CHK.status_reason_id                                                       AS STATUS_REASON_ID
  ,CHK.ID                                                                     AS CHECK_ID
  ,REPLACE(TRY_PARSE_JSON(chk.info):tableName,'""','')                         AS TABLE_NAME
--Counts and Amounts--------------------------------------------------------------------------

  ,TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):fees), 38,4)             AS FEES
  ,TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):giftcards), 38,4)        AS GIFTCARDS
  ,TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):gratuities), 38,4)       AS GRATUITIES

  ,TRY_PARSE_JSON(chk.info):partySize::number(38,4)                           AS PARTY_COUNT
  ,regexp_count( (TRY_PARSE_JSON(chk.info):discounts) , '""id"":' ,1 )          AS DISCOUNT_COUNT
  ,regexp_count( TO_CHAR(CHK.PAYMENTS) , '""id"":' ,1 )                         AS PAYMENT_COUNT
  ,TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):discount), 38,4)         AS DISCOUNT
  ,TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):discountCheck), 38,4)    AS DISCOUNTCHECK
  ,TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):discountItem), 38,4)     AS DISCOUNTITEM
  ,TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):gross), 38,4)            AS GROSS
  ,TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):inclusiveTax), 38,4)     AS INCLUSIVETAX
  ,TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):net), 38,4)              AS NET
  ,TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):paid), 38,4)             AS PAID
  ,TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):surcharge), 38,4)        AS SURCHARGE
  ,TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):tax), 38,4)              AS TAX
  ,TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):tip), 38,4)              AS TIP
  ,TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):total), 38,4)            AS TOTAL
  ,TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):unpaid), 38,4)           AS UNPAID
----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_CHEQUE                   CHK
  WHERE NOT COALESCE(TRUNCATED,FALSE)
    AND CHK.MTLN_CDC_LAST_CHANGE_TYPE <> 'd' 
;"
VIEW,DATAADMIN,DAYPARTSCHEDULE_DIM,"create or replace view DAYPARTSCHEDULE_DIM(
	DAYPARTSCHEDULE_DIM_PK,
	DAYPARTSCHEDULE_DIM_NK,
	DAYPARTSCHEDULE,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	DAYPART_DIM_FK,
	LOCATION_DIM_FK,
	CREATED_AT,
	UPDATED_AT,
	TXID,
	DAY_OF_WEEK,
	START_TIME,
	SYS_PERIOD
) as
--============================================================================================
--SELECT * FROM DATAADMIN.DAYPARTSCHEDULE_DIM;
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  dad.ID                                                       AS DAYPARTSCHEDULE_DIM_PK
--natural keys------------------------------------------------------------------------------
  ,dad.ID                                                      AS DAYPARTSCHEDULE_DIM_NK
--name---------------------------------------------------------------------------------------
  ,dad.ID                                                      AS DAYPARTSCHEDULE
--data warehouse rows------------------------------------------------------------------------
  ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(dad.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY dad.ID ORDER BY dad.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,dad.MTLN_CDC_SEQUENCE_NUMBER,dad.MTLN_CDC_SRC_VERSION
      ,dad.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(dad.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY dad.ID ORDER BY dad.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,dad.MTLN_CDC_SEQUENCE_NUMBER,dad.MTLN_CDC_SRC_VERSION,dad.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY dad.ID ORDER BY 
    dad.MTLN_CDC_LAST_COMMIT_TIMESTAMP,dad.MTLN_CDC_SEQUENCE_NUMBER,dad.MTLN_CDC_SRC_VERSION
   ,dad.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN dad.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY dad.ID ORDER BY  
    dad.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,dad.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,dad.MTLN_CDC_SRC_VERSION DESC
   ,dad.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     --REQUIRED
--CDC Meta data-------------------------------------------------------------------------------
  ,dad.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE
  ,dad.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,dad.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER
  ,dad.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID
  ,dad.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP
  ,dad.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,dad.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION
  ,dad.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME
  ,dad.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH
  ,dad.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE
  ,dad.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA
  ,dad.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE
--foreign keys-------------------------------------------------------------------------------
  -- ,IFNULL(dad.ORGANIZATION_ID,-1)      AS ORGANIZATION_DIM_FK
  ,dad.DAYPART_ID                      AS DAYPART_DIM_FK
  ,dad.LOCATION_ID                     AS LOCATION_DIM_FK
--flags---------------------------------------------------------------------------------------
--none
--Dates--------------.------------------------------------------------------------------------
  ,to_timestamp_tz(dad.CREATED_AT)     AS CREATED_AT  
  ,to_timestamp_tz(dad.UPDATED_AT)     AS UPDATED_AT
--names, options, etc-------------------------------------------------------------------------
 --none
--Counts and Amounts--------------------------------------------------------------------------
 ,dad.TXID                            AS TXID
 ,dad.DAY_OF_WEEK                     AS DAY_OF_WEEK
 ,dad.START_TIME                      AS START_TIME
 ,dad.SYS_PERIOD                      AS SYS_PERIOD
----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_DAYPART_SCHEDULE     dad
;"
VIEW,DATAADMIN,JOBPOSITION_DIM,"create or replace view JOBPOSITION_DIM(
	JOBPOSITION_DIM_PK,
	JOBPOSITION_DIM_NK,
	JOB_POSITION,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	JOBCATEGORY_DIM_FK,
	ORGANIZATION_DIM_FK,
	IS_ARCHIVED,
	IS_CASH_DRAWER_ASSIGNMENT_REQUIRED,
	IS_TRAINING,
	HAS_SKIP_AUTO_CLOCKOUT,
	CREATED_AT,
	UPDATED_AT,
	ARCHIVED_AT,
	DEFAULT_PAY_RATE
) as
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  tab.ID                                                       AS JOBPOSITION_DIM_PK   
--natural keys------------------------------------------------------------------------------
  ,tab.ID                                                      AS JOBPOSITION_DIM_NK   
--name-------------------------------------------------------------------------------------------
  ,tab.NAME                                                    AS JOB_POSITION
--data warehouse REQUIRED rows-------------------------------------------------------------------
  ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY tab.ID ORDER BY tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION
      ,tab.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE      
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY tab.ID ORDER BY tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION,tab.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY tab.ID ORDER BY 
    tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION
   ,tab.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN tab.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY tab.ID ORDER BY  
    tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,tab.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,tab.MTLN_CDC_SRC_VERSION DESC
   ,tab.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     --REQUIRED       
--CDC Meta data REQUIRED rows-----------------------------------------------------------------------------
  ,tab.MTLN_CDC_LAST_CHANGE_TYPE          AS MTLN_CDC_LAST_CHANGE_TYPE                    
  ,tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP     AS MTLN_CDC_LAST_COMMIT_TIMESTAMP               
  ,tab.MTLN_CDC_SEQUENCE_NUMBER           AS MTLN_CDC_SEQUENCE_NUMBER                     
  ,tab.MTLN_CDC_LOAD_BATCH_ID             AS MTLN_CDC_LOAD_BATCH_ID                       
  ,tab.MTLN_CDC_LOAD_TIMESTAMP            AS MTLN_CDC_LOAD_TIMESTAMP                      
  ,tab.MTLN_CDC_PROCESSED_DATE_HOUR       AS MTLN_CDC_PROCESSED_DATE_HOUR                
  ,tab.MTLN_CDC_SRC_VERSION               AS MTLN_CDC_SRC_VERSION                         
  ,tab.MTLN_CDC_FILENAME                  AS MTLN_CDC_FILENAME                            
  ,tab.MTLN_CDC_FILEPATH                  AS MTLN_CDC_FILEPATH                            
  ,tab.MTLN_CDC_SRC_DATABASE              AS MTLN_CDC_SRC_DATABASE                        
  ,tab.MTLN_CDC_SRC_SCHEMA                AS MTLN_CDC_SRC_SCHEMA                          
  ,tab.MTLN_CDC_SRC_TABLE                 AS MTLN_CDC_SRC_TABLE                           
--foreign keys-------------------------------------------------------------------------------
  ,IFNULL(tab.JOB_POSITION_CATEGORY_ID,-1)AS JOBCATEGORY_DIM_FK
  ,IFNULL(tab.ORGANIZATION_ID,-1)         AS ORGANIZATION_DIM_FK
--flags---------------------------------------------------------------------------------------
--ALLCOLUMN NAMES IN THIS SECTION SHOULD begin with is_ or has_ if created by the dw.
--   columns created by the source app should be specifically cast as boolean 
  ,tab.ARCHIVED                           AS IS_ARCHIVED
  ,tab.IS_CASH_DRAWER_ASSIGNMENT_REQUIRED AS IS_CASH_DRAWER_ASSIGNMENT_REQUIRED
  ,tab.IS_TRAINING                        AS IS_TRAINING 
  ,tab.SKIP_AUTO_CLOCKOUT                 AS HAS_SKIP_AUTO_CLOCKOUT

--Dates--------------.------------------------------------------------------------------------
--dates should be cast as dates
-- created_at timestamp with time zone  <--this is the create table from postgres
--,to_timestamp_tz(created_at) 
  ,to_timestamp_tz(tab.CREATED_AT)       AS CREATED_AT  
  ,to_timestamp_tz(tab.UPDATED_AT)       AS UPDATED_AT
  ,to_timestamp_tz(tab.ARCHIVED_AT)      AS ARCHIVED_AT
--names, options, etc-------------------------------------------------------------------------
--Counts and Amounts--------------------------------------------------------------------------
--ALL COLUMNS IN THIS SECTION SHOULD END IN COUNT OR AMOUNT
  ,TO_NUMBER(tab.DEFAULT_PAY_RATE,38,4)/1000000 
                                         AS DEFAULT_PAY_RATE
-- ----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_JOB_POSITION     tab
;"
VIEW,DATAADMIN,MERCHANT_ORGANIZATION_XREF,"create or replace view MERCHANT_ORGANIZATION_XREF(
	MERCHANT_ORGANIZATION_XREF_PK,
	MERCHANT_ORGANIZATION_XREF_NK,
	MERCHANT_ORGANIZATION,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	MERCHANT_DIM_FK,
	ORGANIZATION_DIM_FK,
	CREATED_AT,
	UPDATED_AT
) as
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  LGL.ID                                                     AS MERCHANT_ORGANIZATION_XREF_PK
--natural keys------------------------------------------------------------------------------
  ,LGL.ID                                                    AS MERCHANT_ORGANIZATION_XREF_NK
--name---------------------------------------------------------------------------------------
 ,TO_VARCHAR(LGL.ORGANIZATION_ID) || '.'  || REPLACE(TRY_PARSE_JSON(fields):merchantId,'""','')
                                                             AS MERCHANT_ORGANIZATION
--data warehouse rows------------------------------------------------------- -----------------
  ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LGL.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY LGL.ID ORDER BY LGL.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,LGL.MTLN_CDC_SEQUENCE_NUMBER,LGL.MTLN_CDC_SRC_VERSION
      ,LGL.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(LGL.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY LGL.ID ORDER BY LGL.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,LGL.MTLN_CDC_SEQUENCE_NUMBER,LGL.MTLN_CDC_SRC_VERSION,LGL.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY LGL.ID ORDER BY 
    LGL.MTLN_CDC_LAST_COMMIT_TIMESTAMP,LGL.MTLN_CDC_SEQUENCE_NUMBER,LGL.MTLN_CDC_SRC_VERSION
   ,LGL.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN LGL.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY LGL.ID ORDER BY  
    LGL.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,LGL.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,LGL.MTLN_CDC_SRC_VERSION DESC
   ,LGL.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     --REQUIRED
--CDC Meta data-------------------------------------------------------------------------------
  ,LGL.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE
  ,LGL.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,LGL.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER
  ,LGL.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID
  ,LGL.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP
  ,LGL.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,LGL.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION
  ,LGL.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME
  ,LGL.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH
  ,LGL.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE
  ,LGL.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA
  ,LGL.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE
--foreign keys-------------------------------------------------------------------------------
  ,IFNULL(REPLACE(TRY_PARSE_JSON(fields):merchantId,'""',''),'-1')    
                                       AS MERCHANT_DIM_FK
  ,IFNULL(LGL.ORGANIZATION_ID,-1)      AS ORGANIZATION_DIM_FK
--flags---------------------------------------------------------------------------------------
--NONE
--Dates--------------.------------------------------------------------------------------------
  ,TO_TIMESTAMP_TZ(LGL.CREATED_AT)     AS CREATED_AT   
  ,TO_TIMESTAMP_TZ(LGL.UPDATED_AT)     AS UPDATED_AT
--names, options, etc-------------------------------------------------------------------------
--NONE
--Counts and Amounts--------------------------------------------------------------------------
--NONE
----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_PAYMENT_METHOD     LGL
  WHERE TRY_PARSE_JSON(fields):merchantId IS NOT NULL
;
;"
VIEW,DATAADMIN,VOIDREASON_DIM,"create or replace view VOIDREASON_DIM(
	VOIDREASON_DIM_PK,
	VOIDREASON_DIM_NK,
	VOIDREASON,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	IS_ENABLED,
	CREATED_AT,
	UPDATED_AT,
	DESCRIPTION
) as
--============================================================================================
SELECT 
--primary keys--------------------------------------------------------------------------------
  vdr.ID                                                      AS VoidReason_DIM_PK  
--natural keys--------------------------------------------------------------------------------
  ,vdr.ID                                                     AS VoidReason_DIM_NK  
--name-----------------------------------------------------------------------------------------
  ,vdr.NAME                                                    AS VoidReason
--data warehouse REQUIRED rows-----------------------------------------------------------------
  ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(vdr.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY vdr.ID ORDER BY vdr.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,vdr.MTLN_CDC_SEQUENCE_NUMBER,vdr.MTLN_CDC_SRC_VERSION
      ,vdr.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(vdr.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY vdr.ID ORDER BY vdr.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,vdr.MTLN_CDC_SEQUENCE_NUMBER,vdr.MTLN_CDC_SRC_VERSION,vdr.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY vdr.ID ORDER BY 
    vdr.MTLN_CDC_LAST_COMMIT_TIMESTAMP,vdr.MTLN_CDC_SEQUENCE_NUMBER,vdr.MTLN_CDC_SRC_VERSION
   ,vdr.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN vdr.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY vdr.ID ORDER BY  
    vdr.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,vdr.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,vdr.MTLN_CDC_SRC_VERSION DESC
   ,vdr.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     --REQUIRED   
-- --CDC Meta data REQUIRED rows------------------------------------------------------------------
  ,vdr.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE                  
  ,vdr.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP              
  ,vdr.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER                   
  ,vdr.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID                      
  ,vdr.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP                    
  ,vdr.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR                
  ,vdr.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION                        
  ,vdr.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME                           
  ,vdr.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH                           
  ,vdr.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE                       
  ,vdr.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA                        
  ,vdr.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE                          
-- --foreign keys--------------------------------------------------------------------------------
-- --flags---------------------------------------------------------------------------------------
  ,vdr.IS_ENABLED                      AS IS_ENABLED
-- --Dates--------------.------------------------------------------------------------------------
  ,to_timestamp_tz(vdr.CREATED_AT)     AS CREATED_AT  
  ,to_timestamp_tz(vdr.UPDATED_AT)     AS UPDATED_AT
-- --names, options, etc-------------------------------------------------------------------------
  ,vdr.DESCRIPTION                     AS DESCRIPTION
----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_VOID_REASON    vdr
;"
VIEW,DATAADMIN,DISCOUNTITEM_FACT,"create or replace view DISCOUNTITEM_FACT(
	DISCOUNTITEM_FACT_PK,
	DISCOUNTITEM_FACT_NK,
	DISCOUNTNAME,
	DW_STARTDATE,
	FISCALDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	CHEQUE_FACT_FK,
	DAYPART_DIM_FK,
	EMPLOYEE_DIM_FK_AS_ADDED_BY,
	EMPLOYEE_DIM_FK_AS_APPROVED_BY,
	EMPLOYEE_DIM_FK,
	LOCATION_DIM_FK,
	ITEM_FACT_FK,
	STANDARDDISCOUNT_DIM_FK,
	DO_AUTOAPPLY,
	IS_TRAINING,
	ADDED_AT,
	CREATED_AT,
	FISCAL_DATE,
	OPENED_AT,
	UPDATED_AT,
	APPLICATION,
	STATUS,
	CHEQUESTATUS,
	DISCOUNTREASON,
	DISCOUNTLEVEL,
	RECEIPTNAME,
	PROMOCODE,
	PROMODESCRIPTION,
	REVENUECENTERNAME,
	ROUNDINGMETHOD,
	CHEQUENUMBER,
	ITEM_ID,
	PROMOCODE_ID,
	DISCOUNT_TYPE,
	DISCOUNT_PERCENT,
	APPLIED_AMOUNT,
	DISCOUNT_AMOUNT,
	VALUE,
	DISCOUNT,
	DISCOUNTCHECK,
	DISCOUNTITEM,
	GROSS,
	NET
) as
--============================================================================================
SELECT 
TO_VARCHAR(CHK.ID) || '.'  ||replace(ITM.VALUE:id,'""','') || '.' || TO_CHAR(DIS.value:id)                        
                                                                          AS DISCOUNTITEM_FACT_PK
--natural keys------------------------------------------------------------------------------
  ,TO_VARCHAR(CHK.ID) || '.'  ||replace(ITM.VALUE:id,'""','') || '.' || TO_CHAR(DIS.value:id)                     
                                                                          AS DISCOUNTITEM_FACT_NK
--name---------------------------------------------------------------------------------------
   ,TO_CHAR(DIS.value:id)                                                 AS DISCOUNTNAME
--data warehouse rows--------------------------------------------------------------------------
   ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY TO_VARCHAR(CHK.ID) || '.' || TO_CHAR(DIS.value:id) ORDER BY CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION
      ,CHK.MTLN_CDC_FILENAME)),6))
                                                                           AS DW_STARTDATE 
     ,TO_CHAR(TRY_PARSE_JSON(CHK.info):fiscalDate)::DATE                   AS FISCALDATE                                                                           
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY TO_VARCHAR(CHK.ID) || '.' || TO_CHAR(DIS.value:id) ORDER BY CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION,CHK.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY TO_VARCHAR(CHK.ID) || '.' || TO_CHAR(DIS.value:id) ORDER BY 
    CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION
   ,CHK.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                                           AS DW_ENDDATE          
  
  ,CASE WHEN CHK.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                               AS DW_ISDELETED               
  ,CASE WHEN RANK() OVER(PARTITION BY TO_VARCHAR(CHK.ID) || '.' || TO_CHAR(DIS.value:id) ORDER BY  
    CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,CHK.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,CHK.MTLN_CDC_SRC_VERSION DESC
   ,CHK.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                                           AS DW_ISCURRENTROW     
--CDC Meta data-------------------------------------------------------------------------------
  ,CHK.MTLN_CDC_LAST_CHANGE_TYPE                     AS MTLN_CDC_LAST_CHANGE_TYPE
  ,CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP                AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,CHK.MTLN_CDC_SEQUENCE_NUMBER                      AS MTLN_CDC_SEQUENCE_NUMBER
  ,CHK.MTLN_CDC_LOAD_BATCH_ID                        AS MTLN_CDC_LOAD_BATCH_ID
  ,CHK.MTLN_CDC_LOAD_TIMESTAMP                       AS MTLN_CDC_LOAD_TIMESTAMP
  ,CHK.MTLN_CDC_PROCESSED_DATE_HOUR                  AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,CHK.MTLN_CDC_SRC_VERSION                          AS MTLN_CDC_SRC_VERSION
  ,CHK.MTLN_CDC_FILENAME                             AS MTLN_CDC_FILENAME
  ,CHK.MTLN_CDC_FILEPATH                             AS MTLN_CDC_FILEPATH
  ,CHK.MTLN_CDC_SRC_DATABASE                         AS MTLN_CDC_SRC_DATABASE
  ,CHK.MTLN_CDC_SRC_SCHEMA                           AS MTLN_CDC_SRC_SCHEMA
  ,CHK.MTLN_CDC_SRC_TABLE                            AS MTLN_CDC_SRC_TABLE
--foreign keys-------------------------------------------------------------------------------
  ,IFNULL(CHK.ID,-1)                                            AS CHEQUE_FACT_FK 
  ,IFNULL(CHK.day_part_id,-1)                                   AS DAYPART_DIM_FK  

  ,IFNULL(DIS.value:adddedByEmployeeId,-1)::NUMBER              AS EMPLOYEE_DIM_FK_AS_ADDED_BY
  ,IFNULL(DIS.value:approvedByEmployeeId,-1)::NUMBER            AS EMPLOYEE_DIM_FK_AS_APPROVED_BY
  ,IFNULL(CHK.EMPLOYEE_ID,-1)                                   AS EMPLOYEE_DIM_FK
  ,IFNULL(CHK.LOCATION_ID,-1)                                   AS LOCATION_DIM_FK 
  ,CHK.ID || '.'  ||replace(ITM.VALUE:id,'""','')                AS ITEM_FACT_FK
  -- ,IFNULL(TO_VARCHAR(CHK.ID) || '.' 
  -- || TO_VARCHAR(DIS.value:itemId),-1)                           AS ITEM_DIM_FK
  ,IFNULL(TRY_TO_NUMBER(TO_VARCHAR(DIS.value:standardDiscountId)),-1)  
                                                                AS STANDARDDISCOUNT_DIM_FK
--flags---------------------------------------------------------------------------------------
  ,CASE REPLACE(DIS.value:doAutoApply,'""','') 
    WHEN 'false' THEN FALSE
    WHEN 'true'  THEN TRUE ELSE NULL END             AS DO_AUTOAPPLY
   ,CHK.IS_TRAINING                                  AS IS_TRAINING  
--Dates--------------.------------------------------------------------------------------------
  ,to_timestamp(to_varchar(DIS.value:addedAt))       AS ADDED_AT
  ,to_timestamp_tz(CHK.CREATED_AT)                   AS CREATED_AT 
  -- ,TO_DATE('20' || CHK.FISCAL_DATE_INT,'YYYY-MM-DD')   AS FISCAL_DATE 
   ,TO_DATE(TO_CHAR(TRY_PARSE_JSON(CHK.info):fiscalDate),'YYYY-MM-DD')   AS FISCAL_DATE 
  ,to_timestamp_tz(CHK.OPENED_AT)                    AS OPENED_AT 
  ,to_timestamp_tz(CHK.UPDATED_AT)                   AS UPDATED_AT
--names, options, etc-------------------------------------------------------------------------
  ,IFNULL(REPLACE(DIS.value:application,'""',''),'None')                                     AS APPLICATION
  ,IFNULL(REPLACE(DIS.value:status,'""',''),'None')                                          AS STATUS
  ,CHK.STATUS                                                                               AS CHEQUESTATUS  
  ,IFNULL(UPPER(REPLACE(DIS.value:reason,'""','')),'None')                                   AS DISCOUNTREASON
  ,'Item'                                                                                   AS DISCOUNTLEVEL  
  ,IFNULL(REPLACE(DIS.value:receiptName,'""','') ,'None')                                    AS RECEIPTNAME
  ,IFNULL(REPLACE(DIS.value:promoCode,'""',''),'None')                                       AS PROMOCODE
  ,IFNULL(REPLACE(DIS.value:promoDescription,'""',''),'None')                                AS PROMODESCRIPTION
  ,IFNULL(replace(TRY_PARSE_JSON(CHK.info):revenueCenterName,'""','') ,'None')               AS REVENUECENTERNAME
  ,IFNULL(replace(TRY_PARSE_JSON(CHK.info):taxSettings:roundingMethod,'""',''),'None')       AS ROUNDINGMETHOD
--name---------------------------------------------------------------------------------------
  ,CHK.NUMBER                                                                AS CHEQUENUMBER  
  ,TRY_TO_NUMBER(TO_VARCHAR(DIS.value:itemID))                               AS ITEM_ID
  ,TRY_TO_NUMBER(TO_VARCHAR(DIS.
  value:promoCodeId))                                                        AS PROMOCODE_ID
  ,REPLACE(DIS.value:type,'""','')                                            AS DISCOUNT_TYPE
--Counts and Amounts--------------------------------------------------------------------------
,CASE WHEN REPLACE(DIS.value:type,'""','') = 'Percent'
   THEN to_char(REPLACE(DIS.value:value,'""',''))
   ELSE 0 END ::NUMBER(38,4)                     
                                                                             AS DISCOUNT_PERCENT
,TO_CHAR(DIS.value:appliedValue) ::NUMBER(38,4)                              AS APPLIED_AMOUNT

,CASE WHEN REPLACE(DIS.value:type,'""','') = 'Amount' 
     THEN to_char(REPLACE(DIS.value:value,'""',''))
   END::NUMBER(38,4)                  
                                                                              AS DISCOUNT_AMOUNT

   
  ,to_char(REPLACE(DIS.value:value,'""',''))::NUMBER(38,4)  
                                                                              AS VALUE

    
  ,TO_CHAR(TRY_PARSE_JSON(CHK.balance):discount)::NUMBER(38,4)                AS DISCOUNT
  ,TO_CHAR(TRY_PARSE_JSON(CHK.balance):discountCheck)::NUMBER(38,4)           AS DISCOUNTCHECK
  ,TO_CHAR(TRY_PARSE_JSON(CHK.balance):discountItem)::NUMBER(38,4)            AS DISCOUNTITEM
  ,TO_CHAR(TRY_PARSE_JSON(CHK.balance):gross)::NUMBER(38,4)                   AS GROSS
  ,TO_CHAR(TRY_PARSE_JSON(CHK.balance):net)::NUMBER(38,4)                     AS NET
----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_CHEQUE                                        CHK 
   ,LATERAL FLATTEN(INPUT => 
    TRY_PARSE_JSON( '{ITEMS:' || CHK.ITEMS || '}' ), PATH => 'ITEMS')
                                                                             ITM                                                                                                              
    ,LATERAL FLATTEN(INPUT => 
    TRY_PARSE_JSON('{discounts:' || TRY_PARSE_JSON(ITM.value):discounts || '}'), PATH => 'discounts')
                                                                             DIS
WHERE TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):discount), 38, 4) > 0
 AND NOT COALESCE(TRUNCATED,FALSE)
 AND MTLN_CDC_LAST_CHANGE_TYPE <> 'd' 
;"
VIEW,DATAADMIN,MENUITEM_MENUGROUP_XREF,"create or replace view MENUITEM_MENUGROUP_XREF(
	MENUITEM_MENUGROUP_XREF_PK,
	MENUITEM_MENUGROUP_XREF_NK,
	MENUITEM_MENUGROUP,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	MENUGROUP_DIM_FK,
	MENUITEM_DIM_FK
) as
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  MGI.ID                                                      AS MENUITEM_MENUGROUP_XREF_PK
--natural keys------------------------------------------------------------------------------
  ,MGI.ID                                                     AS MENUITEM_MENUGROUP_XREF_NK
--name---------------------------------------------------------------------------------------
  ,MGI.menu_Item_ID || '|' || MGI.menu_group_id               AS MENUITEM_MENUGROUP
--data warehouse rows------------------------------------------------------------------------
 ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(MGI.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY MGI.ID ORDER BY MGI.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,MGI.MTLN_CDC_SEQUENCE_NUMBER,MGI.MTLN_CDC_SRC_VERSION
      ,MGI.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(MGI.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY MGI.ID ORDER BY MGI.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,MGI.MTLN_CDC_SEQUENCE_NUMBER,MGI.MTLN_CDC_SRC_VERSION,MGI.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY MGI.ID ORDER BY 
    MGI.MTLN_CDC_LAST_COMMIT_TIMESTAMP,MGI.MTLN_CDC_SEQUENCE_NUMBER,MGI.MTLN_CDC_SRC_VERSION
   ,MGI.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN MGI.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY MGI.ID ORDER BY  
    MGI.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,MGI.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,MGI.MTLN_CDC_SRC_VERSION DESC
   ,MGI.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     --REQUIRED
--CDC Meta data-------------------------------------------------------------------------------
  ,MGI.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE
  ,MGI.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,MGI.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER
  ,MGI.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID
  ,MGI.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP
  ,MGI.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,MGI.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION
  ,MGI.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME
  ,MGI.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH
  ,MGI.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE
  ,MGI.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA
  ,MGI.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE
--foreign keys-------------------------------------------------------------------------------
  ,IFNULL(MGI.MENU_GROUP_ID,-1)        AS MENUGROUP_DIM_FK
  ,IFNULL(MGI.MENU_ITEM_ID,-1)         AS MENUITEM_DIM_FK
--flags---------------------------------------------------------------------------------------
--NONE
--Dates--------------.------------------------------------------------------------------------
--NONE  CREATE DATE AND UPDATE DATE EXCEPTED SINCE THIS IS AN XREF
--names, options, etc-------------------------------------------------------------------------
--NONE                           
--Counts and Amounts--------------------------------------------------------------------------
--NONE
----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_MENU_GROUP_ITEMS     MGI
;"
VIEW,DATAADMIN,OVERTIMELABORRULE_JOBPOSITION_XREF,"create or replace view OVERTIMELABORRULE_JOBPOSITION_XREF(
	OVERTIMELABORRULE_JOBPOSITION_XREF_PK,
	OVERTIMELABORRULE_JOBPOSITION_XREF_NK,
	OVERTIMELABORRULE_JOBPOSITION,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	JOBPOSITION_DIM_FK,
	OVERTIMELABORRULE_DIM_FK
) as
-- select * from datalanding.POSAPI_PUBLIC_OVERTIME_LABOR_RULE_JOB_POSITIONS;
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  tab.OVERTIME_LABOR_RULE_ID || '.' || tab.JOB_POSITION_ID   AS OVERTIMELABORRULE_JOBPOSITION_XREF_PK  --REQUIRED
--natural keys------------------------------------------------------------------------------
  ,tab.OVERTIME_LABOR_RULE_ID || '.' || tab.JOB_POSITION_ID   AS OVERTIMELABORRULE_JOBPOSITION_XREF_NK  --REQUIRED
--name-------------------------------------------------------------------------------------------
  ,tab.OVERTIME_LABOR_RULE_ID || '.' || tab.JOB_POSITION_ID   AS OVERTIMELABORRULE_JOBPOSITION
--data warehouse REQUIRED rows-------------------------------------------------------------------
 ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY tab.OVERTIME_LABOR_RULE_ID || '.' || tab.JOB_POSITION_ID ORDER BY tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION
      ,tab.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY tab.OVERTIME_LABOR_RULE_ID || '.' || tab.JOB_POSITION_ID ORDER BY tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION,tab.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY tab.OVERTIME_LABOR_RULE_ID || '.' || tab.JOB_POSITION_ID ORDER BY 
    tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION
   ,tab.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN tab.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY tab.OVERTIME_LABOR_RULE_ID || '.' || tab.JOB_POSITION_ID ORDER BY  
    tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,tab.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,tab.MTLN_CDC_SRC_VERSION DESC
   ,tab.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     --REQUIRED
--CDC Meta data REQUIRED rows-------------------------------------------------------------------------------
  ,tab.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE                   --REQUIRED
  ,tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP              --REQUIRED
  ,tab.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER                    --REQUIRED
  ,tab.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID                      --REQUIRED
  ,tab.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP                     --REQUIRED
  ,tab.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR                --R EQUIRED
  ,tab.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION                        --REQUIRED
  ,tab.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME                           --REQUIRED
  ,tab.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH                           --REQUIRED
  ,tab.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE                       --REQUIRED
  ,tab.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA                         --REQUIRED
  ,tab.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE                          --REQUIRED
--foreign keys-------------------------------------------------------------------------------
  ,IFNULL(tab.JOB_POSITION_ID,-1)                 AS JOBPOSITION_DIM_FK
  ,IFNULL(tab.OVERTIME_LABOR_RULE_ID,-1)          AS OVERTIMELABORRULE_DIM_FK 
--flags---------------------------------------------------------------------------------------
--ALLCOLUMN NAMES IN THIS SECTION SHOULD begin with is_ or has_ if created by the dw.
--   columns created by the source app should be specifically cast as boolean 
--Alphabetize between the lines
--Dates--------------.------------------------------------------------------------------------
--dates should be cast as dates
-- created_at timestamp with time zone  <--this is the create table from postgres
--,to_timestamp_tz(created_at) 
--Alphebetize between the lines
--names, options, etc-------------------------------------------------------------------------
--Counts and Amounts--------------------------------------------------------------------------
--ALL COLUMNS IN THIS SECTION SHOULD END IN COUNT OR AMOUNT
--Alphebetize between the lines
-- ----------------------------------------------------------------------------------------------
FROM datalanding.POSAPI_PUBLIC_OVERTIME_LABOR_RULE_JOB_POSITIONS tab
;"
VIEW,DATAADMIN,REFUNDSCHEQUEBYITEM_FACT,"create or replace view REFUNDSCHEQUEBYITEM_FACT(
	REFUNDSCHEQUEBYITEM_FACT_PK,
	REFUNDSCHEQUEBYITEM_FACT_NK,
	PAYMENTNUMBER,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	CCTRANSACTION_FACT_FK,
	CHEQUE_FACT_FK,
	DAYPART_DIM_FK,
	EMPLOYEE_DIM_FK_AS_CREATOR,
	EMPLOYEE_DIM_FK_AS_PAYEE,
	LOCATION_DIM_FK,
	PAYMENTMETHOD_DIM_FK,
	REVENUECENTER_DIM_FK,
	TRANSACTION_FACT_FK,
	TERMINAL_DIM_FK,
	ITEM_FACT_FK,
	REFUNDS_FACT_FK,
	MENUITEM_DIM_FK,
	MENUITEMNAME_DIM_FK,
	IS_TRAINING,
	OPENED_AT,
	PAID_AT,
	REFUNDED_AT,
	FISCALDATE,
	BATCHNUMBER,
	REFUNDED_BY,
	CARDBRAND,
	CARDHOLDERNAME,
	CHEQUENUMBER,
	CURRENCY_ID,
	FLOORPLAN_ID,
	LASTFOURCCNUMBER,
	NEXTFOURCCNUMBER,
	PAYMENTTYPE,
	PAYMENTSTATUS,
	REVENUECENTERNAME,
	TABLENAME,
	ITEM_ID,
	ITEMSTATUS,
	CHECK_TOTAL_AMOUNT,
	REFUND_AMOUNT,
	ITEM_QUANTITY,
	TOTAL_ITEMS_ON_CHECK,
	ITEM_ROW_NUMBER,
	SINGLE_ITEM_BASE_ALLOCATION,
	CHECK_REMAINDER,
	ALLOCATED_ITEM_REFUND
) as
SELECT
-----primary keys------------------------------------------------------------------------------
     REFUNDS_FACT_PK || '.' || ITM.ITEM_FACT_PK                                      AS REFUNDSCHEQUEBYITEM_FACT_PK
-----natural keys------------------------------------------------------------------------------
    ,REFUNDS_FACT_NK || '.' || ITM.ITEM_FACT_NK                                      AS REFUNDSCHEQUEBYITEM_FACT_NK
-----name---------------------------------------------------------------------------------------
    ,REF.PAYMENTNUMBER                                                               AS PAYMENTNUMBER
----data warehouse rows------------------------------------------------------------------------
    ,REF.DW_STARTDATE                                                                AS DW_STARTDATE
    ,REF.DW_ENDDATE                                                                  AS DW_ENDDATE
    ,REF.DW_ISDELETED                                                                AS DW_ISDELETED
    ,REF.DW_ISCURRENTROW                                                             AS DW_ISCURRENTROW
----CDC Meta data-------------------------------------------------------------------------------
    ,REF.MTLN_CDC_LAST_CHANGE_TYPE                                                   AS MTLN_CDC_LAST_CHANGE_TYPE
    ,REF.MTLN_CDC_LAST_COMMIT_TIMESTAMP                                              AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,REF.MTLN_CDC_SEQUENCE_NUMBER                                                    AS MTLN_CDC_SEQUENCE_NUMBER
    ,REF.MTLN_CDC_LOAD_BATCH_ID                                                      AS MTLN_CDC_LOAD_BATCH_ID
    ,REF.MTLN_CDC_LOAD_TIMESTAMP                                                     AS MTLN_CDC_LOAD_TIMESTAMP
    ,REF.MTLN_CDC_PROCESSED_DATE_HOUR                                                AS MTLN_CDC_PROCESSED_DATE_HOUR
    ,REF.MTLN_CDC_SRC_VERSION                                                        AS MTLN_CDC_SRC_VERSION
    ,REF.MTLN_CDC_FILENAME                                                           AS MTLN_CDC_FILENAME
    ,REF.MTLN_CDC_FILEPATH                                                           AS MTLN_CDC_FILEPATH
    ,REF.MTLN_CDC_SRC_DATABASE                                                       AS MTLN_CDC_SRC_DATABASE
    ,REF.MTLN_CDC_SRC_SCHEMA                                                         AS MTLN_CDC_SRC_SCHEMA
    ,REF.MTLN_CDC_SRC_TABLE                                                          AS MTLN_CDC_SRC_TABLE
----foreign keys-------------------------------------------------------------------------------
    ,REF.CCTRANSACTION_FACT_FK                                                       AS CCTRANSACTION_FACT_FK
    ,REF.CHEQUE_FACT_FK                                                              AS CHEQUE_FACT_FK
    ,REF.DAYPART_DIM_FK                                                              AS DAYPART_DIM_FK
    ,REF.EMPLOYEE_DIM_FK_AS_CREATOR                                                  AS EMPLOYEE_DIM_FK_AS_CREATOR
    ,REF.EMPLOYEE_DIM_FK_AS_PAYEE                                                    AS EMPLOYEE_DIM_FK_AS_PAYEE
    ,REF.LOCATION_DIM_FK                                                             AS LOCATION_DIM_FK
    ,REF.PAYMENTMETHOD_DIM_FK                                                        AS PAYMENTMETHOD_DIM_FK
    ,REF.REVENUECENTER_DIM_FK                                                        AS REVENUECENTER_DIM_FK
    ,REF.TRANSACTION_FACT_FK                                                         AS TRANSACTION_FACT_FK
    ,REF.TERMINAL_DIM_FK                                                             AS TERMINAL_DIM_FK
    ,ITM.ITEM_FACT_NK                                                                AS ITEM_FACT_FK
    ,REF.REFUNDS_FACT_NK                                                             AS REFUNDS_FACT_FK
    ,ITM.MENUITEM_DIM_FK                                                             AS MENUITEM_DIM_FK
    ,ITM.MENUITEMNAME_DIM_FK                                                         AS MENUITEMNAME_DIM_FK
----flags---------------------------------------------------------------------------------------
    ,REF.IS_TRAINING                                                                 AS IS_TRAINING
----Dates--------------.------------------------------------------------------------------------
    ,REF.OPENED_AT                                                                   AS OPENED_AT
    ,REF.PAID_AT                                                                     AS PAID_AT
    ,REF.REFUNDED_AT                                                                 AS REFUNDED_AT
    ,REF.FISCALDATE                                                                  AS FISCALDATE
-----names, options, etc----------------------------------------------------------- -------------
    ,REF.BATCHNUMBER                                                                 AS BATCHNUMBER
    ,REF.REFUNDED_BY                                                                 AS REFUNDED_BY
    ,REF.CARDBRAND                                                                   AS CARDBRAND
    ,REF.CARDHOLDERNAME                                                              AS CARDHOLDERNAME
    ,REF.CHEQUENUMBER                                                                AS CHEQUENUMBER
    ,REF.CURRENCY_ID                                                                 AS CURRENCY_ID
    ,REF.FLOORPLAN_ID                                                                AS FLOORPLAN_ID
    ,REF.LASTFOURCCNUMBER                                                            AS LASTFOURCCNUMBER
    ,REF.NEXTFOURCCNUMBER                                                            AS NEXTFOURCCNUMBER
    ,REF.PAYMENTTYPE                                                                 AS PAYMENTTYPE
    ,REF.PAYMENTSTATUS                                                               AS PAYMENTSTATUS
    ,REF.REVENUECENTERNAME                                                           AS REVENUECENTERNAME
    ,REF.TABLENAME                                                                   AS TABLENAME
    ,ITM.ITEM_ID                                                                     AS ITEM_ID
    ,ITM.ITEMSTATUS                                                                  AS ITEMSTATUS
-----Counts and Amounts--------------------------------------------------------------------------
    ,REF.CHECK_TOTAL_AMOUNT                                                          AS CHECK_TOTAL_AMOUNT
    ,REF.REFUND_AMOUNT                                                               AS REFUND_AMOUNT
    -- main logic starts
    ,ITM.QUANTITY                                                                    AS ITEM_QUANTITY
    ,SUM(ITM.QUANTITY) OVER (
        PARTITION BY REF.CHEQUE_FACT_FK, REF.REFUNDS_FACT_PK, REF.MTLN_CDC_SEQUENCE_NUMBER
     )                                                                                      AS TOTAL_ITEMS_ON_CHECK -- Calculate the total quantity of all items on the check for this specific REFUND record.
    ,ROW_NUMBER() OVER (
        PARTITION BY REF.CHEQUE_FACT_FK, REF.REFUNDS_FACT_PK, REF.MTLN_CDC_SEQUENCE_NUMBER
        ORDER BY ITM.ITEM_ID
     )                                                                                      AS ITEM_ROW_NUMBER -- Assign a row number to each item line within the check. This is used to assign the rounding remainder.
    ,ROUND(REF.REFUND_AMOUNT / TOTAL_ITEMS_ON_CHECK, 2)                                     AS SINGLE_ITEM_BASE_ALLOCATION  -- Calculate the base allocation for a single item (quantity of 1).
    ,REF.REFUND_AMOUNT - (SINGLE_ITEM_BASE_ALLOCATION * TOTAL_ITEMS_ON_CHECK)               AS CHECK_REMAINDER -- Calculate the total remainder for the entire check to handle rounding issues.
    ,(SINGLE_ITEM_BASE_ALLOCATION * ITM.QUANTITY) +
        CASE
            WHEN ITEM_ROW_NUMBER = 1 THEN CHECK_REMAINDER
            ELSE 0
        END                                                                                 AS ALLOCATED_ITEM_REFUND -- Calculate the final allocated REFUND for this specific item, adding the remainder to the first ITM.
FROM DATAADMIN.REFUNDS_FACT REF
    JOIN DATAADMIN.ITEM_FACT ITM
        ON REF.CHEQUE_FACT_FK = ITM.CHEQUE_FACT_FK
        AND REF.MTLN_CDC_SEQUENCE_NUMBER = ITM.MTLN_CDC_SEQUENCE_NUMBER
        AND REF.MTLN_CDC_SRC_VERSION = ITM.MTLN_CDC_SRC_VERSION
        AND REF.MTLN_CDC_FILENAME = ITM.MTLN_CDC_FILENAME
    WHERE
        ITM.ITEMSTATUS IN ('Added','Sent')

--===========================================================================================
--End of View
--============================================================================================
/*
;
-- USAGE AND VALIDATIONS
-- The query below should output a difference of 0 for most location-dates.
-- The few deltas that appear are because business rules have changed with time, but the sum of the deltas shoun't be higher than 200 dollars total.
DROP TABLE if exists REPORT_DATA_REFUND;
CALL PRD_HOSPENG_REPORTING.DATAADMIN.SP_REPORT_REFUNDS('2020-07-01T14:48:37.661Z','2029-07-26T14:48:37.661Z','[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99]');
CREATE TEMP TABLE REPORT_DATA_REFUND AS
     SELECT * FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()));


WITH RefundsByItemFactAgg AS (
    SELECT
        LOCATION_DIM_FK,
        FISCALDATE,
        SUM(ALLOCATED_ITEM_REFUND) AS TOTAL_ALLOCATED_ITEM_REFUND
    FROM
        DATAADMIN.REFUNDSCHEQUEBYITEM_FACT_DEV_V2
    WHERE
      DW_ISCURRENTROW
      AND NOT DW_ISDELETED
      -- AND LOCATION_DIM_FK = 26
    GROUP BY
        LOCATION_DIM_FK,
        FISCALDATE
),
ReportDataAgg AS (
    -- This new CTE aggregates the report data to the same level as RefundsByItemFactAgg
    SELECT
        ""Location ID"",
        ""Fiscal Date"",
        SUM(""Refund Amount"") AS total_report_refund_amount
    FROM
        REPORT_DATA_REFUND
    GROUP BY
        ""Location ID"",
        ""Fiscal Date""
)
SELECT
    v.location_dim_fk,
    v.fiscaldate,
    v.total_allocated_item_refund,
    rdv.total_report_refund_amount,
    -- Calculate the difference using the new aggregated amount
    (v.total_allocated_item_refund - rdv.total_report_refund_amount) AS difference
FROM
    RefundsByItemFactAgg AS v
INNER JOIN
    -- Join to the newly created aggregated CTE
    ReportDataAgg AS rdv
ON
    v.location_dim_fk = rdv.""Location ID"" AND v.fiscaldate = rdv.""Fiscal Date""
WHERE difference <> 0
ORDER BY
    abs(difference) DESC
;

*/;"
VIEW,DATAADMIN,REPORTCATEGORY_DIM,"create or replace view REPORTCATEGORY_DIM(
	REPORTCATEGORY_DIM_PK,
	REPORTCATEGORY_DIM_NK,
	REPORTCATEGORY,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	COGSCATEGORY_DIM_FK,
	ORGANIZATION_DIM_FK,
	CREATED_AT,
	UPDATED_AT
) as
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  rec.ID                                                     AS REPORTCATEGORY_DIM_PK
--natural keys------------------------------------------------------------------------------
  ,rec.ID                                                    AS REPORTCATEGORY_DIM_NK
--name---------------------------------------------------------------------------------------
  ,rec.name                                                  AS REPORTCATEGORY
--data warehouse rows------------------------------------------------------------------------
  ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(rec.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY rec.ID ORDER BY rec.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,rec.MTLN_CDC_SEQUENCE_NUMBER,rec.MTLN_CDC_SRC_VERSION
      ,rec.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(rec.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY rec.ID ORDER BY rec.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,rec.MTLN_CDC_SEQUENCE_NUMBER,rec.MTLN_CDC_SRC_VERSION,rec.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY rec.ID ORDER BY 
    rec.MTLN_CDC_LAST_COMMIT_TIMESTAMP,rec.MTLN_CDC_SEQUENCE_NUMBER,rec.MTLN_CDC_SRC_VERSION
   ,rec.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN rec.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY rec.ID ORDER BY  
    rec.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,rec.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,rec.MTLN_CDC_SRC_VERSION DESC
   ,rec.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     --REQUIRED
--CDC Meta data-------------------------------------------------------------------------------
  ,rec.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE
  ,rec.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,rec.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER
  ,rec.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID
  ,rec.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP
  ,rec.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,rec.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION
  ,rec.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME
  ,rec.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH
  ,rec.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE
  ,rec.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA
  ,rec.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE
--foreign keys-------------------------------------------------------------------------------  
 ,IFNULL(COGS_CATEGORY_ID,-1)       AS COGSCATEGORY_DIM_FK
  ,IFNULL(rec.ORGANIZATION_ID,-1)      AS ORGANIZATION_DIM_FK
--flags---------------------------------------------------------------------------------------
--none
--Dates--------------------------------------------------------------------------------------
  ,TO_TIMESTAMP_TZ(rec.CREATED_AT)     AS CREATED_AT  
  ,TO_TIMESTAMP_TZ(rec.UPDATED_AT)     AS UPDATED_AT
--names, options, etc---------------------------------------------------------
 --none
--Counts and Amounts--------------------------------------------------------------------------
 --none
----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_REPORTING_CATEGORY    rec
;"
VIEW,DATAADMIN,SHIFTBREAK_FACT,"create or replace view SHIFTBREAK_FACT(
	SHIFTBREAK_FACT_PK,
	SHIFTBREAK_FACT_NK,
	SHIFTBREAK,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	SHIFT_DIM_FK,
	IS_BREAKCOMPLETE,
	IS_ARCHIVED,
	CREATED_AT,
	UPDATED_AT,
	START_AT,
	ORIG_BEGIN_AT,
	END_AT_INT,
	END_AT,
	ORIG_END_AT,
	TIME_RANGE,
	BREAK_SECONDS,
	BREAK_MINUTES,
	BREAK_HOURS,
	BREAK_DAYS
) as
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  tab.ID                                                      AS SHIFTBREAK_FACT_PK  
--natural keys------------------------------------------------------------------------------
  ,tab.ID                                                     AS SHIFTBREAK_FACT_NK  
--name-------------------------------------------------------------------------------------------
  ,tab.TIME_RANGE                                             AS SHIFTBREAK
--data warehouse REQUIRED rows-------------------------------------------------------------------
 ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY tab.ID ORDER BY tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION
      ,tab.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY tab.ID ORDER BY tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION,tab.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY tab.ID ORDER BY 
    tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION
   ,tab.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          
  
  ,CASE WHEN tab.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED               
  ,CASE WHEN RANK() OVER(PARTITION BY tab.ID ORDER BY  
    tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,tab.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,tab.MTLN_CDC_SRC_VERSION DESC
   ,tab.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     
--CDC Meta data REQUIRED rows-------------------------------------------------------------------------------
  ,tab.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE                   
  ,tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP              
  ,tab.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER                    
  ,tab.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID                      
  ,tab.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP                     
  ,tab.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR                
  ,tab.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION                        
  ,tab.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME                            
  ,tab.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH                            
  ,tab.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE                        
  ,tab.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA                          
  ,tab.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE                           
--foreign keys-------------------------------------------------------------------------------
  ,tab.SHIFT_id                        AS SHIFT_DIM_FK  
--flags---------------------------------------------------------------------------------------
--ALLCOLUMN NAMES IN THIS SECTION SHOULD begin with is_ or has_ if created by the dw.
--   columns created by the source app should be specifically cast as boolean 
--Alphabetize between the lines
 ,tab.END_AT IS NOT NULL                   AS IS_BREAKCOMPLETE             
 ,tab.ARCHIVED                             AS IS_ARCHIVED
--Dates--------------.------------------------------------------------------------------------
--dates should be cast as dates
-- created_at timestamp with time zone  <--this is the create table from postgres
--,to_timestamp_tz(created_at) 
--Alphebetize between the lines
  ,try_to_timestamp_tz(tab.CREATED_AT)      AS CREATED_AT  
  ,try_to_timestamp_tz(tab.UPDATED_AT)      AS UPDATED_AT
  ,try_to_timestamp_tz(tab.BEGIN_AT)        AS START_AT
  ,try_to_timestamp_tz(tab.ORIG_BEGIN_AT)   AS ORIG_BEGIN_AT
  ,tab.END_AT as END_AT_int
  ,try_to_timestamp_tz(tab.END_AT)          AS END_AT
  ,try_to_timestamp_tz(tab.ORIG_END_AT)     AS ORIG_END_AT
  ,tab.TIME_RANGE                           AS TIME_RANGE
--names, options, etc-------------------------------------------------------------------------
--Counts and Amounts--------------------------------------------------------------------------
--ALL COLUMNS IN THIS SECTION SHOULD END IN COUNT OR AMOUNT
--Alphebetize between the lines
,ROUND(TIMEDIFF(second,to_timestamp_tz(tab.BEGIN_AT),to_timestamp_tz(tab.END_AT))             ::Number(38,0),0)
                                           AS BREAK_SECONDS
,ROUND(TIMEDIFF(second,to_timestamp_tz(tab.BEGIN_AT),to_timestamp_tz(tab.END_AT)) /60         ::Number(38,0),0)
                                           AS BREAK_MINUTES
,ROUND(TIMEDIFF(second,to_timestamp_tz(tab.BEGIN_AT),to_timestamp_tz(tab.END_AT))  /60/60     ::Number(38,0),0)
                                           AS BREAK_HOURS
,ROUND(TIMEDIFF(second,to_timestamp_tz(tab.BEGIN_AT),to_timestamp_tz(tab.END_AT))  /60/60/60  ::Number(38,0),0)
                                           AS BREAK_DAYS                                         
-- ----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_EMPLOYEE_SHIFT_BREAK tab 
  WHERE NOT COALESCE(tab.TRUNCATED,FALSE)
      AND tab.MTLN_CDC_LAST_CHANGE_TYPE <> 'd' 
;
--=====================DAT======================================================================
--End of View"
VIEW,DATAADMIN,ADDRESS_DIM,"create or replace view ADDRESS_DIM(
	ADDRESS_DIM_PK,
	ADDRESS_DIM_NK,
	ADDRESS,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	CREATED_AT,
	UPDATED_AT,
	GEO,
	ZIP,
	ZIP4,
	COUNTRY,
	INTERNAL,
	LOCATION,
	STREETNAME,
	STREETTYPEABBREV,
	PREDIRABBREV,
	POSTDIRABBREV,
	ADDRESS_ALPHANUMERIC
) as
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  ADD.ID                                                     AS ADDRESS_DIM_PK
--natural keys------------------------------------------------------------------------------
  ,ADD.ID                                                    AS ADDRESS_DIM_NK
--name---------------------------------------------------------------------------------------
  ,ADD.STREETNAME                                            AS ADDRESS
--data warehouse rows------------------------------------------------------------------------
  ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(ADD.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY ADD.ID ORDER BY ADD.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,ADD.MTLN_CDC_SEQUENCE_NUMBER,ADD.MTLN_CDC_SRC_VERSION
      ,ADD.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(ADD.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY ADD.ID ORDER BY ADD.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,ADD.MTLN_CDC_SEQUENCE_NUMBER,ADD.MTLN_CDC_SRC_VERSION,ADD.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY ADD.ID ORDER BY 
    ADD.MTLN_CDC_LAST_COMMIT_TIMESTAMP,ADD.MTLN_CDC_SEQUENCE_NUMBER,ADD.MTLN_CDC_SRC_VERSION
   ,ADD.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN ADD.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY ADD.ID ORDER BY  
    ADD.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,ADD.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,ADD.MTLN_CDC_SRC_VERSION DESC
   ,ADD.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     --REQUIRED
--CDC Meta data-------------------------------------------------------------------------------
  ,ADD.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE
  ,ADD.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,ADD.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER
  ,ADD.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID
  ,ADD.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP
  ,ADD.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,ADD.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION
  ,ADD.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME
  ,ADD.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH
  ,ADD.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE
  ,ADD.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA
  ,ADD.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE
--foreign keys-------------------------------------------------------------------------------
 --none
--flags---------------------------------------------------------------------------------------
--none
--Dates--------------.------------------------------------------------------------------------
  ,to_timestamp_tz(ADD.CREATED_AT)     AS CREATED_AT   
  ,to_timestamp_tz(ADD.UPDATED_AT)     AS UPDATED_AT  
--names, options, etc-------------------------------------------------------------------------
  ,to_varchar(ADD.GEO)                 AS GEO
  ,ADD.ZIP                             AS ZIP
  ,ADD.ZIP4                            AS ZIP4
  ,ADD.COUNTRY                         AS COUNTRY
  ,ADD.INTERNAL                        AS INTERNAL
  ,ADD.LOCATION                        AS LOCATION
  ,ADD.STREETNAME                      AS STREETNAME
  ,ADD.STREETTYPEABBREV                AS STREETTYPEABBREV
  ,ADD.PREDIRABBREV                    AS PREDIRABBREV
  ,ADD.POSTDIRABBREV                   AS POSTDIRABBREV
  ,ADD.ADDRESS_ALPHANUMERIC            AS ADDRESS_ALPHANUMERIC
--Counts and Amounts--------------------------------------------------------------------------
--none 
----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_ADDRESS     ADD
;"
VIEW,DATAADMIN,DISCOUNTCHECK_FACT,"create or replace view DISCOUNTCHECK_FACT(
	DISCOUNTCHECK_FACT_PK,
	DISCOUNTCHECK_FACT_NK,
	DISCOUNTNAME,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	CHEQUE_FACT_FK,
	DAYPART_DIM_FK,
	EMPLOYEE_DIM_FK_AS_ADDED_BY,
	EMPLOYEE_DIM_FK_AS_APPROVED_BY,
	EMPLOYEE_DIM_FK,
	LOCATION_DIM_FK,
	STANDARDDISCOUNT_DIM_FK,
	DO_AUTOAPPLY,
	IS_TRAINING,
	ADDED_AT,
	CREATED_AT,
	FISCAL_DATE,
	OPENED_AT,
	UPDATED_AT,
	APPLICATION,
	STATUS,
	CHEQUESTATUS,
	DISCOUNTREASON,
	DISCOUNTLEVEL,
	RECEIPTNAME,
	PROMOCODE,
	PROMODESCRIPTION,
	REVENUECENTERNAME,
	ROUNDINGMETHOD,
	CHEQUENUMBER,
	ITEM_ID,
	PROMOCODE_ID,
	DISCOUNT_TYPE,
	DISCOUNT_PERCENT,
	APPLIED_AMOUNT,
	DISCOUNT_AMOUNT,
	VALUE,
	DISCOUNT,
	DISCOUNTCHECK,
	DISCOUNTITEM,
	GROSS,
	NET
) as
--============================================================================================
SELECT 
TO_VARCHAR(CHK.ID) || '.' || TO_CHAR(DIS.value:id)                        AS DISCOUNTCHECK_FACT_PK
--natural keys------------------------------------------------------------------------------
  ,TO_VARCHAR(CHK.ID) || '.' || TO_CHAR(DIS.value:id)                     AS DISCOUNTCHECK_FACT_NK
--name---------------------------------------------------------------------------------------
   ,TO_CHAR(DIS.value:id)                                                 AS DISCOUNTNAME
--data warehouse rows--------------------------------------------------------------------------
,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY TO_VARCHAR(CHK.ID) || '.' || TO_CHAR(DIS.value:id) ORDER BY CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION
      ,CHK.MTLN_CDC_FILENAME)),6))
                                                                          AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY TO_VARCHAR(CHK.ID) || '.' || TO_CHAR(DIS.value:id) ORDER BY CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION,CHK.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY TO_VARCHAR(CHK.ID) || '.' || TO_CHAR(DIS.value:id) ORDER BY 
    CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION
   ,CHK.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                                           AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN CHK.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                               AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY TO_VARCHAR(CHK.ID) || '.' || TO_CHAR(DIS.value:id) ORDER BY  
    CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,CHK.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,CHK.MTLN_CDC_SRC_VERSION DESC
   ,CHK.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                                           AS DW_ISCURRENTROW     --REQUIRED
--CDC Meta data-------------------------------------------------------------------------------
  ,CHK.MTLN_CDC_LAST_CHANGE_TYPE                     AS MTLN_CDC_LAST_CHANGE_TYPE
  ,CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP                AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,CHK.MTLN_CDC_SEQUENCE_NUMBER                      AS MTLN_CDC_SEQUENCE_NUMBER
  ,CHK.MTLN_CDC_LOAD_BATCH_ID                        AS MTLN_CDC_LOAD_BATCH_ID
  ,CHK.MTLN_CDC_LOAD_TIMESTAMP                       AS MTLN_CDC_LOAD_TIMESTAMP
  ,CHK.MTLN_CDC_PROCESSED_DATE_HOUR                  AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,CHK.MTLN_CDC_SRC_VERSION                          AS MTLN_CDC_SRC_VERSION
  ,CHK.MTLN_CDC_FILENAME                             AS MTLN_CDC_FILENAME
  ,CHK.MTLN_CDC_FILEPATH                             AS MTLN_CDC_FILEPATH
  ,CHK.MTLN_CDC_SRC_DATABASE                         AS MTLN_CDC_SRC_DATABASE
  ,CHK.MTLN_CDC_SRC_SCHEMA                           AS MTLN_CDC_SRC_SCHEMA
  ,CHK.MTLN_CDC_SRC_TABLE                            AS MTLN_CDC_SRC_TABLE
--foreign keys-------------------------------------------------------------------------------
  ,IFNULL(CHK.ID,-1)                                            AS CHEQUE_FACT_FK 
  ,IFNULL(CHK.day_part_id,-1)                                   AS DAYPART_DIM_FK

  ,IFNULL(DIS.value:adddedByEmployeeId,-1)::int                 AS EMPLOYEE_DIM_FK_AS_ADDED_BY
  ,IFNULL(DIS.value:approvedByEmployeeId,-1)::int               AS EMPLOYEE_DIM_FK_AS_APPROVED_BY
  
  ,IFNULL(CHK.EMPLOYEE_ID,-1)                                   AS EMPLOYEE_DIM_FK
  ,IFNULL(CHK.LOCATION_ID,-1)                                   AS LOCATION_DIM_FK 
  ,IFNULL(TRY_TO_NUMBER(TO_VARCHAR(DIS.value:standardDiscountId)),-1)  
                                                                AS STANDARDDISCOUNT_DIM_FK
--flags---------------------------------------------------------------------------------------
  ,CASE REPLACE(DIS.value:doAutoApply,'""','') 
    WHEN 'false' THEN FALSE
    WHEN 'true'  THEN TRUE ELSE NULL END             AS DO_AUTOAPPLY
 ,CHK.IS_TRAINING                                    AS IS_TRAINING    
--Dates--------------.------------------------------------------------------------------------
  ,to_timestamp(to_varchar(DIS.value:addedAt))       AS ADDED_AT
  ,to_timestamp_tz(CHK.CREATED_AT)                   AS CREATED_AT 
  -- ,TO_DATE('20' || CHK.FISCAL_DATE_INT,'YYYYMMDD')   AS FISCAL_DATE 
,TO_DATE(TO_CHAR(TRY_PARSE_JSON(CHK.info):fiscalDate),'YYYY-MM-DD')   AS FISCAL_DATE 
  ,to_timestamp_tz(CHK.OPENED_AT)                    AS OPENED_AT 
  ,to_timestamp_tz(CHK.UPDATED_AT)                   AS UPDATED_AT

--names, options, etc-------------------------------------------------------------------------
  ,IFNULL(REPLACE(DIS.value:application,'""',''),'None')                                     AS APPLICATION
  ,IFNULL(REPLACE(DIS.value:status,'""',''),'None')                                          AS STATUS
  ,CHK.STATUS                                                                               AS CHEQUESTATUS  
  ,IFNULL(UPPER(REPLACE(DIS.value:reason,'""','')),'None')                                   AS DISCOUNTREASON
  ,'Check'                                                                                  AS DISCOUNTLEVEL  
  ,IFNULL(REPLACE(DIS.value:receiptName,'""','') ,'None')                                    AS RECEIPTNAME
  ,IFNULL(REPLACE(DIS.value:promoCode,'""',''),'None')                                       AS PROMOCODE
  ,IFNULL(REPLACE(DIS.value:promoDescription,'""',''),'None')                                AS PROMODESCRIPTION
  ,IFNULL(replace(TRY_PARSE_JSON(CHK.info):revenueCenterName,'""','') ,'None')               AS REVENUECENTERNAME
  ,IFNULL(replace(TRY_PARSE_JSON(CHK.info):taxSettings:roundingMethod,'""',''),'None')       AS ROUNDINGMETHOD
--name---------------------------------------------------------------------------------------
  ,CHK.NUMBER                                                                AS CHEQUENUMBER  
  ,TRY_TO_NUMBER(TO_VARCHAR(DIS.value:itemID))                               AS ITEM_ID
  ,TRY_TO_NUMBER(TO_VARCHAR(DIS.value:promoCodeId))                          AS PROMOCODE_ID
  ,REPLACE(DIS.value:type,'""','')                                            AS DISCOUNT_TYPE
--Counts and Amounts--------------------------------------------------------------------------
 ,CASE WHEN REPLACE(DIS.value:type,'""','') = 'Percent'
   THEN to_char(REPLACE(DIS.value:value,'""',''))
   ELSE 0 END ::NUMBER(38,4)                     
                                                                             AS DISCOUNT_PERCENT
,TO_CHAR(DIS.value:appliedValue) ::NUMBER(38,4)                              AS APPLIED_AMOUNT

,CASE WHEN REPLACE(DIS.value:type,'""','') = 'Amount' 
     THEN to_char(REPLACE(DIS.value:value,'""',''))
   END::NUMBER(38,4)                  
                                                                              AS DISCOUNT_AMOUNT

   
  ,to_char(REPLACE(DIS.value:value,'""',''))::NUMBER(38,4)  
                                                                              AS VALUE

    
  ,TO_CHAR(TRY_PARSE_JSON(CHK.balance):discount)::NUMBER(38,4)                AS DISCOUNT
  ,TO_CHAR(TRY_PARSE_JSON(CHK.balance):discountCheck)::NUMBER(38,4)           AS DISCOUNTCHECK
  ,TO_CHAR(TRY_PARSE_JSON(CHK.balance):discountItem)::NUMBER(38,4)            AS DISCOUNTITEM
  ,TO_CHAR(TRY_PARSE_JSON(CHK.balance):gross)::NUMBER(38,4)                   AS GROSS
  ,TO_CHAR(TRY_PARSE_JSON(CHK.balance):net)::NUMBER(38,4)                     AS NET
----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_CHEQUE                                  CHK 
    ,LATERAL FLATTEN(INPUT => 
    TRY_PARSE_JSON('{discounts:' || TRY_PARSE_JSON(chk.info):discounts || '}'), PATH => 'discounts')
                                                                        DIS
WHERE TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):discount), 38, 4) > 0
  AND NOT COALESCE(TRUNCATED,FALSE)
  AND CHK.MTLN_CDC_LAST_CHANGE_TYPE <> 'd'
;"
VIEW,DATAADMIN,ERRORDWDATE_DIM,"create or replace view ERRORDWDATE_DIM(
	ERRORDWDATE_DIM_NK,
	REPORTCATEGORY,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	ORGANIZATION_DIM_FK,
	CREATED_AT,
	MODIFIED_AT,
	TESTERROR_AT,
	TESTERROR_ID,
	IS_BOOLEANTEST,
	ERROR_VARIANT,
	TEST_ID,
	TEST_DECIMAL_TRUE,
	TEST_NUMERIC_TRUE,
	TEST_AMOUNT_FALSE,
	TEST_BOOLEAN_TRUE,
	V,
	VTYPE_INT,
	VTYPE_DEC,
	VTYPE_STRING,
	VTYPE_BOOLEAN,
	VTYPE_DATE,
	IS_NAMEBOOLEANERROR,
	NAMEBOOLEANERROR_IS,
	NAMENUMBRANERROR_COUNT
) as

SELECT 
REPORTCATEGORY_DIM_NK  as ERRORDWDATE_DIM_NK, REPORTCATeGORY, DW_STARTDATE, DW_ENDDATE, DW_ISDELETED, DW_ISCURRENTROW, MTLN_CDC_LAST_CHANGE_TYPE, MTLN_CDC_LAST_COMMIT_TIMESTAMP, MTLN_CDC_SEQUENCE_NUMBER, MTLN_CDC_LOAD_BATCH_ID, MTLN_CDC_LOAD_TIMESTAMP, MTLN_CDC_PROCESSED_DATE_HOUR, MTLN_CDC_SRC_VERSION, MTLN_CDC_FILENAME, MTLN_CDC_FILEPATH, MTLN_CDC_SRC_SCHEMA, MTLN_CDC_SRC_TABLE, ORGANIZATION_DIM_FK, CREATED_AT, UPDATED_AT AS MODIFIED_AT
, '1234' AS TESTERROR_AT
, '1234' AS TESTERROR_id
,'true' AS IS_BOOLEANtest
,CAST(233 AS VARIANT) as ERROR_VARIANT
,'233' as test_id
,'123.777' AS test_decimal_true
,'444' AS test_numeric_true
,'444.45' AS TEST_AMOUNT_false
,'true' as test_boolean_true
,'123.777' AS v

,CAST(456 as VARIANT) AS VType_int
,CAST(1234.4567 as VARIANT) AS VType_dec
,CAST('here is text' as VARIANT) AS VType_string
,CAST(true as VARIANT) AS VType_boolean
,CAST('2022-08-26T20:01:09.134279Z' as VARIANT) AS VType_date

,CAST ('BST' AS VARCHAR) AS IS_NAMEBOOLEANERROR
,CAST ('XXX' AS VARCHAR) AS NAMEBOOLEANERROR_IS
,CAST ('2245' AS VARCHAR) AS NAMENUMBRANERROR_COUNT


FROM REPORTCATEGORY_DIM

UNION

SELECT 
REPORTCATEGORY_DIM_NK, REPORTCATeGORY, DW_STARTDATE, DW_ENDDATE, DW_ISDELETED, DW_ISCURRENTROW, MTLN_CDC_LAST_CHANGE_TYPE, MTLN_CDC_LAST_COMMIT_TIMESTAMP, MTLN_CDC_SEQUENCE_NUMBER, MTLN_CDC_LOAD_BATCH_ID, MTLN_CDC_LOAD_TIMESTAMP, MTLN_CDC_PROCESSED_DATE_HOUR, MTLN_CDC_SRC_VERSION, MTLN_CDC_FILENAME, MTLN_CDC_FILEPATH, MTLN_CDC_SRC_SCHEMA, MTLN_CDC_SRC_TABLE, ORGANIZATION_DIM_FK, CREATED_AT, UPDATED_AT
, '1234' AS TESTERROR_AT
, '1234' AS TESTERROR_id
,'true' AS IS_BOOLEANtest
,CAST('233' AS VARIANT) as ERROR_VARIANT
,'233' as test_id
,'123.777' AS test_decimal_true
,'444' AS test_numeric_true
,'444 first street' AS TEST_AMOUNT_false
,'false' as test_boolean_true
,'123.777' AS v

,CAST(456 as VARIANT) AS VType_int
,CAST(1234.4567 as VARIANT) AS VType_dec
,CAST('here is text' as VARIANT) AS VType_string
,CAST(false as VARIANT) AS VType_boolean
,CAST('2022-08-26T20:01:09.134279Z' as VARIANT) AS VType_date

,CAST ('TRUE' AS VARCHAR) AS IS_NAMEBOOLEANERROR
,CAST ('TRUE' AS VARCHAR) AS NAMEBOOLEANERROR_IS
,CAST ('2245' AS VARCHAR) AS NAMENUMBRANERROR_COUNT

FROM REPORTCATEGORY_DIM
;"
VIEW,DATAADMIN,ITEMMODIFIER_DIM,"create or replace view ITEMMODIFIER_DIM(
	ITEMMODIFIER_DIM_PK,
	ITEMMODIFIER_DIM_NK,
	MODIFICATION_ID,
	DW_STARTDATE,
	FISCALDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	CHEQUE_FACT_FK,
	DAYPART_DIM_FK,
	EMPLOYEE_DIM_FK,
	ITEM_FACT_FK,
	LOCATION_DIM_FK,
	MODIFIERGROUP_DIM_FK,
	MODIFIER_DIM_FK,
	IS_TRAINING,
	CREATED_AT,
	FISCAL_DATE,
	OPENED_AT,
	UPDATED_AT,
	CHEQUESTATUS,
	MODIFIER_GROUP,
	MODIFIER,
	MODIFIER_TYPE,
	REVENUECENTERNAME,
	ROUNDINGMETHOD,
	CHEQUENUMBER,
	PRICE
) as
-- select * from ITEMMODIFIER_DIM where MTLN_CDC_LAST_CHANGE_TYPE ='d' 
--============================================================================================
-- select * From ITEMMODIFIER_DIM;
----------------------------------------------------------------------------------------------
SELECT 
TO_VARCHAR(CHK.ID) || '.'  ||replace(ITM.VALUE:id,'""','') || '.' || TO_CHAR(MOD.index)                        
                                                                          AS ITEMMODIFIER_DIM_PK
--natural keys------------------------------------------------------------------------------
  ,TO_VARCHAR(CHK.ID) || '.'  ||replace(ITM.VALUE:id,'""','') || '.' || TO_CHAR(MOD.index)                     
                                                                          AS ITEMMODIFIER_DIM_NK
--name---------------------------------------------------------------------------------------
   ,TO_CHAR(MOD.index)                                                    AS MODIFICATION_ID
--data warehouse rows--------------------------------------------------------------------------
   ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY 
         TO_VARCHAR(CHK.ID) || '.'  ||replace(ITM.VALUE:id,'""','') || '.' || TO_CHAR(MOD.index)     
          ORDER BY CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION
      ,CHK.MTLN_CDC_FILENAME)),6))
                                                                           AS DW_STARTDATE 
     ,TO_CHAR(TRY_PARSE_JSON(CHK.info):fiscalDate)::DATE                   AS FISCALDATE                                                                           
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY 
      TO_VARCHAR(CHK.ID) || '.'  ||replace(ITM.VALUE:id,'""','') || '.' || TO_CHAR(MOD.index)   
      ORDER BY CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION,CHK.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY 
    TO_VARCHAR(CHK.ID) || '.'  ||replace(ITM.VALUE:id,'""','') || '.' || TO_CHAR(MOD.index) 
    ORDER BY 
    CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION
   ,CHK.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                                           AS DW_ENDDATE          
  
  ,CASE WHEN CHK.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                               AS DW_ISDELETED               
  ,CASE WHEN RANK() OVER(PARTITION BY 
  TO_VARCHAR(CHK.ID) || '.'  ||replace(ITM.VALUE:id,'""','') || '.' || TO_CHAR(MOD.index)  
   ORDER BY  
    CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,CHK.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,CHK.MTLN_CDC_SRC_VERSION DESC
   ,CHK.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                                           AS DW_ISCURRENTROW     
--CDC Meta data-------------------------------------------------------------------------------
  ,CHK.MTLN_CDC_LAST_CHANGE_TYPE                     AS MTLN_CDC_LAST_CHANGE_TYPE
  ,CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP                AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,CHK.MTLN_CDC_SEQUENCE_NUMBER                      AS MTLN_CDC_SEQUENCE_NUMBER
  ,CHK.MTLN_CDC_LOAD_BATCH_ID                        AS MTLN_CDC_LOAD_BATCH_ID
  ,CHK.MTLN_CDC_LOAD_TIMESTAMP                       AS MTLN_CDC_LOAD_TIMESTAMP
  ,CHK.MTLN_CDC_PROCESSED_DATE_HOUR                  AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,CHK.MTLN_CDC_SRC_VERSION                          AS MTLN_CDC_SRC_VERSION
  ,CHK.MTLN_CDC_FILENAME                             AS MTLN_CDC_FILENAME
  ,CHK.MTLN_CDC_FILEPATH                             AS MTLN_CDC_FILEPATH
  ,CHK.MTLN_CDC_SRC_DATABASE                         AS MTLN_CDC_SRC_DATABASE
  ,CHK.MTLN_CDC_SRC_SCHEMA                           AS MTLN_CDC_SRC_SCHEMA
  ,CHK.MTLN_CDC_SRC_TABLE                            AS MTLN_CDC_SRC_TABLE
-- --foreign keys-------------------------------------------------------------------------------
  ,IFNULL(CHK.ID,-1)                                 AS CHEQUE_FACT_FK 
  ,IFNULL(CHK.day_part_id,-1)                        AS DAYPART_DIM_FK   
  ,IFNULL(CHK.EMPLOYEE_ID,-1)                        AS EMPLOYEE_DIM_FK
  ,IFNULL(CHK.ID || '.'  ||replace(ITM.VALUE:id,'""',''),'-1')                           
                                                     AS ITEM_FACT_FK
  ,IFNULL(CHK.LOCATION_ID,-1)                        AS LOCATION_DIM_FK                                                      
  ,IFNULL(MOD.value:groupId,-1)::number(38,0)        AS MODIFIERGROUP_DIM_FK                          
  ,IFNULL(MOD.index,-1)::number(38,0)             AS MODIFIER_DIM_FK

-- --flags---------------------------------------------------------------------------------------
   ,CHK.IS_TRAINING                                  AS IS_TRAINING  
--Dates--------------.------------------------------------------------------------------------
  ,to_timestamp_tz(CHK.CREATED_AT)                   AS CREATED_AT 
   ,TO_DATE(TO_CHAR(TRY_PARSE_JSON(CHK.info):fiscalDate),'YYYY-MM-DD')   
                                                     AS FISCAL_DATE 
  ,to_timestamp_tz(CHK.OPENED_AT)                    AS OPENED_AT 
  ,to_timestamp_tz(CHK.UPDATED_AT)                   AS UPDATED_AT
--names, options, etc-------------------------------------------------------------------------
  ,CHK.STATUS                                                                AS CHEQUESTATUS  
  ,REPLACE(MOD.value:groupName,'""','')                                       AS MODIFIER_GROUP
  ,REPLACE(MOD.value:name,'""','')                                            AS MODIFIER
  ,REPLACE(MOD.value:type,'""','')                                            AS MODIFIER_TYPE
  ,IFNULL(replace(TRY_PARSE_JSON(CHK.info):revenueCenterName,'""','') ,'None')AS REVENUECENTERNAME
  ,IFNULL(replace(TRY_PARSE_JSON(CHK.info):taxSettings:roundingMethod,'""',''),'None')       
                                                                             AS ROUNDINGMETHOD
--name---------------------------------------------------------------------------------------
  ,CHK.NUMBER                                                                AS CHEQUENUMBER  
--Counts and Amounts--------------------------------------------------------------------------
  ,MOD.value:price::decimal(38,2)                                             AS PRICE
----------------------------------------------------------------------------------------------
-- select
-- --12478.a661b719-79c6-4a53-8e8c-3c4e7aa95cee.689
-- TO_VARCHAR(CHK.ID) ,replace(ITM.VALUE:id,'""',''), TO_CHAR(MOD.index),mod.value,mod.index
FROM DATALANDING.POSAPI_PUBLIC_CHEQUE                                        CHK 
   ,LATERAL FLATTEN(INPUT => 
    TRY_PARSE_JSON( '{ITEMS:' || CHK.ITEMS || '}' ), PATH => 'ITEMS')
                                                                             ITM                                                                                               
    ,LATERAL FLATTEN(INPUT => 
    TRY_PARSE_JSON('{modifiers:' || TRY_PARSE_JSON(ITM.value):modifiers || '}'), PATH => 'modifiers')
                                                                             MOD
 WHERE NOT COALESCE(TRUNCATED,FALSE)
   and MTLN_CDC_LAST_CHANGE_TYPE <> 'd' 
 --CHK.ID
--    and chk.id = 12478 and MTLN_CDC_SEQUENCE_NUMBER = 900815384
--      and replace(ITM.VALUE:id,'""','') = 'a661b719-79c6-4a53-8e8c-3c4e7aa95cee'
-- order by  TO_VARCHAR(CHK.ID) ,replace(ITM.VALUE:id,'""',''), TO_CHAR(MOD.index),mod.value    
;"
VIEW,DATAADMIN,MENUGROUP_DIM,"create or replace view MENUGROUP_DIM(
	MENUGROUP_DIM_PK,
	MENUGROUP_DIM_NK,
	MENUGROUP,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	ORGANIZATION_DIM_FK,
	CREATED_AT,
	UPDATED_AT,
	PARENT_ID
) as
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  meg.ID                                                      AS MENUGROUP_DIM_PK
--natural keys------------------------------------------------------------------------------
  ,meg.ID                                                     AS MENUGROUP_DIM_NK
--name---------------------------------------------------------------------------------------
    ,meg.NAME                                                     AS MENUGROUP
--data warehouse rows------------------------------------------------------------------------
  ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(meg.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY meg.ID ORDER BY meg.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,meg.MTLN_CDC_SEQUENCE_NUMBER,meg.MTLN_CDC_SRC_VERSION
      ,meg.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(meg.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY meg.ID ORDER BY meg.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,meg.MTLN_CDC_SEQUENCE_NUMBER,meg.MTLN_CDC_SRC_VERSION,meg.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY meg.ID ORDER BY 
    meg.MTLN_CDC_LAST_COMMIT_TIMESTAMP,meg.MTLN_CDC_SEQUENCE_NUMBER,meg.MTLN_CDC_SRC_VERSION
   ,meg.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN meg.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY meg.ID ORDER BY  
    meg.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,meg.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,meg.MTLN_CDC_SRC_VERSION DESC
   ,meg.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     --REQUIRED 
--CDC Meta data-------------------------------------------------------------------------------
  ,meg.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE
  ,meg.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,meg.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER
  ,meg.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID
  ,meg.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP
  ,meg.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,meg.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION
  ,meg.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME
  ,meg.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH
  ,meg.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE
  ,meg.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA
  ,meg.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE
--foreign keys-------------------------------------------------------------------------------
  ,IFNULL(meg.organization_ID,-1)      AS ORGANIZATION_DIM_FK
--flags---------------------------------------------------------------------------------------
--Dates--------------.------------------------------------------------------------------------
  ,TO_TIMESTAMP_TZ(meg.created_at)     AS CREATED_AT
  ,TO_TIMESTAMP_TZ(meg.updated_at)     AS UPDATED_AT      
--names, options, etc-------------------------------------------------------------------------
  ,MEG.parent_id                       AS PARENT_ID
----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_MENU_GROUP     meg
;"
VIEW,DATAADMIN,ORDERTYPE_DIM,"create or replace view ORDERTYPE_DIM(
	ORDERTYPE_DIM_PK,
	ORDERTYPE_DIM_NK,
	ORDER_TYPE,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	ORGANIZATION_DIM_FK,
	IS_GUEST_REQUIRED,
	IS_DELIVERY_ADDRESS_REQUIRED,
	IS_ORDER_ALERT_REQUIRED,
	CAN_BE_SCHEDULED,
	CREATED_AT,
	UPDATED_AT,
	PREP_TIME_SECONDS
) as
--SELECT * FROM DATALANDING.POSAPI_PUBLIC_ORDER_TYPE;
--============================================================================================
SELECT
--primary keys------------------------------------------------------------------------------
  tab.ID                                                      AS OrderType_DIM_PK  --REQUIRED
--natural keys------------------------------------------------------------------------------
  ,tab.ID                                                     AS OrderType_DIM_NK  --REQUIRED
--name-------------------------------------------------------------------------------------------
  ,tab.NAME                                                   AS ORDER_TYPE
--data warehouse REQUIRED rows-------------------------------------------------------------------
 ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY tab.ID ORDER BY tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION
      ,tab.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP)
    OVER (PARTITION BY tab.ID ORDER BY tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION,tab.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY tab.ID ORDER BY
    tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION
   ,tab.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  ,CASE WHEN tab.MTLN_CDC_LAST_CHANGE_TYPE ='d'
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED
  ,CASE WHEN RANK() OVER(PARTITION BY tab.ID ORDER BY
    tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,tab.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,tab.MTLN_CDC_SRC_VERSION DESC
   ,tab.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     --REQUIRED
--CDC Meta data REQUIRED rows-------------------------------------------------------------------------------
  ,tab.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE                   --REQUIRED
  ,tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP              --REQUIRED
  ,tab.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER                    --REQUIRED
  ,tab.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID                      --REQUIRED
  ,tab.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP                     --REQUIRED
  ,tab.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR                --REQUIRED
  ,tab.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION                        --REQUIRED
  ,tab.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME                           --REQUIRED
  ,tab.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH                           --REQUIRED
  ,tab.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE                       --REQUIRED
  ,tab.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA                         --REQUIRED
  ,tab.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE                          --REQUIRED
--foreign keys-------------------------------------------------------------------------------
  ,tab.ORGANIZATION_ID                 AS ORGANIZATION_DIM_FK
--flags---------------------------------------------------------------------------------------
--ALLCOLUMN NAMES IN THIS SECTION SHOULD begin with is_ or has_ if created by the dw.
--   columns created by the source app should be specifically cast as boolean
--Alphabetize between the lines
  ,tab.IS_GUEST_REQUIRED               AS IS_GUEST_REQUIRED
  ,tab.IS_DELIVERY_ADDRESS_REQUIRED    AS IS_DELIVERY_ADDRESS_REQUIRED
  ,tab.IS_ORDER_ALERT_REQUIRED         AS IS_ORDER_ALERT_REQUIRED
  ,tab.CAN_BE_SCHEDULED                AS CAN_BE_SCHEDULED
--Dates--------------.------------------------------------------------------------------------
--dates should be cast as dates
-- created_at timestamp with time zone  <--this is the create table from postgres
--,to_timestamp_tz(created_at)
--Alphebetize between the lines
  ,to_timestamp_tz(tab.CREATED_AT)     AS CREATED_AT
  ,to_timestamp_tz(tab.UPDATED_AT)     AS UPDATED_AT
--names, options, etc-------------------------------------------------------------------------
--Counts and Amounts--------------------------------------------------------------------------
--ALL COLUMNS IN THIS SECTION SHOULD END IN COUNT OR AMOUNT
--Alphebetize between the lines
  ,TO_NUMBER(PREP_TIME_SECONDS,38,0)   AS PREP_TIME_SECONDS
-- ----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_ORDER_TYPE tab;"
VIEW,DATAADMIN,JOBCATEGORY_DIM,"create or replace view JOBCATEGORY_DIM(
	JOBCATEGORY_DIM_PK,
	JOBCATEGORY_DIM_NK,
	JOBCATEGORY,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	ORGANIZATION_DIM_FK,
	CREATED_AT,
	UPDATED_AT
) as
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  TBL.ID                                                     AS JOBCATEGORY_DIM_PK
--natural keys------------------------------------------------------------------------------
  ,TBL.ID                                                    AS JOBCATEGORY_DIM_NK
--name---------------------------------------------------------------------------------------
  ,TBL.NAME                                                  AS JOBCATEGORY
--data warehouse rows------------------------------------------------------------------------
  ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(TBL.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY TBL.ID ORDER BY TBL.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,TBL.MTLN_CDC_SEQUENCE_NUMBER,TBL.MTLN_CDC_SRC_VERSION
      ,TBL.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(TBL.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY TBL.ID ORDER BY TBL.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,TBL.MTLN_CDC_SEQUENCE_NUMBER,TBL.MTLN_CDC_SRC_VERSION,TBL.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY TBL.ID ORDER BY 
    TBL.MTLN_CDC_LAST_COMMIT_TIMESTAMP,TBL.MTLN_CDC_SEQUENCE_NUMBER,TBL.MTLN_CDC_SRC_VERSION
   ,TBL.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN TBL.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY TBL.ID ORDER BY  
    TBL.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,TBL.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,TBL.MTLN_CDC_SRC_VERSION DESC
   ,TBL.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     --REQUIRED
--CDC Meta data-------------------------------------------------------------------------------
  ,TBL.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE
  ,TBL.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,TBL.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER
  ,TBL.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID
  ,TBL.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP
  ,TBL.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,TBL.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION
  ,TBL.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME
  ,TBL.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH
  ,TBL.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE
  ,TBL.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA
  ,TBL.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE
--foreign keys--------------------------------------------------------------------------------
  ,TBL.ORGANIZATION_ID                 AS ORGANIZATION_DIM_FK
--flags---------------------------------------------------------------------------------------
--none
--Dates--------------.------------------------------------------------------------------------
  ,to_timestamp_tz(TBL.CREATED_AT)     AS CREATED_AT   
  ,to_timestamp_tz(TBL.UPDATED_AT)     AS UPDATED_AT  
--names, options, etc-------------------------------------------------------------------------
--Counts and Amounts--------------------------------------------------------------------------
--none 
----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_JOB_POSITION_CATEGORY     TBL
;"
VIEW,DATAADMIN,LOCATIONGROUP_DIM,"create or replace view LOCATIONGROUP_DIM(
	LOCATIONGROUP_DIM_PK,
	LOCATIONGROUP_DIM_NK,
	LOCATIONGROUP,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	ORGANIZATION_DIM_FK,
	IS_DEFAULT,
	CREATED_AT,
	UPDATED_AT,
	TYPE
) as
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  LCG.ID                                                     AS LOCATIONGROUP_DIM_PK
--natural keys------------------------------------------------------------------------------
  ,LCG.ID                                                    AS LOCATIONGROUP_DIM_NK
--name---------------------------------------------------------------------------------------
  ,LCG.NAME                                                  AS LOCATIONGROUP
--data warehouse rows------------------------------------------------------------------------
   ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LCG.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY LCG.ID ORDER BY LCG.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,LCG.MTLN_CDC_SEQUENCE_NUMBER,LCG.MTLN_CDC_SRC_VERSION
      ,LCG.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(LCG.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY LCG.ID ORDER BY LCG.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,LCG.MTLN_CDC_SEQUENCE_NUMBER,LCG.MTLN_CDC_SRC_VERSION,LCG.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY LCG.ID ORDER BY 
    LCG.MTLN_CDC_LAST_COMMIT_TIMESTAMP,LCG.MTLN_CDC_SEQUENCE_NUMBER,LCG.MTLN_CDC_SRC_VERSION
   ,LCG.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN LCG.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY LCG.ID ORDER BY  
    LCG.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,LCG.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,LCG.MTLN_CDC_SRC_VERSION DESC
   ,LCG.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     --REQUIRED
--CDC Meta data-------------------------------------------------------------------------------
  ,LCG.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE
  ,LCG.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,LCG.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER
  ,LCG.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID
  ,LCG.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP
  ,LCG.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,LCG.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION
  ,LCG.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME
  ,LCG.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH
  ,LCG.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE
  ,LCG.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA
  ,LCG.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE
--foreign keys-------------------------------------------------------------------------------
  ,IFNULL(LCG.ORGANIZATION_ID,-1)      AS ORGANIZATION_DIM_FK   
--flags---------------------------------------------------------------------------------------
  ,LCG.IS_DEFAULT                      AS IS_DEFAULT
--Dates--------------.------------------------------------------------------------------------
  ,TO_TIMESTAMP(LCG.CREATED_AT)        AS CREATED_AT   
  ,TO_TIMESTAMP(LCG.UPDATED_AT)        AS UPDATED_AT
--names, options, etc-------------------------------------------------------------------------
  ,LCG.TYPE                            AS TYPE
--Counts and Amounts--------------------------------------------------------------------------
--NONE
----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_LOCATION_GROUP     LCG
;"
VIEW,DATAADMIN,MENUITEMNAME_DIM,"create or replace view MENUITEMNAME_DIM(
	MENUITEMNAME_DIM_PK,
	MENUITEMNAME_DIM_NK,
	MENUITEMNAME,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	ORGANIZATION_DIM_FK,
	REPORTCATEGORY_DIM_FK,
	ARCHIVED,
	ARCHIVED_AT,
	CREATED_AT,
	UPDATED_AT
) as
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  min.ID                                                      AS MENUITEMNAME_DIM_PK
--natural keys------------------------------------------------------------------------------
  ,min.ID                                                     AS MENUITEMNAME_DIM_NK
--name---------------------------------------------------------------------------------------
   ,min.name                                                  AS MENUITEMNAME
--data warehouse rows------------------------------------------------------------------------
 ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(min.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY min.ID ORDER BY min.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,min.MTLN_CDC_SEQUENCE_NUMBER,min.MTLN_CDC_SRC_VERSION
      ,min.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(min.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY min.ID ORDER BY min.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,min.MTLN_CDC_SEQUENCE_NUMBER,min.MTLN_CDC_SRC_VERSION,min.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY min.ID ORDER BY 
    min.MTLN_CDC_LAST_COMMIT_TIMESTAMP,min.MTLN_CDC_SEQUENCE_NUMBER,min.MTLN_CDC_SRC_VERSION
   ,min.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN min.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY min.ID ORDER BY  
    min.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,min.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,min.MTLN_CDC_SRC_VERSION DESC
   ,min.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     --REQUIRED
--CDC Meta data-------------------------------------------------------------------------------
  ,min.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE
  ,min.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,min.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER
  ,min.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID
  ,min.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP
  ,min.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,min.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION
  ,min.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME
  ,min.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH
  ,min.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE
  ,min.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA
  ,min.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE
--foreign keys-------------------------------------------------------------------------------
  ,IFNULL(min.ORGANIZATION_ID,-1)      AS ORGANIZATION_DIM_FK
  ,IFNULL(min.reporting_category_id,-1)AS REPORTCATEGORY_DIM_FK
--flags---------------------------------------------------------------------------------------
  ,min.ARCHIVED                        AS ARCHIVED
--Dates--------------.------------------------------------------------------------------------
  ,TO_TIMESTAMP_TZ(min.ARCHIVED_AT)   AS ARCHIVED_AT
  ,TO_TIMESTAMP_TZ(min.CREATED_AT)    AS CREATED_AT   
  ,TO_TIMESTAMP_TZ(min.UPDATED_AT)    AS UPDATED_AT
--names, options, etc-------------------------------------------------------------------------
--none
--Counts and Amounts--------------------------------------------------------------------------
--none
----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_MENU_ITEM_NAME     min
;"
VIEW,DATAADMIN,PAYMENTMETHOD_DIM,"create or replace view PAYMENTMETHOD_DIM(
	PAYMENTMETHOD_DIM_PK,
	PAYMENTMETHOD_DIM_NK,
	PAYMENTMETHODNAME,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	ORGANIZATION_DIM_FK,
	ARCHIVED,
	IS_ENABLED,
	IS_TIPPABLE,
	ARCHIVED_AT,
	CREATED_AT,
	UPDATED_AT,
	PAYMENTMETHODTYPE
) as
--select * from DATAADMIN.PAYMENTMETHOD_DIM:
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  pmm.ID                                                      AS PAYMENTMETHOD_DIM_PK
--natural keys------------------------------------------------------------------------------
  ,pmm.ID                                                     AS PAYMENTMETHOD_DIM_NK
--name---------------------------------------------------------------------------------------
  ,pmm.NAME                                                   AS PAYMENTMETHODNAME
--data warehouse rows------------------------------------------------------------------------
,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(pmm.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY pmm.ID ORDER BY pmm.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,pmm.MTLN_CDC_SEQUENCE_NUMBER,pmm.MTLN_CDC_SRC_VERSION
      ,pmm.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(pmm.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY pmm.ID ORDER BY pmm.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,pmm.MTLN_CDC_SEQUENCE_NUMBER,pmm.MTLN_CDC_SRC_VERSION,pmm.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY pmm.ID ORDER BY 
    pmm.MTLN_CDC_LAST_COMMIT_TIMESTAMP,pmm.MTLN_CDC_SEQUENCE_NUMBER,pmm.MTLN_CDC_SRC_VERSION
   ,pmm.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN pmm.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY pmm.ID ORDER BY  
    pmm.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,pmm.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,pmm.MTLN_CDC_SRC_VERSION DESC
   ,pmm.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     --REQUIRED
--CDC Meta data-------------------------------------------------------------------------------
  ,pmm.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE
  ,pmm.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,pmm.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER
  ,pmm.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID
  ,pmm.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP
  ,pmm.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,pmm.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION
  ,pmm.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME
  ,pmm.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH
  ,pmm.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE
  ,pmm.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA
  ,pmm.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE
--foreign keys-------------------------------------------------------------------------------
   ,IFNULL(pmm.ORGANIZATION_ID,-1)     AS ORGANIZATION_DIM_FK
--flags---------------------------------------------------------------------------------------
  ,pmm.archived                        AS ARCHIVED
  ,pmm.is_enabled                      AS IS_ENABLED
  ,pmm.is_tippable                     AS IS_TIPPABLE
--Dates--------------.------------------------------------------------------------------------
  ,TO_TIMESTAMP_TZ(pmm.ARCHIVED_AT)    AS ARCHIVED_AT
  ,TO_TIMESTAMP_TZ(pmm.CREATED_AT)     AS CREATED_AT   
  ,TO_TIMESTAMP_TZ(pmm.UPDATED_AT)     AS UPDATED_AT
--names, options, etc-------------------------------------------------------------------------
   ,pmm.Type                           AS PAYMENTMETHODTYPE
--Counts and Amounts--------------------------------------------------------------------------
  --none
----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_PAYMENT_METHOD     pmm
;"
VIEW,DATAADMIN,POSTERMINAL_DIM,"create or replace view POSTERMINAL_DIM(
	POSTERMINAL_DIM_PK,
	POSTERMINAL_DIM_NK,
	NAME,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	CREATED_AT,
	UPDATED_AT
) as
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  ADD.ID                                                     AS POSTERMINAL_DIM_PK
--natural keys------------------------------------------------------------------------------
  ,ADD.ID                                                    AS POSTERMINAL_DIM_NK
--name---------------------------------------------------------------------------------------
  ,ADD.name                                                  AS NAME
--data warehouse rows------------------------------------------------------------------------
  ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(ADD.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY ADD.ID ORDER BY ADD.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,ADD.MTLN_CDC_SEQUENCE_NUMBER,ADD.MTLN_CDC_SRC_VERSION
      ,ADD.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(ADD.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY ADD.ID ORDER BY ADD.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,ADD.MTLN_CDC_SEQUENCE_NUMBER,ADD.MTLN_CDC_SRC_VERSION,ADD.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY ADD.ID ORDER BY 
    ADD.MTLN_CDC_LAST_COMMIT_TIMESTAMP,ADD.MTLN_CDC_SEQUENCE_NUMBER,ADD.MTLN_CDC_SRC_VERSION
   ,ADD.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN ADD.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY ADD.ID ORDER BY  
    ADD.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,ADD.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,ADD.MTLN_CDC_SRC_VERSION DESC
   ,ADD.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     --REQUIRED
--CDC Meta data-------------------------------------------------------------------------------
  ,ADD.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE
  ,ADD.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,ADD.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER
  ,ADD.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID
  ,ADD.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP
  ,ADD.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,ADD.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION
  ,ADD.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME
  ,ADD.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH
  ,ADD.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE
  ,ADD.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA
  ,ADD.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE
--foreign keys-------------------------------------------------------------------------------
 --none
--flags---------------------------------------------------------------------------------------
--none
--Dates--------------.------------------------------------------------------------------------
  ,to_timestamp_tz(ADD.CREATED_AT)     AS CREATED_AT   
  ,to_timestamp_tz(ADD.UPDATED_AT)     AS UPDATED_AT  
--names, options, etc-------------------------------------------------------------------------
  
--Counts and Amounts--------------------------------------------------------------------------
--none 
----------------------------------------------------------------------------------------------

FROM DATALANDING.POSAPI_PUBLIC_POS_TERMINAL ADD;"
VIEW,DATAADMIN,SHIFT_DIM,"create or replace view SHIFT_DIM(
	SHIFT_DIM_PK,
	SHIFT_DIM_NK,
	SHIFT,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	EMPLOYEE_DIM_FK,
	LOCATION_DIM_FK,
	JOBPOSITION_DIM_FK,
	WAS_SYSTEM_CLOCKOUT,
	IS_ARCHIVED,
	IS_SHIFTCOMPLETE,
	PAY_RATE_BASIS,
	GETS_PAID_BREAK,
	CREATED_AT,
	UPDATED_AT,
	ORIGINAL_CLOCKIN_AT,
	FISCAL_DAY,
	CLOCKEDIN_AT,
	CLOCKEDOUT_AT,
	ARCHIVED_AT,
	SHIFT_START_AT,
	SHIFT_END_AT,
	GENERAL_LEDGER,
	REGULAR_RATE,
	SHIFT_SECONDS,
	SHIFT_MINUTES,
	SHIFT_HOURS,
	SHIFT_DAYS
) as
--============================================================================================
SELECT 
--primary keys--------------------------------------------------------------------------------
  tab.ID                                                      AS SHIFT_DIM_PK  
--natural keys--------------------------------------------------------------------------------
  ,tab.ID                                                     AS SHIFT_DIM_NK  
--name-----------------------------------------------------------------------------------------
  ,tab.ID                                                     AS SHIFT
--data warehouse REQUIRED rows----------------------------------------------------------------
 ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY tab.ID ORDER BY tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION
      ,tab.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY tab.ID ORDER BY tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION,tab.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY tab.ID ORDER BY 
    tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION
   ,tab.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          
  
  ,CASE WHEN tab.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED            
  ,CASE WHEN RANK() OVER(PARTITION BY tab.ID ORDER BY  
    tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,tab.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,tab.MTLN_CDC_SRC_VERSION DESC
   ,tab.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW      
--CDC Meta data REQUIRED rows----------------------------------------------------------------
  ,tab.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE                    
  ,tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP               
  ,tab.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER                     
  ,tab.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID                       
  ,tab.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP                      
  ,tab.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR                 
  ,tab.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION                         
  ,tab.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME                            
  ,tab.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH                            
  ,tab.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE                        
  ,tab.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA                          
  ,tab.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE                          
--foreign keys-------------------------------------------------------------------------------
  ,IFNULL(tab.EMPLOYEE_ID,-1)          AS EMPLOYEE_DIM_FK
  ,IFNULL(tab.LOCATION_ID,-1)          AS LOCATION_DIM_FK 
  ,IFNULL(tab.JOB_POSITION_ID,-1)      AS JOBPOSITION_DIM_FK
--flags---------------------------------------------------------------------------------------
--ALLCOLUMN NAMES IN THIS SECTION SHOULD begin with is_ or has_ if created by the dw.
--   columns created by the source app should be specifically cast as boolean 
  ,tab.WAS_SYSTEM_CLOCKOUT             AS WAS_SYSTEM_CLOCKOUT
  ,tab.ARCHIVED                        AS IS_ARCHIVED
  ,tab.CLOCK_OUT IS NOT NULL           AS IS_SHIFTCOMPLETE
  ,TRIM(tab.PAY_RATE_BASIS)::VARCHAR(50)   
                                       AS PAY_RATE_BASIS
  ,TRUE                                AS GETS_PAID_BREAK          --GET NEW FROM DATA STRUCTURE
--Dates--------------.------------------------------------------------------------------------
--dates should be cast as dates
-- created_at timestamp with time zone  <--this is the create table from postgres
--,to_timestamp_tz(created_at) 
  ,to_timestamp_tz(tab.CREATED_AT)     AS CREATED_AT  
  ,to_timestamp_tz(tab.UPDATED_AT)     AS UPDATED_AT
  ,to_timestamp_tz(tab.ORIG_CLOCK_IN)  AS ORIGINAL_CLOCKIN_AT
  ,to_date(to_timestamp(fiscal_date * 86400))
                                       AS FISCAL_DAY              
  ,to_timestamp_tz(tab.CLOCK_IN)       AS CLOCKEDIN_AT
  ,to_timestamp_tz(tab.CLOCK_OUT)      AS CLOCKEDOUT_AT  
  ,to_timestamp_tz(tab.ARCHIVED_AT)    AS ARCHIVED_AT   
  ,to_timestamp_tz(REPLACE(REPLACE(SPLIT_PART(tab.TIME_RANGE,',',1),'""',''),'[',''))    
                                       AS SHIFT_START_AT
  ,TRY_TO_TIMESTAMP_TZ(REPLACE(REPLACE(SPLIT_PART(tab.TIME_RANGE,',',2),'""',''),')','')) 
    
                                       AS SHIFT_END_AT 

                                   
--names, options, etc-------------------------------------------------------------------------
,tab.GENERAL_LEDGER                   AS GENERAL_LEDGER
--Counts and Amounts--------------------------------------------------------------------------
,tab.pay_rate/1000000                 AS REGULAR_RATE         
,ROUND(TIMEDIFF(second,to_timestamp_tz(tab.CLOCK_IN),to_timestamp_tz(tab.CLOCK_OUT))             ::Number(38,0),0)
                                      AS SHIFT_SECONDS
,ROUND(TIMEDIFF(second,to_timestamp_tz(tab.CLOCK_IN),to_timestamp_tz(tab.CLOCK_OUT)) /60         ::Number(38,0),0)
                                      AS SHIFT_MINUTES
,ROUND(TIMEDIFF(second,to_timestamp_tz(tab.CLOCK_IN),to_timestamp_tz(tab.CLOCK_OUT))  /60/60     ::Number(38,0),0)
                                      AS SHIFT_HOURS
,ROUND(TIMEDIFF(second,to_timestamp_tz(tab.CLOCK_IN),to_timestamp_tz(tab.CLOCK_OUT))  /60/60/60  ::Number(38,0),0)
                                      AS SHIFT_DAYS                                      
-- --------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_EMPLOYEE_SHIFT     tab
  WHERE NOT COALESCE(tab.TRUNCATED,FALSE)
    AND tab.MTLN_CDC_LAST_CHANGE_TYPE <> 'd' 
;"
VIEW,DATAADMIN,SURCHARGE_FACT2,"create or replace view SURCHARGE_FACT2(
	SURCHARGE_FACT_PK,
	SURCHARGE_FACT_NK,
	SURCHARGENAME,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	CHEQUE_FACT_FK,
	DAYPART_DIM_FK,
	EMPLOYEE_DIM_FK,
	LOCATION_DIM_FK,
	SURCHARGE_DIM_NK,
	IS_AUTOAPPLIED,
	IS_GRATUITY,
	IS_TAXABLE,
	IS_TRAINING,
	IS_PRINTONRECEIPT,
	CREATED_AT,
	FISCAL_DATE,
	OPENED_AT,
	UPDATED_AT,
	STATUS,
	CHEQUENUMBER,
	SURCHARGE_TYPE,
	QUANTITY,
	AMOUNT,
	APPLIEDAMOUNT
) as
--============================================================================================
SELECT 
COALESCE(TO_VARCHAR(CHK.ID) || '.' || TO_CHAR(replace(SSS.VALUE:id,'""',''))
  ,TO_VARCHAR(CHK.ID) || '.' || MAX(TO_CHAR(replace(SSS.VALUE:id,'""',''))) OVER (PARTITION BY CHK.ID)
  ,TO_CHAR(CHK.ID)  || '.'||'0')
                                                                         AS SURCHARGE_FACT_PK
-- --natural keys------------------------------------------------------------------------------
  ,COALESCE(TO_VARCHAR(CHK.ID) || '.' || TO_CHAR(replace(SSS.VALUE:id,'""',''))
  ,TO_VARCHAR(CHK.ID) || '.' || MAX(TO_CHAR(replace(SSS.VALUE:id,'""',''))) OVER (PARTITION BY CHK.ID)
  ,TO_CHAR(CHK.ID)  || '.'||'0')  
                                                                         AS SURCHARGE_FACT_NK
-- --name---------------------------------------------------------------------------------------
   ,COALESCE( TO_CHAR(replace(SSS.VALUE:id,'""',''))
  ,MAX(TO_CHAR(replace(SSS.VALUE:id,'""',''))) OVER (PARTITION BY CHK.ID)
  ,'0')                               
                                                                         AS SURCHARGENAME
--data warehouse rows--------------------------------------------------------------------------
 ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY CHK.ID ORDER BY CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION
      ,CHK.MTLN_CDC_FILENAME)),6))
                                                                          AS DW_STARTDATE      
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY CHK.ID
    ,SSS.VALUE:id   ----------------------------
    ORDER BY CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION,CHK.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY CHK.ID ORDER BY 
    CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION
   ,CHK.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                                          AS DW_ENDDATE          
  
  ,CASE WHEN CHK.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                              AS DW_ISDELETED        
  ,CASE WHEN RANK() OVER(PARTITION BY CHK.ID ORDER BY  
    CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,CHK.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,CHK.MTLN_CDC_SRC_VERSION DESC
   ,CHK.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                                          AS DW_ISCURRENTROW 
--CDC Meta data-------------------------------------------------------------------------------
  ,CHK.MTLN_CDC_LAST_CHANGE_TYPE                     AS MTLN_CDC_LAST_CHANGE_TYPE
  ,CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP                AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,CHK.MTLN_CDC_SEQUENCE_NUMBER                      AS MTLN_CDC_SEQUENCE_NUMBER
  ,CHK.MTLN_CDC_LOAD_BATCH_ID                        AS MTLN_CDC_LOAD_BATCH_ID
  ,CHK.MTLN_CDC_LOAD_TIMESTAMP                       AS MTLN_CDC_LOAD_TIMESTAMP
  ,CHK.MTLN_CDC_PROCESSED_DATE_HOUR                  AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,CHK.MTLN_CDC_SRC_VERSION                          AS MTLN_CDC_SRC_VERSION
  ,CHK.MTLN_CDC_FILENAME                             AS MTLN_CDC_FILENAME
  ,CHK.MTLN_CDC_FILEPATH                             AS MTLN_CDC_FILEPATH
  ,CHK.MTLN_CDC_SRC_DATABASE                         AS MTLN_CDC_SRC_DATABASE
  ,CHK.MTLN_CDC_SRC_SCHEMA                           AS MTLN_CDC_SRC_SCHEMA
  ,CHK.MTLN_CDC_SRC_TABLE                            AS MTLN_CDC_SRC_TABLE
--foreign keys-------------------------------------------------------------------------------
  ,IFNULL(CHK.ID,-1)                                 AS CHEQUE_FACT_FK 
  ,IFNULL(CHK.day_part_id,-1)                        AS DAYPART_DIM_FK
  ,IFNULL(CHK.EMPLOYEE_ID,-1)                        AS EMPLOYEE_DIM_FK
  ,IFNULL(CHK.LOCATION_ID,-1)                        AS LOCATION_DIM_FK
  ,IFNULL(TO_VARCHAR(SSS.value:surchargeId),-1)      AS SURCHARGE_DIM_NK
--flags--------------------------------------------------------------------------------------
  ,case upper(SSS.value:isAutoApplied) when 'TRUE' THEN TRUE else FALSE END
                                                     AS IS_AUTOAPPLIED
  ,case upper(SSS.value:isGratuity) when 'TRUE' THEN TRUE else FALSE END
                                                     AS IS_GRATUITY 
  ,case upper(SSS.value:isTaxable) when 'TRUE' THEN TRUE else FALSE END                              
                                                     AS IS_TAXABLE
  ,CHK.IS_TRAINING                                   AS IS_TRAINING 
 ,case upper(SSS.value:printOnReceip) when 'TRUE' THEN TRUE else FALSE END                         
                                                     AS IS_PRINTONRECEIPT   
--Dates--------------.------------------------------------------------------------------------
  ,to_timestamp_tz(CHK.CREATED_AT)                   AS CREATED_AT 
  ,TO_CHAR(TRY_PARSE_JSON(CHK.info):fiscalDate)::DATE   
                                                     AS FISCAL_DATE 
  ,to_timestamp_tz(CHK.OPENED_AT)                    AS OPENED_AT 
  ,to_timestamp_tz(CHK.UPDATED_AT)                   AS UPDATED_AT

--names, options, etc-------------------------------------------------------------------------
   ,IFNULL(TO_VARCHAR(SSS.value:status),'None')      AS STATUS
--name---------------------------------------------------------------------------------------
  ,CHK.NUMBER                                        AS CHEQUENUMBER  
  ,IFNULL(REPLACE(SSS.value:type,'""',''),'None')     AS SURCHARGE_TYPE
--Counts and Amounts--------------------------------------------------------------------------
 ,IFNULL(SSS.value:quantity,0)::NUMBER(38,2)         AS QUANTITY
 ,IFNULL(SSS.value:value,0)::NUMBER(38,2)            AS AMOUNT
 ,IFNULL(SSS.value:appliedValue,0)::NUMBER(38,2)     AS APPLIEDAMOUNT  
----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_CHEQUE                                        CHK
  LEFT JOIN (  --LOJ needed to get the correct current row and start dates.  Necessary for cases where the current check row has no surcharges, but a previous row did have surcharges
    SELECT *
      FROM 
        DATALANDING.POSAPI_PUBLIC_CHEQUE              CHK_1 
            ,LATERAL FLATTEN(INPUT => 
            TRY_PARSE_JSON('{surcharges:' || TRY_PARSE_JSON(chk_1.info):surcharges || '}'), PATH => 'surcharges')
                                                      SUR
            WHERE NOT COALESCE(TRUNCATED,FALSE)                               )SSS
       ON CHK.ID = SSS.ID
         AND CHK.MTLN_CDC_SEQUENCE_NUMBER = SSS.MTLN_CDC_SEQUENCE_NUMBER
         AND CHK.MTLN_CDC_SRC_VERSION = SSS.MTLN_CDC_SRC_VERSION
         AND CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP = SSS.MTLN_CDC_LAST_COMMIT_TIMESTAMP
         -- and chk.id = 3287
;"
VIEW,DATAADMIN,CASHBANK_DIM,"create or replace view CASHBANK_DIM(
	CASHBANK_DIM_PK,
	CASHBANK_DIM_NK,
	CASHBANK,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	SHIFT_DIM_FK,
	CREATED_AT,
	UPDATED_AT,
	STATUS,
	EXPECTED_AMOUNT,
	OPEN_AMOUNT,
	CLOSE_AMOUNT
) as
--============================================================================================
SELECT 
--primary keys--------------------------------------------------------------------------------
  tab.ID                                                      AS CASHBANK_DIM_PK  
--natural keys--------------------------------------------------------------------------------
  ,tab.ID                                                     AS CASHBANK_DIM_NK 
--name-----------------------------------------------------------------------------------------
  ,tab.ID                                                     AS CASHBANK
--data warehouse REQUIRED rows-----------------------------------------------------------------
  ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY tab.ID ORDER BY tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION
      ,tab.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY tab.ID ORDER BY tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION,tab.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY tab.ID ORDER BY 
    tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION
   ,tab.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN tab.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY tab.ID ORDER BY  
    tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,tab.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,tab.MTLN_CDC_SRC_VERSION DESC
   ,tab.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     --REQUIRED
--CDC Meta data REQUIRED rows---------------------------------------------------------------
  ,tab.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE                  
  ,tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP              
  ,tab.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER                    
  ,tab.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID                      
  ,tab.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP                     
  ,tab.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR               
  ,tab.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION                        
  ,tab.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME                          
  ,tab.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH                           
  ,tab.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE                      
  ,tab.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA                        
  ,tab.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE                          
--foreign keys-------------------------------------------------------------------------------
   ,IFNULL(tab.EMPLOYEE_SHIFT_ID,-1)   AS SHIFT_DIM_FK
--flags--------------------------------------------------------------------------------------
--ALLCOLUMN NAMES IN THIS SECTION SHOULD begin with is_ or has_ if created by the dw.
--   columns created by the source app should be specifically cast as boolean 
--Dates--------------.-----------------------------------------------------------------------
--dates should be cast as dates
-- created_at timestamp with time zone  <--this is the create table from postgres
--,to_timestamp_tz(created_at) 
  ,to_timestamp_tz(tab.CREATED_AT)     AS CREATED_AT  
  ,to_timestamp_tz(tab.UPDATED_AT)     AS UPDATED_AT
--names, options, etc-------------------------------------------------------------------------
 ,tab.STATUS                           AS STATUS
--Counts and Amounts--------------------------------------------------------------------------
--ALL COLUMNS IN THIS SECTION SHOULD END IN COUNT OR AMOUNT
  ,TO_NUMBER(tab.EXPECTED_AMOUNT,38,4)/1000000 AS EXPECTED_AMOUNT
  ,TO_NUMBER(tab.OPEN_AMOUNT,38,0)/1000000     AS OPEN_AMOUNT
  ,TO_NUMBER(tab.CLOSE_AMOUNT,38,4)/1000000    AS CLOSE_AMOUNT
  
-- ----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_CASH_BANK     tab
;"
VIEW,DATAADMIN,FEETAX_FACT,"create or replace view FEETAX_FACT(
	FEETAX_FACT_PK,
	FEETAX_FACT_NK,
	FEENAME,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	CHEQUE_FACT_FK,
	DAYPART_DIM_FK,
	EMPLOYEE_DIM_FK,
	LOCATION_DIM_FK,
	TAXRATEDIM_DIM_FK,
	IS_AUTOAPPLIED,
	IS_GRATUITY,
	IS_TAXABLE,
	IS_TAXINCLUDED,
	IS_TRAINING,
	IS_PRINTONRECEIPT,
	CREATED_AT,
	FISCAL_DATE,
	OPENED_AT,
	UPDATED_AT,
	STATUS,
	CHEQUENUMBER,
	SURCHARGE_TYPE,
	TAXRATENAME,
	PERCENT,
	APPLIEDAMOUNT,
	TAX,
	TAXBASIS
) as

--============================================================================================
SELECT  TO_VARCHAR(CHK.ID) || '.' || sss.SURCHARGEVALUE:id || '.' || TO_CHAR(sss.TAXKEY)
                                                                         AS FEETAX_FACT_PK                                                                
-- -- --natural keys------------------------------------------------------------------------------
  ,TO_VARCHAR(CHK.ID) || '.' || sss.SURCHARGEVALUE:id || '.'
   || TO_CHAR(sss.TAXKEY)
                                                                         AS FEETAX_FACT_NK
-- -- --name---------------------------------------------------------------------------------------
  ,COALESCE( TO_CHAR(replace(SSS.SURCHARGEVALUE:id,'""',''))
  ,MAX(TO_CHAR(replace(SSS.SURCHARGEVALUE:id,'""',''))) OVER (PARTITION BY CHK.ID)
  ,'0')                               
                                                                         AS FEENAME
-- --data warehouse rows--------------------------------------------------------------------------
 ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(row_number() OVER (
      PARTITION BY TO_VARCHAR(CHK.ID) || '.' || sss.SURCHARGEVALUE:id || '.' || TO_CHAR(sss.TAXKEY) 
      ORDER BY CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION
      ,CHK.MTLN_CDC_FILENAME)),6))
                                                                          AS DW_STARTDATE      
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY TO_VARCHAR(CHK.ID) || '.' || sss.SURCHARGEVALUE:id || '.' || TO_CHAR(sss.TAXKEY)
    ORDER BY CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION,CHK.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(row_number() OVER (PARTITION BY CHK.ID ORDER BY 
    CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION
   ,CHK.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                                          AS DW_ENDDATE          
  
  ,CASE WHEN CHK.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                              AS DW_ISDELETED        
  ,CASE WHEN row_number() OVER(PARTITION BY TO_VARCHAR(CHK.ID) || '.' || sss.SURCHARGEVALUE:id || '.' || TO_CHAR(sss.TAXKEY) 
    ORDER BY  
    CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,CHK.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,CHK.MTLN_CDC_SRC_VERSION DESC
   ,CHK.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                                          AS DW_ISCURRENTROW 
-- --CDC Meta data-------------------------------------------------------------------------------
  ,CHK.MTLN_CDC_LAST_CHANGE_TYPE                     AS MTLN_CDC_LAST_CHANGE_TYPE
  ,CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP                AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,CHK.MTLN_CDC_SEQUENCE_NUMBER                      AS MTLN_CDC_SEQUENCE_NUMBER
  ,CHK.MTLN_CDC_LOAD_BATCH_ID                        AS MTLN_CDC_LOAD_BATCH_ID
  ,CHK.MTLN_CDC_LOAD_TIMESTAMP                       AS MTLN_CDC_LOAD_TIMESTAMP
  ,CHK.MTLN_CDC_PROCESSED_DATE_HOUR                  AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,CHK.MTLN_CDC_SRC_VERSION                          AS MTLN_CDC_SRC_VERSION
  ,CHK.MTLN_CDC_FILENAME                             AS MTLN_CDC_FILENAME
  ,CHK.MTLN_CDC_FILEPATH                             AS MTLN_CDC_FILEPATH
  ,CHK.MTLN_CDC_SRC_DATABASE                         AS MTLN_CDC_SRC_DATABASE
  ,CHK.MTLN_CDC_SRC_SCHEMA                           AS MTLN_CDC_SRC_SCHEMA
  ,CHK.MTLN_CDC_SRC_TABLE                            AS MTLN_CDC_SRC_TABLE
-- --foreign keys-------------------------------------------------------------------------------
  ,IFNULL(CHK.ID,-1)                                 AS CHEQUE_FACT_FK 
  ,IFNULL(CHK.day_part_id,-1)                        AS DAYPART_DIM_FK
  ,IFNULL(CHK.EMPLOYEE_ID,-1)                        AS EMPLOYEE_DIM_FK
  ,IFNULL(CHK.LOCATION_ID,-1)                        AS LOCATION_DIM_FK
  ,IFNULL(TO_CHAR(SSS.TAXVALUE:taxRateId),-1)        AS TAXRATEDIM_DIM_FK  
-- --flags--------------------------------------------------------------------------------------
  ,case upper(SSS.SURCHARGEVALUE:isAutoApplied) when 'TRUE' THEN TRUE else FALSE END
                                                     AS IS_AUTOAPPLIED
   ,case upper(SSS.SURCHARGEVALUE:isGratuity) when 'TRUE' THEN TRUE else FALSE END
                                                      AS IS_GRATUITY 
   ,case upper(SSS.SURCHARGEVALUE:isTaxable) when 'TRUE' THEN TRUE else FALSE END                              
                                                      AS IS_TAXABLE
   ,case upper(SSS.TAXVALUE:isTaxIncluded) when 'TRUE' THEN TRUE else FALSE END                              
                                                      AS IS_TAXINCLUDED                                                     
   ,CHK.IS_TRAINING                                   AS IS_TRAINING 
  ,case upper(SSS.SURCHARGEVALUE:printOnReceip) when 'TRUE' THEN TRUE else FALSE END                         
                                                     AS IS_PRINTONRECEIPT   
-- --Dates--------------.------------------------------------------------------------------------
  ,to_timestamp_tz(CHK.CREATED_AT)                   AS CREATED_AT 
  ,TO_CHAR(max(TRY_PARSE_JSON(CHK.info):fiscalDate) over (partition by chk.id))::DATE      
                                                     AS FISCAL_DATE 
  ,to_timestamp_tz(CHK.OPENED_AT)                    AS OPENED_AT 
  ,to_timestamp_tz(CHK.UPDATED_AT)                   AS UPDATED_AT

-- --names, options, etc-------------------------------------------------------------------------
   ,IFNULL(TO_VARCHAR(SSS.SURCHARGEVALUE:status),'None')      AS STATUS
-- --name---------------------------------------------------------------------------------------
  ,CHK.NUMBER                                                 AS CHEQUENUMBER      
  ,IFNULL(REPLACE(SSS.SURCHARGEVALUE:type,'""',''),'None')     AS SURCHARGE_TYPE
-- --Counts and Amounts--------------------------------------------------------------------------
  ,IFNULL(SSS.TAXVALUE:taxRateName,'None')                    AS TAXRATENAME  
  ,IFNULL(SSS.TAXVALUE:percent,0)::NUMBER(38,2)               AS PERCENT
  ,IFNULL(SSS.TAXVALUE:appliedValue,0)::NUMBER(38,2)          AS APPLIEDAMOUNT 
  ,IFNULL(SSS.TAXVALUE:tax,0)::NUMBER(38,2)                   AS TAX
  ,IFNULL(SSS.TAXVALUE:basis,0)::NUMBER(38,2)                 AS TAXBASIS 
----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_CHEQUE                                        CHK
  LEFT JOIN (  --LOJ needed to get the correct current row and start dates.  Necessary for cases where the current check row has no surcharges, but a previous row did have surcharges
    SELECT CHK_1.ID AS ID
      ,CHK_1.MTLN_CDC_SEQUENCE_NUMBER
      ,CHK_1.MTLN_CDC_SRC_VERSION
      ,CHK_1.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      -- ,TRY_PARSE_JSON(TAX.VALUE)
      ,TAX.VALUE AS TAXVALUE
      ,TAX.INDEX AS TAXKEY
      ,SUR.VALUE AS SURCHARGEVALUE
      FROM 
        DATALANDING.POSAPI_PUBLIC_CHEQUE              CHK_1 
            ,LATERAL FLATTEN(INPUT => 
            TRY_PARSE_JSON('{surcharges:' || TRY_PARSE_JSON(chk_1.info):surcharges || '}'), PATH => 'surcharges')
                                                      SUR
           ,LATERAL FLATTEN(INPUT => 
            TRY_PARSE_JSON('{taxes:' || TRY_PARSE_JSON(sur.value):taxes || '}'), PATH => 'taxes')
                                                      TAX                                                                      
            WHERE NOT COALESCE(CHK_1.TRUNCATED,FALSE)   
              AND TAX.VALUE IS NOT NULL

                                                      )SSS
       ON CHK.ID = SSS.ID
         AND SSS.TAXVALUE IS NOT NULL
         AND CHK.MTLN_CDC_SEQUENCE_NUMBER = SSS.MTLN_CDC_SEQUENCE_NUMBER
         AND CHK.MTLN_CDC_SRC_VERSION = SSS.MTLN_CDC_SRC_VERSION
         AND CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP = SSS.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    WHERE SSS.TAXVALUE IS NOT NULL
      AND CHK.MTLN_CDC_LAST_CHANGE_TYPE <> 'd' 
      AND NOT COALESCE(TRUNCATED,FALSE)
      and FEETAX_FACT_NK in ('227408.c93993a0-88f8-4760-9d0c-409c1bda3339.1'
,'227408.c93993a0-88f8-4760-9d0c-409c1bda3339.0')
order by  chk.mtln_cdc_sequence_number
         -- and chk.mtln_cdc_sequence_number = 31912528448
-- ORDER BY    COALESCE(TO_VARCHAR(CHK.ID) || '.' || TO_CHAR(replace(SSS.VALUE:id,'""',''))
--   ,TO_VARCHAR(CHK.ID) || '.' || MAX(TO_CHAR(replace(SSS.VALUE:id,'""',''))) OVER (PARTITION BY CHK.ID)
--   ,TO_CHAR(CHK.ID)  || '.'||'0')        
;"
VIEW,DATAADMIN,GIFTCARDACTIVITY_FACT,"create or replace view GIFTCARDACTIVITY_FACT(
	GIFTCARDACTIVITY_FACT_PK,
	GIFTCARDACTIVITY_FACT_NK,
	GIFTCARD,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	ACCOUNT_DIM_FK,
	CHEQUE_FACT_FK,
	DAYPART_DIM_FK,
	EMPLOYEE_DIM_FK_AS_CREATOR,
	LOCATION_DIM_FK,
	MERCHANT_DIM_FK,
	ORDERTYPE_DIM_FK,
	REVENUECENTER_DIM_FK,
	STATUSREASON_DIM_FK,
	IS_RELOAD,
	IS_TRAINING,
	CREATED_AT,
	UPDATED_AT,
	OPENED_AT,
	FISCALDATE,
	AUTHGUIDID,
	CHEQUENUMBER,
	CURRENCY_ID,
	FLOORPLAN_ID,
	REVENUECENTERNAME,
	STATUS,
	STATUSREASON,
	TABLENAME,
	PARTYSIZE,
	AMOUNT
) as
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------ 
   CHK.ID || '.' || REPLACE(GCD.value:id,'""','')                    AS GIFTCARDACTIVITY_FACT_PK
--natural keys------------------------------------------------------------------------------
  ,CHK.ID || '.' || REPLACE(GCD.value:id,'""','')                    AS GIFTCARDACTIVITY_FACT_NK
--name---------------------------------------------------------------------------------------
  , REPLACE(GCD.value:id,'""','')                                    AS GIFTCARD
--data warehouse rows------------------------------------------------------------------------
 ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY 
        CHK.ID || '.'  || REPLACE(GCD.value:id,'""','') 
        ORDER BY CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION
      ,CHK.MTLN_CDC_FILENAME)),6))
                                                                      AS DW_STARTDATE        
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY 
    CHK.ID || '.'  || REPLACE(GCD.value:id,'""','') 
    ORDER BY CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION,CHK.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY CHK.ID || '.'  || REPLACE(GCD.value:id,'""','') ORDER BY 
    CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION
   ,CHK.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                                       AS DW_ENDDATE         
  
  ,CASE WHEN CHK.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                           AS DW_ISDELETED          
  ,CASE WHEN RANK() OVER(PARTITION BY  CHK.ID || '.'  || REPLACE(GCD.value:id,'""','') 
    ORDER BY  
    CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,CHK.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,CHK.MTLN_CDC_SRC_VERSION DESC
   ,CHK.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                                        AS DW_ISCURRENTROW    
--CDC Meta data-------------------------------------------------------------------------------
  ,CHK.MTLN_CDC_LAST_CHANGE_TYPE                                        AS MTLN_CDC_LAST_CHANGE_TYPE
  ,CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP                                   AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,CHK.MTLN_CDC_SEQUENCE_NUMBER                                         AS MTLN_CDC_SEQUENCE_NUMBER
  ,CHK.MTLN_CDC_LOAD_BATCH_ID                                           AS MTLN_CDC_LOAD_BATCH_ID
  ,CHK.MTLN_CDC_LOAD_TIMESTAMP                                          AS MTLN_CDC_LOAD_TIMESTAMP
  ,CHK.MTLN_CDC_PROCESSED_DATE_HOUR                                     AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,CHK.MTLN_CDC_SRC_VERSION                                             AS MTLN_CDC_SRC_VERSION
  ,CHK.MTLN_CDC_FILENAME                                                AS MTLN_CDC_FILENAME
  ,CHK.MTLN_CDC_FILEPATH                                                AS MTLN_CDC_FILEPATH
  ,CHK.MTLN_CDC_SRC_DATABASE                                            AS MTLN_CDC_SRC_DATABASE
  ,CHK.MTLN_CDC_SRC_SCHEMA                                              AS MTLN_CDC_SRC_SCHEMA
  ,CHK.MTLN_CDC_SRC_TABLE                                               AS MTLN_CDC_SRC_TABLE
--foreign keys-------------------------------------------------------------------------------
  ,IFNULL(REPLACE(GCD.value:account,'""',''),'-1')                       AS ACCOUNT_DIM_FK
  ,IFNULL(CHK.ID,-1)                                                    AS CHEQUE_FACT_FK
  ,IFNULL(CHK.DAY_PART_ID,-1)                                           AS DAYPART_DIM_FK
  ,IFNULL(CHK.EMPLOYEE_ID,-1)                                           AS EMPLOYEE_DIM_FK_AS_CREATOR
  ,IFNULL(CHK.LOCATION_ID,-1)                                           AS LOCATION_DIM_FK
  ,IFNULL(REPLACE(GCD.value:merchantId,'""',''),'-1')                    AS MERCHANT_DIM_FK  
  ,IFNULL(CHK.order_type_id,-1)                                         AS ORDERTYPE_DIM_FK    
  ,IFNULL(TO_NUMBER(replace(TRY_PARSE_JSON(
      CHK.info):revenueCenterId,'""','')),-1)                            AS REVENUECENTER_DIM_FK    
  ,IFNULL(REPLACE(GCD.value:statusReasonId,'""',''),-1)                  AS STATUSREASON_DIM_FK                                                      
--flags---------------------------------------------------------------------------------------
  ,REPLACE(GCD.value:isReload,'""','')                                   AS IS_RELOAD
  ,CHK.IS_TRAINING                                                      AS IS_TRAINING
--Dates--------------.------------------------------------------------------------------------
  ,to_timestamp_tz(CHK.CREATED_AT)                                      AS CREATED_AT   
  ,to_timestamp_tz(CHK.UPDATED_AT)                                      AS UPDATED_AT
 -- ,to_timestamp_tz(replace(value:ccData:expirationDate,'""',''))       AS EXPIRATIONDATE   
  ,to_timestamp_tz(CHK.opened_at)                                       AS OPENED_AT
  ,TO_CHAR(TRY_PARSE_JSON(CHK.info):fiscalDate)::DATE                   AS FISCALDATE
--names, options, etc-------------------------------------------------------------------------
  ,REPLACE(GCD.value:authGuid,'""','')                                   AS AUTHGUIDID
  ,CHK.NUMBER                                                           AS CHEQUENUMBER
  ,REPLACE(TRY_PARSE_JSON(info):currencyId,'""','')                      AS CURRENCY_ID  
  ,TO_NUMBER(REPLACE(TRY_PARSE_JSON(info):floorplanId,'""',''))          AS FLOORPLAN_ID
  ,REPLACE(TRY_PARSE_JSON(info):revenueCenterName,'""','')               AS REVENUECENTERNAME
  ,REPLACE(GCD.value:status,'""','')                                     AS STATUS
  ,REPLACE(GCD.value:statusReason,'""','')                               AS STATUSREASON 
  ,REPLACE(TRY_PARSE_JSON(info):tableName,'""','')                       AS TABLENAME
--Counts and Amounts--------------------------------------------------------------------------
   ,REPLACE(TRY_PARSE_JSON(info):partySize,'""','')::NUMBER(38)          AS PARTYSIZE
   ,GCD.value:amount::NUMBER(38,4)                                      AS AMOUNT
----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_CHEQUE                                   CHK 
    ,LATERAL FLATTEN(INPUT => 
    PARSE_JSON( '{GIFTCARDS:' || CHK.GIFT_CARDS || '}' ),  
        path => 'GIFTCARDS')                                            GCD
  WHERE CHK.GIFT_CARDS <> '__value_not_modified__'  
    AND NOT COALESCE(TRUNCATED,FALSE)
    AND CHK.MTLN_CDC_LAST_CHANGE_TYPE <> 'd' 
;"
VIEW,DATAADMIN,MODIFIEROPTIONS_DIM,"create or replace view MODIFIEROPTIONS_DIM(
	MODIFIEROPTIONS_DIM_PK,
	MODIFIEROPTIONS_DIM_NK,
	MODIFIEROPTION,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	MODIFIER_DIM_FK,
	MODIFIER_COMMAND_DIM_FK,
	CREATED_AT,
	UPDATED_AT,
	PRICE
) as
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  vao.ID                                                     AS MODIFIEROPTIONS_DIM_PK
--natural keys------------------------------------------------------------------------------
  ,vao.ID                                                    AS MODIFIEROPTIONS_DIM_NK
--name---------------------------------------------------------------------------------------
  ,vao.ID                                                    AS MODIFIEROPTION
--data warehouse rows------------------------------------------------------------------------
  ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(vao.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY vao.ID ORDER BY vao.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,vao.MTLN_CDC_SEQUENCE_NUMBER,vao.MTLN_CDC_SRC_VERSION
      ,vao.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(vao.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY vao.ID ORDER BY vao.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,vao.MTLN_CDC_SEQUENCE_NUMBER,vao.MTLN_CDC_SRC_VERSION,vao.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY vao.ID ORDER BY 
    vao.MTLN_CDC_LAST_COMMIT_TIMESTAMP,vao.MTLN_CDC_SEQUENCE_NUMBER,vao.MTLN_CDC_SRC_VERSION
   ,vao.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN vao.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY vao.ID ORDER BY  
    vao.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,vao.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,vao.MTLN_CDC_SRC_VERSION DESC
   ,vao.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     --REQUIRED
--CDC Meta data-------------------------------------------------------------------------------
  ,vao.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE
  ,vao.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,vao.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER
  ,vao.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID
  ,vao.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP
  ,vao.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,vao.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION
  ,vao.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME
  ,vao.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH
  ,vao.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE
  ,vao.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA
  ,vao.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE
--foreign keys-------------------------------------------------------------------------------
  ,IFNULL(vao.MODIFIER_ID,-1)          AS MODIFIER_DIM_FK
  ,IFNULL(vao.MODIFIER_CMD_ID,-1)      AS MODIFIER_COMMAND_DIM_FK
--flags---------------------------------------------------------------------------------------
  --none--
--Dates--------------.------------------------------------------------------------------------
  ,to_timestamp_tz(vao.CREATED_AT)     AS CREATED_AT  
  ,to_timestamp_tz(vao.UPDATED_AT)     AS UPDATED_AT  
--names, options, etc-------------------------------------------------------------------------
--Counts and Amounts--------------------------------------------------------------------------
  ,vao.PRICE/1000000                    AS PRICE
----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_MODIFIER_OPTIONS     vao
;"
VIEW,DATAADMIN,TAXRATE_DIM,"create or replace view TAXRATE_DIM(
	TAXRATE_DIM_PK,
	TAXRATE_DIM_NK,
	TAXRATE,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	ORGANIZATION_DIM_FK,
	IS_TAX_INCLUDED,
	CREATED_AT,
	UPDATED_AT,
	PERCENT
) as
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  tab.ID                                                      AS TAXRATE_DIM_PK  
--natural keys------------------------------------------------------------------------------
  ,tab.ID                                                     AS TAXRATE_DIM_NK  
--name-------------------------------------------------------------------------------------------
  ,tab.NAME                                                   AS TAXRATE
--data warehouse REQUIRED rows-------------------------------------------------------------------
  ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY tab.ID ORDER BY tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION
      ,tab.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE    
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY tab.ID ORDER BY tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION,tab.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY tab.ID ORDER BY 
    tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION
   ,tab.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE 
  
  ,CASE WHEN tab.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED          
  ,CASE WHEN RANK() OVER(PARTITION BY tab.ID ORDER BY  
    tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,tab.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,tab.MTLN_CDC_SRC_VERSION DESC
   ,tab.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW       
--CDC Meta data REQUIRED rows-------------------------------------------------------------------------------
  ,tab.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE                   
  ,tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP             
  ,tab.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER                   
  ,tab.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID                     
  ,tab.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP                     
  ,tab.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR                
  ,tab.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION                        
  ,tab.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME                          
  ,tab.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH                           
  ,tab.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE                      
  ,tab.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA                        
  ,tab.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE                          
--foreign keys-------------------------------------------------------------------------------
 ,IFNULL(tab.ORGANIZATION_ID,-1)       AS ORGANIZATION_DIM_FK 
--flags---------------------------------------------------------------------------------------
--ALLCOLUMN NAMES IN THIS SECTION SHOULD begin with is_ or has_ if created by the dw.
--   columns created by the source app should be specifically cast as boolean 
  ,tab.IS_TAX_INCLUDED                  AS IS_TAX_INCLUDED
--Dates--------------.------------------------------------------------------------------------
--dates should be cast as dates
-- created_at timestamp with time zone  <--this is the create table from postgres
--,to_timestamp_tz(created_at) 
  ,to_timestamp_tz(tab.CREATED_AT)     AS CREATED_AT  
  ,to_timestamp_tz(tab.UPDATED_AT)     AS UPDATED_AT
--names, options, etc-------------------------------------------------------------------------
  ,tab.PERCENT/1000000                 AS PERCENT
-- ----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_TAX_RATE     tab
;"
VIEW,DATAADMIN,TAXASSOCIATION_MENUITEM_XREF,"create or replace view TAXASSOCIATION_MENUITEM_XREF(
	TAXASSOCIATION_MENUITEM_XREF_PK,
	TAXASSOCIATION_MENUITEM_XREF_NK,
	TAXASSOCIATION_MENUITEM,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	TAXASSOCIATION_DIM_FK,
	MENUITEM_DIM_FK
) as
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  tab.ID                                                      AS TAXASSOCIATION_MENUITEM_XREF_PK
--natural keys------------------------------------------------------------------------------
  ,tab.ID                                                     AS TAXASSOCIATION_MENUITEM_XREF_NK
--name---------------------------------------------------------------------------------------
  ,tab.TAX_ASSOCIATION_ID || '|' || tab.MENU_ITEM_ID          AS TAXASSOCIATION_MENUITEM
--data warehouse rows------------------------------------------------------------------------
 ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY tab.ID ORDER BY tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION
      ,tab.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY tab.ID ORDER BY tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION,tab.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY tab.ID ORDER BY 
    tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION
   ,tab.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN tab.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY tab.ID ORDER BY  
    tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,tab.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,tab.MTLN_CDC_SRC_VERSION DESC
   ,tab.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     --REQUIRED
--CDC Meta data-------------------------------------------------------------------------------
  ,tab.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE
  ,tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,tab.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER
  ,tab.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID
  ,tab.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP
  ,tab.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,tab.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION
  ,tab.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME
  ,tab.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH
  ,tab.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE
  ,tab.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA
  ,tab.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE
--foreign keys-------------------------------------------------------------------------------
  ,IFNULL(tab.TAX_ASSOCIATION_ID,-1)   AS TAXASSOCIATION_DIM_FK
  ,IFNULL(tab.MENU_ITEM_ID,-1)         AS MENUITEM_DIM_FK
--flags---------------------------------------------------------------------------------------
--NONE
--Dates--------------.------------------------------------------------------------------------
--NONE  CREATE DATE AND UPDATE DATE EXCEPTED SINCE THIS IS AN XREF
--names, options, etc-------------------------------------------------------------------------
--NONE                           
--Counts and Amounts--------------------------------------------------------------------------
--NONE
----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_TAX_ASSOCIATION_MENU_ITEMS     tab
;"
VIEW,DATAADMIN,VOIDCHECKBYITEM_FACT,"create or replace view VOIDCHECKBYITEM_FACT(
	VOIDCHECKBYITEM_FACT_PK,
	VOIDCHECKBYITEM_FACT_NK,
	CHEQUENUMBER,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	CHEQUE_FACT_FK,
	DAYPART_DIM_FK,
	EMPLOYEE_DIM_FK,
	ITEM_FACT_FK,
	LOCATION_DIM_FK,
	MENUITEM_DIM_FK,
	MENUITEMNAME_DIM_FK,
	ORDERTYPE_DIM_FK,
	ORGANIZATION_DIM_FK,
	REVENUECENTER_DIM_FK,
	SHIFT_DIM_FK,
	TAXSETTINGS_DIM_FK,
	VARIANT_DIM_FK,
	VOIDREASON_DIM_FK,
	HAS_DISCOUNT,
	IS_TRAINING,
	IS_VOID,
	HAS_TRACKTAXESONCOMP,
	FISCAL_DATE_INT,
	FISCAL_DATE,
	OPENED_AT,
	BEGIN_PREP_AT,
	CLOSED_AT,
	SCHEDULED_AT,
	CREATED_AT,
	UPDATED_AT,
	UUID,
	AUDIT,
	ROUNDINGMETHOD,
	COMBINEDRECEIPTNAME,
	RECEIPTOPTION,
	TAXTRACKING,
	REVENUECENTERNAME,
	REVENUECENTERID,
	STATUS_REASON_ID,
	CHECK_ID,
	TABLE_NAME,
	STATUS,
	ITEM_ID,
	ITEMSTATUS,
	CHECKGROSS,
	CHECKTOTAL,
	PRICE,
	BASEPRICE,
	QUANTITY,
	GROSS,
	VOID_LEVEL,
	TOTAL_NON_VOIDED_QUANTITY_ON_CHECK,
	NON_VOIDED_ITEM_ROW_NUMBER,
	ALLOCATED_ITEM_VOID
) as

--=================================================================================================================
SELECT
     ITM.ITEM_FACT_PK                                                                 as VOIDCHECKBYITEM_FACT_PK
    ,ITM.ITEM_FACT_NK                                                                 as VOIDCHECKBYITEM_FACT_NK
    --name--------------------------------------------------------------------------------------------------------
    ,CHK.CHEQUENUMBER                                                                 as CHEQUENUMBER
    --data warehouse rows-----------------------------------------------------------------------------------------            
	,CHK.DW_STARTDATE                                                                 as DW_STARTDATE
	,CHK.DW_ENDDATE                                                                   as DW_ENDDATE
	,CHK.DW_ISDELETED                                                                 as DW_ISDELETED
	,CHK.DW_ISCURRENTROW                                                              as DW_ISCURRENTROW
    --CDC Meta data-----------------------------------------------------------------------------------------------
	,CHK.MTLN_CDC_LAST_CHANGE_TYPE                                                    as MTLN_CDC_LAST_CHANGE_TYPE
	,CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP                                               as MTLN_CDC_LAST_COMMIT_TIMESTAMP
	,CHK.MTLN_CDC_SEQUENCE_NUMBER                                                     as MTLN_CDC_SEQUENCE_NUMBER
	,CHK.MTLN_CDC_LOAD_BATCH_ID                                                       as MTLN_CDC_LOAD_BATCH_ID
	,CHK.MTLN_CDC_LOAD_TIMESTAMP                                                      as MTLN_CDC_LOAD_TIMESTAMP
	,CHK.MTLN_CDC_PROCESSED_DATE_HOUR                                                 as MTLN_CDC_PROCESSED_DATE_HOUR
	,CHK.MTLN_CDC_SRC_VERSION                                                         as MTLN_CDC_SRC_VERSION
	,CHK.MTLN_CDC_FILENAME                                                            as MTLN_CDC_FILENAME
	,CHK.MTLN_CDC_FILEPATH                                                            as MTLN_CDC_FILEPATH
	,CHK.MTLN_CDC_SRC_DATABASE                                                        as MTLN_CDC_SRC_DATABASE
	,CHK.MTLN_CDC_SRC_SCHEMA                                                          as MTLN_CDC_SRC_SCHEMA
	,CHK.MTLN_CDC_SRC_TABLE                                                           as MTLN_CDC_SRC_TABLE
    --foreign keys------------------------------------------------------------------------------------------------
    ,ITM.CHEQUE_FACT_FK                                                               as CHEQUE_FACT_FK
    ,CHK.DAYPART_DIM_FK                                                               as DAYPART_DIM_FK
	,CHK.EMPLOYEE_DIM_FK                                                              as EMPLOYEE_DIM_FK
    ,ITM.ITEM_FACT_NK                                                                 as ITEM_FACT_FK    
	,CHK.LOCATION_DIM_FK                                                              as LOCATION_DIM_FK
	,ITM.MENUITEM_DIM_FK                                                              as MENUITEM_DIM_FK
	,ITM.MENUITEMNAME_DIM_FK                                                          as MENUITEMNAME_DIM_FK    
	,CHK.ORDERTYPE_DIM_FK                                                             as ORDERTYPE_DIM_FK
	,CHK.ORGANIZATION_DIM_FK                                                          as ORGANIZATION_DIM_FK
	,CHK.REVENUECENTER_DIM_FK                                                         as REVENUECENTER_DIM_FK   
	,CHK.SHIFT_DIM_FK                                                                 as SHIFT_DIM_FK
	,CHK.TAXSETTINGS_DIM_FK                                                           as TAXSETTINGS_DIM_FK
	,ITM.VARIANT_DIM_FK                                                               as VARIANT_DIM_FK
	,CHK.VOIDREASON_DIM_FK                                                            as VOIDREASON_DIM_FK    
    --flags------------------------------------------------------------------------------------------------------
    ,CHK.HAS_DISCOUNT                                                                 as HAS_DISCOUNT
	,CHK.IS_TRAINING                                                                  as IS_TRAINING
	,CHK.IS_VOID                                                                      as IS_VOID
	,CHK.HAS_TRACKTAXESONCOMP                                                         as HAS_TRACKTAXESONCOMP
    --Dates--------------.---------------------------------------------------------------------------------------
	,CHK.FISCAL_DATE_INT                                                              as FISCAL_DATE_INT
	,CHK.FISCAL_DATE                                                                  as FISCAL_DATE
	,CHK.OPENED_AT                                                                    as OPENED_AT
	,CHK.BEGIN_PREP_AT                                                                as BEGIN_PREP_AT
	,CHK.CLOSED_AT                                                                    as CLOSED_AT
	,CHK.SCHEDULED_AT                                                                 as SCHEDULED_AT
	,CHK.CREATED_AT                                                                   as CREATED_AT
	,CHK.UPDATED_AT                                                                   as UPDATED_AT
    --names, options, etc---------------------------------------------------------------------------------------
	,CHK.UUID                                                                         as UUID
	,CHK.AUDIT                                                                        as AUDIT
	,CHK.ROUNDINGMETHOD                                                               as ROUNDINGMETHOD
	,CHK.COMBINEDRECEIPTNAME                                                          as COMBINEDRECEIPTNAME
	,CHK.RECEIPTOPTION                                                                as RECEIPTOPTION
	,CHK.TAXTRACKING                                                                  as TAXTRACKING
	,CHK.REVENUECENTERNAME                                                            as REVENUECENTERNAME
	,CHK.REVENUECENTERID                                                              as REVENUECENTERID
	,CHK.STATUS_REASON_ID                                                             as STATUS_REASON_ID
	,CHK.CHECK_ID                                                                     as CHECK_ID
	,CHK.TABLE_NAME                                                                   as TABLE_NAME
    ,CHK.STATUS                                                                       as STATUS
    ,ITM.ITEM_ID                                                                      as ITEM_ID
    ,ITM.ITEMSTATUS                                                                   as ITEMSTATUS
    --Counts and Amounts-------------------------------------------------------------------------------------
    --columns I used when developing the view
    ,CHK.GROSS                                                                        as CHECKGROSS
    ,CHK.TOTAL                                                                        as CHECKTOTAL
    ,ITM.PRICE                                                                        as PRICE
    ,ITM.BASEPRICE                                                                    as BASEPRICE
    ,ITM.QUANTITY                                                                     as QUANTITY
    ,ITM.GROSS                                                                        as GROSS
    ,CASE
        WHEN ITM.ITEMSTATUS = 'Voided' THEN 'item'
        WHEN CHK.STATUS = 'Voided' THEN 'cheque'
        ELSE 'ERROR'
    END                                                                              as VOID_LEVEL
    -- Calculate the total quantity of non-voided items on the cheque for distribution
    ,SUM(CASE WHEN ITM.ITEMSTATUS <> 'Voided' THEN ITM.QUANTITY ELSE 0 END) OVER (
        PARTITION BY CHK.CHEQUE_FACT_NK, CHK.MTLN_CDC_SEQUENCE_NUMBER
    )                                                                                as TOTAL_NON_VOIDED_QUANTITY_ON_CHECK
    -- Assign a row number to non-voided items to handle rounding remainders
    ,ROW_NUMBER() OVER (
        PARTITION BY CHK.CHEQUE_FACT_NK, CHK.MTLN_CDC_SEQUENCE_NUMBER
        ORDER BY (CASE WHEN ITM.ITEMSTATUS <> 'Voided' THEN ITM.ITEM_FACT_NK ELSE NULL END) ASC NULLS LAST
    )                                                                                as NON_VOIDED_ITEM_ROW_NUMBER
    -- Calculate the final allocated void amount for each item
    ,CASE
        -- If an item is voided, use its PRICE value to match sp_report_void
        WHEN ITM.ITEMSTATUS = 'Voided' THEN 
            ((CASE WHEN ITM.PRICE > 0.0000 THEN ITM.PRICE ELSE ITM.BASEPRICE END) + IFNULL(MOD.TotalModifierPrice, 0))
        -- If the cheque is voided, distribute the cheque's TOTAL across the non-voided items.
        WHEN CHK.STATUS = 'Voided' THEN
            -- Calculate the base allocation for this item based on its quantity, using CHK.GROSS.
            (ROUND(CHK.GROSS / NULLIF(TOTAL_NON_VOIDED_QUANTITY_ON_CHECK, 0), 2) * ITM.QUANTITY)
            +
            -- Add the rounding remainder to the first non-voided item.
            CASE
                WHEN NON_VOIDED_ITEM_ROW_NUMBER = 1 THEN
                    CHK.GROSS - (ROUND(CHK.GROSS / NULLIF(TOTAL_NON_VOIDED_QUANTITY_ON_CHECK, 0), 2) * TOTAL_NON_VOIDED_QUANTITY_ON_CHECK)
                ELSE 0
            END
        -- This case should not be reached due to the WHERE clause, but as a fallback, the void is 0.
        ELSE 0
    END                                                                              as ALLOCATED_ITEM_VOID
    
FROM DATAADMIN.CHEQUE_FACT                                       CHK
  LEFT JOIN DATAADMIN.ITEM_FACT                                  ITM
    ON CHK.CHEQUE_FACT_NK = ITM.CHEQUE_FACT_FK
    AND CHK.MTLN_CDC_SEQUENCE_NUMBER = ITM.MTLN_CDC_SEQUENCE_NUMBER
  LEFT JOIN (
            SELECT
                ITEM_FACT_FK,
                SUM(IFNULL(PRICE, 0)) AS TotalModifierPrice
            FROM DATAADMIN.ITEMMODIFIER_DIM
            WHERE DW_ISCURRENTROW
            GROUP BY ITEM_FACT_FK
    )
                                                                 MOD -- Join the new CTE
    ON ITM.ITEM_FACT_NK = MOD.ITEM_FACT_FK
    
WHERE 
    (
        (CHK.STATUS = 'Voided' AND ITM.ITEMSTATUS IN ('Added','Sent') )
        OR
        (ITM.ITEMSTATUS = 'Voided')
    )
    -- uncomment when developing
    -- AND CHK.DW_ISCURRENTROW
    -- AND ITM.DW_ISCURRENTROW
    -- AND NOT CHK.DW_ISDELETED
    -- AND NOT ITM.DW_ISDELETED
    -- AND CHK.location_dim_fk = 26
    -- AND ITM.location_dim_fk = 26
    -- AND CHK.FISCAL_DATE = '2025-05-09'
    -- AND CHK.CHEQUE_FACT_NK in (175772, 197923)


--===========================================================================================
--End of View
--============================================================================================

/*
;
--DATA VALIDATION QUERIES

CALL DATAADMIN.SP_REPORT_VOID_0001('2020-07-01T14:48:37.661Z','2029-07-26T14:48:37.661Z','[26,27]');
CREATE OR REPLACE TEMP TABLE REPORT_DATA_VOID AS
     SELECT * FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()));


-- compare vs void report at the cheque level
WITH
  fact_data AS (
    -- First query with LEVEL normalization
    SELECT
      LOCATION_DIM_FK,
      CHEQUE_FACT_FK,
      SUM(ALLOCATED_ITEM_VOID * (case when VOID_LEVEL = 'item' then QUANTITY else 1 END) )  AS total_allocated_void
    -- SUM(ALLOCATED_ITEM_VOID) AS total_allocated_void
    FROM
       dataadmin.VOIDCHECKBYITEM_FACT
    WHERE
      dw_iscurrentrow
      AND LOCATION_DIM_FK IN (26, 27)
    --   and CHEQUE_FACT_FK in (220356)
    GROUP BY
      LOCATION_DIM_FK,
      CHEQUE_FACT_FK
  ),
  report_data AS (
    -- Second query with LEVEL normalization
    SELECT
      ""Location ID"",
      ""Check ID"",
      SUM(""Amount"") AS total_report_amount
    FROM
      REPORT_DATA_VOID
    -- WHERE ""Check ID"" in (220356)
    GROUP BY
      ""Location ID"",
      ""Check ID""
  )
SELECT
  COALESCE(fd.LOCATION_DIM_FK, rd.""Location ID"") AS location,
  fd.CHEQUE_FACT_FK,
  rd.""Check ID"",
  COALESCE(fd.total_allocated_void, 0) AS allocated_void,
  COALESCE(rd.total_report_amount, 0) AS report_amount,
  COALESCE(fd.total_allocated_void, 0) - COALESCE(rd.total_report_amount, 0) AS difference
FROM
  fact_data fd
--   FULL OUTER JOIN report_data rd 
  INNER JOIN report_data rd --it returns null with inner join, meaning that all matching cheques have the same void value which makes me think there are missing cheques.
  ON fd.LOCATION_DIM_FK = rd.""Location ID""
  AND fd.CHEQUE_FACT_FK = rd.""Check ID""
where
  abs(difference) > 0.01
order by
 abs(difference) desc
 
-- LOCATION	CHEQUE_FACT_FK	Check ID	ALLOCATED_VOID	REPORT_AMOUNT	DIFFERENCE
-- 26	243922	243922	59.9	89.85	-29.95
-- 26	207917	207917	14.95	29.9	-14.95
-- 26	336065	336065	14.95	29.9	-14.95
-- 26	369101	369101	4.95	9.9	-4.95

;


--AD HOC granualr queries
select * from datawarehouse.VOIDCHECKBYITEM where dw_iscurrentrow and cheque_fact_fk in (207917)
;

SELECT CHEQUE_FACT_NK, fiscal_date,STATUS, DW_ISCURRENTROW, gross, net, total FROM DATAWAREHOUSE.CHEQUE_FACT WHERE CHEQUE_FACT_NK IN (207917 ) AND DW_ISCURRENTROW;


SELECT CHEQUE_FACT_FK, item_fact_nk,  fiscal_date,ITEMSTATUS, is_void , price, quantity, gross, net, total , DW_ISCURRENTROW 
FROM DATAWAREHOUSE.ITEM_FACT 
WHERE 
CHEQUE_FACT_FK IN (207917 ) 
--  item_fact_nk in ('243922.b8526d5c-d26c-422b-83e2-d50ea4fab464')

AND DW_ISCURRENTROW
;

SELECT ITEM_FACT_FK, PRICE FROM DATAWAREHOUSE.ITEMMODIFIER_DIM 
WHERE ITEM_FACT_FK IN ('243922.cb54829f-87f6-4a5d-855b-dba26dcca2f0'
                       , '243922.b8526d5c-d26c-422b-83e2-d50ea4fab464') 
AND DW_ISCURRENTROW;




select PRICE, item_fact_fk from DATAWAREHOUSE.ITEMMODIFIER_DIM 
where item_fact_fk in ('220356.ef517b20-5cbc-4b46-9ee5-d498dfa80ca2','220356.42bcee5e-2bc7-459f-97db-17b79a3e6b71','220356.3a493c1e-f328-4ad7-aa95-653cf2ae81d0')
AND dw_iscurrentrow

here are the missing 30.85!!
-- PRICE	ITEM_FACT_FK
-- 0	220356.42bcee5e-2bc7-459f-97db-17b79a3e6b71
-- 0	220356.ef517b20-5cbc-4b46-9ee5-d498dfa80ca2
-- 0	220356.3a493c1e-f328-4ad7-aa95-653cf2ae81d0
-- 4.95	220356.3a493c1e-f328-4ad7-aa95-653cf2ae81d0
-- 20.95	220356.42bcee5e-2bc7-459f-97db-17b79a3e6b71
-- 4.95	220356.ef517b20-5cbc-4b46-9ee5-d498dfa80ca2
;

*/
;"
VIEW,DATAADMIN,ACTIVITY_FACT,"create or replace view ACTIVITY_FACT(
	ACTIVITY_FACT_PK,
	ACTIVITY_FACT_NK,
	ACTIVITY,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	VOIDSUMMARY_FACT_FK,
	CHEQUE_FACT_FK,
	DISCOUNT_FACT_FK,
	EMPLOYEE_DIM_FK,
	EMPLOYEE_DIM_FK_AS_PERFORMING_EMPLOYEE,
	EMPLOYEE_DIM_FK_AS_APPROVING_EMPLOYEE,
	ITEM_FACT_FK,
	LOCATION_DIM_FK,
	MENUITEM_DIM_FK,
	IS_DISCOUNT,
	IS_TRAINING,
	IS_VOID,
	IS_VOID_ITEM,
	CREATED_AT,
	UPDATED_AT,
	PERFORMED_AT,
	TABLENAME,
	PERFORMEDBYUSERUUID,
	MENUITEMNAME,
	MENUITEMID,
	TYPE,
	ITEM_ID,
	OVERRIDE,
	LEVEL,
	REASON,
	PRICE
) as
-- --============================================================================================
SELECT 
--primary keys--------------------------------------------------------------------------------
  TO_DECIMAL(TO_VARCHAR(CHK.ID) || '.'  || RIGHT('000000000000000' || ACT.INDEX, 16) ,38,16)   
                                                                          AS ACTIVITY_FACT_PK
--natural keys------------------------------------------------------------------------------
  ,TO_DECIMAL(TO_VARCHAR(CHK.ID) || '.'  || RIGHT('000000000000000' || ACT.INDEX, 16) ,38,16)  
                                                                          AS ACTIVITY_FACT_NK
--name---------------------------------------------------------------------------------------
  ,ACT.INDEX                                                              AS ACTIVITY
--data warehouse rows------------------------------------------------------------------------
 ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY TO_DECIMAL(TO_VARCHAR(CHK.ID) || '.'  || RIGHT('000000000000000' || ACT.INDEX, 16) ,38,16) ORDER BY CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION
      ,CHK.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY TO_DECIMAL(TO_VARCHAR(CHK.ID) || '.'  || RIGHT('000000000000000' || ACT.INDEX, 16) ,38,16) ORDER BY CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION,CHK.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY TO_DECIMAL(TO_VARCHAR(CHK.ID) || '.'  || RIGHT('000000000000000' || ACT.INDEX, 16) ,38,16) ORDER BY 
    CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION
   ,CHK.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN CHK.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY TO_DECIMAL(TO_VARCHAR(CHK.ID) || '.'  || RIGHT('000000000000000' || ACT.INDEX, 16) ,38,16) ORDER BY  
    CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,CHK.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,CHK.MTLN_CDC_SRC_VERSION DESC
   ,CHK.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     --REQUIRED
--CDC Meta data-------------------------------------------------------------------------------
  ,CHK.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE
  ,CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,CHK.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER
  ,CHK.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID
  ,CHK.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP
  ,CHK.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,CHK.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION
  ,CHK.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME
  ,CHK.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH
  ,CHK.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE
  ,CHK.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA
  ,CHK.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE
--foreign keys-------------------------------------------------------------------------------
  ,CASE WHEN TO_CHAR(ACT.value:type) in ('ItemVoided','ItemAdded')
    THEN 
    '.'  ||TO_VARCHAR(REPLACE(ACT.value:updatedUuid,'""',''))
    ELSE '-1'
    END
                                                  AS VOIDSUMMARY_FACT_FK
  ,IFNULL(CHK.id,-1)                              AS CHEQUE_FACT_FK     
  ,IFNULL(IFNULL(CASE WHEN ACT.value:type ILIKE ('%discount%') 
    THEN TO_VARCHAR(CHK.ID) || '.' 
      || TO_VARCHAR(REPLACE(ACT.value:updatedUuid,'""',''))
    END,NULL),'-1')
                                                  AS DISCOUNT_FACT_FK
  ,IFNULL(CHK.employee_id,-1)                     AS EMPLOYEE_DIM_FK   
  ,IFNULL(TO_NUMBER(value:actor.performedByEmployeeId),-1)
                                       AS EMPLOYEE_DIM_FK_AS_PERFORMING_EMPLOYEE
  ,IFNULL(TO_NUMBER(value:actor.approvedByEmployeeId),-1)
                                       AS EMPLOYEE_DIM_FK_AS_APPROVING_EMPLOYEE                                       
,IFNULL(CASE WHEN ACT.value:type ILIKE ANY ('%item%','%DiscountAdded%')THEN
  CHK.ID || '.'  ||TO_VARCHAR(REPLACE(COALESCE(ACT.value:discountInfo.itemId,ACT.value:updatedUuid),'""',''))--THIS PK IS TEXT BECAUSE OF ITEM GUID
  ELSE '-1' END,'-1') 
                                       AS ITEM_FACT_FK

                                       
  ,IFNULL(CHK.location_id ,-1)         AS LOCATION_DIM_FK
  ,IFNULL(TO_NUMBER(value:itemInfo.menuItem.menuItemId),-1)  
                                       AS MENUITEM_DIM_FK
--flags---------------------------------------------------------------------------------------
  ,CASE WHEN ACT.value:type ILIKE ('%discount%') 
        THEN TRUE ELSE FALSE END                       AS IS_DISCOUNT
  ,CHK.IS_TRAINING                                     AS IS_TRAINING
  ,CASE WHEN ACT.value:type ILIKE ('%void%') 
        THEN TRUE ELSE FALSE END                       AS IS_VOID
  ,MAX(CASE WHEN ACT.value:type ILIKE ('%void%') 
        THEN TRUE ELSE FALSE END) 
        OVER (PARTITION BY CHK.MTLN_CDC_SEQUENCE_NUMBER
          ,CHK.ID || '.'  ||TO_VARCHAR(REPLACE(ACT.value:updatedUuid,'""',''))
        )
                                                       AS IS_VOID_ITEM        
--Dates--------------.------------------------------------------------------------------------
  ,to_timestamp_tz(CHK.CREATED_AT)                     AS CREATED_AT   
  ,to_timestamp_tz(CHK.UPDATED_AT)                     AS UPDATED_AT
  ,TO_TIMESTAMP(TO_VARCHAR(value:performedAt))         AS PERFORMED_AT
--names, options, etc-------------------------------------------------------------------------
  ,REPLACE(ACT.value:tableName,'""','')                 AS TABLENAME
  ,REPLACE(ACT.value:performedByUserUuid,'""','')       AS PERFORMEDBYUSERUUID
  ,REPLACE(ACT.value:itemInfo.menuItem.name,'""','')    AS MENUITEMNAME 
  ,TO_NUMBER(ACT.value:itemInfo.menuItem.menuItemId)   AS MENUITEMID  
  ,REPLACE(ACT.value:type,'""','')                      AS TYPE
  ,CASE WHEN TO_CHAR(ACT.value:type) ILIKE ANY ('%item%','%DiscountAdded%')
     THEN TO_VARCHAR(REPLACE(COALESCE(ACT.value:discountInfo.itemId,ACT.value:updatedUuid),'""','')) 
     ELSE NULL END
                                                       AS ITEM_ID
  ,REPLACE(ACT.value:itemInfo.menuItem.override,'""','')AS OVERRIDE
  ,CASE WHEN ACT.value:type ILIKE ('%Item%') THEN 'Item' 
        ELSE CASE WHEN ACT.value:type ILIKE ('%Discount%') 
          THEN ACT.value:discountInfo.application
          ELSE 'None'
  END END                                               AS LEVEL
  ,REPLACE(REPLACE(value:info,'""""',''),'reason: ','')   AS REASON
  -- ,AS REASON_ID
--Counts and Amounts--------------------------------------------------------------------------
  ,ACT.value:itemInfo.menuItem.price::NUMBER(38,4)      AS PRICE  
  -------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_CHEQUE                  CHK 
    ,LATERAL FLATTEN(INPUT => 
    TRY_PARSE_JSON( '{ACTIVITIES:' || CHK.ACTIVITIES || '}' ), PATH => 'ACTIVITIES')
                                                        ACT
WHERE CHK.ACTIVITIES IS NOT NULL
  AND NOT COALESCE(TRUNCATED,FALSE)
  AND CHK.MTLN_CDC_LAST_CHANGE_TYPE <> 'd' 
;"
VIEW,DATAADMIN,GIFTCARD_DIM,"create or replace view GIFTCARD_DIM(
	GIFTCARD_DIM_PK,
	GIFTCARD_DIM_NK,
	GIFTCARD,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	MERCHANT_DIM_FK,
	IS_LEGACY,
	IS_ISSUED,
	CREATED_AT,
	EXPIRES_AT,
	UPDATED_AT,
	ISSUED_AT,
	BALANCE_REQUESTED_AT,
	BATCH_ID,
	BALANCE_REQUEST_COUNT,
	START_BALANCE,
	BALANCE
) as
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  dad.ID                                                       AS GIFTCARD_DIM_PK
--natural keys------------------------------------------------------------------------------
  ,dad.ID                                                      AS GIFTCARD_DIM_NK
--name---------------------------------------------------------------------------------------
  ,dad.ACCOUNT                                                 AS GIFTCARD
--data warehouse rows------------------------------------------------------------------------
  ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(dad.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY dad.ID ORDER BY dad.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,dad.MTLN_CDC_SEQUENCE_NUMBER,dad.MTLN_CDC_SRC_VERSION
      ,dad.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(dad.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY dad.ID ORDER BY dad.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,dad.MTLN_CDC_SEQUENCE_NUMBER,dad.MTLN_CDC_SRC_VERSION,dad.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY dad.ID ORDER BY 
    dad.MTLN_CDC_LAST_COMMIT_TIMESTAMP,dad.MTLN_CDC_SEQUENCE_NUMBER,dad.MTLN_CDC_SRC_VERSION
   ,dad.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN dad.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY dad.ID ORDER BY  
    dad.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,dad.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,dad.MTLN_CDC_SRC_VERSION DESC
   ,dad.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     --REQUIRED
--CDC Meta data-------------------------------------------------------------------------------
  ,dad.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE
  ,dad.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,dad.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER
  ,dad.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID
  ,dad.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP
  ,dad.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,dad.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION
  ,dad.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME
  ,dad.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH
  ,dad.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE
  ,dad.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA
  ,dad.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE
--foreign keys-------------------------------------------------------------------------------
  ,IFNULL(dad.MERCHANT_ID,'-1')       AS MERCHANT_DIM_FK
--flags---------------------------------------------------------------------------------------
  ,dad.IS_LEGACY::boolean              AS IS_LEGACY
  ,dad.IS_ISSUED::boolean              AS IS_ISSUED
--Dates--------------.------------------------------------------------------------------------
  ,to_timestamp_tz(dad.CREATED_AT)     AS CREATED_AT  
  ,to_timestamp_tz(dad.EXPIRES_AT)     AS EXPIRES_AT
  ,to_timestamp_tz(dad.UPDATED_AT)     AS UPDATED_AT
  ,to_timestamp_tz(dad.ISSUED_AT)      AS ISSUED_AT
  ,to_timestamp_tz(dad.BALANCE_REQUESTED_AT)  as BALANCE_REQUESTED_AT
--names, options, etc-------------------------------------------------------------------------
  ,dad.BATCH_ID                        AS BATCH_ID
--Counts and Amounts--------------------------------------------------------------------------
  ,dad.BALANCE_REQUEST_COUNT           AS BALANCE_REQUEST_COUNT    ----
  ,dad.start_balance                   AS START_BALANCE
  ,dad.BALANCE                         AS BALANCE

----------------------------------------------------------------------------------------------
FROM DATALANDING.GIFTCARD_PUBLIC_GIFTCARDS     DAD
;"
VIEW,DATAADMIN,SURCHARGE_DIM,"create or replace view SURCHARGE_DIM(
	SURCHARGE_DIM_PK,
	SURCHARGE_DIM_NK,
	SURCHARGE,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	ORGANIZATION_DIM_FK,
	IS_ARCHIVED,
	IS_ENABLED,
	IS_PRINT_ON_RECEIPT,
	IS_TAXABLE,
	IS_GRATUITY,
	CREATED_AT,
	UPDATED_AT,
	DESCRIPTION,
	POS_NAME,
	RECEIPT_DISPLAY_NAME,
	TYPE,
	MIN_GUESTS,
	MIN_CHECK_AMOUNT,
	FIXED_VALUE
) as
--SELECT * FROM DATAADMIN.SURCHARGE_DIM;
--SELECT * FROM DEV_HOSPENG_REPORTING.DATALANDING.POSAPI_PUBLIC_SURCHARGE;
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  tab.ID                                                      AS SURCHARGE_DIM_PK  --REQUIRED
--natural keys------------------------------------------------------------------------------
  ,tab.ID                                                     AS SURCHARGE_DIM_NK  --REQUIRED
--name-------------------------------------------------------------------------------------------
  ,tab.NAME                                                   AS SURCHARGE
--data warehouse REQUIRED rows-------------------------------------------------------------------
 ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY tab.ID ORDER BY tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION
      ,tab.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY tab.ID ORDER BY tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION,tab.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY tab.ID ORDER BY 
    tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION
   ,tab.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN tab.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY tab.ID ORDER BY  
    tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,tab.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,tab.MTLN_CDC_SRC_VERSION DESC
   ,tab.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     --REQUIRED
--CDC Meta data REQUIRED rows-------------------------------------------------------------------------------
  ,tab.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE                   --REQUIRED
  ,tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP              --REQUIRED
  ,tab.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER                    --REQUIRED
  ,tab.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID                      --REQUIRED
  ,tab.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP                     --REQUIRED
  ,tab.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR                --REQUIRED
  ,tab.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION                        --REQUIRED
  ,tab.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME                           --REQUIRED
  ,tab.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH                           --REQUIRED
  ,tab.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE                       --REQUIRED
  ,tab.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA                         --REQUIRED
  ,tab.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE                          --REQUIRED
--foreign keys-------------------------------------------------------------------------------
  ,tab.ORGANIZATION_ID                 AS ORGANIZATION_DIM_FK
--flags---------------------------------------------------------------------------------------
--ALLCOLUMN NAMES IN THIS SECTION SHOULD begin with is_ or has_ if created by the dw.
-- --   columns created by the source app should be specifically cast as boolean 
-- --Alphabetize between the lines
  ,tab.ARCHIVED                         AS IS_ARCHIVED
  ,tab.IS_ENABLED                       AS IS_ENABLED
  ,tab.PRINT_ON_RECEIPT                 AS IS_PRINT_ON_RECEIPT
  ,tab.IS_TAXABLE                       AS IS_TAXABLE
  ,tab.IS_GRATUITY                      AS IS_GRATUITY
-- --Dates--------------.------------------------------------------------------------------------
-- --dates should be cast as dates
-- -- created_at timestamp with time zone  <--this is the create table from postgres
-- --,to_timestamp_tz(created_at) 
-- --Alphebetize between the lines
  ,to_timestamp_tz(tab.CREATED_AT)       AS CREATED_AT  
  ,to_timestamp_tz(tab.UPDATED_AT)       AS UPDATED_AT
-- --names, options, etc-------------------------------------------------------------------------
  ,tab.DESCRIPTION                       AS DESCRIPTION
    ,tab.POS_NAME                        AS POS_NAME
  ,tab.RECEIPT_DISPLAY_NAME              AS RECEIPT_DISPLAY_NAME
  ,tab.TYPE                              AS TYPE
-- --Counts and Amounts--------------------------------------------------------------------------
-- --ALL COLUMNS IN THIS SECTION SHOULD END IN COUNT OR AMOUNT
-- --Alphebetize between the lines
  ,TO_NUMBER(tab.MIN_GUESTS,38,2)         AS MIN_GUESTS
  ,TO_NUMBER(tab.MIN_CHECK_AMOUNT,38,2)   AS MIN_CHECK_AMOUNT  
  ,TO_NUMBER(tab.FIXED_VALUE,38,2)        AS FIXED_VALUE
-- ----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_SURCHARGE tab;"
VIEW,DATAADMIN,TERMINAL_DIM,"create or replace view TERMINAL_DIM(
	TERMINAL_DIM_PK,
	TERMINAL_DIM_NK,
	TERMINALNAME,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	LOCATION_DIM_FK,
	IS_CALL_CENTER,
	CREATED_AT,
	UPDATED_AT,
	DELETED_AT,
	TERMINAL_ROLE,
	PROVISION_TOKEN
) as
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  tab.ID                                                      AS TERMINAL_DIM_PK  
--natural keys------------------------------------------------------------------------------
  ,tab.ID                                                     AS TERMINAL_DIM_NK  
--name-------------------------------------------------------------------------------------------
  ,tab.NAME                                                   AS TERMINALNAME
--data warehouse REQUIRED rows-------------------------------------------------------------------
  ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY tab.ID ORDER BY tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION
      ,tab.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE    
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY tab.ID ORDER BY tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION,tab.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY tab.ID ORDER BY 
    tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION
   ,tab.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE 
  
  ,CASE WHEN tab.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED          
  ,CASE WHEN RANK() OVER(PARTITION BY tab.ID ORDER BY  
    tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,tab.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,tab.MTLN_CDC_SRC_VERSION DESC
   ,tab.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW       
--CDC Meta data REQUIRED rows-------------------------------------------------------------------------------
  ,tab.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE                   
  ,tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP             
  ,tab.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER                   
  ,tab.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID                     
  ,tab.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP                     
  ,tab.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR                
  ,tab.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION                        
  ,tab.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME                          
  ,tab.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH                           
  ,tab.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE                      
  ,tab.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA                        
  ,tab.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE                          
--foreign keys-------------------------------------------------------------------------------
 ,IFNULL(tab.LOCATION_ID,-1)           AS LOCATION_DIM_FK 
--flags---------------------------------------------------------------------------------------
--ALLCOLUMN NAMES IN THIS SECTION SHOULD begin with is_ or has_ if created by the dw.
--   columns created by the source app should be specifically cast as boolean 
  ,IS_CALL_CENTER                      AS IS_CALL_CENTER
--Dates--------------.------------------------------------------------------------------------
--dates should be cast as dates
-- created_at timestamp with time zone  <--this is the create table from postgres
--,to_timestamp_tz(created_at) 
  ,to_timestamp_tz(tab.CREATED_AT)     AS CREATED_AT  
  ,to_timestamp_tz(tab.UPDATED_AT)     AS UPDATED_AT
  ,to_timestamp_tz(tab.DELETED_AT)     AS DELETED_AT  
--names, options, etc-------------------------------------------------------------------------
  ,tab.TERMINAL_ROLE                   AS TERMINAL_ROLE
  ,tab.PROVISION_TOKEN                 AS PROVISION_TOKEN
-- ----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_POS_TERMINAL     tab
;"
VIEW,DATAADMIN,COGSCATEGORY_DIM,"create or replace view COGSCATEGORY_DIM(
	COGSCATEGORY_DIM_PK,
	COGSCATEGORY_DIM_NK,
	COGSCATEGORY,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	ORGANIZATION_DIM_FK,
	CREATED_AT,
	UPDATED_AT,
	DESCRIPTION
) as
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  tab.ID                                                      AS COGSCATEGORY_DIM_PK  --REQUIRED
--natural keys------------------------------------------------------------------------------
  ,tab.ID                                                     AS COGSCATEGORY_DIM_NK  --REQUIRED
--name-------------------------------------------------------------------------------------------
  ,tab.NAME                                                   AS COGSCATEGORY
--data warehouse REQUIRED rows-------------------------------------------------------------------
 ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY tab.ID ORDER BY tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION
      ,tab.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY tab.ID ORDER BY tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION,tab.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY tab.ID ORDER BY 
    tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION
   ,tab.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN tab.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY tab.ID ORDER BY  
    tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,tab.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,tab.MTLN_CDC_SRC_VERSION DESC
   ,tab.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     --REQUIRED
--CDC Meta data REQUIRED rows-------------------------------------------------------------------------------
  ,tab.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE                   --REQUIRED
  ,tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP              --REQUIRED
  ,tab.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER                    --REQUIRED
  ,tab.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID                      --REQUIRED
  ,tab.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP                     --REQUIRED
  ,tab.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR                --REQUIRED
  ,tab.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION                        --REQUIRED
  ,tab.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME                           --REQUIRED
  ,tab.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH                           --REQUIRED
  ,tab.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE                       --REQUIRED
  ,tab.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA                         --REQUIRED
  ,tab.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE                          --REQUIRED
--foreign keys-------------------------------------------------------------------------------
  ,tab.ORGANIZATION_ID                 AS ORGANIZATION_DIM_FK
--flags---------------------------------------------------------------------------------------
--ALLCOLUMN NAMES IN THIS SECTION SHOULD begin with is_ or has_ if created by the dw.
--   columns created by the source app should be specifically cast as boolean 
--Alphabetize between the lines
--Dates--------------.------------------------------------------------------------------------
--dates should be cast as dates
  ,to_timestamp_tz(tab.CREATED_AT)     AS CREATED_AT  
  ,to_timestamp_tz(tab.UPDATED_AT)     AS UPDATED_AT
--names, options, etc-------------------------------------------------------------------------
--Counts and Amounts--------------------------------------------------------------------------
--ALL COLUMNS IN THIS SECTION SHOULD END IN COUNT OR AMOUNT
,tab.DESCRIPTION                       AS DESCRIPTION
-- ----------------------------------------------------------------------------------------------
FROM DATALANDING.posapi_public_cogs_category tab;"
VIEW,DATAADMIN,ITEM_FACT,"create or replace view ITEM_FACT(
	ITEM_FACT_PK,
	ITEM_FACT_NK,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	CHEQUE_FACT_FK,
	DAYPART_DIM_FK,
	EMPLOYEE_DIM_FK,
	LOCATION_DIM_FK,
	ORDERTYPE_DIM_FK,
	MENUITEM_DIM_FK,
	MENUITEMNAME_DIM_FK,
	VOIDREASON_DIM_FK,
	VARIANT_DIM_FK,
	HASMODIFIERS,
	IS_TRAINING,
	IS_VOID,
	FISCAL_DATE_INT,
	FISCAL_DATE,
	OPENED_AT,
	BEGIN_PREP_AT,
	CLOSED_AT,
	SCHEDULED_AT,
	CREATED_AT,
	UPDATED_AT,
	SPLITBY,
	ITEMSTATUS,
	CHECKSTATUS,
	STATUSREASON_ID,
	STATUSREASON,
	COMBINEDNAME,
	MODIFIERS,
	NOTE,
	DESCRIPTION,
	NAME,
	PATH,
	VARIANTNAME,
	REVENUECENTERNAME,
	CHECK_ID,
	EMPLOYEE_ID,
	ITEM_ID,
	LOCATION_ID,
	REVENUECENTER_ID,
	ORDER_TYPE_ID,
	CHEQUENUMBER,
	APPLIEDAMOUNT,
	QUANTITY,
	REPORTQUANTITY,
	BASEPRICE,
	INCLUSIVETAX,
	TAB,
	DISCOUNTCHECK,
	DISCOUNTITEM,
	PRICE,
	GROSS,
	NET,
	TAX,
	TOTAL,
	CHECKGROSS,
	CHECKTOTAL
) as
--===========================================================================================
SELECT
--primary keys-------------------------------------------------------------------------------
   CHK.ID || '.'  ||replace(ITM.VALUE:id,'""','')--THIS PK IS TEXT BEreCAUSE OF ITEM GUID
                                                              AS ITEM_FACT_PK
--natural keys-f------------------------------------------------------------------------------
  ,CHK.ID || '.'  ||replace(ITM.VALUE:id,'""','')              AS ITEM_FACT_NK
--name---------------------------------------------------is-----------------------------------
 ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(row_number() OVER (
      PARTITION BY  CHK.ID || '.'  ||replace(ITM.VALUE:id,'""','') ORDER BY CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION
      ,CHK.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY  CHK.ID || '.'  ||replace(ITM.VALUE:id,'""','') ORDER BY CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION,CHK.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(row_number() OVER (PARTITION BY  CHK.ID || '.'  ||replace(ITM.VALUE:id,'""','') ORDER BY 
    CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION
   ,CHK.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN CHK.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN row_number() OVER(PARTITION BY  CHK.ID || '.'  ||replace(ITM.VALUE:id,'""','') ORDER BY  
    CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,CHK.MTLN_CDC_SEQUENCE_NUMBER DESc
   ,CHK.MTLN_CDC_SRC_VERSION DESC
   ,CHK.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END        AS DW_ISCURRENTROW     --REQUIRED
--CDC Meta data------------------------------------------------------------------------------
  ,CHK.MTLN_CDC_LAST_CHANGE_TYPE        AS MTLN_CDC_LAST_CHANGE_TYPE
  ,CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP   AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,CHK.MTLN_CDC_SEQUENCE_NUMBER         AS MTLN_CDC_SEQUENCE_NUMBER
  ,CHK.MTLN_CDC_LOAD_BATCH_ID           AS MTLN_CDC_LOAD_BATCH_ID
  ,CHK.MTLN_CDC_LOAD_TIMESTAMP          AS MTLN_CDC_LOAD_TIMESTAMP
  ,CHK.MTLN_CDC_PROCESSED_DATE_HOUR     AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,CHK.MTLN_CDC_SRC_VERSION             AS MTLN_CDC_SRC_VERSION
  ,CHK.MTLN_CDC_FILENAME                AS MTLN_CDC_FILENAME
  ,CHK.MTLN_CDC_FILEPATH                AS MTLN_CDC_FILEPATH
  ,CHK.MTLN_CDC_SRC_DATABASE            AS MTLN_CDC_SRC_DATABASE
  ,CHK.MTLN_CDC_SRC_SCHEMA              AS MTLN_CDC_SRC_SCHEMA
  ,CHK.MTLN_CDC_SRC_TABLE               AS MTLN_CDC_SRC_TABLE
-- --foreign keys-------------------------------------------------------------------------------
  ,IFNULL(CHK.ID,-1)                    AS CHEQUE_FACT_FK      --one checque,many items
  ,IFNULL(CHK.day_part_id,-1)           AS DAYPART_DIM_FK  
  ,IFNULL(CHK.employee_id,-1)           AS EMPLOYEE_DIM_FK     
  ,IFNULL(CHK.location_id,-1)           AS LOCATION_DIM_FK  
  ,IFNULL(CHK.order_type_id,-1)         AS ORDERTYPE_DIM_FK  

  -- ,IFNULL(TO_NUMBER(replace(replace(split_part(
  --   replace(ITM.value:menuItem:path,'',''),'.',2),'{',''),'}','') ),-1)
  --                                       AS MENUGROUP_DIM_FK
  ,IFNULL(TO_NUMBER(ITM.value:menuItem:menuItemId),-1)       
                                        AS MENUITEM_DIM_FK     
  ,IFNULL(TO_NUMBER(ITM.value:menuItem:menuItemNameId),-1)   
                                        AS MENUITEMNAME_DIM_FK 
  ,IFNULL(CASE WHEN replace(ITM.value:status,'""','') 
     = 'Voided' 
    THEN TO_NUMBER(replace(ITM.value:statusReasonId,'""',''),38,0 )
    ELSE -1 END,-1)                     AS VoidReason_DIM_FK
  ,IFNULL(TO_NUMBER(replace(ITM.value:menuItem:variantId,'','')),-1)       
                                        AS VARIANT_DIM_FK      
-- --flags---------------------------------------------------------------------------------------
  ,CASE ITM.value:modifiers
    WHEN NULL THEN FALSE
    ELSE TRUE END                        AS HASMODIFIERS 
 ,CHK.IS_TRAINING                        AS IS_TRAINING
 ,CASE WHEN replace(ITM.value:status,'""','')
   = 'Voided' THEN TRUE ELSE FALSE END   AS IS_VOID
-- --Dates--------------.-----------------------------------------------------------------------
  ,CHK.FISCAL_DATE_INT                 AS FISCAL_DATE_INT                    
  ,(TO_CHAR(max(TRY_PARSE_JSON(CHK.info):fiscalDate) over (partition by chk.id)))::DATE   
                                       AS FISCAL_DATE              
  ,to_timestamp_tz(CHK.opened_at)      AS OPENED_AT
  ,to_timestamp_tz(CHK.begin_prep_at)  AS BEGIN_PREP_AT
  ,to_timestamp_tz(CHK.closed_at)      AS CLOSED_AT
  ,to_timestamp_tz(CHK.scheduled_at)   AS SCHEDULED_AT
  ,to_timestamp_tz(CHK.created_at)     AS CREATED_AT
  ,to_timestamp_tz(CHK.UPDATED_AT)     AS UPDATED_AT
-- --names,etc---------------------------------------------------------------------------------------
  ,TO_NUMBER(ITM.value:splitBy  )                              AS SPLITBY
  ,replace(ITM.value:status,'""','')                            AS ITEMSTATUS
  ,CHK.STATUS                                                  AS CHECKSTATUS
  ,replace(ITM.value:statusReasonId,'""','')                    AS STATUSREASON_ID
  ,ifnull(replace(ITM.value:statusReason,'""',''),'None')       AS STATUSREASON
  ,replace(ITM.value:menuItem:combinedName,'','')              AS COMBINEDNAME
  ,replace(ITM.value:modifiers,'""','')                         AS MODIFIERS
  ,ifnull(replace(ITM.value:note,'""',''),' ')                  AS NOTE
  ,replace(ITM.value:menuItem:description,'','')               AS DESCRIPTION
  ,replace(ITM.value:menuItem:name,'','')                      AS NAME
  ,replace(ITM.value:menuItem:path,'','')                      AS PATH    
  ,ifnull(replace(ITM.value:menuItem:variantName,'',''),' ')   AS VARIANTNAME
  ,replace(TRY_PARSE_JSON(CHk.info):revenueCenterName,'""','')  AS REVENUECENTERNAME
  ,CHK.ID                                                      AS CHECK_ID
  ,CHK.EMPLOYEE_ID                                             AS EMPLOYEE_ID  
  ,replace(ITM.VALUE:id,'""','')                                AS ITEM_ID
  ,CHK.LOCATION_ID                                             AS LOCATION_ID
  ,TO_NUMBER(replace(TRY_PARSE_JSON(CHK.info):revenueCenterId,'""',''))    AS REVENUECENTER_ID  
  ,CHK.ORDER_TYPE_ID                                           AS ORDER_TYPE_ID
  ,CHK.NUMBER                                                  AS CHEQUENUMBER
-- --counts and amounts--------------------------------------------------------------------------------
  ,CAST(ITM.value:appliedAmount AS DECIMAL(38,4))              AS APPLIEDAMOUNT
  ,CAST(ITM.value:quantity AS DECIMAL(38,4))                   AS QUANTITY
  ,IFNULL(CAST(ITM.value:reportQuantity AS DECIMAL(38,4)),1)   AS REPORTQUANTITY
  ,CAST(ITM.value:basePrice AS DECIMAL(38,4))                  AS BASEPRICE
  ,CAST(ITM.value:inclusiveTax AS DECIMAL(38,4))               AS INCLUSIVETAX
  ,CAST(ITM.value:discount AS DECIMAL(38,4))                   AS TAB
  ,CAST(ITM.value:discountCheck AS DECIMAL(38,4))              AS DISCOUNTCHECK
  ,CAST(ITM.value:discountItem AS DECIMAL(38,4))               AS DISCOUNTITEM
  ,CAST(ITM.value:menuItem:price AS DECIMAL(38,4))             AS PRICE
  ,CAST(ITM.value:gross AS DECIMAL(38,4))                      AS GROSS  
  ,CAST(ITM.value:net AS DECIMAL(38,4))                        AS NET  
  ,CAST(ITM.value:tax AS DECIMAL(38,4))                        AS TAX
  ,CAST(ITM.value:total AS DECIMAL(38,4))                      AS TOTAL 
  ,TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):gross), 38, 4)           
                                                               AS CHECKGROSS
 ,TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):total), 38, 4)           
                                                               AS CHECKTOTAL                                                               
  -------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_CHEQUE                          CHK 
    ,LATERAL FLATTEN(INPUT => 
    TRY_PARSE_JSON( '{ITEMS:' || CHK.ITEMS || '}' ), PATH => 'ITEMS')
                                                               ITM 
 WHERE NOT COALESCE(CHK.TRUNCATED,FALSE)   
   AND CHK.MTLN_CDC_LAST_CHANGE_TYPE <> 'd' 
       -- and item_fact_nk = '53344.3f6e9f4e-f9ed-47ff-875f-580df5f695c2'            
;"
VIEW,DATAADMIN,PAYMENTS_FACT,"create or replace view PAYMENTS_FACT(
	PAYMENTS_FACT_PK,
	PAYMENTS_FACT_NK,
	PAYMENTNUMBER,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	CHEQUE_FACT_FK,
	DAYPART_DIM_FK,
	EMPLOYEE_DIM_FK_AS_CREATOR,
	EMPLOYEE_DIM_FK_AS_PAYEE,
	LOCATION_DIM_FK,
	ORDERTYPE_DIM_FK,
	PAYMENTMETHOD_DIM_FK,
	REVENUECENTER_DIM_FK,
	TRANSACTION_FACT_FK,
	TERMINAL_DIM_FK,
	SHOULD_VERIFYID,
	IS_PARTIALAPPROVAL,
	IS_TRAINING,
	CREATED_AT,
	UPDATED_AT,
	OPENED_AT,
	PAID_AT,
	FISCALDATE,
	SEQ,
	BATCHNUMBER,
	CARDBRAND,
	CARDHOLDERNAME,
	CHEQUENUMBER,
	CURRENCY_ID,
	FLOORPLAN_ID,
	LASTFOURCCNUMBER,
	NEXTFOURCCNUMBER,
	PAYMENTTYPE,
	PAYMENTSTATUS,
	REVENUECENTERNAME,
	TABLENAME,
	PARTYSIZE,
	TIP,
	AMOUNTAPPLIEDTOCHECK,
	CHANGE,
	TOTAL
) as
-- --============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------ 
   CHK.ID || '.'  || REPLACE(PAY.value:id,'""','')                        AS PAYMENTS_FACT_PK
--natural keys------------------------------------------------------------------------------
  ,CHK.ID || '.'  || REPLACE(PAY.value:id,'""','')                        AS PAYMENTS_FACT_NK
--name---------------------------------------------------------------------------------------
  ,RIGHT('000000000000000' || PAY.INDEX, 16)                             AS PAYMENTNUMBER
--data warehouse rows------------------------------------------------------------------------
 ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY 
        CHK.ID || '.'  || REPLACE(PAY.value:id,'""','') 
        ORDER BY CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION
      ,CHK.MTLN_CDC_FILENAME)),6))
                                                                         AS DW_STARTDATE       
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY 
    CHK.ID || '.'  || REPLACE(PAY.value:id,'""','') 
    ORDER BY CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION,CHK.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY CHK.ID || '.'  || REPLACE(PAY.value:id,'""','') ORDER BY 
    CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION
   ,CHK.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                                         AS DW_ENDDATE          
  
  ,CASE WHEN CHK.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                             AS DW_ISDELETED             
  ,CASE WHEN RANK() OVER(PARTITION BY  CHK.ID || '.'  || REPLACE(PAY.value:id,'""','') 
    ORDER BY  
    CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,CHK.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,CHK.MTLN_CDC_SRC_VERSION DESC
   ,CHK.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                                          AS DW_ISCURRENTROW     
--CDC Meta data-------------------------------------------------------------------------------
  ,CHK.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE
  ,CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,CHK.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER
  ,CHK.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID
  ,CHK.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP
  ,CHK.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,CHK.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION
  ,CHK.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME
  ,CHK.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH
  ,CHK.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE
  ,CHK.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA
  ,CHK.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE
--foreign keys-------------------------------------------------------------------------------
  ,IFNULL(CHK.ID,-1)                               AS CHEQUE_FACT_FK
  ,IFNULL(CHK.DAY_PART_ID,-1)                      AS DAYPART_DIM_FK
  ,IFNULL(CHK.EMPLOYEE_ID,-1)                      AS EMPLOYEE_DIM_FK_AS_CREATOR
  ,IFNULL(TO_NUMBER(PAY.value:employeeId),-1)      AS EMPLOYEE_DIM_FK_AS_PAYEE
  ,IFNULL(CHK.LOCATION_ID,-1)                      AS LOCATION_DIM_FK
  ,IFNULL(CHK.order_type_id,-1)                    AS Ordertype_DIM_FK    
  ,IFNULL(TO_NUMBER(PAY.value:paymentMethodId),-1) AS PAYMENTMETHOD_DIM_FK
  ,IFNULL(TO_NUMBER(replace(TRY_PARSE_JSON(CHK.info):revenueCenterId,'""','')),-1)
                                                   AS REVENUECENTER_DIM_FK 
  ,IFNULL(TO_NUMBER(replace(PAY.value:ccData:transactionID,'""','')),-1)  
                                                   AS TRANSACTION_FACT_FK
  ,IFNULL(PAY.value:applicationSettings.posTerminalId::INT,-1)  
                                                   AS TERMINAL_DIM_FK                                
-- --flags---------------------------------------------------------------------------------------
  ,replace(PAY.value:ccData:shouldVerifyId,'""','')   ::boolean          AS SHOULD_VERIFYID
  ,replace(PAY.value:ccData:isPartialApproval,'""','')::boolean          AS IS_PARTIALAPPROVAL
  ,CHK.IS_TRAINING                                                      AS IS_TRAINING
-- -- --Dates--------------.------------------------------------------------------------------------
  ,to_timestamp_tz(CHK.CREATED_AT)                                      AS CREATED_AT   
  ,to_timestamp_tz(CHK.UPDATED_AT)                                      AS UPDATED_AT
 -- ,to_timestamp_tz(replace(value:ccData:expirationDate,'""',''))       AS EXPIRATIONDATE   
  ,to_timestamp_tz(CHK.opened_at)                                       AS OPENED_AT
  ,to_timestamp_tz(to_char((PAY.value:paidAt)))                         AS PAID_AT
  ,TO_CHAR(TRY_PARSE_JSON(CHK.info):fiscalDate)::DATE                   AS FISCALDATE
-- --names, options, etc-------------------------------------------------------------------------
  ,seq                                                                  AS SEQ
  ,replace(value:ccData:batchNumber,'""','')                             AS BATCHNUMBER
  -- ,initcap(replace(value:ccData:cardBrand,'""',''))   

  ,case when value:ccData:cardBrand = '' or value:ccData:cardBrand is null then 'None' 
    else initcap(replace(value:ccData:cardBrand,'""','')) end 
  
  
                                                                        AS CARDBRAND
  ,replace(value:ccData:cardholderName,'""','')                          AS CARDHOLDERNAME
  ,CHK.NUMBER                                                           AS CHEQUENUMBER
  ,replace(TRY_PARSE_JSON(info):currencyId,'""','')                      AS CURRENCY_ID  
  ,TO_NUMBER(replace(TRY_PARSE_JSON(info):floorplanId,'""',''))          AS FLOORPLAN_ID
  ,replace(value:ccData:lastFourCcNumber,'""','')                        AS LASTFOURCCNUMBER  
  ,replace(value:ccData:nextFourCcNumber,'""','')                        AS NEXTFOURCCNUMBER
  ,replace(value:paymentType,'""','')                                    AS PAYMENTTYPE
  ,replace(value:paymentStatus,'""','')                                  AS PAYMENTSTATUS
  ,replace(TRY_PARSE_JSON(info):revenueCenterName,'""','')               AS REVENUECENTERNAME
  ,replace(TRY_PARSE_JSON(info):tableName,'""','')                       AS TABLENAME
-- --Counts and Amounts--------------------------------------------------------------------------
   ,replace(TRY_PARSE_JSON(info):partySize,'""','')::NUMBER(38)       
                                                                        AS PARTYSIZE
   ,PAY.value:tip::NUMBER(38,4)                                         AS TIP
   ,PAY.value:amountAppliedToCheck::NUMBER(38,4)                        AS AMOUNTAPPLIEDTOCHECK
   ,PAY.value:change::NUMBER(38,4)                                      AS CHANGE   
   ,PAY.value:total::NUMBER(38,4)                                       AS TOTAL 
----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_CHEQUE             CHK 
    ,LATERAL FLATTEN(INPUT => 
    PARSE_JSON( '{PAYMENTS:' || CHK.PAYMENTS || '}' ),  path => 'PAYMENTS')
                                                                        PAY
  WHERE CHK.payments <> '' 
   AND CHK.PAYMENTS <> '__value_not_modified__'  
   AND NOT COALESCE(TRUNCATED,FALSE)
   AND MTLN_CDC_LAST_CHANGE_TYPE <> 'd'
;"
VIEW,DATAADMIN,DAYPART_DIM,"create or replace view DAYPART_DIM(
	DAYPART_DIM_PK,
	DAYPART_DIM_NK,
	DAYPART,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	ORGANIZATION_DIM_FK,
	DELETED_AT,
	CREATED_AT,
	UPDATED_AT
) as
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  dad.ID                                                     AS DAYPART_DIM_PK
--natural keys------------------------------------------------------------------------------
  ,dad.ID                                                    AS DAYPART_DIM_NK
--name---------------------------------------------------------------------------------------
  ,dad.name                                                    AS DAYPART
--data warehouse rows------------------------------------------------------------------------
  ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(dad.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY dad.ID ORDER BY dad.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,dad.MTLN_CDC_SEQUENCE_NUMBER,dad.MTLN_CDC_SRC_VERSION
      ,dad.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(dad.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY dad.ID ORDER BY dad.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,dad.MTLN_CDC_SEQUENCE_NUMBER,dad.MTLN_CDC_SRC_VERSION,dad.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY dad.ID ORDER BY 
    dad.MTLN_CDC_LAST_COMMIT_TIMESTAMP,dad.MTLN_CDC_SEQUENCE_NUMBER,dad.MTLN_CDC_SRC_VERSION
   ,dad.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN dad.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY dad.ID ORDER BY  
    dad.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,dad.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,dad.MTLN_CDC_SRC_VERSION DESC
   ,dad.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     --REQUIRED
--CDC Meta data-------------------------------------------------------------------------------
  ,dad.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE
  ,dad.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,dad.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER
  ,dad.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID
  ,dad.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP
  ,dad.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,dad.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION
  ,dad.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME
  ,dad.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH
  ,dad.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE
  ,dad.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA
  ,dad.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE
--foreign keys-------------------------------------------------------------------------------
  ,IFNULL(dad.ORGANIZATION_ID,-1)      AS ORGANIZATION_DIM_FK
--flags---------------------------------------------------------------------------------------
--none
--Dates--------------.------------------------------------------------------------------------
  ,to_timestamp_tz(dad.DELETED_AT)     AS DELETED_AT
  ,to_timestamp_tz(dad.CREATED_AT)     AS CREATED_AT  
  ,to_timestamp_tz(dad.UPDATED_AT)     AS UPDATED_AT
--names, options, etc-------------------------------------------------------------------------
 --none
--Counts and Amounts--------------------------------------------------------------------------
 --none
----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_DAYPART     dad
;"
VIEW,DATAADMIN,MERCHANT_DIM,"create or replace view MERCHANT_DIM(
	MERCHANT_DIM_PK,
	MERCHANT_DIM_NK,
	MERCHANT,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	IS_GIFTCARDDISABED,
	CREATED_AT,
	UPDATED_AT,
	GIFTCARD_CREDIT_CEILING,
	GIFTCARD_DEBIT_CEILING,
	GIFTCARD_CREDIT_FLOOR
) as
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  dad.ID                                                       AS MERCHANT_DIM_PK
--natural keys------------------------------------------------------------------------------
  ,dad.ID                                                      AS MERCHANT_DIM_NK
--name---------------------------------------------------------------------------------------
  ,dad.NAME                                                    AS MERCHANT
--data warehouse rows------------------------------------------------------------------------
  ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(dad.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY dad.ID ORDER BY dad.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,dad.MTLN_CDC_SEQUENCE_NUMBER,dad.MTLN_CDC_SRC_VERSION
      ,dad.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(dad.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY dad.ID ORDER BY dad.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,dad.MTLN_CDC_SEQUENCE_NUMBER,dad.MTLN_CDC_SRC_VERSION,dad.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY dad.ID ORDER BY 
    dad.MTLN_CDC_LAST_COMMIT_TIMESTAMP,dad.MTLN_CDC_SEQUENCE_NUMBER,dad.MTLN_CDC_SRC_VERSION
   ,dad.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN dad.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY dad.ID ORDER BY  
    dad.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,dad.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,dad.MTLN_CDC_SRC_VERSION DESC
   ,dad.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     --REQUIRED
--CDC Meta data-------------------------------------------------------------------------------
  ,dad.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE
  ,dad.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,dad.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER
  ,dad.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID
  ,dad.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP
  ,dad.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,dad.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION
  ,dad.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME
  ,dad.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH
  ,dad.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE
  ,dad.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA
  ,dad.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE
--foreign keys-------------------------------------------------------------------------------
  -- ,IFNULL(dad.MERCHANT_ID,'-1')       AS MERCHANT_DIM_FK
--flags---------------------------------------------------------------------------------------
  ,dad.GIFTCARD_DISABLED::boolean      AS IS_GIFTCARDDISABED
  -- ,dad.IS_ISSUED::boolean              AS IS_ISSUED
--Dates--------------.------------------------------------------------------------------------
  ,to_timestamp_tz(dad.CREATED_AT)     AS CREATED_AT  
  ,to_timestamp_tz(dad.UPDATED_AT)     AS UPDATED_AT
--names, options, etc-------------------------------------------------------------------------
  -- ,dad.BATCH_ID                        AS BATCH_ID
--Counts and Amounts--------------------------------------------------------------------------
 --none
  ,dad.GIFTCARD_CREDIT_CEILING        AS GIFTCARD_CREDIT_CEILING
  ,dad.GIFTCARD_DEBIT_CEILING         AS GIFTCARD_DEBIT_CEILING
  ,dad.GIFTCARD_CREDIT_FLOOR          AS GIFTCARD_CREDIT_FLOOR
----------------------------------------------------------------------------------------------
FROM DATALANDING.GIFTCARD_PUBLIC_MERCHANTS    DAD
;"
VIEW,DATAADMIN,CLOSEOUTSUMMARY_FACT,"create or replace view CLOSEOUTSUMMARY_FACT(
	CLOSEOUTSUMMARY_FACT_PK,
	CLOSEOUTSUMMARY_FACT_NK,
	NAME,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	LOCATION_DIM_FK,
	CREATED_AT,
	UPDATED_AT,
	FISCAL_DATE,
	TAX,
	TIPS,
	VOIDS,
	DISCOUNTS,
	FEES,
	GRATUITIES,
	GROSS_RECEIPTS,
	GROSS_SALES
) as
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  to_char(tab.fiscal_day_int) || '.' || tab.location_id       AS CLOSEOUTSUMMARY_FACT_PK  
--natural keys------------------------------------------------------------------------------
  ,to_char(tab.fiscal_day_int) || '.' || tab.location_id      AS CLOSEOUTSUMMARY_FACT_NK  
--name-------------------------------------------------------------------------------------------
  ,tab.fiscal_day_int || ':' || tab.created_at                AS NAME
--data warehouse REQUIRED rows-------------------------------------------------------------------
 ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY to_char(tab.fiscal_day_int) || '.' || tab.location_id
      ORDER BY tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION
      ,tab.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY to_char(tab.fiscal_day_int) || '.' || tab.location_id
    ORDER BY tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION,tab.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (
    PARTITION BY to_char(tab.fiscal_day_int) || '.' || tab.location_id 
    ORDER BY 
    tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION
   ,tab.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          
  
  ,CASE WHEN tab.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED          
  ,CASE WHEN RANK() OVER(
  PARTITION BY to_char(tab.fiscal_day_int) || '.' || tab.location_id
  ORDER BY  
    tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,tab.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,tab.MTLN_CDC_SRC_VERSION DESC
   ,tab.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     
--CDC Meta data REQUIRED rows-------------------------------------------------------------------------------
  ,tab.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE                   
  ,tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP              
  ,tab.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER                    
  ,tab.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID                      
  ,tab.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP                     
  ,tab.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR                
  ,tab.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION                        
  ,tab.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME                           
  ,tab.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH                           
  ,tab.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE                       
  ,tab.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA                         
  ,tab.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE                          
--foreign keys-------------------------------------------------------------------------------
  ,tab.LOCATION_id                     AS LOCATION_DIM_FK 
--flags---------------------------------------------------------------------------------------
--ALLCOLUMN NAMES IN THIS SECTION SHOULD begin with is_ or has_ if created by the dw.
--   columns created by the source app should be specifically cast as boolean 
--Alphabetize between the lines
--Dates--------------.------------------------------------------------------------------------
--dates should be cast as dates
-- created_at timestamp with time zone  <--this is the create table from postgres
--,to_timestamp_tz(created_at) 
--Alphebetize between the lines
  ,to_timestamp_tz(tab.CREATED_AT)                  AS CREATED_AT  
  ,to_timestamp_tz(tab.UPDATED_AT)                  AS UPDATED_AT
  ,TO_DATE('20' || tab.FISCAL_DAY_INT,'YYYYMMDD')   AS FISCAL_DATE 
--names, options, etc-------------------------------------------------------------------------
--Counts and Amounts--------------------------------------------------------------------------
--ALL COLUMNS IN THIS SECTION SHOULD END IN COUNT OR AMOUNT
--Alphebetize between the lines
  ,TO_NUMBER(tab.TAX,38,4)/1000000 ::number(38,4)                AS TAX
  ,TO_NUMBER(tab.TIPS,38,4)/1000000 ::number(38,4)               AS TIPS
  ,TO_NUMBER(tab.VOIDS,38,4)/1000000  ::number(38,4)             AS VOIDS
  ,TO_NUMBER(tab.DISCOUNTS,38,4)/1000000::number(38,4)           AS DISCOUNTS  
  ,TO_NUMBER(tab.FEES,38,4)/1000000  ::number(38,4)              AS FEES
  ,TO_NUMBER(tab.GRATUITIES,38,4)/1000000::number(38,4)          AS GRATUITIES
  ,TO_NUMBER(tab.GROSS_RECEIPTS,38,4)/1000000 ::number(38,4)     AS GROSS_RECEIPTS
  ,TO_NUMBER(tab.GROSS_SALES,38,4)/1000000  ::number(38,4)       AS GROSS_SALES
-- ----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_CLOSEOUT_SUMMARY     tab
;"
VIEW,DATAADMIN,EMPLOYMENTPERIOD_DIM,"create or replace view EMPLOYMENTPERIOD_DIM(
	EMPLOYMENTPERIOD_DIM_PK,
	EMPLOYMENTPERIOD_DIM_NK,
	EMPLOYMENTPERIOD_ID,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	EMPLOYEE_DIM_FK,
	JOBPOSITION_DIM_FK,
	LOCATION_DIM_FK,
	LOCATION_GROUP_DIM_FK,
	CREATED_AT,
	UPDATED_AT,
	STARTED_AT,
	ENDED_AT,
	PAY_RATE_AMOUNT,
	PAY_RATE_PER_SECOND
) as
--============================================================================================
SELECT 
--primary keys--------------------------------------------------------------------------------
  tab.ID                                                      AS EMPLOYMENTPERIOD_DIM_PK   
--natural keys--------------------------------------------------------------------------------
  ,tab.ID                                                     AS EMPLOYMENTPERIOD_DIM_NK   
--name-----------------------------------------------------------------------------------------
  ,tab.ID                                                     AS EMPLOYMENTPERIOD_ID
--data warehouse REQUIRED rows-----------------------------------------------------------------
 ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY tab.ID ORDER BY tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION
      ,tab.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE      
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY tab.ID ORDER BY tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION,tab.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY tab.ID ORDER BY 
    tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION
   ,tab.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE         
  
  ,CASE WHEN tab.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED            
  ,CASE WHEN RANK() OVER(PARTITION BY tab.ID ORDER BY  
    tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,tab.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,tab.MTLN_CDC_SRC_VERSION DESC
   ,tab.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     
--CDC Meta data REQUIRED rows----------------------------------------------------------------------------
  ,tab.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE                   
  ,tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP             
  ,tab.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER                    
  ,tab.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID                     
  ,tab.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP                    
  ,tab.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR              
  ,tab.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION                        
  ,tab.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME                          
  ,tab.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH                    
  ,tab.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE                     
  ,tab.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA                         
  ,tab.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE                          
--foreign keys-------------------------------------------------------------------------------
  ,IFNULL(tab.EMPLOYEE_ID,-1)                     AS EMPLOYEE_DIM_FK
  ,IFNULL(tab.JOB_POSITION_ID,-1)                 AS JOBPOSITION_DIM_FK
  ,IFNULL(tab.LOCATION_ID,-1)                     AS LOCATION_DIM_FK 
  ,IFNULL(tab.LOCATION_GROUP_ID,-1)               AS LOCATION_GROUP_DIM_FK
--flags---------------------------------------------------------------------------------------
--Dates--------------.------------------------------------------------------------------------
  ,to_timestamp_tz(tab.CREATED_AT)     AS CREATED_AT  
  ,to_timestamp_tz(tab.UPDATED_AT)     AS UPDATED_AT
  ,to_timestamp_tz(tab.START_DATE)     AS STARTED_AT
  ,to_timestamp_tz(tab.END_DATE)       AS ENDED_AT  
--names, options, etc-------------------------------------------------------------------------
--Counts and Amounts--------------------------------------------------------------------------
  ,TO_NUMBER(tab.PAY_RATE,38,0) / 1000000           AS PAY_RATE_AMOUNT
  ,(TO_NUMBER(tab.PAY_RATE,38,0) / 1000000) / (60)  AS PAY_RATE_PER_SECOND  
-- -------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_EMPLOYMENT_PERIOD     tab
;"
VIEW,DATAADMIN,GIFTCARDTRANSACTION_FACT,"create or replace view GIFTCARDTRANSACTION_FACT(
	GIFTCARDTRANSACTION_FACT_PK,
	GIFTCARDTRANSACTION_FACT_NK,
	TRANSACTION,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	GIFTCARD_DIM_FK,
	CHEQUE_FACT_FK,
	LOCATION_DIM_FK,
	ADJUSTED_BY_ID,
	ADJUSTS_ID,
	ADJUSTER,
	IS_VOIDED,
	IS_ADJUSTED,
	CREATED_AT,
	UPDATED_AT,
	AUTH_GUID,
	COMMAND,
	CARD_ENTRY_METHOD,
	CURRENCY_CODE,
	AMOUNT,
	ADJUSTED_AMOUNT,
	TRANSACTION_AMOUNT,
	TIP,
	TOTAL,
	BALANCE,
	OPENING_BALANCE,
	CLOSING_BALANCE
) as
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------ 
   GCD.ID                                                            AS GIFTCARDTRANSACTION_FACT_PK
--natural keys------------------------------------------------------------------------------
  ,GCD.ID                                                            AS GIFTCARDTRANSACTION_FACT_NK
--name---------------------------------------------------------------------------------------
  ,GCD.TRAN_NBR                                                      AS TRANSACTION
--data warehouse rows------------------------------------------------------------------------
  ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(GCD.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY 
        GCD.ID 
        ORDER BY GCD.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,GCD.MTLN_CDC_SEQUENCE_NUMBER,GCD.MTLN_CDC_SRC_VERSION
      ,GCD.MTLN_CDC_FILENAME)),6))
                                                                      AS DW_STARTDATE        
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(GCD.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY 
    GCD.ID
    ORDER BY GCD.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,GCD.MTLN_CDC_SEQUENCE_NUMBER,GCD.MTLN_CDC_SRC_VERSION,GCD.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY GCD.ID  ORDER BY 
    GCD.MTLN_CDC_LAST_COMMIT_TIMESTAMP,GCD.MTLN_CDC_SEQUENCE_NUMBER,GCD.MTLN_CDC_SRC_VERSION
   ,GCD.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                                       AS DW_ENDDATE         
  
  ,CASE WHEN GCD.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                           AS DW_ISDELETED          
  ,CASE WHEN RANK() OVER(PARTITION BY  GCD.ID 
    ORDER BY  
    GCD.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,GCD.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,GCD.MTLN_CDC_SRC_VERSION DESC
   ,GCD.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                                        AS DW_ISCURRENTROW    
--CDC Meta data-------------------------------------------------------------------------------
  ,GCD.MTLN_CDC_LAST_CHANGE_TYPE                                        AS MTLN_CDC_LAST_CHANGE_TYPE
  ,GCD.MTLN_CDC_LAST_COMMIT_TIMESTAMP                                   AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,GCD.MTLN_CDC_SEQUENCE_NUMBER                                         AS MTLN_CDC_SEQUENCE_NUMBER
  ,GCD.MTLN_CDC_LOAD_BATCH_ID                                           AS MTLN_CDC_LOAD_BATCH_ID
  ,GCD.MTLN_CDC_LOAD_TIMESTAMP                                          AS MTLN_CDC_LOAD_TIMESTAMP
  ,GCD.MTLN_CDC_PROCESSED_DATE_HOUR                                     AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,GCD.MTLN_CDC_SRC_VERSION                                             AS MTLN_CDC_SRC_VERSION
  ,GCD.MTLN_CDC_FILENAME                                                AS MTLN_CDC_FILENAME
  ,GCD.MTLN_CDC_FILEPATH                                                AS MTLN_CDC_FILEPATH
  ,GCD.MTLN_CDC_SRC_DATABASE                                            AS MTLN_CDC_SRC_DATABASE
  ,GCD.MTLN_CDC_SRC_SCHEMA                                              AS MTLN_CDC_SRC_SCHEMA
  ,GCD.MTLN_CDC_SRC_TABLE                                               AS MTLN_CDC_SRC_TABLE
--foreign keys-------------------------------------------------------------------------------
  ,IFNULL(REPLACE(GCD.GIFTCARD_ID,'""',''),'-1')                         AS GIFTCARD_DIM_FK
  ,IFNULL(TRY_TO_NUMBER(gcd.POS_CHECK_ID),-1)                           AS CHEQUE_FACT_FK
  ,IFNULL(GCD.LOCATION_ID,-1)                                           AS LOCATION_DIM_FK    
  ,GCD.ADJUSTED_BY_ID                                                   AS ADJUSTED_BY_ID
  ,GCD.ADJUSTS_ID                                                       AS ADJUSTS_ID 
  ,CASE WHEN ADJUSTED_BY_ID IS NOT NULL 
      THEN GCD.ID -1 ELSE ADJUSTS_ID END                                AS ADJUSTER
--flags---------------------------------------------------------------------------------------
  ,REPLACE(GCD.IS_VOIDED,'""','')  ::BOOLEAN                             AS IS_VOIDED
  ,REPLACE(GCD.IS_ADJUSTED,'""','')::BOOLEAN                             AS IS_ADJUSTED  
--Dates--------------.------------------------------------------------------------------------
  ,to_timestamp_tz(GCD.CREATED_AT)                                      AS CREATED_AT   
  ,to_timestamp_tz(GCD.UPDATED_AT)                                      AS UPDATED_AT
 -- ,to_timestamp_tz(replace(value:ccData:expirationDate,'""',''))       AS EXPIRATIONDATE   

--names, options, etc-------------------------------------------------------------------------
  ,gcd.AUTH_GUID                                                        AS AUTH_GUID
  ,gcd.COMMAND                                                          AS COMMAND
  ,gcd.CARD_ENTRY_METHOD                                                AS CARD_ENTRY_METHOD
  ,gcd.CURRENCY_CODE                                                    AS CURRENCY_CODE
--Counts and Amounts--------------------------------------------------------------------------
   ,GCD.AMOUNT::NUMBER(38,4)                                            AS AMOUNT
   -- ,SUM(CASE WHEN gcd.ADJUSTED_BY_ID IS NOT NULL 
   --    THEN GCD.AMOUNT * CASE WHEN GCD.COMMAND IN ('NoNSFSale','Adjust','VoidReload','VoidIssue') 
   --       THEN -1 ELSE 1 END
   --  ELSE 0 END) OVER (PARTITION by GCD.ID,GCD.ADJUSTED_BY_ID) 
   --                                                                      AS ADJUSTEMENT_AMOUNT
   ,IFNULL(LAG(GCD.AMOUNT * CASE WHEN GCD.COMMAND IN ('NoNSFSale','Adjust','VoidReload','VoidIssue')
     THEN -1 ELSE 1 END)
      OVER (PARTITION BY GCD.ID ORDER BY CASE WHEN ADJUSTED_BY_ID IS NOT NULL 
      THEN GCD.ID -1 ELSE ADJUSTS_ID END),0)  
                                                                        AS ADJUSTED_AMOUNT  

   ,GCD.AMOUNT - IFNULL(LAG(GCD.AMOUNT * CASE WHEN GCD.COMMAND IN ('NoNSFSale','Adjust','VoidReload','VoidIssue')
     THEN -1 ELSE 1 END)
      OVER (PARTITION BY GCD.ID ORDER BY CASE WHEN ADJUSTED_BY_ID IS NOT NULL 
      THEN GCD.ID -1 ELSE ADJUSTS_ID END),0)  
   
                                                                        AS TRANSACTION_AMOUNT                                                                        


                                                                        
   ,GCD.TIP::NUMBER(38,4)                                               AS TIP
   ,GCD.TOTAL::NUMBER(38,4)                                             AS TOTAL
   ,GCD.BALANCE::NUMBER(38,4)                                           AS BALANCE
   ,LAG(GCD.BALANCE) OVER (PARTITION BY GCD.GIFTCARD_ID ORDER BY GCD.CREATED_AT) ::NUMBER(18,2) 
                                                                        AS OPENING_BALANCE   
   ,GCD.BALANCE::NUMBER(38,4)                                           AS CLOSING_BALANCE
----------------------------------------------------------------------------------------------
FROM DATALANDING.GIFTCARD_PUBLIC_GIFTCARD_TX                            GCD

;"
VIEW,DATAADMIN,MODIFIER_DIM,"create or replace view MODIFIER_DIM(
	MODIFIER_DIM_PK,
	MODIFIER_DIM_NK,
	MODIFIER,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	MODIFIERGROUP_DIM_FK,
	INGREDIENT_DIM_FK,
	CREATED_AT,
	UPDATED_AT
) as
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  vao.ID                                                     AS MODIFIER_DIM_PK
--natural keys------------------------------------------------------------------------------
  ,vao.ID                                                    AS MODIFIER_DIM_NK
--name---------------------------------------------------------------------------------------
    ,vao.name                                                AS MODIFIER
--data warehouse rows------------------------------------------------------------------------
  ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(vao.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY vao.ID ORDER BY vao.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,vao.MTLN_CDC_SEQUENCE_NUMBER,vao.MTLN_CDC_SRC_VERSION
      ,vao.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(vao.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY vao.ID ORDER BY vao.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,vao.MTLN_CDC_SEQUENCE_NUMBER,vao.MTLN_CDC_SRC_VERSION,vao.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY vao.ID ORDER BY 
    vao.MTLN_CDC_LAST_COMMIT_TIMESTAMP,vao.MTLN_CDC_SEQUENCE_NUMBER,vao.MTLN_CDC_SRC_VERSION
   ,vao.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN vao.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY vao.ID ORDER BY  
    vao.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,vao.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,vao.MTLN_CDC_SRC_VERSION DESC
   ,vao.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     --REQUIRED
--CDC Meta data-------------------------------------------------------------------------------
  ,vao.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE
  ,vao.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,vao.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER
  ,vao.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID
  ,vao.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP
  ,vao.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,vao.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION
  ,vao.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME
  ,vao.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH
  ,vao.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE
  ,vao.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA
  ,vao.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE
--foreign keys-------------------------------------------------------------------------------
  ,IFNULL(vao.MODIFIER_GROUP_ID,-1)    AS MODIFIERGROUP_DIM_FK
  ,IFNULL(vao.INGREDIENT_ID,-1)        AS INGREDIENT_DIM_FK
--flags---------------------------------------------------------------------------------------
  --none--
--Dates--------------.------------------------------------------------------------------------
  ,to_timestamp_tz(vao.CREATED_AT)     AS CREATED_AT  
  ,to_timestamp_tz(vao.UPDATED_AT)     AS UPDATED_AT  
--names, options, etc-------------------------------------------------------------------------
--Counts and Amounts--------------------------------------------------------------------------
  --none
----------------------------------------------------------------------------------------------
FROM DATALANDING.posapi_public_modifier     vao
;"
VIEW,DATAADMIN,REVENUECENTER_DIM,"create or replace view REVENUECENTER_DIM(
	REVENUECENTER_DIM_PK,
	REVENUECENTER_DIM_NK,
	REVENUECENTER,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	CREATED_AT,
	UPDATED_AT,
	RECEIPT_FOOTER
) as
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  tab.ID                                                      AS REVENUECENTER_DIM_PK  --REQUIRED
--natural keys------------------------------------------------------------------------------
  ,tab.ID                                                     AS REVENUECENTER_DIM_NK  --REQUIRED
--name-------------------------------------------------------------------------------------------
  ,tab.NAME                                                   AS REVENUECENTER
--data warehouse REQUIRED rows-------------------------------------------------------------------
,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY tab.ID ORDER BY tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION
      ,tab.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY tab.ID ORDER BY tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION,tab.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY tab.ID ORDER BY 
    tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION
   ,tab.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN tab.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY tab.ID ORDER BY  
    tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,tab.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,tab.MTLN_CDC_SRC_VERSION DESC
   ,tab.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     --REQUIRED
--CDC Meta data REQUIRED rows-------------------------------------------------------------------------------
  ,tab.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE                   --REQUIRED
  ,tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP              --REQUIRED
  ,tab.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER                    --REQUIRED
  ,tab.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID                      --REQUIRED
  ,tab.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP                     --REQUIRED
  ,tab.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR                --R EQUIRED
  ,tab.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION                        --REQUIRED
  ,tab.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME                           --REQUIRED
  ,tab.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH                           --REQUIRED
  ,tab.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE                       --REQUIRED
  ,tab.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA                         --REQUIRED
  ,tab.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE                          --REQUIRED
--foreign keys-------------------------------------------------------------------------------
  -- ,IFNULL(tab.LOCATION_ID,-1)          AS LOCATION_DIM_FK 
--flags---------------------------------------------------------------------------------------
--ALLCOLUMN NAMES IN THIS SECTION SHOULD begin with is_ or has_ if created by the dw.
--   columns created by the source app should be specifically cast as boolean 
--Dates--------------.------------------------------------------------------------------------
--dates should be cast as dates
-- created_at timestamp with time zone  <--this is the create table from postgres
--,to_timestamp_tz(created_at) 
  ,to_timestamp_tz(tab.CREATED_AT)     AS CREATED_AT  
  ,to_timestamp_tz(tab.UPDATED_AT)     AS UPDATED_AT
--names, options, etc-------------------------------------------------------------------------
  ,tab.RECEIPT_FOOTER                  AS RECEIPT_FOOTER
--Counts and Amounts--------------------------------------------------------------------------
-- ----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_REVENUE_CENTER     tab
;"
VIEW,DATAADMIN,TAX_FACT,"create or replace view TAX_FACT(
	TAX_FACT_PK,
	TAX_FACT_NK,
	TAXRATENAME,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	CHEQUE_FACT_FK,
	DAYPART_DIM_FK,
	EMPLOYEE_DIM_FK,
	ITEM_FACT_FK,
	LOCATION_DIM_FK,
	MENUITEM_DIM_FK,
	MENUITEMNAME_DIM_FK,
	ORDERTYPE_DIM_FK,
	TAX_RATE_ID,
	IS_TRAINING,
	IS_TAX_INCLUDED,
	CLOSED_AT,
	CREATED_AT,
	FISCAL_DATE,
	OPENED_AT,
	UPDATED_AT,
	CHECKSTATUS,
	ITEMSTATUS,
	REVENUECENTERNAME,
	ROUNDINGMETHOD,
	CHEQUENUMBER,
	ITEM_ID,
	CHECKTOTALINCLUSIVETAX,
	CHECKTOTALTAX,
	TAXBASIS,
	AMOUNT,
	PERCENT
) as

--============================================================================================
SELECT  
TO_VARCHAR(CHK.ID) || '.'  ||replace(ITM.VALUE:id,'""','') || '.' || TO_CHAR(TAX.index)                        
                                                                             AS TAX_FACT_PK
--natural keys------------------------------------------------------------------------------
  ,TO_VARCHAR(CHK.ID) || '.'  ||replace(ITM.VALUE:id,'""','') || '.' || TO_CHAR(TAX.index)                     
                                                                             AS TAX_FACT_NK
--name---------------------------------------------------------------------------------------
 , REPLACE(TAX.value:taxRateName,'""','')                                     AS TAXRATENAME
-- --data warehouse rows--------------------------------------------------------------------------
   ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(row_number() OVER (
      PARTITION BY 
      
     TO_VARCHAR(CHK.ID) || '.'  ||replace(ITM.VALUE:id,'""','') || '.' || TO_CHAR(TAX.index)
      
       ORDER BY CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION
      ,CHK.MTLN_CDC_FILENAME)),6))
                                                                             AS DW_STARTDATE       
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY 
    
    TO_VARCHAR(CHK.ID) || '.'  ||replace(ITM.VALUE:id,'""','') || '.' || TO_CHAR(TAX.index)
    
     ORDER BY CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION,CHK.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(row_number() OVER (
    
    PARTITION BY 
    TO_VARCHAR(CHK.ID) || '.'  ||replace(ITM.VALUE:id,'""','') || '.' || TO_CHAR(TAX.index)
    
     ORDER BY 
    CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION
   ,CHK.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                                           AS DW_ENDDATE          
  
  ,CASE WHEN CHK.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                               AS DW_ISDELETED               
  ,CASE WHEN row_number() OVER(
  PARTITION BY 
   TO_VARCHAR(CHK.ID) || '.'  ||replace(ITM.VALUE:id,'""','') || '.' || TO_CHAR(TAX.index)
  
  ORDER BY  
    CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,CHK.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,CHK.MTLN_CDC_SRC_VERSION DESC
   ,CHK.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                                           AS DW_ISCURRENTROW     
--CDC Meta data-------------------------------------------------------------------------------
  ,CHK.MTLN_CDC_LAST_CHANGE_TYPE                     AS MTLN_CDC_LAST_CHANGE_TYPE
  ,CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP                AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,CHK.MTLN_CDC_SEQUENCE_NUMBER                      AS MTLN_CDC_SEQUENCE_NUMBER
  ,CHK.MTLN_CDC_LOAD_BATCH_ID                        AS MTLN_CDC_LOAD_BATCH_ID
  ,CHK.MTLN_CDC_LOAD_TIMESTAMP                       AS MTLN_CDC_LOAD_TIMESTAMP
  ,CHK.MTLN_CDC_PROCESSED_DATE_HOUR                  AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,CHK.MTLN_CDC_SRC_VERSION                          AS MTLN_CDC_SRC_VERSION
  ,CHK.MTLN_CDC_FILENAME                             AS MTLN_CDC_FILENAME
  ,CHK.MTLN_CDC_FILEPATH                             AS MTLN_CDC_FILEPATH
  ,CHK.MTLN_CDC_SRC_DATABASE                         AS MTLN_CDC_SRC_DATABASE
  ,CHK.MTLN_CDC_SRC_SCHEMA                           AS MTLN_CDC_SRC_SCHEMA
  ,CHK.MTLN_CDC_SRC_TABLE                            AS MTLN_CDC_SRC_TABLE
-- --foreign keys-------------------------------------------------------------------------------
  ,IFNULL(CHK.ID,-1)                                 AS CHEQUE_FACT_FK 
  ,IFNULL(CHK.day_part_id,-1)                        AS DAYPART_DIM_FK  
  ,IFNULL(CHK.EMPLOYEE_ID,-1)                        AS EMPLOYEE_DIM_FK
  ,CHK.ID || '.'  || replace(ITM.VALUE:id,'""','')    AS ITEM_FACT_FK
  ,IFNULL(CHK.LOCATION_ID,-1)                        AS LOCATION_DIM_FK  
  -- ,IFNULL(TO_NUMBER(replace(replace(split_part(
  --   replace(ITM.value:menuItem:path,'',''),'.',2),'{',''),'}','') ),-1)
  --                                                   AS MENUGROUP_DIM_FK
  ,IFNULL(TO_NUMBER(ITM.value:menuItem:menuItemId),-1)       
                                                     AS MENUITEM_DIM_FK     
  ,IFNULL(TO_NUMBER(ITM.value:menuItem:menuItemNameId),-1)   
                                                     AS MENUITEMNAME_DIM_FK
  ,IFNULL(CHK.order_type_id,-1)                      AS ORDERTYPE_DIM_FK                                                
  ,TAX.value:taxRateId::NUMBER(38,0)                 AS TAX_RATE_ID  



-- --flags---------------------------------------------------------------------------------------
   ,CHK.IS_TRAINING::BOOLEAN                         AS IS_TRAINING 
   ,TAX.value:isTaxIncluded::BOOLEAN                 AS IS_TAX_INCLUDED
-- --Dates--------------.------------------------------------------------------------------------
  ,to_timestamp_tz(CHK.closed_at)                    AS CLOSED_AT
  ,to_timestamp_tz(CHK.CREATED_AT)                   AS CREATED_AT 
  ,TO_CHAR(max(TRY_PARSE_JSON(CHK.info):fiscalDate) over (partition by chk.id))::DATE    
                                                     AS FISCAL_DATE 
  ,to_timestamp_tz(CHK.OPENED_AT)                    AS OPENED_AT 
  ,to_timestamp_tz(CHK.UPDATED_AT)                   AS UPDATED_AT
--names, options, etc-------------------------------------------------------------------------
  ,CHK.STATUS                                        AS CHECKSTATUS
  ,replace(ITM.value:status,'""','')                  AS ITEMSTATUS
  ,IFNULL(replace(TRY_PARSE_JSON(CHK.info):revenueCenterName,'""','') ,'None')               
                                                     AS REVENUECENTERNAME
  ,IFNULL(replace(TRY_PARSE_JSON(CHK.info):taxSettings:roundingMethod,'""',''),'None')       
                                                     AS ROUNDINGMETHOD
-- --name---------------------------------------------------------------------------------------
  ,CHK.NUMBER                                                                AS CHEQUENUMBER  
  ,replace(ITM.VALUE:id,'""','')                                              AS ITEM_ID
--Counts and Amounts--------------------------------------------------------------------------
 ,TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):inclusiveTax), 38,4)     AS CHECKTOTALINCLUSIVETAX
 ,TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):tax), 38,4)              AS CHECKTOTAlTAX
 ,TAX.value:taxBasis::NUMBER(38,4)                                           AS TAXBASIS
 ,TAX.value:tax::NUMBER(38,4)                                                AS AMOUNT
 ,TAX.value:percent::NUMBER(38,4)                                            AS PERCENT
----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_CHEQUE                          CHK 
    ,LATERAL FLATTEN(INPUT => 
    TRY_PARSE_JSON( '{ITEMS:' || CHK.ITEMS || '}' ), PATH => 'ITEMS')
                                                               ITM 
  ,LATERAL FLATTEN(INPUT => 
    TRY_PARSE_JSON('{taxes:' || TRY_PARSE_JSON(ITM.value):taxes || '}'), PATH => 'taxes')
                                                               TAX 
WHERE NOT COALESCE(TRUNCATED,FALSE)
  AND MTLN_CDC_LAST_CHANGE_TYPE <> 'd' 
   -- and TAX_FACT_NK = '53368.5a713e5d-7a4a-4e4b-a69f-1669bdb86e96.0'
   -- order by chk.MTLN_CDC_SEQUENCE_NUMBER
;"
VIEW,DATAADMIN,INTEGRATIONTYPE_DIM,"create or replace view INTEGRATIONTYPE_DIM(
	INTEGRATIONTYPE_DIM_PK,
	INTEGRATIONTYPE_DIM_NK,
	INTEGRATIONTYPE,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	CREATED_AT,
	UPDATED_AT
) as
--============================================================================================
SELECT 
--primary keys--------------------------------------------------------------------------------
  tab.ID                                                      AS INTEGRATIONTYPE_DIM_PK  
--natural keys--------------------------------------------------------------------------------
  ,tab.ID                                                     AS INTEGRATIONTYPE_DIM_NK  
--name-----------------------------------------------------------------------------------------
  ,tab.NAME                                                   AS INTEGRATIONTYPE
--data warehouse REQUIRED rows----------------------------------------------------------------
 ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY tab.ID ORDER BY tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION
      ,tab.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY tab.ID ORDER BY tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION,tab.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY tab.ID ORDER BY 
    tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION
   ,tab.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          
  
  ,CASE WHEN tab.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED            
  ,CASE WHEN RANK() OVER(PARTITION BY tab.ID ORDER BY  
    tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,tab.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,tab.MTLN_CDC_SRC_VERSION DESC
   ,tab.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW      
--CDC Meta data REQUIRED rows----------------------------------------------------------------
  ,tab.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE                    
  ,tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP               
  ,tab.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER                     
  ,tab.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID                       
  ,tab.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP                      
  ,tab.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR                 
  ,tab.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION                         
  ,tab.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME                            
  ,tab.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH                            
  ,tab.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE                        
  ,tab.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA                          
  ,tab.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE                          
--foreign keys-------------------------------------------------------------------------------
--flags---------------------------------------------------------------------------------------
--ALLCOLUMN NAMES IN THIS SECTION SHOULD begin with is_ or has_ if created by the dw.
--   columns created by the source app should be specifically cast as boolean 
--Dates--------------.------------------------------------------------------------------------
--dates should be cast as dates
-- created_at timestamp with time zone  <--this is the create table from postgres
--,to_timestamp_tz(created_at) 
  ,to_timestamp_tz(tab.CREATED_AT)     AS CREATED_AT  
  ,to_timestamp_tz(tab.UPDATED_AT)     AS UPDATED_AT

--names, options, etc-------------------------------------------------------------------------
--Counts and Amounts--------------------------------------------------------------------------
-- --------------------------------------------------------------------------------------------
FROM DATALANDING.posapi_public_integration_type     tab
;"
VIEW,DATAADMIN,ORGANIZATION_DIM,"create or replace view ORGANIZATION_DIM(
	ORGANIZATION_DIM_PK,
	ORGANIZATION_DIM_NK,
	ORGANIZATION,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	DO_AUTO_END_SHIFTS,
	FISCAL_DAY_START,
	START_OF_PAYROLL_WEEK_INT,
	START_OF_BIZ_WEEK_INT,
	CREATED_AT,
	UPDATED_AT,
	STATUS,
	VERSION,
	SERVICE_LEVEL,
	DEFAULT_CURRENCY,
	SUPPORTED_CURRENCIES
) as
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  org.ID                                                     AS ORGANIZATION_DIM_PK
--natural keys------------------------------------------------------------------------------
  ,org.ID                                                    AS ORGANIZATION_DIM_NK
--name---------------------------------------------------------------------------------------
  ,org.NAME                                                  AS ORGANIZATION
--data warehouse rows------------------------------------------------------------------------
 ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(org.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY org.ID ORDER BY org.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,org.MTLN_CDC_SEQUENCE_NUMBER,org.MTLN_CDC_SRC_VERSION
      ,org.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE        
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(org.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY org.ID ORDER BY org.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,org.MTLN_CDC_SEQUENCE_NUMBER,org.MTLN_CDC_SRC_VERSION,org.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY org.ID ORDER BY 
    org.MTLN_CDC_LAST_COMMIT_TIMESTAMP,org.MTLN_CDC_SEQUENCE_NUMBER,org.MTLN_CDC_SRC_VERSION
   ,org.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          
  
  ,CASE WHEN org.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED             
  ,CASE WHEN RANK() OVER(PARTITION BY org.ID ORDER BY  
    org.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,org.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,org.MTLN_CDC_SRC_VERSION DESC
   ,org.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW      
--CDC Meta data-------------------------------------------------------------------------------
  ,org.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE
  ,org.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,org.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER
  ,org.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID
  ,org.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP
  ,org.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,org.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION
  ,org.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME
  ,org.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH
  ,org.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE
  ,org.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA
  ,org.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE
--foreign keys-------------------------------------------------------------------------------
  --none
--flags---------------------------------------------------------------------------------------
  ,org.DO_AUTO_END_SHIFTS              AS DO_AUTO_END_SHIFTS
--Dates--------------.------------------------------------------------------------------------
-- ,TIMESTAMPADD('Seconds',LOC.FISCAL_DAY_START,'')
  ,TO_NUMBER(org.fiscal_day_start)/1000 ::NUMBER(38,0) 
                                       AS FISCAL_DAY_START 
  ,TO_NUMBER(org.start_of_payroll_week)AS START_OF_PAYROLL_WEEK_INT
  ,TO_NUMBER(org.start_of_biz_week)    AS START_OF_BIZ_WEEK_INT
  ,TO_TIMESTAMP_TZ(org.created_at)     AS CREATED_AT
  ,TO_TIMESTAMP_TZ(org.updated_at)     AS UPDATED_AT  
--names, options, etc-------------------------------------------------------------------------
  ,org.status                          AS STATUS
  ,org.version                         AS VERSION
  ,org.service_level                   AS SERVICE_LEVEL
  ,org.default_currency                AS DEFAULT_CURRENCY
  ,replace(replace(replace(
        supported_currencies,'[',' '),']',''),'""','') 
                                       AS SUPPORTED_CURRENCIES    
--Counts and Amounts--------------------------------------------------------------------------
--none
----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_ORGANIZATION    org
;"
VIEW,DATAADMIN,PHONENUMBER_DIM,"create or replace view PHONENUMBER_DIM(
	PHONENUMBER_DIM_PK,
	PHONENUMBER_DIM_NK,
	PHONE,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	CREATED_AT,
	UPDATED_AT,
	KIND,
	REGION,
	EXTENSION,
	COUNTRY_CODE,
	FUZZY_VECTOR
) as
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  PHN.ID                                                     AS PHONENUMBER_DIM_PK
--natural keys------------------------------------------------------------------------------
  ,PHN.ID                                                    AS PHONENUMBER_DIM_NK
--name---------------------------------------------------------------------------------------
  ,PHN.PHONE                                                 AS PHONE
--data warehouse rows------------------------------------------------------------------------
 ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(PHN.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY PHN.ID ORDER BY PHN.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,PHN.MTLN_CDC_SEQUENCE_NUMBER,PHN.MTLN_CDC_SRC_VERSION
      ,PHN.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(PHN.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY PHN.ID ORDER BY PHN.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,PHN.MTLN_CDC_SEQUENCE_NUMBER,PHN.MTLN_CDC_SRC_VERSION,PHN.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY PHN.ID ORDER BY 
    PHN.MTLN_CDC_LAST_COMMIT_TIMESTAMP,PHN.MTLN_CDC_SEQUENCE_NUMBER,PHN.MTLN_CDC_SRC_VERSION
   ,PHN.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN PHN.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY PHN.ID ORDER BY  
    PHN.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,PHN.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,PHN.MTLN_CDC_SRC_VERSION DESC
   ,PHN.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     --REQUIRED
--CDC Meta data-------------------------------------------------------------------------------
  ,PHN.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE
  ,PHN.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,PHN.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER
  ,PHN.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID
  ,PHN.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP
  ,PHN.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,PHN.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION
  ,PHN.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME
  ,PHN.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH
  ,PHN.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE
  ,PHN.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA
  ,PHN.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE
--foreign keys-------------------------------------------------------------------------------
--NONE
--flags---------------------------------------------------------------------------------------
--NONE
--Dates--------------.------------------------------------------------------------------------
  ,to_timestamp_tz(PHN.CREATED_AT)     AS CREATED_AT   
  ,to_timestamp_tz(PHN.UPDATED_AT)     AS UPDATED_AT
--names, options, etc-------------------------------------------------------------------------
  ,PHN.KIND                            AS KIND
  ,PHN.REGION                          AS REGION
  ,PHN.EXTENSION                       AS EXTENSION
  ,PHN.COUNTRY_CODE                    AS COUNTRY_CODE
  ,PHN.FUZZY_VECTOR                    AS FUZZY_VECTOR
--Counts and Amounts--------------------------------------------------------------------------
--NONE
----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_PHONE_NUMBER     PHN
;"
VIEW,DATAADMIN,VARIANT_DIM,"create or replace view VARIANT_DIM(
	VARIANT_DIM_PK,
	VARIANT_DIM_NK,
	VARIANT,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	ORGANIZATION_DIM_FK,
	VTYPE
) as
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  vao.ID                                                     AS VARIANT_DIM_PK
--natural keys------------------------------------------------------------------------------
  ,vao.ID                                                    AS VARIANT_DIM_NK
--name---------------------------------------------------------------------------------------
    ,vao.name                                                AS VARIANT
--data warehouse rows------------------------------------------------------------------------
  ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(vao.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY vao.ID ORDER BY vao.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,vao.MTLN_CDC_SEQUENCE_NUMBER,vao.MTLN_CDC_SRC_VERSION
      ,vao.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(vao.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY vao.ID ORDER BY vao.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,vao.MTLN_CDC_SEQUENCE_NUMBER,vao.MTLN_CDC_SRC_VERSION,vao.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY vao.ID ORDER BY 
    vao.MTLN_CDC_LAST_COMMIT_TIMESTAMP,vao.MTLN_CDC_SEQUENCE_NUMBER,vao.MTLN_CDC_SRC_VERSION
   ,vao.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN vao.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY vao.ID ORDER BY  
    vao.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,vao.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,vao.MTLN_CDC_SRC_VERSION DESC
   ,vao.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     --REQUIRED
--CDC Meta data-------------------------------------------------------------------------------
  ,vao.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE
  ,vao.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,vao.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER
  ,vao.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID
  ,vao.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP
  ,vao.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,vao.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION
  ,vao.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME
  ,vao.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH
  ,vao.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE
  ,vao.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA
  ,vao.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE
--foreign keys-------------------------------------------------------------------------------
  ,IFNULL(vao.ORGANIZATION_ID,-1)      AS ORGANIZATION_DIM_FK
--flags---------------------------------------------------------------------------------------
  --none
--Dates--------------.------------------------------------------------------------------------
  -- ,to_timestamp_tz(vao.CREATED_AT)     AS CREATED_AT  --EXCEPTION NO SOURE COL WITH NAME
  -- ,to_timestamp_tz(vao.UPDATED_AT)     AS UPDATED_AT  --EXCEPTION NO SOURE COL WITH NAME
--names, options, etc-------------------------------------------------------------------------
  ,vao.vtype                           AS VTYPE
--Counts and Amounts--------------------------------------------------------------------------
  --none
----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_VARIANT_OPTION     vao
;"
VIEW,DATAADMIN,REFUNDS_FACT,"create or replace view REFUNDS_FACT(
	REFUNDS_FACT_PK,
	REFUNDS_FACT_NK,
	PAYMENTNUMBER,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	CCTRANSACTION_FACT_FK,
	CHEQUE_FACT_FK,
	DAYPART_DIM_FK,
	EMPLOYEE_DIM_FK_AS_CREATOR,
	EMPLOYEE_DIM_FK_AS_PAYEE,
	LOCATION_DIM_FK,
	PAYMENTMETHOD_DIM_FK,
	REVENUECENTER_DIM_FK,
	TRANSACTION_FACT_FK,
	TERMINAL_DIM_FK,
	IS_TRAINING,
	OPENED_AT,
	PAID_AT,
	REFUNDED_AT,
	FISCALDATE,
	BATCHNUMBER,
	REFUNDED_BY,
	CARDBRAND,
	CARDHOLDERNAME,
	CHEQUENUMBER,
	CURRENCY_ID,
	FLOORPLAN_ID,
	LASTFOURCCNUMBER,
	NEXTFOURCCNUMBER,
	PAYMENTTYPE,
	PAYMENTSTATUS,
	REVENUECENTERNAME,
	TABLENAME,
	CHECK_TOTAL_AMOUNT,
	REFUND_AMOUNT
) as
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------ 
   REPLACE(PAY.value:id,'""','') || '.' || REF.index                      AS REFUNDS_FACT_PK
--natural keys------------------------------------------------------------------------------
  ,REPLACE(PAY.value:id,'""','')  || '.' || REF.index                     AS REFUNDS_FACT_NK
--name---------------------------------------------------------------------------------------
  ,RIGHT('000000000000000' || PAY.INDEX, 16)                             AS PAYMENTNUMBER
--data warehouse rows------------------------------------------------------------------------
  ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY 
        REPLACE(PAY.value:id,'""','')  || '.' || REF.index
        ORDER BY CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION
      ,CHK.MTLN_CDC_FILENAME)),6))
                                                                         AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY 
    REPLACE(PAY.value:id,'""','')  || '.' || REF.index
    
    ORDER BY CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION,CHK.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY REPLACE(PAY.value:id,'""','')  || '.' || REF.index ORDER BY 
    CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION
   ,CHK.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                                         AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN CHK.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                             AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY  REPLACE(PAY.value:id,'""','')  || '.' || REF.index ORDER BY  
    CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,CHK.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,CHK.MTLN_CDC_SRC_VERSION DESC
   ,CHK.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                                         AS DW_ISCURRENTROW     --REQUIRED
--CDC Meta data-------------------------------------------------------------------------------
  ,CHK.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE
  ,CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,CHK.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER
  ,CHK.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID
  ,CHK.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP
  ,CHK.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,CHK.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION
  ,CHK.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME
  ,CHK.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH
  ,CHK.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE
  ,CHK.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA
  ,CHK.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE
--foreign keys-------------------------------------------------------------------------------
  ,IFNULL(REF.value:ccTransactionId::NUMBER(38,0),-1)         
                                                   AS CCTRANSACTION_FACT_FK
  ,IFNULL(CHK.ID,-1)                               AS CHEQUE_FACT_FK
  ,IFNULL(CHK.DAY_PART_ID,-1)                      AS DAYPART_DIM_FK
  ,IFNULL(CHK.EMPLOYEE_ID,-1)                      AS EMPLOYEE_DIM_FK_AS_CREATOR
  ,IFNULL(TO_NUMBER(PAY.value:employeeId),-1)      AS EMPLOYEE_DIM_FK_AS_PAYEE
  ,IFNULL(CHK.LOCATION_ID,-1)                      AS LOCATION_DIM_FK
  ,IFNULL(TO_NUMBER(PAY.value:paymentMethodId),-1) AS PAYMENTMETHOD_DIM_FK
  ,IFNULL(TO_NUMBER(replace(TRY_PARSE_JSON(CHK.info):revenueCenterId,'""','')),-1)
                                                   AS REVENUECENTER_DIM_FK 
  ,IFNULL(TO_NUMBER(replace(PAY.value:ccData:transactionID,'""','')),-1)  
                                                   AS TRANSACTION_FACT_FK
  ,IFNULL(PAY.value:applicationSettings.posTerminalId::NUMBER,-1)  
                                                   AS TERMINAL_DIM_FK                                
--flags---------------------------------------------------------------------------------------
  ,CHK.IS_TRAINING                                                      AS IS_TRAINING
--Dates--------------.------------------------------------------------------------------------

  ,to_timestamp_tz(CHK.opened_at)                                       AS OPENED_AT
  ,to_timestamp_tz(to_char((PAY.value:paidAt)))                         AS PAID_AT
  ,to_timestamp_tz(REF.value:refundedAt::VARCHAR)                       AS REFUNDED_AT 
  ,to_timestamp_tz(replace(try_PARSE_JSON(info):fiscalDate,'""',''))     AS FISCALDATE
--names, options, etc----------------------------------------------------------- ------------- 
  ,replace(PAY.value:ccData:batchNumber,'""','')                         AS BATCHNUMBER
  ,REF.value:sessionMoniker::VARCHAR                                    AS REFUNDED_BY                        
  ,replace(PAY.value:ccData:cardBrand,'""','')                           AS CARDBRAND
  ,replace(PAY.value:ccData:cardholderName,'""','')                      AS CARDHOLDERNAME
  ,CHK.NUMBER                                                           AS CHEQUENUMBER
  ,replace(TRY_PARSE_JSON(info):currencyId,'""','')                      AS CURRENCY_ID  
  ,TO_NUMBER(replace(TRY_PARSE_JSON(info):floorplanId,'""',''))          AS FLOORPLAN_ID
  ,replace(PAY.value:ccData:lastFourCcNumber,'""','')                    AS LASTFOURCCNUMBER  
  ,replace(PAY.value:ccData:nextFourCcNumber,'""','')                    AS NEXTFOURCCNUMBER
  ,replace(PAY.value:paymentType,'""','')                                AS PAYMENTTYPE
  ,replace(PAY.value:paymentStatus,'""','')                              AS PAYMENTSTATUS
  ,replace(TRY_PARSE_JSON(info):revenueCenterName,'""','')               AS REVENUECENTERNAME
  ,replace(TRY_PARSE_JSON(info):tableName,'""','')                       AS TABLENAME
--Counts and Amounts--------------------------------------------------------------------------
  ,TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):total), 38,4)      AS CHECK_TOTAL_AMOUNT
  ,REF.value:refundAmount::NUMBER(38,4)                                 AS REFUND_AMOUNT   
----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_CHEQUE             CHK 
    ,LATERAL FLATTEN(INPUT => 
     TRY_PARSE_JSON( '{PAYMENTS:' || CHK.PAYMENTS || '}' ),  path => 'PAYMENTS')
                                                                        PAY
 ,LATERAL FLATTEN(INPUT => 
    TRY_PARSE_JSON('{refunds:' || TRY_PARSE_JSON(PAY.value):refunds || '}'), PATH => 'refunds')
                                                                        REF  
WHERE REF.value IS NOT NULL and CHK.PAYMENTS <> '__value_not_modified__'                                                                       
                                                                        ;
;"
VIEW,DATAADMIN,CASHPAYMENTLEDGER_FACT,"create or replace view CASHPAYMENTLEDGER_FACT(
	CASHPAYMENTLEDGER_FACT_PK,
	CASHPAYMENTLEDGER_FACT_NK,
	CASHPAYMENTLEDGER,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	CHEQUE_DIM_FK,
	PAYMENTS_FACT_FK,
	PAYMENTMETHOD_DIM_ID,
	SHIFT_DIM_FK,
	IS_VOIDED,
	CREATED_AT,
	UPDATED_AT,
	TENDERED_AMOUNT,
	CHANGE_AMOUNT
) as
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  tab.ID                                                      AS CASHPAYMENTLEDGER_FACT_PK  
--natural keys------------------------------------------------------------------------------
  ,tab.ID                                                     AS CASHPAYMENTLEDGER_FACT_NK  
--name-------------------------------------------------------------------------------------------
  ,tab.ID                                                     AS CASHPAYMENTLEDGER
--data warehouse REQUIRED rows-------------------------------------------------------------------
 ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY tab.ID ORDER BY tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION
      ,tab.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY tab.ID ORDER BY tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION,tab.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY tab.ID ORDER BY 
    tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION
   ,tab.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN tab.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY tab.ID ORDER BY  
    tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,tab.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,tab.MTLN_CDC_SRC_VERSION DESC
   ,tab.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     --REQUIRED
--CDC Meta data REQUIRED rows-------------------------------------------------------------------------------
  ,tab.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE                  
  ,tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP              
  ,tab.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER                    
  ,tab.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID                      
  ,tab.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP                     
  ,tab.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR                
  ,tab.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION                        
  ,tab.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME                           
  ,tab.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH                           
  ,tab.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE                       
  ,tab.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA                         
  ,tab.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE                         
--foreign keys-------------------------------------------------------------------------------
  ,tab.CHECK_ID                        AS CHEQUE_DIM_FK
  ,tab.CHECK_ID || '.' || tab.CHECK_PAYMENT_UID               AS PAYMENTS_FACT_FK--this is a guid and is not expected to pbe #
  ,tab.PAYMENT_METHOD_ID               AS PAYMENTMETHOD_DIM_ID
  ,tab.SHIFT_ID                        AS SHIFT_DIM_FK
--flags---------------------------------------------------------------------------------------
--ALLCOLUMN NAMES IN THIS SECTION SHOULD begin with is_ or has_ if created by the dw.
--   columns created by the source app should be specifically cast as boolean 
  ,tab.IS_VOIDED                       AS IS_VOIDED
--Dates--------------.------------------------------------------------------------------------
--dates should be cast as dates
-- created_at timestamp with time zone  <--this is the create table from postgres
--,to_timestamp_tz(created_at) 
  ,to_timestamp_tz(tab.CREATED_AT)     AS CREATED_AT  
  ,to_timestamp_tz(tab.UPDATED_AT)     AS UPDATED_AT
--names, options, etc-------------------------------------------------------------------------
--Counts and Amounts--------------------------------------------------------------------------
--ALL COLUMNS IN THIS SECTION SHOULD END IN COUNT OR AMOUNT
  ,TO_NUMBER(tab.AMOUNT_TENDERED,38,4)/1000000  AS TENDERED_AMOUNT
  ,TO_NUMBER(tab.AMOUNT_CHANGED,38,4)/1000000   AS CHANGE_AMOUNT
-- ----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_CHECK_CASH_PAYMENT_LEDGER     tab
;"
VIEW,DATAADMIN,CCTRANSACTION_FACT,"create or replace view CCTRANSACTION_FACT(
	CCTRANSACTION_FACT_PK,
	CCTRANSACTION_FACT_NK,
	TRANSACTION_NUMBER,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	BATCH_DIM_FK,
	LOCATION_DIM_FK,
	EMPLOYEE_DIM_FK,
	PAYMENTMETHOD_DIM_FK,
	CHEQUE_FACT_FK,
	ISCARDPRESENT,
	ISFIRSTTRANSACTION,
	FISCAL_DAY,
	AUTH_TRAN_GMT,
	CREATED_AT,
	UPDATED_AT,
	AUTH_TRAN_ID,
	BATCH_ID,
	AUTH_BRIC,
	CARDHOLDER_LOCATION,
	CARD_ENTRY_METHOD,
	BATCH_NUMBER,
	AUTHORIZATION,
	AUTHORIZATION_CODE,
	APPROVAL,
	POS_TERMINAL_ID,
	MASKED_CC_NUMBER,
	CARDHOLDER_NAME,
	CARD_TYPE,
	CARD_TYPE_RAW,
	REFERENCE_NUMBER,
	COMMAND,
	STATUS,
	AUTHAMOUNTREQUESTED,
	AUTH_AMOUNT,
	TOTAL_INCREMENT,
	TIP_INCREMENT,
	TOTAL,
	TIP
) as
--============================================================================================
-- SELECT * FROM DATAADMIN.CCTRANSACTION_FACT WHERE MTLN_CDC_LAST_CHANGE_TYPE = 'd' ;
SELECT 
--primary keys------------------------------------------------------------------------------
  cct.ID                                                     AS CCTRANSACTION_FACT_PK
--natural keys------------------------------------------------------------------------------
  ,cct.ID                                                    AS CCTRANSACTION_FACT_NK
--name---------------------------------------------------------------------------------------
  ,TO_NUMBER(cct.TRANSACTION_NUMBER)                         AS TRANSACTION_NUMBER
--data warehouse rows------------------------------------------------------------------------
 ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(cct.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY cct.ID ORDER BY cct.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,cct.MTLN_CDC_SEQUENCE_NUMBER,cct.MTLN_CDC_SRC_VERSION
      ,cct.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE        
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(cct.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY cct.ID ORDER BY cct.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,cct.MTLN_CDC_SEQUENCE_NUMBER,cct.MTLN_CDC_SRC_VERSION,cct.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY cct.ID ORDER BY 
    cct.MTLN_CDC_LAST_COMMIT_TIMESTAMP,cct.MTLN_CDC_SEQUENCE_NUMBER,cct.MTLN_CDC_SRC_VERSION
   ,cct.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE           
  
  ,CASE WHEN cct.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED              
  ,CASE WHEN RANK() OVER(PARTITION BY cct.ID ORDER BY  
    cct.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,cct.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,cct.MTLN_CDC_SRC_VERSION DESC
   ,cct.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW      
--CDC Meta data-------------------------------------------------------------------------------
  ,cct.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE
  ,cct.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,cct.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER
  ,cct.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID
  ,cct.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP
  ,cct.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,cct.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION
  ,cct.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME
  ,cct.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH
  ,cct.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE
  ,cct.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA
  ,cct.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE
--foreign keys-------------------------------------------------------------------------------
  ,CASE WHEN cct.BATCH_NUMBER IS NULL THEN -1
    ELSE  cct.BATCH_NUMBER || '.' || TO_CHAR(cct.LOCATION_ID) 
    END
                                       AS BATCH_DIM_FK  
  ,IFNULL(cct.LOCATION_ID,-1)          AS LOCATION_DIM_FK
  ,IFNULL(cct.EMPLOYEE_ID,-1)          AS EMPLOYEE_DIM_FK
  ,IFNULL(cct.PAYMENT_METHOD_ID,-1)    AS PAYMENTMETHOD_DIM_FK
  ,IFNULL(cct.CHECK_ID,-1)             AS CHEQUE_FACT_FK
--flags---------------------------------------------------------------------------------------
  ,CASE WHEN cct.cardholder_location = 'ManualPhone' THEN FALSE ELSE TRUE END
                                       AS ISCARDPRESENT
  ,CASE WHEN 1=1 THEN TRUE ELSE FALSE END 
                                       AS ISFIRSTTRANSACTION
--Dates--------------.------------------------------------------------------------------------

,'20' || SUBSTRING(REPLACE(parse_json(parse_json(payment_provider_response_body):data):batchID,'""',''),1,2) 
 || '-' || SUBSTRING(REPLACE(parse_json(parse_json(payment_provider_response_body):data):batchID,'""',''),3,2)
 || '-' || SUBSTRING(REPLACE(parse_json(parse_json(payment_provider_response_body):data):batchID,'""',''),5,2)
                                        AS FISCAL_DAY
                                                                                    , to_timestamp_ntz(REPLACE(parse_json(parse_json(payment_provider_response_body):data):authTranDateGMT,'""',''),'MM/DD/YYYY HH12:MI:SS PM') 
                                       AS AUTH_TRAN_GMT
  ,to_timestamp_tz(cct.CREATED_AT)     AS CREATED_AT   
  ,to_timestamp_tz(cct.UPDATED_AT)     AS UPDATED_AT
--names, options, etc-------------------------------------------------------------------------
  ,REPLACE(parse_json(parse_json(payment_provider_response_body):data):authTranID,'""','') AS AUTH_TRAN_ID
  ,REPLACE(parse_json(parse_json(payment_provider_response_body):data):batchID,'""','')    AS BATCH_ID
  ,REPLACE(parse_json(parse_json(payment_provider_response_body):data):authBric,'""','')   AS AUTH_BRIC
  ,cct.CARDHOLDER_LOCATION             AS CARDHOLDER_LOCATION
  ,cct.CARD_ENTRY_METHOD               AS CARD_ENTRY_METHOD
  ,cct.BATCH_NUMBER                    AS BATCH_NUMBER
  ,REPLACE(parse_json(parse_json(payment_provider_response_body):data):authorization,'""','') 
                                       AS AUTHORIZATION
  ,cct.AUTHORIZATION_CODE              AS AUTHORIZATION_CODE
  ,REPLACE(parse_json(parse_json(payment_provider_response_body):data):text,'""','') 
                                       AS APPROVAL
  ,cct.POS_TERMINAL_ID                 AS POS_TERMINAL_ID
  ,cct.MASKED_CC_NUMBER                AS MASKED_CC_NUMBER
  ,cct.CARDHOLDER_NAME                 AS CARDHOLDER_NAME
  ,cct.CARD_TYPE                       AS CARD_TYPE
  ,cct.CARD_TYPE_RAW                   AS CARD_TYPE_RAW
  ,cct.REFERENCE_NUMBER                AS REFERENCE_NUMBER
  ,cct.COMMAND                         AS COMMAND
  ,cct.STATUS                          AS STATUS
  
--Counts and Amounts--------------------------------------------------------------------------
  ,TO_DECIMAL(TRY_PARSE_JSON(payment_provider_response_body):data:authAmountRequested,38,4)
                                                                        AS AUTHAMOUNTREQUESTED
  ,REPLACE(parse_json(parse_json(payment_provider_response_body):data):authAmount,'""','') ::DECIMAL(38,4)
                                                                        AS AUTH_AMOUNT                                                                        
  ,cct.total_increment/1000000 ::DECIMAL(38,4)                          AS TOTAL_INCREMENT
  ,cct.tip_increment/1000000 ::DECIMAL(38,4)                            AS TIP_INCREMENT
  ,cct.Total/1000000  ::DECIMAL(38,4)                                   AS TOTAL
  ,cct.Tip  /1000000  ::DECIMAL(38,4)                                   AS TIP
----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_CC_TRANSACTION     cct
  WHERE NOT COALESCE(cct.TRUNCATED,FALSE)
       AND cct.MTLN_CDC_LAST_CHANGE_TYPE <> 'd' 
;"
VIEW,DATAADMIN,CONFIG_DIM,"create or replace view CONFIG_DIM(
	CONFIG_DIM_PK,
	CONFIG_DIM_NK,
	CONFIG_ID,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	INTEGRATIONTYPE_DIM_FK,
	CREATED_AT,
	UPDATED_AT,
	CONFIG
) as
--============================================================================================
SELECT
--primary keys--------------------------------------------------------------------------------
  tab.ID                                                      AS CONFIG_DIM_PK
--natural keys--------------------------------------------------------------------------------
  ,tab.ID                                                     AS CONFIG_DIM_NK
--name-----------------------------------------------------------------------------------------
  ,tab.ID                                                     AS CONFIG_ID
--data warehouse REQUIRED rows----------------------------------------------------------------
 ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY tab.ID ORDER BY tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION
      ,tab.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP)
    OVER (PARTITION BY tab.ID ORDER BY tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION,tab.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY tab.ID ORDER BY
    tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION
   ,tab.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE
  ,CASE WHEN tab.MTLN_CDC_LAST_CHANGE_TYPE ='d'
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED
  ,CASE WHEN RANK() OVER(PARTITION BY tab.ID ORDER BY
    tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,tab.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,tab.MTLN_CDC_SRC_VERSION DESC
   ,tab.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW
--CDC Meta data REQUIRED rows----------------------------------------------------------------
  ,tab.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE
  ,tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,tab.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER
  ,tab.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID
  ,tab.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP
  ,tab.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,tab.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION
  ,tab.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME
  ,tab.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH
  ,tab.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE
  ,tab.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA
  ,tab.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE
--foreign keys-------------------------------------------------------------------------------
  ,IFNULL(tab.integration_type_id,-1)  AS INTEGRATIONTYPE_DIM_FK
--flags---------------------------------------------------------------------------------------
--ALLCOLUMN NAMES IN THIS SECTION SHOULD begin with is_ or has_ if created by the dw.
--   columns created by the source app should be specifically cast as boolean
--Dates--------------.------------------------------------------------------------------------
--dates should be cast as dates
-- created_at timestamp with time zone  <--this is the create table from postgres
--,to_timestamp_tz(created_at)
  ,to_timestamp_tz(tab.CREATED_AT)     AS CREATED_AT
  ,to_timestamp_tz(tab.UPDATED_AT)     AS UPDATED_AT
--names, options, etc-------------------------------------------------------------------------
  ,tab.config                          AS CONFIG

--Counts and Amounts--------------------------------------------------------------------------
FROM DATALANDING.posapi_public_integration_config     tab
ORDER BY tab.integration_type_id
;"
VIEW,DATAADMIN,DATASHARE_SECURE_VIEW,"create or replace secure view DATASHARE_SECURE_VIEW(
	DATASHARETESTNAME,
	OTHER_ID
) as
SELECT DATASHARETESTNAME,OTHER_ID FROM DATAWAREHOUSE.DATASHARETEST_DIM;"
VIEW,DATAADMIN,EMPLOYEE_DIM,"create or replace view EMPLOYEE_DIM(
	EMPLOYEE_DIM_PK,
	EMPLOYEE_DIM_NK,
	EMPLOYEE_NAME,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	ORGANIZATION_DIM_FK,
	IS_DISABLED,
	IS_TRAINING,
	TERMINATE_DATE,
	BIRTH_DATE,
	CREATED_AT,
	UPDATED_AT,
	FIRST_NAME,
	LAST_NAME,
	IMPORT_GUID,
	SYSTEM_ID,
	PAYROLL_ID,
	PIN,
	EMAIL,
	INITIALS,
	NICKNAME,
	UI_COLOR,
	CARD_CODE,
	AVATAR,
	GENDER,
	FLSA_STATUS
) as
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  EMP.ID                                                                  AS EMPLOYEE_DIM_PK
--natural keys------------------------------------------------------------------------------
  ,EMP.ID                                                                 AS EMPLOYEE_DIM_NK
--name---------------------------------------------------------------------------------------
  ,EMP.first_name || ' ' || EMP.last_name                                 AS EMPLOYEE_NAME
--data warehouse rows------------------------------------------------------------------------
 ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(EMP.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY EMP.ID ORDER BY EMP.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,EMP.MTLN_CDC_SEQUENCE_NUMBER,EMP.MTLN_CDC_SRC_VERSION
      ,EMP.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(EMP.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY EMP.ID ORDER BY EMP.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,EMP.MTLN_CDC_SEQUENCE_NUMBER,EMP.MTLN_CDC_SRC_VERSION,EMP.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY EMP.ID ORDER BY 
    EMP.MTLN_CDC_LAST_COMMIT_TIMESTAMP,EMP.MTLN_CDC_SEQUENCE_NUMBER,EMP.MTLN_CDC_SRC_VERSION
   ,EMP.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN EMP.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY EMP.ID ORDER BY  
    EMP.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,EMP.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,EMP.MTLN_CDC_SRC_VERSION DESC
   ,EMP.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW    
--CDC Meta data-------------------------------------------------------------------------------
  ,EMP.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE
  ,EMP.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,EMP.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER
  ,EMP.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID
  ,EMP.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP
  ,EMP.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,EMP.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION
  ,EMP.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME
  ,EMP.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH
  ,EMP.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE                     
  ,EMP.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA
  ,EMP.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE                          
--foreign keys-------------------------------------------------------------------------------
  ,IFNULL(EMP.organization_id,-1)      AS ORGANIZATION_DIM_FK
--flags---------------------------------------------------------------------------------------
  ,EMP.is_disabled                     AS IS_DISABLED
  ,EMP.is_training                     AS IS_TRAINING
--Dates--------------.------------------------------------------------------------------------
  ,to_date(EMP.terminated_at)          AS TERMINATE_DATE
  ,to_date(EMP.date_of_birth)          AS BIRTH_DATE  
  ,to_timestamp_tz(EMP.CREATED_AT)     AS CREATED_AT
  ,to_timestamp_tz(UPDATED_AT)         AS UPDATED_AT
-- --names, options, etc-----------------------------------------------------------------------
   ,EMP.first_name                     AS FIRST_NAME
   ,EMP.last_name                      AS LAST_NAME
   ,EMP.import_id                      AS IMPORT_GUID
   ,EMP.SYSTEM_USER_UUID               AS SYSTEM_ID
   ,EMP.payroll_id                     AS PAYROLL_ID
   ,EMP.pin                            AS PIN
   ,EMP.email                          AS EMAIL
   ,EMP.initials                       AS INITIALS
   ,EMP.nickname                       AS NICKNAME
   ,EMP.ui_color                       AS UI_COLOR
   ,EMP.card_code                      AS CARD_CODE
   ,EMP.avatar                         AS AVATAR
   ,EMP.gender                         AS GENDER
   ,EMP.flsa_status                    AS FLSA_STATUS
----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_EMPLOYEE                          EMP 
;"
VIEW,DATAADMIN,INTEGRATION_FACT,"create or replace view INTEGRATION_FACT(
	INTEGRATION_FACT_PK,
	INTEGRATION_FACT_NK,
	INTEGRATION_ID,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	INTEGRATIONTYPE_DIM_FK,
	LOCATION_DIM_FK,
	LOCATIONGGROUP_DIM_FK,
	CREATED_AT,
	UPDATED_AT
) as
--select * From DATALANDING.POSAPI_PUBLIC_INTEGRATION_CONFIG
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  ADD.ID                                                     AS INTEGRATION_FACT_PK
--natural keys------------------------------------------------------------------------------
  ,ADD.ID                                                    AS INTEGRATION_FACT_NK
--name---------------------------------------------------------------------------------------
  ,ADD.ID                                                    AS INTEGRATION_ID
--data warehouse rows------------------------------------------------------------------------
  ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(ADD.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY ADD.ID ORDER BY ADD.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,ADD.MTLN_CDC_SEQUENCE_NUMBER,ADD.MTLN_CDC_SRC_VERSION
      ,ADD.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(ADD.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY ADD.ID ORDER BY ADD.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,ADD.MTLN_CDC_SEQUENCE_NUMBER,ADD.MTLN_CDC_SRC_VERSION,ADD.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY ADD.ID ORDER BY 
    ADD.MTLN_CDC_LAST_COMMIT_TIMESTAMP,ADD.MTLN_CDC_SEQUENCE_NUMBER,ADD.MTLN_CDC_SRC_VERSION
   ,ADD.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN ADD.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY ADD.ID ORDER BY  
    ADD.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,ADD.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,ADD.MTLN_CDC_SRC_VERSION DESC
   ,ADD.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     --REQUIRED
--CDC Meta data-------------------------------------------------------------------------------
  ,ADD.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE
  ,ADD.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,ADD.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER
  ,ADD.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID
  ,ADD.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP
  ,ADD.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,ADD.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION
  ,ADD.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME
  ,ADD.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH
  ,ADD.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE
  ,ADD.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA
  ,ADD.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE
--foreign keys-------------------------------------------------------------------------------
   ,ADD.INTEGRATION_TYPE_ID            AS INTEGRATIONTYPE_DIM_FK
   ,ADD.LOCATION_ID                    AS LOCATION_DIM_FK
   ,ADD.LOCATION_GROUP_ID              AS LOCATIONGGROUP_DIM_FK
--flags---------------------------------------------------------------------------------------
--none
--Dates--------------.------------------------------------------------------------------------
  ,to_timestamp_tz(ADD.CREATED_AT)     AS CREATED_AT   
  ,to_timestamp_tz(ADD.UPDATED_AT)     AS UPDATED_AT  
--names, options, etc-------------------------------------------------------------------------
--Counts and Amounts--------------------------------------------------------------------------
--none 
----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_INTEGRATION_CONFIG     ADD
;"
VIEW,DATAADMIN,MENUITEM_DIM,"create or replace view MENUITEM_DIM(
	MENUITEM_DIM_PK,
	MENUITEM_DIM_NK,
	SKU,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	ORGANIZATION_DIM_FK,
	MENUITEMNAME_DIM_FK,
	VARIANT_DIM_FK,
	CREATED_AT,
	UPDATED_AT,
	UPC,
	VARIANT_OPTION_ID,
	CALORIES,
	COST,
	PRICE
) as
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  mei.ID                                                      AS MENUITEM_DIM_PK
--natural keys------------------------------------------------------------------------------
  ,mei.ID                                                     AS MENUITEM_DIM_NK
--name---------------------------------------------------------------------------------------
  ,mei.SKU                                                    AS SKU
--data warehouse rows------------------------------------------------------------------------
 ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(mei.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY mei.ID ORDER BY mei.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,mei.MTLN_CDC_SEQUENCE_NUMBER,mei.MTLN_CDC_SRC_VERSION
      ,mei.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(mei.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY mei.ID ORDER BY mei.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,mei.MTLN_CDC_SEQUENCE_NUMBER,mei.MTLN_CDC_SRC_VERSION,mei.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY mei.ID ORDER BY 
    mei.MTLN_CDC_LAST_COMMIT_TIMESTAMP,mei.MTLN_CDC_SEQUENCE_NUMBER,mei.MTLN_CDC_SRC_VERSION
   ,mei.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN mei.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY mei.ID ORDER BY  
    mei.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,mei.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,mei.MTLN_CDC_SRC_VERSION DESC
   ,mei.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     --REQUIRED 
--CDC Meta data-------------------------------------------------------------------------------
  ,mei.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE
  ,mei.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,mei.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER
  ,mei.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID
  ,mei.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP
  ,mei.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,mei.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION
  ,mei.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME
  ,mei.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH
  ,mei.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE
  ,mei.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA
  ,mei.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE
--foreign keys-------------------------------------------------------------------------------
  ,IFNULL(mei.organization_id,-1)                 AS ORGANIZATION_DIM_FK
  ,IFNULL(mei.menu_item_name_id,-1)               AS MENUITEMNAME_DIM_FK
  -- ,IFNULL(mei.reporting_category_id,-1)        AS REPORTCATEGORY_DIM_FK
  ,IFNULL(mei.variant_option_id,-1)               AS VARIANT_DIM_FK
--flags---------------------------------------------------------------------------------------
--NO FLAGS
--Dates--------------.------------------------------------------------------------------------
  ,to_timestamp_tz(mei.CREATED_AT)      AS CREATED_AT
  ,to_timestamp_tz(mei.UPDATED_AT)      AS UPDATED_AT
--names, options, etc-------------------------------------------------------------------------
  ,mei.UPC                              AS UPC
  -- ,mei.reporting_category_id         AS REPORT_CATEGORY_ID
  ,mei.variant_option_id                as VARIANT_OPTION_ID
--Counts and Amounts--------------------------------------------------------------------------
  ,mei.CALORIES                         AS CALORIES
  ,mei.COST                             AS COST
  ,mei.PRICE                            AS PRICE
----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_MENU_ITEM     mei
;"
VIEW,DATAADMIN,DRAWER_DIM,"create or replace view DRAWER_DIM(
	DRAWER_DIM_PK,
	DRAWER_DIM_NK,
	DRAWER,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	EMPLOYEE_DIM_FK,
	LOCATION_DIM_FK,
	TERMINAL_DIM_FK,
	CREATED_AT,
	UPDATED_AT
) as
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  TO_NUMBER(dwr.DRAWER_ID,38,0)                              AS DRAWER_DIM_PK  
--natural keys------------------------------------------------------------------------------
  ,TO_NUMBER(dwr.DRAWER_ID,38,0)                             AS DRAWER_DIM_NK  
--name-------------------------------------------------------------------------------------------
  ,TO_NUMBER(dwr.DRAWER_ID,38,0)                             AS DRAWER
--data warehouse REQUIRED rows-------------------------------------------------------------------
 ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(dwr.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY TO_NUMBER(dwr.DRAWER_ID,38,0) ORDER BY dwr.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,dwr.MTLN_CDC_SEQUENCE_NUMBER,dwr.MTLN_CDC_SRC_VERSION
      ,dwr.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(dwr.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY TO_NUMBER(dwr.DRAWER_ID,38,0) ORDER BY dwr.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,dwr.MTLN_CDC_SEQUENCE_NUMBER,dwr.MTLN_CDC_SRC_VERSION,dwr.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY TO_NUMBER(dwr.DRAWER_ID,38,0) ORDER BY 
    dwr.MTLN_CDC_LAST_COMMIT_TIMESTAMP,dwr.MTLN_CDC_SEQUENCE_NUMBER,dwr.MTLN_CDC_SRC_VERSION
   ,dwr.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN dwr.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY TO_NUMBER(dwr.DRAWER_ID,38,0)ORDER BY  
    dwr.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,dwr.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,dwr.MTLN_CDC_SRC_VERSION DESC
   ,dwr.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     --REQUIRED 
--CDC Meta data REQUIRED rows-------------------------------------------------------------------------------
  ,dwr.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE                   
  ,dwr.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP              
  ,dwr.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER                    
  ,dwr.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID                      
  ,dwr.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP                     
  ,dwr.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR                
  ,dwr.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION                        
  ,dwr.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME                           
  ,dwr.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH                           
  ,dwr.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE                       
  ,dwr.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA                         
  ,dwr.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE                          
--foreign keys-------------------------------------------------------------------------------
  ,IFNULL(dwr.employee_id,-1)                     AS EMPLOYEE_DIM_FK
  ,IFNULL(dwr.LOCATION_id,-1)                     AS LOCATION_DIM_FK 
  ,IFNULL(dwr.TERMINAL_ID,-1)                     AS TERMINAL_DIM_FK
--flags---------------------------------------------------------------------------------------
--ALLCOLUMN NAMES IN THIS SECTION SHOULD begin with is_ or has_ if created by the dw.
--   columns created by the source app should be specifically cast as boolean 
--Dates--------------.------------------------------------------------------------------------
--dates should be cast as dates
-- created_at timestamp with time zone  <--this is the create dwrle from postgres
--,to_timestamp_tz(created_at) 
  ,to_timestamp_tz(dwr.CREATED_AT)     AS CREATED_AT  
  ,to_timestamp_tz(dwr.UPDATED_AT)     AS UPDATED_AT
--names, options, etc-------------------------------------------------------------------------
--Counts and Amounts--------------------------------------------------------------------------
--ALL COLUMNS IN THIS SECTION SHOULD END IN COUNT OR AMOUNT
-- ----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_DRAWER   dwr
;"
VIEW,DATAADMIN,PAYINPAYOUTREASON_DIM,"create or replace view PAYINPAYOUTREASON_DIM(
	PAYINPAYOUTREASON_DIM_PK,
	PAYINPAYOUTREASON_DIM_NK,
	PAYINPAYOUTREASON,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	ORGANIZATION_DIM_FK,
	IS_ENABLED,
	IS_PAY_IN,
	CREATED_AT,
	UPDATED_AT,
	TYPE,
	DESCRIPTION
) as
--============================================================================================
SELECT 
--primary keys--------------------------------------------------------------------------------
  vdr.ID                                                      AS PayInPayOutReason_DIM_PK  
--natural keys--------------------------------------------------------------------------------
  ,vdr.ID                                                     AS PayInPayOutReason_DIM_NK  
--name-----------------------------------------------------------------------------------------
  ,vdr.NAME                                                   AS PayInPayOutReason
--data warehouse REQUIRED rows-----------------------------------------------------------------
  ,TO_TIMESTAMP(TO_CHAR(MTLN_CDC_LAST_COMMIT_TIMESTAMP)  
    || RIGHT(vdr.MTLN_CDC_SEQUENCE_NUMBER,6)) 
    
                                                              AS DW_STARTDATE         
  ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(TO_CHAR(LEAD(MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY vdr.ID ORDER BY vdr.MTLN_CDC_SEQUENCE_NUMBER)  
    || RIGHT(LEAD(vdr.MTLN_CDC_SEQUENCE_NUMBER) OVER (PARTITION 
    BY vdr.ID ORDER BY vdr.MTLN_CDC_SEQUENCE_NUMBER)
   ,6)),'9999-09-09 09:09:09.000')))
                                                              AS DW_ENDDATE        
  ,CASE WHEN vdr.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                    
                                                              AS DW_ISDELETED       
  ,CASE vdr.MTLN_CDC_SEQUENCE_NUMBER 
        WHEN MAX(vdr.MTLN_CDC_SEQUENCE_NUMBER) 
        OVER (PARTITION BY vdr.ID) THEN TRUE ELSE FALSE END 
                                                              AS DW_ISCURRENTROW     
-- --CDC Meta data REQUIRED rows------------------------------------------------------------------
  ,vdr.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE                  
  ,vdr.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP              
  ,vdr.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER                   
  ,vdr.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID                      
  ,vdr.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP                    
  ,vdr.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR                
  ,vdr.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION                        
  ,vdr.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME                           
  ,vdr.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH                           
  ,vdr.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE                       
  ,vdr.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA                        
  ,vdr.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE                          
-- --foreign keys--------------------------------------------------------------------------------
  ,vdr.ORGANIZATION_ID                 AS ORGANIZATION_DIM_FK
-- --flags---------------------------------------------------------------------------------------
  ,vdr.IS_ENABLED                      AS IS_ENABLED
  ,vdr.IS_PAY_IN                       AS IS_PAY_IN
-- --Dates--------------.------------------------------------------------------------------------
  ,to_timestamp_tz(vdr.CREATED_AT)     AS CREATED_AT  
  ,to_timestamp_tz(vdr.UPDATED_AT)     AS UPDATED_AT
-- --names, options, etc-------------------------------------------------------------------------
  ,CASE WHEN vdr.IS_PAY_IN THEN 'Pay In'
    ELSE 'Pay Out'  END                AS TYPE
  ,vdr.description                     AS DESCRIPTION
----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_PAY_IN_OUT_REASON    vdr
;"
VIEW,DATAADMIN,SURCHARGE_FACT,"create or replace view SURCHARGE_FACT(
	SURCHARGE_FACT_PK,
	SURCHARGE_FACT_NK,
	SURCHARGENAME,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	CHEQUE_FACT_FK,
	DAYPART_DIM_FK,
	EMPLOYEE_DIM_FK,
	LOCATION_DIM_FK,
	SURCHARGE_DIM_NK,
	IS_AUTOAPPLIED,
	IS_GRATUITY,
	IS_TAXABLE,
	IS_TRAINING,
	IS_PRINTONRECEIPT,
	CREATED_AT,
	FISCAL_DATE,
	OPENED_AT,
	UPDATED_AT,
	STATUS,
	CHEQUENUMBER,
	SURCHARGE_TYPE,
	QUANTITY,
	AMOUNT,
	APPLIEDAMOUNT
) as
--============================================================================================
SELECT 
COALESCE(TO_VARCHAR(CHK.ID) || '.' || TO_CHAR(replace(SSS.VALUE:id,'""',''))
  ,TO_VARCHAR(CHK.ID) || '.' || MAX(TO_CHAR(replace(SSS.VALUE:id,'""',''))) OVER (PARTITION BY CHK.ID)
  ,TO_CHAR(CHK.ID)  || '.'||'0')
                                                                         AS SURCHARGE_FACT_PK
-- --natural keys------------------------------------------------------------------------------
  ,COALESCE(TO_VARCHAR(CHK.ID) || '.' || TO_CHAR(replace(SSS.VALUE:id,'""',''))
  ,TO_VARCHAR(CHK.ID) || '.' || MAX(TO_CHAR(replace(SSS.VALUE:id,'""',''))) OVER (PARTITION BY CHK.ID)
  ,TO_CHAR(CHK.ID)  || '.'||'0')  
                                                                         AS SURCHARGE_FACT_NK
-- --name---------------------------------------------------------------------------------------
   ,COALESCE( TO_CHAR(replace(SSS.VALUE:id,'""',''))
  ,MAX(TO_CHAR(replace(SSS.VALUE:id,'""',''))) OVER (PARTITION BY CHK.ID)
  ,'0')                               
                                                                         AS SURCHARGENAME
--data warehouse rows--------------------------------------------------------------------------
 ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY CHK.ID ,SSS.VALUE:id ORDER BY CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION
      ,CHK.MTLN_CDC_FILENAME)),6))
                                                                          AS DW_STARTDATE      
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY CHK.ID
    ,SSS.VALUE:id   ----------------------------
    ORDER BY CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION,CHK.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY CHK.ID,SSS.VALUE:id ORDER BY 
    CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION
   ,CHK.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                                          AS DW_ENDDATE          
  
  ,CASE WHEN CHK.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                              AS DW_ISDELETED        
  ,CASE WHEN RANK() OVER(PARTITION BY CHK.ID,SSS.VALUE:id ORDER BY  
    CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,CHK.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,CHK.MTLN_CDC_SRC_VERSION DESC
   ,CHK.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                                          AS DW_ISCURRENTROW 
--CDC Meta data-------------------------------------------------------------------------------
  ,CHK.MTLN_CDC_LAST_CHANGE_TYPE                     AS MTLN_CDC_LAST_CHANGE_TYPE
  ,CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP                AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,CHK.MTLN_CDC_SEQUENCE_NUMBER                      AS MTLN_CDC_SEQUENCE_NUMBER
  ,CHK.MTLN_CDC_LOAD_BATCH_ID                        AS MTLN_CDC_LOAD_BATCH_ID
  ,CHK.MTLN_CDC_LOAD_TIMESTAMP                       AS MTLN_CDC_LOAD_TIMESTAMP
  ,CHK.MTLN_CDC_PROCESSED_DATE_HOUR                  AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,CHK.MTLN_CDC_SRC_VERSION                          AS MTLN_CDC_SRC_VERSION
  ,CHK.MTLN_CDC_FILENAME                             AS MTLN_CDC_FILENAME
  ,CHK.MTLN_CDC_FILEPATH                             AS MTLN_CDC_FILEPATH
  ,CHK.MTLN_CDC_SRC_DATABASE                         AS MTLN_CDC_SRC_DATABASE
  ,CHK.MTLN_CDC_SRC_SCHEMA                           AS MTLN_CDC_SRC_SCHEMA
  ,CHK.MTLN_CDC_SRC_TABLE                            AS MTLN_CDC_SRC_TABLE
--foreign keys-------------------------------------------------------------------------------
  ,IFNULL(CHK.ID,-1)                                 AS CHEQUE_FACT_FK 
  ,IFNULL(CHK.day_part_id,-1)                        AS DAYPART_DIM_FK
  ,IFNULL(CHK.EMPLOYEE_ID,-1)                        AS EMPLOYEE_DIM_FK
  ,IFNULL(CHK.LOCATION_ID,-1)                        AS LOCATION_DIM_FK
  ,IFNULL(TO_VARCHAR(SSS.value:surchargeId),-1)      AS SURCHARGE_DIM_NK
--flags--------------------------------------------------------------------------------------
  ,case upper(SSS.value:isAutoApplied) when 'TRUE' THEN TRUE else FALSE END
                                                     AS IS_AUTOAPPLIED
  ,case upper(SSS.value:isGratuity) when 'TRUE' THEN TRUE else FALSE END
                                                     AS IS_GRATUITY 
  ,case upper(SSS.value:isTaxable) when 'TRUE' THEN TRUE else FALSE END                              
                                                     AS IS_TAXABLE
  ,CHK.IS_TRAINING                                   AS IS_TRAINING 
 ,case upper(SSS.value:printOnReceip) when 'TRUE' THEN TRUE else FALSE END                         
                                                     AS IS_PRINTONRECEIPT   
--Dates--------------.------------------------------------------------------------------------
  ,to_timestamp_tz(CHK.CREATED_AT)                   AS CREATED_AT 
  ,TO_CHAR(TRY_PARSE_JSON(CHK.info):fiscalDate)::DATE   
                                                     AS FISCAL_DATE 
  ,to_timestamp_tz(CHK.OPENED_AT)                    AS OPENED_AT 
  ,to_timestamp_tz(CHK.UPDATED_AT)                   AS UPDATED_AT

--names, options, etc-------------------------------------------------------------------------
   ,IFNULL(TO_VARCHAR(SSS.value:status),'None')      AS STATUS
--name---------------------------------------------------------------------------------------
  ,CHK.NUMBER                                        AS CHEQUENUMBER  
  ,IFNULL(REPLACE(SSS.value:type,'""',''),'None')     AS SURCHARGE_TYPE
--Counts and Amounts--------------------------------------------------------------------------
 ,IFNULL(SSS.value:quantity,0)::NUMBER(38,2)         AS QUANTITY
 ,IFNULL(SSS.value:value,0)::NUMBER(38,2)            AS AMOUNT
 ,IFNULL(SSS.value:appliedValue,0)::NUMBER(38,2)     AS APPLIEDAMOUNT  
----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_CHEQUE                                        CHK
  LEFT JOIN (  --LOJ needed to get the correct current row and start dates.  Necessary for cases where the current check row has no surcharges, but a previous row did have surcharges
    SELECT *
      FROM 
        DATALANDING.POSAPI_PUBLIC_CHEQUE              CHK_1 
            ,LATERAL FLATTEN(INPUT => 
            TRY_PARSE_JSON('{surcharges:' || TRY_PARSE_JSON(chk_1.info):surcharges || '}'), PATH => 'surcharges')
                                                      SUR
            WHERE NOT COALESCE(TRUNCATED,FALSE)                               )SSS
       ON CHK.ID = SSS.ID
         AND CHK.MTLN_CDC_SEQUENCE_NUMBER = SSS.MTLN_CDC_SEQUENCE_NUMBER
         AND CHK.MTLN_CDC_SRC_VERSION = SSS.MTLN_CDC_SRC_VERSION
         AND CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP = SSS.MTLN_CDC_LAST_COMMIT_TIMESTAMP
         AND CHK.MTLN_CDC_FILENAME = SSS.MTLN_CDC_FILENAME
  WHERE CHK.MTLN_CDC_LAST_CHANGE_TYPE <> 'd'     
    AND NOT COALESCE(CHK.TRUNCATED,FALSE)
;"
VIEW,DATAADMIN,TAXSETTINGS_DIM,"create or replace view TAXSETTINGS_DIM(
	TAXSETTINGS_DIM_PK,
	TAXSETTINGS_DIM_NK,
	TAXSETTINGS_ID,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	LOCATION_DIM_FK,
	LOCATIONGROUP_DIM_FK,
	TRACK_TAXES_ON_COMPS,
	CREATED_AT,
	UPDATED_AT,
	TAX_TRACKING,
	RECEIPT_OPTIONS,
	ROUNDING_METHOD,
	COMBINED_RECEIPT_NAME
) as
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  tax.ID                                                     AS TAXSETTINGS_DIM_PK
--natural keys------------------------------------------------------------------------------
  ,tax.ID                                                    AS TAXSETTINGS_DIM_NK
--name---------------------------------------------------------------------------------------
   ,tax.ID                                                   AS TAXSETTINGS_ID
--data warehouse rows--------------------------------------------------s----------------------
  ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(tax.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY tax.ID ORDER BY tax.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,tax.MTLN_CDC_SEQUENCE_NUMBER,tax.MTLN_CDC_SRC_VERSION
      ,tax.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(tax.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY tax.ID ORDER BY tax.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,tax.MTLN_CDC_SEQUENCE_NUMBER,tax.MTLN_CDC_SRC_VERSION,tax.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY tax.ID ORDER BY 
    tax.MTLN_CDC_LAST_COMMIT_TIMESTAMP,tax.MTLN_CDC_SEQUENCE_NUMBER,tax.MTLN_CDC_SRC_VERSION
   ,tax.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN tax.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY tax.ID ORDER BY  
    tax.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,tax.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,tax.MTLN_CDC_SRC_VERSION DESC
   ,tax.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     --REQUIRED  
--CDC Meta data-------------------------------------------------------------------------------
  ,tax.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE
  ,tax.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,tax.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER
  ,tax.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID
  ,tax.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP
  ,tax.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,tax.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION
  ,tax.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME
  ,tax.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH
  ,tax.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE
  ,tax.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA
  ,tax.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE
--foreign keys-------------------------------------------------------------------------------
 ,IFNULL(tax.location_id,-1)           AS LOCATION_DIM_FK 
 ,IFNULL(tax.location_group_id,-1)     AS LOCATIONGROUP_DIM_FK 
--flags---------------------------------------------------------------------------------------
  ,tax.track_taxes_on_comps            AS TRACK_TAXES_ON_COMPS
--Dates--------------.------------------------------------------------------------------------
  ,TO_TIMESTAMP_TZ(tax.created_at)     AS CREATED_AT
  ,TO_TIMESTAMP_TZ(tax.updated_at)     AS UPDATED_AT 
--names, options, etc-------------------------------------------------------------------------
  ,tax.tax_tracking                    AS TAX_TRACKING
  ,tax.receipt_options                 AS RECEIPT_OPTIONS
  ,tax.rounding_method                 AS ROUNDING_METHOD
  ,tax.combined_receipt_name           AS COMBINED_RECEIPT_NAME
--Counts and Amounts--------------------------------------------------------------------------
--none
----------------------------------------------------------------------------------------------

FROM DATALANDING.POSAPI_PUBLIC_TAX_SETTINGS     tax
;"
VIEW,DATAADMIN,BATCH_DIM,"create or replace view BATCH_DIM(
	BATCH_DIM_PK,
	BATCH_DIM_NK,
	BATCH_NUMBER,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	LOCATION_DIM_FK,
	PAYMENTMETHOD_DIM_FK,
	IS_TRUNCATED,
	FISCAL_DATE_INT,
	FISCAL_DATE,
	CREATED_AT,
	UPDATED_AT,
	BATCH_NUMBER_SUFFIX,
	STATE,
	TRANSACTION_NUMBER
) as
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  ((((dad.fiscal_date_int)::int * 10000) + dad.batch_number_suffix)) || '.' || TO_CHAR(dad.LOCATION_ID)                                             
                                                              AS BATCH_DIM_PK
--natural keys------------------------------------------------------------------------------
  ,((((dad.fiscal_date_int)::int * 10000) + dad.batch_number_suffix)) || '.' || TO_CHAR(dad.LOCATION_ID)                                            
                                                              AS BATCH_DIM_NK
--name---------------------------------------------------------------------------------------
  ,((((dad.fiscal_date_int)::int * 10000) + dad.batch_number_suffix))                                                    
                                                              AS BATCH_NUMBER
--data warehouse rows------------------------------------------------------------------------
  ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(dad.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY 
      ((((dad.fiscal_date_int)::int * 10000) + dad.batch_number_suffix)) || '.' || TO_CHAR(dad.LOCATION_ID) 
      ORDER BY dad.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,dad.MTLN_CDC_SEQUENCE_NUMBER,dad.MTLN_CDC_SRC_VERSION
      ,dad.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(dad.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY 
    ((((dad.fiscal_date_int)::int * 10000) + dad.batch_number_suffix)) || '.' || TO_CHAR(dad.LOCATION_ID) 
    ORDER BY dad.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,dad.MTLN_CDC_SEQUENCE_NUMBER,dad.MTLN_CDC_SRC_VERSION,dad.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY 
    ((((dad.fiscal_date_int)::int * 10000) + dad.batch_number_suffix)) || '.' || TO_CHAR(dad.LOCATION_ID) 
    ORDER BY 
    dad.MTLN_CDC_LAST_COMMIT_TIMESTAMP,dad.MTLN_CDC_SEQUENCE_NUMBER,dad.MTLN_CDC_SRC_VERSION
   ,dad.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN dad.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY 
  ((((dad.fiscal_date_int)::int * 10000) + dad.batch_number_suffix)) || '.' || TO_CHAR(dad.LOCATION_ID) 
  ORDER BY  
    dad.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,dad.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,dad.MTLN_CDC_SRC_VERSION DESC
   ,dad.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     --REQUIRED
--CDC Meta data-------------------------------------------------------------------------------
  ,dad.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE
  ,dad.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,dad.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER
  ,dad.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID
  ,dad.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP
  ,dad.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,dad.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION
  ,dad.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME
  ,dad.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH
  ,dad.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE
  ,dad.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA
  ,dad.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE
--foreign keys-------------------------------------------------------------------------------
  ,IFNULL(dad.LOCATION_ID,-1)          AS LOCATION_DIM_FK  
  ,IFNULL(dad.PAYMENT_METHOD_ID,-1)    AS PAYMENTMETHOD_DIM_FK
--flags---------------------------------------------------------------------------------------
  ,dad.TRUNCATED                       AS IS_TRUNCATED
--Dates--------------.------------------------------------------------------------------------
  ,dad.fiscal_date_int                 AS FISCAL_DATE_INT
  ,CASE WHEN FISCAL_DATE_INT > 0 
    THEN '20' || SUBSTRING(TO_CHAR(dad.fiscal_date_int),1,2) || '-' 
      || SUBSTRING(TO_CHAR(dad.fiscal_date_int),3,2)     || '-' 
      || SUBSTRING(TO_CHAR(dad.fiscal_date_int),5,2) 
    ELSE NULL END
                                       AS FISCAL_DATE
  ,to_timestamp_tz(dad.CREATED_AT)     AS CREATED_AT  
  ,to_timestamp_tz(dad.UPDATED_AT)     AS UPDATED_AT
--names, options, etc-------------------------------------------------------------------------
  ,to_char(dad.batch_number_suffix)    AS BATCH_NUMBER_SUFFIX
  ,dad.STATE                           AS STATE
  ,to_char(dad.TRANSACTION_NUMBER)     AS TRANSACTION_NUMBER  
--Counts and Amounts--------------------------------------------------------------------------
 --none
----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_EPX_BATCH     dad
   WHERE dad.MTLN_CDC_LAST_CHANGE_TYPE <> 'd' 
;"
VIEW,DATAADMIN,CASHBANKEVENT_FACT,"create or replace view CASHBANKEVENT_FACT(
	CASHBANKEVENT_FACT_PK,
	CASHBANKEVENT_FACT_NK,
	EVENT_TYPE,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	EMPLOYEE_DIM_FK,
	CASHBANK_DIM_FK,
	CREATED_AT,
	NOTES,
	AMOUNT
) as
--==========================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  cbf.ID                                                      AS CASHBANKEVENT_FACT_PK  
--natural keys------------------------------------------------------------------------------
  ,cbf.ID                                                     AS CASHBANKEVENT_FACT_NK   
--name---------------------------------------------------------------------------------------
  ,EVENT_TYPE                                                 AS EVENT_TYPE 
--data warehouse REQUIRED rows---------------------------------------------------------------
  ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(cbf.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY cbf.ID ORDER BY cbf.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,cbf.MTLN_CDC_SEQUENCE_NUMBER,cbf.MTLN_CDC_SRC_VERSION
      ,cbf.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(cbf.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY cbf.ID ORDER BY cbf.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,cbf.MTLN_CDC_SEQUENCE_NUMBER,cbf.MTLN_CDC_SRC_VERSION,cbf.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY cbf.ID ORDER BY 
    cbf.MTLN_CDC_LAST_COMMIT_TIMESTAMP,cbf.MTLN_CDC_SEQUENCE_NUMBER,cbf.MTLN_CDC_SRC_VERSION
   ,cbf.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN cbf.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY cbf.ID ORDER BY  
    cbf.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,cbf.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,cbf.MTLN_CDC_SRC_VERSION DESC
   ,cbf.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     --REQUIRED    
--CDC Meta data REQUIRED rows--------------------------------------------------------------------
  ,cbf.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE                    
  ,cbf.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP               
  ,cbf.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER                     
  ,cbf.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID                       
  ,cbf.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP                      
  ,cbf.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR                 
  ,cbf.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION                         
  ,cbf.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME                            
  ,cbf.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH                            
  ,cbf.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE                        
  ,cbf.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA                         
  ,cbf.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE                           
--foreign keys-------------------------------------------------------------------------------
-- Note:  if the foreign key comes from JSON, cast it to a number as JSON values are typically text
  ,IFNULL(TO_NUMBER(cbf.EMPLOYEE_ID, 10, 0),-1)    AS EMPLOYEE_DIM_FK
  ,IFNULL(cbf.CASH_BANK_ID,-1)                     AS CASHBANK_DIM_FK              
--flags---------------------------------------------------------------------------------------
--Note:  ALLCOLUMN NAMES IN THIS SECTION SHOULD begin with is_ or has_ if created by the dw.
--    columns created by the source app should be specifically cast as boolean 
--Dates--------------.------------------------------------------------------------------------
--dates should be cast as dates
-- created_at timestamp with time zone  <--this is the create table from postgres
  ,to_timestamp_tz(cbf.CREATED_AT)     AS CREATED_AT 
--names, options, etc-------------------------------------------------------------------------
  ,cbf.NOTES                           AS NOTES
--Counts and Amounts--------------------------------------------------------------------------
--ALL COLUMNS IN THIS SECTION SHOULD END IN COUNT OR AMOUNT
--cOUNTS ARE INTEGERS, AMOUNTS ARE CONINUOUS OR DECIMAL
--if a count and amount exist for the same fact, they should be together with the count first
  ,TO_NUMBER(AMOUNT,38,4)/1000000       AS AMOUNT
-------------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_CASH_BANK_EVENT     cbf

;"
VIEW,DATAADMIN,DATASHARE_VIEW,"create or replace view DATASHARE_VIEW(
	DATASHARETESTNAME,
	OTHER_ID
) as
SELECT DATASHARETESTNAME,OTHER_ID FROM DATAWAREHOUSE.DATASHARETEST_DIM;"
VIEW,DATAADMIN,DISCOUNTCHEQUEBYITEM_FACT,"create or replace view DISCOUNTCHEQUEBYITEM_FACT(
	DISCOUNTCHEQUEBYITEM_FACT_PK,
	DISCOUNTCHEQUEBYITEM_FACT_NK,
	DISCOUNTNAME,
	DW_STARTDATE,
	FISCAL_DATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	CHEQUE_FACT_FK,
	DAYPART_DIM_FK,
	DISCOUNTCHECK_FACT_FK,
	EMPLOYEE_DIM_FK_AS_ADDED_BY,
	EMPLOYEE_DIM_FK_AS_APPROVED_BY,
	EMPLOYEE_DIM_FK,
	ITEM_FACT_FK,
	LOCATION_DIM_FK,
	STANDARDDISCOUNT_DIM_FK,
	DO_AUTOAPPLY,
	IS_TRAINING,
	ADDED_AT,
	CREATED_AT,
	OPENED_AT,
	UPDATED_AT,
	APPLICATION,
	STATUS,
	CHEQUESTATUS,
	DISCOUNTREASON,
	DISCOUNTLEVEL,
	RECEIPTNAME,
	PROMOCODE,
	PROMODESCRIPTION,
	REVENUECENTERNAME,
	ROUNDINGMETHOD,
	CHEQUENUMBER,
	DISCOUNT_ID,
	ITEM_ID,
	PROMOCODE_ID,
	DISCOUNT_TYPE,
	DISCOUNT_PERCENT,
	APPLIED_AMOUNT,
	DISCOUNT_AMOUNT,
	VALUE,
	DISCOUNT,
	DISCOUNTCHECK,
	DISCOUNTITEM,
	GROSS,
	NET,
	ITEM_QUANTITY,
	TOTAL_ITEMS_ON_CHECK,
	ITEM_ROW_NUMBER,
	SINGLE_ITEM_BASE_ALLOCATION,
	CHECK_REMAINDER,
	ALLOCATED_ITEM_DISCOUNT
) as
--============================================================================================
  SELECT
    -- Primary and Natural Keys
    -- Construct a unique key for each item's portion of a cheque discount.
     CD.CHEQUE_FACT_FK || '.' || CD.DISCOUNTNAME || '.' || ITM.ITEM_ID            AS DISCOUNTCHEQUEBYITEM_FACT_PK
     --natural keys------------------------------------------------------------------------------
    ,CD.CHEQUE_FACT_FK || '.' || CD.DISCOUNTNAME || '.' || ITM.ITEM_ID            AS DISCOUNTCHEQUEBYITEM_FACT_NK
    --name---------------------------------------------------------------------------------------
    ,CD.DISCOUNTNAME                                                              AS DISCOUNTNAME --this is discount id
    --data warehouse rows--------------------------------------------------------------------------
    ,CD.DW_STARTDATE                                                              AS DW_STARTDATE
    ,CD.FISCAL_DATE                                                               AS FISCAL_DATE
    ,CD.DW_ENDDATE                                                                AS DW_ENDDATE
    ,CD.DW_ISDELETED                                                              AS DW_ISDELETED
    ,CD.DW_ISCURRENTROW                                                           AS DW_ISCURRENTROW
    --CDC Meta data-------------------------------------------------------------------------------
    ,CD.MTLN_CDC_LAST_CHANGE_TYPE                                                 AS MTLN_CDC_LAST_CHANGE_TYPE
    ,CD.MTLN_CDC_LAST_COMMIT_TIMESTAMP                                            AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,CD.MTLN_CDC_SEQUENCE_NUMBER                                                  AS MTLN_CDC_SEQUENCE_NUMBER
    ,CD.MTLN_CDC_LOAD_BATCH_ID                                                    AS MTLN_CDC_LOAD_BATCH_ID
    ,CD.MTLN_CDC_LOAD_TIMESTAMP                                                   AS MTLN_CDC_LOAD_TIMESTAMP
    ,CD.MTLN_CDC_PROCESSED_DATE_HOUR                                              AS MTLN_CDC_PROCESSED_DATE_HOUR
    ,CD.MTLN_CDC_SRC_VERSION                                                      AS MTLN_CDC_SRC_VERSION
    ,CD.MTLN_CDC_FILENAME                                                         AS MTLN_CDC_FILENAME
    ,CD.MTLN_CDC_FILEPATH                                                         AS MTLN_CDC_FILEPATH
    ,CD.MTLN_CDC_SRC_DATABASE                                                     AS MTLN_CDC_SRC_DATABASE
    ,CD.MTLN_CDC_SRC_SCHEMA                                                       AS MTLN_CDC_SRC_SCHEMA
    ,CD.MTLN_CDC_SRC_TABLE                                                        AS MTLN_CDC_SRC_TABLE
    --foreign keys-------------------------------------------------------------------------------
    ,CD.CHEQUE_FACT_FK                                                            AS CHEQUE_FACT_FK
    ,CD.DAYPART_DIM_FK                                                            AS DAYPART_DIM_FK
    ,CD.DISCOUNTCHECK_FACT_NK                                                     AS DISCOUNTCHECK_FACT_FK
    ,CD.EMPLOYEE_DIM_FK_AS_ADDED_BY                                               AS EMPLOYEE_DIM_FK_AS_ADDED_BY
    ,CD.EMPLOYEE_DIM_FK_AS_APPROVED_BY                                            AS EMPLOYEE_DIM_FK_AS_APPROVED_BY
    ,CD.EMPLOYEE_DIM_FK                                                           AS EMPLOYEE_DIM_FK
    ,ITM.ITEM_FACT_NK                                                             AS ITEM_FACT_FK    
    ,CD.LOCATION_DIM_FK                                                           AS LOCATION_DIM_FK
    ,CD.STANDARDDISCOUNT_DIM_FK                                                   AS STANDARDDISCOUNT_DIM_FK
    --flags---------------------------------------------------------------------------------------
    ,CD.DO_AUTOAPPLY                                                              AS DO_AUTOAPPLY
    ,CD.IS_TRAINING                                                               AS IS_TRAINING
    --Dates--------------.------------------------------------------------------------------------
    ,CD.ADDED_AT                                                                  AS ADDED_AT
    ,CD.CREATED_AT                                                                AS CREATED_AT
    ,CD.OPENED_AT                                                                 AS OPENED_AT
    ,CD.UPDATED_AT                                                                AS UPDATED_AT
    --names, options, etc-------------------------------------------------------------------------
    ,CD.APPLICATION                                                               AS APPLICATION
    ,CD.STATUS                                                                    AS STATUS
    ,CD.CHEQUESTATUS                                                              AS CHEQUESTATUS
    ,CD.DISCOUNTREASON                                                            AS DISCOUNTREASON
    ,CD.DISCOUNTLEVEL                                                             AS DISCOUNTLEVEL
    ,CD.RECEIPTNAME                                                               AS RECEIPTNAME
    ,CD.PROMOCODE                                                                 AS PROMOCODE
    ,CD.PROMODESCRIPTION                                                          AS PROMODESCRIPTION
    ,CD.REVENUECENTERNAME                                                         AS REVENUECENTERNAME
    ,CD.ROUNDINGMETHOD                                                            AS ROUNDINGMETHOD
    --name---------------------------------------------------------------------------------------
    ,CD.CHEQUENUMBER                                                              AS CHEQUENUMBER
    ,CD.DISCOUNTNAME                                                              AS DISCOUNT_ID
    ,ITM.ITEM_ID                                                                  AS ITEM_ID
    ,CD.PROMOCODE_ID                                                              AS PROMOCODE_ID
    ,CD.DISCOUNT_TYPE                                                             AS DISCOUNT_TYPE
    --Counts and Amounts--------------------------------------------------------------------------
    ,CD.DISCOUNT_PERCENT                                                          AS DISCOUNT_PERCENT
    ,CD.APPLIED_AMOUNT                                                            AS APPLIED_AMOUNT
    ,CD.DISCOUNT_AMOUNT                                                           AS DISCOUNT_AMOUNT
    ,CD.VALUE                                                                     AS VALUE
    ,CD.DISCOUNT                                                                  AS DISCOUNT
    ,CD.DISCOUNTCHECK                                                             AS DISCOUNTCHECK
    ,CD.DISCOUNTITEM                                                              AS DISCOUNTITEM
    ,CD.GROSS                                                                     AS GROSS
    ,CD.NET                                                                       AS NET

    -- here starts the operations to calculate the final ALLOCATED_ITEM_DISCOUNT which will be used with STANDARDDISCOUNTNAME
    ,ITM.QUANTITY                                                                           AS ITEM_QUANTITY -- This section performs the distribution of the cheque discount across the items.
    ,SUM(ITM.QUANTITY) OVER (
        PARTITION BY CD.CHEQUE_FACT_FK, CD.DISCOUNTNAME, CD.MTLN_CDC_SEQUENCE_NUMBER
     )                                                                                      AS TOTAL_ITEMS_ON_CHECK -- Calculate the total quantity of all items on the check for this specific discount record.
    ,ROW_NUMBER() OVER (
        PARTITION BY CD.CHEQUE_FACT_FK, CD.DISCOUNTNAME, CD.MTLN_CDC_SEQUENCE_NUMBER
        ORDER BY ITM.ITEM_ID
     )                                                                                      AS ITEM_ROW_NUMBER -- Assign a row number to each item line within the check. This is used to assign the rounding remainder.
    ,ROUND(CD.APPLIED_AMOUNT / TOTAL_ITEMS_ON_CHECK, 2)                                     AS SINGLE_ITEM_BASE_ALLOCATION  -- Calculate the base allocation for a single item (quantity of 1).
    ,CD.APPLIED_AMOUNT - (SINGLE_ITEM_BASE_ALLOCATION * TOTAL_ITEMS_ON_CHECK)               AS CHECK_REMAINDER -- Calculate the total remainder for the entire check to handle rounding issues.
    ,(SINGLE_ITEM_BASE_ALLOCATION * ITM.QUANTITY) +
        CASE
            WHEN ITEM_ROW_NUMBER = 1 THEN CHECK_REMAINDER
            ELSE 0
        END                                                                                 AS ALLOCATED_ITEM_DISCOUNT -- Calculate the final allocated discount for this specific item, adding the remainder to the first item.
  ------------------------------------------------------------------------------------------------------------------------
  FROM DATAADMIN.DISCOUNTCHECK_FACT AS CD
  -- Join the cheque-level discounts with all items on that same cheque using ITEM_FACT.
  -- The join includes MTLN_CDC_SEQUENCE_NUMBER to ensure correctness for records processed in the same batch.
  JOIN DATAADMIN.ITEM_FACT AS ITM
    ON CD.CHEQUE_FACT_FK = ITM.CHEQUE_FACT_FK
   AND CD.MTLN_CDC_SEQUENCE_NUMBER = ITM.MTLN_CDC_SEQUENCE_NUMBER
  WHERE
    ITM.ITEMSTATUS IN ('Added','Sent','IndefiniteHold')
    -- AND CD.CHEQUESTATUS IN ('Closed') 
    -- AND NOT CD.STATUS = 'Disabled'

--===========================================================================================
--End of View
--============================================================================================

/*
-- USAGE AND VALIDATIONS
;
--===========================================================================================
--Compare vs discount report
--============================================================================================
DROP TABLE if exists REPORT_DATA_DIS;
CALL DATAADMIN.SP_REPORT_DISCOUNT('2000-06-01T14:48:37.661Z','2029-06-26T14:48:37.661Z','[26,27]');
CREATE TEMP TABLE REPORT_DATA_DIS AS
     SELECT * FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()));

WITH DiscountsByItemFactAgg AS (
    SELECT
    CHEQUE_FACT_FK,
        LOCATION_DIM_FK,
        FISCAL_DATE,
        SUM(ALLOCATED_ITEM_DISCOUNT) AS TOTAL_ALLOCATED_ITEM_DISCOUNT
    FROM
        DISCOUNTCHEQUEBYITEM_FACT
        -- DISCOUNTCHEQUEBYITEM_FACT_DEV
    WHERE
      DW_ISCURRENTROW
      AND NOT DW_ISDELETED
      AND LOCATION_DIM_FK IN (26,27)
    GROUP BY
    CHEQUE_FACT_FK,
        LOCATION_DIM_FK,
        FISCAL_DATE
),
ReportDataAgg AS (
    -- This new CTE aggregates the report data to the same level as VoidsByItemFactAgg
    SELECT
    SUBSTR(""Support ID"", 1, POSITION('.', ""Support ID"") - 1) AS CHEQUE_REPORT,
        ""Location ID"",
        ""Fiscal Date"",
        SUM(""Discount Amount"") AS total_report_discount_amount
    FROM
         DATAADMIN.REPORT_DATA_DIS
    where ""Discount Level"" = 'Check'
    
    GROUP BY
    CHEQUE_REPORT,
        ""Location ID"",
        ""Fiscal Date""
)
SELECT
    v.location_dim_fk,
    v.fiscal_date,
    v.CHEQUE_FACT_FK ,
    COALESCE(v.TOTAL_ALLOCATED_ITEM_DISCOUNT, 0) AS TOTAL_ALLOCATED_ITEM_DISCOUNT,
    COALESCE(rdv.total_report_discount_amount, 0) AS total_report_discount_amount,
    -- Calculate the difference using the coalesced amounts
    (COALESCE(v.TOTAL_ALLOCATED_ITEM_DISCOUNT, 0) - COALESCE(rdv.total_report_discount_amount, 0)) AS difference
FROM
    DiscountsByItemFactAgg AS v
-- INNER JOIN
FULL OUTER JOIN
    -- Join to the newly created aggregated CTE
    ReportDataAgg AS rdv
ON
    v.location_dim_fk = rdv.""Location ID""
    AND v.fiscal_date = rdv.""Fiscal Date""
    AND v.CHEQUE_FACT_FK = rdv.CHEQUE_REPORT
-- WHERE v.CHEQUE_FACT_FK = 356344
ORDER BY
    abs(difference) DESC
;



--===========================================================================================
--Other validation queries
--============================================================================================
-- AT THE PARTITION LEVEL validate if the sum of the allocated disounts yields the same value as the sum if the discounts (APPLIED_AMOUT)
SELECT 
-- Validation columns
  SUM(ALLOCATED_ITEM_DISCOUNT) OVER (PARTITION BY CHEQUE_FACT_FK, DISCOUNT_ID, MTLN_CDC_SEQUENCE_NUMBER)     AS TOTAL_ALLOCATED_DISCOUNT
  ,APPLIED_AMOUNT - SUM(ALLOCATED_ITEM_DISCOUNT) OVER (PARTITION BY CHEQUE_FACT_FK, DISCOUNT_ID, MTLN_CDC_SEQUENCE_NUMBER) AS ALLOCATION_DIFFERENCE
from DISCOUNTCHEQUEBYITEM_FACT_DEV_V2
WHERE DW_ISCURRENTROW
AND LOCATION_DIM_FK = 26
qualify ALLOCATION_DIFFERENCE > 0
;



--remove caching and test if this runs fast that means snowflake is able to apply filters as early as possible
ALTER SESSION SET USE_CACHED_RESULT = FALSE;
SELECT * FROM DISCOUNTCHEQUEBYITEM_FACT_DEV_V2
WHERE
DW_ISCURRENTROW
AND LOCATION_DIM_FK = 26
AND CHEQUE_FACT_FK = 183828
AND DISCOUNT_ID = '547e90f5-5683-4de4-b44c-06f5d44c4878'
;


-- Compares total sum of discounts in entire dataset
WITH UniqueDiscounts AS (
    -- This CTE isolates the unique discount amounts to avoid double-counting.
    -- The view is at an item level, so each check-level discount is repeated for every item on the check.
    SELECT
        APPLIED_AMOUNT,
        CHEQUE_FACT_FK
    FROM DISCOUNTCHEQUEBYITEM_FACT_DEV_V2
    WHERE DW_ISCURRENTROW
    AND LOCATION_DIM_FK = 26
    -- We partition by the unique identifiers of a check discount instance.
    QUALIFY ROW_NUMBER() OVER (PARTITION BY CHEQUE_FACT_FK, DISCOUNT_ID, MTLN_CDC_SEQUENCE_NUMBER ORDER BY MTLN_CDC_SEQUENCE_NUMBER DESC ) = 1
),
TotalOriginalDiscount AS (
    -- This CTE sums up the unique discount amounts and counts distinct cheques to get the true total values.
    SELECT
        SUM(APPLIED_AMOUNT) AS TOTAL_APPLIED,
        COUNT(DISTINCT CHEQUE_FACT_FK) AS TOTAL_ORIGINAL_CHECKS
    FROM UniqueDiscounts
),
TotalAllocatedDiscount AS (
    -- This CTE sums up the allocated discount amounts across all items and counts the distinct cheques.
    -- This should equal the total original discount if the allocation logic is correct.
    SELECT
        SUM(ALLOCATED_ITEM_DISCOUNT) AS TOTAL_ALLOCATED,
        COUNT(DISTINCT CHEQUE_FACT_FK) AS TOTAL_ALLOCATED_CHECKS
    FROM DISCOUNTCHEQUEBYITEM_FACT_DEV_V2
    WHERE DW_ISCURRENTROW
    AND LOCATION_DIM_FK = 26
)
-- Final comparison
SELECT
    T1.TOTAL_APPLIED,
    T2.TOTAL_ALLOCATED,
    T1.TOTAL_APPLIED - T2.TOTAL_ALLOCATED AS DIFFERENCE,
    T1.TOTAL_ORIGINAL_CHECKS,
    T2.TOTAL_ALLOCATED_CHECKS,
    T1.TOTAL_ORIGINAL_CHECKS - T2.TOTAL_ALLOCATED_CHECKS AS CHECKS_DIFFERENCE
FROM TotalOriginalDiscount T1, TotalAllocatedDiscount T2;

-- TOTAL_APPLIED	TOTAL_ALLOCATED	DIFFERENCE	TOTAL_ORIGINAL_CHECKS	TOTAL_ALLOCATED_CHECKS	CHECKS_DIFFERENCE
-- 35119.32	35119.32	0	597	597	0
;
*/
;"
VIEW,DATAADMIN,DISCOUNTREASON_DIM,"create or replace view DISCOUNTREASON_DIM(
	DISCOUNTREASON_DIM_PK,
	DISCOUNTREASON_DIM_NK,
	DISCOUNTREASON,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	IS_ENABLED,
	CREATED_AT,
	UPDATED_AT,
	DESCRIPTION
) as
--============================================================================================
SELECT 
--primary keys--------------------------------------------------------------------------------
  vdr.ID                                                      AS DiscountReason_DIM_PK  
--natural keys--------------------------------------------------------------------------------
  ,vdr.ID                                                     AS DiscountReason_DIM_NK  
--name-----------------------------------------------------------------------------------------
  ,vdr.REASON                                                 AS DiscountReason
--data warehouse REQUIRED rows-----------------------------------------------------------------
 ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(vdr.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY vdr.ID ORDER BY vdr.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,vdr.MTLN_CDC_SEQUENCE_NUMBER,vdr.MTLN_CDC_SRC_VERSION
      ,vdr.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(vdr.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY vdr.ID ORDER BY vdr.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,vdr.MTLN_CDC_SEQUENCE_NUMBER,vdr.MTLN_CDC_SRC_VERSION,vdr.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY vdr.ID ORDER BY 
    vdr.MTLN_CDC_LAST_COMMIT_TIMESTAMP,vdr.MTLN_CDC_SEQUENCE_NUMBER,vdr.MTLN_CDC_SRC_VERSION
   ,vdr.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN vdr.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY vdr.ID ORDER BY  
    vdr.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,vdr.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,vdr.MTLN_CDC_SRC_VERSION DESC
   ,vdr.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     --REQUIRED 
-- --CDC Meta data REQUIRED rows------------------------------------------------------------------
  ,vdr.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE                  
  ,vdr.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP              
  ,vdr.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER                   
  ,vdr.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID                      
  ,vdr.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP                    
  ,vdr.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR                
  ,vdr.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION                        
  ,vdr.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME                           
  ,vdr.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH                           
  ,vdr.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE                       
  ,vdr.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA                        
  ,vdr.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE                          
-- --foreign keys--------------------------------------------------------------------------------
-- --flags---------------------------------------------------------------------------------------
  ,vdr.IS_ENABLED                      AS IS_ENABLED
-- --Dates--------------.------------------------------------------------------------------------
  ,to_timestamp_tz(vdr.CREATED_AT)     AS CREATED_AT  
  ,to_timestamp_tz(vdr.UPDATED_AT)     AS UPDATED_AT
-- --names, options, etc-------------------------------------------------------------------------
  ,'None'                              AS DESCRIPTION
----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_DISCOUNT_REASON    vdr
;"
VIEW,DATAADMIN,PAYINOUT_FACT,"create or replace view PAYINOUT_FACT(
	PAYINOUT_FACT_PK,
	PAYINOUT_FACT_NK,
	PAYID,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	CCTRANSATION_FACT_FK,
	PAYMENTMETHOD_DIM_FK,
	PAYINPAYOUTREASON_DIM_FK,
	SHIFT_DIM_FK,
	IS_VOID,
	VOIDED_AT,
	CREATED_AT,
	UPDATED_AT,
	STATUS,
	VOIDED_BY,
	NOTES,
	CC_TRANSACTION_ID,
	PAY_IN_OUT_REASON_ID,
	SHIFT_ID,
	AMOUNT
) as
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  PIO.ID                                                      AS PAYINOUT_FACT_PK
--natural keys------------------------------------------------------------------------------
  ,PIO.ID                                                     AS PAYINOUT_FACT_NK
--name---------------------------------------------------------------------------------------
  ,PIO.ID                                                     AS PAYID
--data warehouse rows------------------------------------------------------------------------
 ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(PIO.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY PIO.ID ORDER BY PIO.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,PIO.MTLN_CDC_SEQUENCE_NUMBER,PIO.MTLN_CDC_SRC_VERSION
      ,PIO.MTLN_CDC_FILENAME)),6))
                                                             AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(PIO.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY PIO.ID ORDER BY PIO.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,PIO.MTLN_CDC_SEQUENCE_NUMBER,PIO.MTLN_CDC_SRC_VERSION,PIO.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY PIO.ID ORDER BY 
    PIO.MTLN_CDC_LAST_COMMIT_TIMESTAMP,PIO.MTLN_CDC_SEQUENCE_NUMBER,PIO.MTLN_CDC_SRC_VERSION
   ,PIO.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN PIO.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY PIO.ID ORDER BY  
    PIO.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,PIO.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,PIO.MTLN_CDC_SRC_VERSION DESC
   ,PIO.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     --REQUIRED
--CDC Meta data-------------------------------------------------------------------------------
  ,PIO.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE
  ,PIO.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,PIO.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER
  ,PIO.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID
  ,PIO.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP
  ,PIO.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,PIO.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION
  ,PIO.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME
  ,PIO.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH
  ,PIO.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE
  ,PIO.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA
  ,PIO.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE
--foreign keys-------------------------------------------------------------------------------
  ,IFNULL(PIO.CC_TRANSACTION_ID,-1)               AS CCTRANSATION_FACT_FK
  ,IFNULL(PIO.PAYMENT_METHOD_ID,-1)               AS PAYMENTMETHOD_DIM_FK
  ,IFNULL(PIO.PAY_IN_OUT_REASON_ID,-1)            AS PAYINPAYOUTREASON_DIM_FK
  ,IFNULL(PIO.SHIFT_ID,-1)                        AS SHIFT_DIM_FK
--flags---------------------------------------------------------------------------------------
  ,PIO.IS_VOID                         AS IS_VOID
--Dates--------------.------------------------------------------------------------------------
  ,TO_TIMESTAMP_TZ(PIO.VOIDED_AT)      AS VOIDED_AT
  ,TO_TIMESTAMP_TZ(PIO.CREATED_AT)     AS CREATED_AT
  ,TO_TIMESTAMP_TZ(PIO.UPDATED_AT)     AS UPDATED_AT
--names, options, etc-------------------------------------------------------------------------
  ,PIO.STATUS                          AS STATUS
  ,PIO.VOIDED_BY                       AS VOIDED_BY
  ,PIO.NOTES                           AS NOTES
  ,PIO.CC_TRANSACTION_ID               AS CC_TRANSACTION_ID
  ,PIO.PAY_IN_OUT_REASON_ID            AS PAY_IN_OUT_REASON_ID
  ,PIO.SHIFT_ID                        AS SHIFT_ID
--Counts and Amounts--------------------------------------------------------------------------
   ,PIO.AMOUNT/1000000                 AS AMOUNT
----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_PAY_IN_OUT_TX     PIO
order by TO_TIMESTAMP_TZ(PIO.CREATED_AT)  desc
;"
VIEW,DATAADMIN,TAXASSOCIATION_DIM,"create or replace view TAXASSOCIATION_DIM(
	TAXASSOCIATION_DIM_PK,
	TAXASSOCIATION_DIM_NK,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	LOCATION_DIM_FK,
	LOCATIONGROUP_DIM_FK,
	ORDERTYPE_DIM_FK,
	IS_VETO,
	CREATED_AT,
	UPDATED_AT
) as
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  tab.ID                                                      AS TAXASSOCIATION_DIM_PK  
--natural keys------------------------------------------------------------------------------
  ,tab.ID                                                     AS TAXASSOCIATION_DIM_NK  
--name-------------------------------------------------------------------------------------------
  -- ,tab.NAME                                                AS TAXASSOCIATION
--data warehouse REQUIRED rows-------------------------------------------------------------------
  ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY tab.ID ORDER BY tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION
      ,tab.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE    
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY tab.ID ORDER BY tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION,tab.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY tab.ID ORDER BY 
    tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION
   ,tab.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE 
  
  ,CASE WHEN tab.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED          
  ,CASE WHEN RANK() OVER(PARTITION BY tab.ID ORDER BY  
    tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,tab.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,tab.MTLN_CDC_SRC_VERSION DESC
   ,tab.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW       
--CDC Meta data REQUIRED rows-------------------------------------------------------------------------------
  ,tab.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE                   
  ,tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP             
  ,tab.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER                   
  ,tab.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID                     
  ,tab.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP                     
  ,tab.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR                
  ,tab.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION                        
  ,tab.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME                          
  ,tab.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH                           
  ,tab.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE                      
  ,tab.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA                        
  ,tab.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE                          
--foreign keys-------------------------------------------------------------------------------
 ,IFNULL(tab.LOCATION_ID,-1)           AS LOCATION_DIM_FK 
 ,IFNULL(tab.LOCATION_GROUP_ID,-1)     AS LOCATIONGROUP_DIM_FK 
 ,IFNULL(tab.ORDER_TYPE_ID,-1)         AS ORDERTYPE_DIM_FK 
--flags---------------------------------------------------------------------------------------
--ALLCOLUMN NAMES IN THIS SECTION SHOULD begin with is_ or has_ if created by the dw.
--   columns created by the source app should be specifically cast as boolean 
,tab.IS_VETO                           AS IS_VETO
--Dates--------------.------------------------------------------------------------------------
--dates should be cast as dates
-- created_at timestamp with time zone  <--this is the create table from postgres
--,to_timestamp_tz(created_at) 
  ,to_timestamp_tz(tab.CREATED_AT)     AS CREATED_AT  
  ,to_timestamp_tz(tab.UPDATED_AT)     AS UPDATED_AT
--names, options, etc-------------------------------------------------------------------------
-- -------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_TAX_ASSOCIATION     tab
;"
VIEW,DATAADMIN,LOCATION_DIM,"create or replace view LOCATION_DIM(
	LOCATION_DIM_PK,
	LOCATION_DIM_NK,
	LOCATIONNAME,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	ADDRESS_DIM_FK,
	ORGANIZATION_DIM_FK,
	CREATED_AT,
	UPDATED_AT,
	FISCAL_DAY_START,
	TZ_NAME
) as
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  LOC.ID                                                     AS LOCATION_DIM_PK
--natural keys------------------------------------------------------------------------------
  ,LOC.ID                                                    AS LOCATION_DIM_NK
--name---------------------------------------------------------------------------------------
  ,LOC.name                                                  AS LOCATIONNAME
--data warehouse rows------------------------------------------------------------------------
  ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LOC.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY LOC.ID ORDER BY LOC.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,LOC.MTLN_CDC_SEQUENCE_NUMBER,LOC.MTLN_CDC_SRC_VERSION
      ,LOC.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(LOC.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY LOC.ID ORDER BY LOC.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,LOC.MTLN_CDC_SEQUENCE_NUMBER,LOC.MTLN_CDC_SRC_VERSION,LOC.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY LOC.ID ORDER BY 
    LOC.MTLN_CDC_LAST_COMMIT_TIMESTAMP,LOC.MTLN_CDC_SEQUENCE_NUMBER,LOC.MTLN_CDC_SRC_VERSION
   ,LOC.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN LOC.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY LOC.ID ORDER BY  
    LOC.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,LOC.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,LOC.MTLN_CDC_SRC_VERSION DESC
   ,LOC.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     --REQUIRED 
--CDC Meta data-------------------------------------------------------------------------------
  ,LOC.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE
  ,LOC.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,LOC.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER
  ,LOC.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID
  ,LOC.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP
  ,LOC.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,LOC.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION
  ,LOC.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME
  ,LOC.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH
  ,LOC.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE
  ,LOC.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA
  ,LOC.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE
--foreign keys-------------------------------------------------------------------------------
  ,IFNULL(LOC.address_id,-1)           AS ADDRESS_DIM_FK
  ,IFNULL(LOC.organization_id,-1)      AS ORGANIZATION_DIM_FK
--flags---------------------------------------------------------------------------------------
--Dates--------------.------------------------------------------------------------------------
   --,LOC.auto_eod_time                AS AUTO_EOD_TIME
   ,TO_TIMESTAMP_TZ(LOC.created_at)    AS CREATED_AT
   ,TO_TIMESTAMP_TZ(LOC.updated_at)    AS UPDATED_AT
--Names--------------------------------------------------------------------------------------
  ,LOC.FISCAL_DAY_START /1000 ::NUMBER          AS FISCAL_DAY_START
  -- ,CASE LOC.FISCAL_DAY_START 
  --   WHEN 0 THEN 'Sunday'
  --   WHEN 1 THEN 'Monday'
  --   WHEN 2 THEN 'Tuesday'
  --   WHEN 3 THEN 'Wednesday'
  --   WHEN 4 THEN 'Thursday'
  --   WHEN 5 THEN 'Fridayday'
  --   WHEN 6 THEN 'Saturday'
  --   END                             AS FISCAL_DAY_START
  ,LOC.TZ_NAME                         AS TZ_NAME
----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_LOCATION     LOC
;"
VIEW,DATAADMIN,LOCATION_LOCATIONGROUP_XREF,"create or replace view LOCATION_LOCATIONGROUP_XREF(
	LOCATION_LOCATIONGROUP_XREF_PK,
	LOCATION_LOCATIONGROUP_XREF_NK,
	LOCATION_LOCATION_GROUP,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	LOCATIONGROUP_DIM_FK,
	LOCATION_DIM_FK,
	CREATED_AT,
	UPDATED_AT
) as
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  LGL.ID                                                     AS LOCATION_LOCATIONGROUP_XREF_PK
--natural keys------------------------------------------------------------------------------
  ,LGL.ID                                                    AS LOCATION_LOCATIONGROUP_XREF_NK
--name---------------------------------------------------------------------------------------
 ,TO_DECIMAL(TO_VARCHAR(LGL.LOCATION_ID) || '.'  || RIGHT('000000000000000' || LGL.LOCATION_GROUP_ID , 16) ,38,16) 
                                                             AS LOCATION_LOCATION_GROUP
--data warehouse rows------------------------------------------------------- -----------------
  ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LGL.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY LGL.ID ORDER BY LGL.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,LGL.MTLN_CDC_SEQUENCE_NUMBER,LGL.MTLN_CDC_SRC_VERSION
      ,LGL.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(LGL.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY LGL.ID ORDER BY LGL.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,LGL.MTLN_CDC_SEQUENCE_NUMBER,LGL.MTLN_CDC_SRC_VERSION,LGL.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY LGL.ID ORDER BY 
    LGL.MTLN_CDC_LAST_COMMIT_TIMESTAMP,LGL.MTLN_CDC_SEQUENCE_NUMBER,LGL.MTLN_CDC_SRC_VERSION
   ,LGL.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN LGL.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY LGL.ID ORDER BY  
    LGL.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,LGL.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,LGL.MTLN_CDC_SRC_VERSION DESC
   ,LGL.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     --REQUIRED
--CDC Meta data-------------------------------------------------------------------------------
  ,LGL.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE
  ,LGL.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,LGL.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER
  ,LGL.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID
  ,LGL.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP
  ,LGL.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,LGL.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION
  ,LGL.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME
  ,LGL.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH
  ,LGL.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE
  ,LGL.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA
  ,LGL.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE
--foreign keys-------------------------------------------------------------------------------
  ,IFNULL(LGL.LOCATION_GROUP_ID,-1)    AS LOCATIONGROUP_DIM_FK
  ,IFNULL(LGL.LOCATION_ID,-1)          AS LOCATION_DIM_FK
--flags---------------------------------------------------------------------------------------
--NONE
--Dates--------------.------------------------------------------------------------------------
  ,TO_TIMESTAMP_TZ(LGL.CREATED_AT)     AS CREATED_AT   
  ,TO_TIMESTAMP_TZ(LGL.UPDATED_AT)     AS UPDATED_AT
--names, options, etc-------------------------------------------------------------------------
--NONE
--Counts and Amounts--------------------------------------------------------------------------
--NONE
----------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_LOCATION_GROUP_LOCATIONS     LGL
;"
VIEW,DATAADMIN,OVERTIMELABORRULE_DIM,"create or replace view OVERTIMELABORRULE_DIM(
	OVERTIMELABORRULE_DIM_PK,
	OVERTIMELABORRULE_DIM_NK,
	OVERTIMERULE,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	LOCATION_DIM_FK,
	SHOULD_NOTIFY_MANAGER,
	IS_ACTIVE,
	CREATED_AT,
	UPDATED_AT,
	HOURS_PER_DAY,
	HOURS_PER_WEEK
) as
--============================================================================================
SELECT 
--primary keys------------------------------------------------------------------------------
  tab.ID                                                      AS OVERTIMELABORRULE_DIM_PK   
--natural keys------------------------------------------------------------------------------
  ,tab.ID                                                     AS OVERTIMELABORRULE_DIM_NK   
--name-------------------------------------------------------------------------------------------
  ,tab.NAME                                                   AS OVERTIMERULE
--data warehouse REQUIRED rows-------------------------------------------------------------------
 ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY tab.ID ORDER BY tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION
      ,tab.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY tab.ID ORDER BY tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION,tab.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY tab.ID ORDER BY 
    tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP,tab.MTLN_CDC_SEQUENCE_NUMBER,tab.MTLN_CDC_SRC_VERSION
   ,tab.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE           
  
  ,CASE WHEN tab.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED             
  ,CASE WHEN RANK() OVER(PARTITION BY tab.ID ORDER BY  
    tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,tab.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,tab.MTLN_CDC_SRC_VERSION DESC
   ,tab.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW      
--CDC Meta data REQUIRED rows-------------------------------------------------------------------------------
  ,tab.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE                    
  ,tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP               
  ,tab.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER                     
  ,tab.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID                       
  ,tab.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP                     
  ,tab.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR                
  ,tab.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION                         
  ,tab.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME                           
  ,tab.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH                           
  ,tab.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE                       
  ,tab.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA                         
  ,tab.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE                           
--foreign keys-------------------------------------------------------------------------------
  ,IFNULL(tab.LOCATION_ID,-1)          AS LOCATION_DIM_FK 
--flags---------------------------------------------------------------------------------------
--ALLCOLUMN NAMES IN THIS SECTION SHOULD begin with is_ or has_ if created by the dw.
--   columns created by the source app should be specifically cast as boolean 
--Alphabetize between the lines
  ,tab.NOTIFY_MANAGER                  AS SHOULD_NOTIFY_MANAGER
  ,tab.IS_ACTIVE                       AS IS_ACTIVE
--Dates--------------.------------------------------------------------------------------------
  ,to_timestamp_tz(tab.CREATED_AT)     AS CREATED_AT  
  ,to_timestamp_tz(tab.UPDATED_AT)     AS UPDATED_AT
--names, options, etc-------------------------------------------------------------------------
--Counts and Amounts--------------------------------------------------------------------------
  ,TO_NUMBER(tab.HOURS_PER_DAY,38,0)    AS HOURS_PER_DAY
 ,TO_NUMBER(tab.HOURS_PER_WEEK,38,0)    AS HOURS_PER_WEEK
-- --------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_OVERTIME_LABOR_RULE     tab
;"
VIEW,DATAADMIN,STANDARDDISCOUNT_DIM,"create or replace view STANDARDDISCOUNT_DIM(
	STANDARDDISCOUNT_DIM_PK,
	STANDARDDISCOUNT_DIM_NK,
	STANDARDDISCOUNTNAME,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	ORGANIZATION_DIM_FK,
	IS_ENABLED,
	IS_TAXABLE,
	DO_AUTO_APPLY,
	REQUIRE_APPROVAL,
	CREATED_AT,
	UPDATED_AT,
	STANDARDDISCOUNTSHORTNAME,
	RECEIPT_NAME,
	OPEN_LIMIT,
	DISCOUNTTYPE,
	DISCOUNTAPPLICATION,
	FIXED_VALUE,
	MIN_CHECK_AMOUNT,
	MAX_CHECK_AMOUNT
) as
--============================================================================================
SELECT 
--primary keys---------------------------------------------------------------------------------
  tab.ID                                                      AS STANDARDDISCOUNT_DIM_PK   
--natural keys---------------------------------------------------------------------------------
  ,tab.ID                                                     AS STANDARDDISCOUNT_DIM_NK   
-- --name--------------------------------------------------------------------------------------
  ,name                                                       AS STANDARDDISCOUNTNAME
--data warehouse REQUIRED rows-----------------------------------------------------------------
  ,TO_TIMESTAMP(TO_CHAR(MTLN_CDC_LAST_COMMIT_TIMESTAMP)  
    || RIGHT(TAB.MTLN_CDC_SEQUENCE_NUMBER,6)) 
                                                              AS DW_STARTDATE         
  ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(TO_CHAR(LEAD(MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY tab.ID ORDER BY tab.MTLN_CDC_SEQUENCE_NUMBER)  
    || RIGHT(LEAD(tab.MTLN_CDC_SEQUENCE_NUMBER) OVER (PARTITION 
    BY tab.ID ORDER BY tab.MTLN_CDC_SEQUENCE_NUMBER)
   ,6)),'9999-09-09 09:09:09.000')))
                                                              AS DW_ENDDATE         
  ,CASE WHEN tab.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                    
                                                              AS DW_ISDELETED         
  ,CASE tab.MTLN_CDC_SEQUENCE_NUMBER 
        WHEN MAX(tab.MTLN_CDC_SEQUENCE_NUMBER) 
        OVER (PARTITION BY tab.ID) THEN TRUE ELSE FALSE END 
                                                              AS DW_ISCURRENTROW     
--CDC Meta data REQUIRED rows-----------------------------------------------------------------
  ,tab.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE                   
  ,tab.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP              
  ,tab.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER                    
  ,tab.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID                      
  ,tab.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP                     
  ,tab.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR                
  ,tab.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION                         
  ,tab.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME                            
  ,tab.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH                            
  ,tab.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE                        
  ,tab.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA                          
  ,tab.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE                           
--foreign keys-------------------------------------------------------------------------------
  ,tab.ORGANIZATION_id                 AS ORGANIZATION_DIM_FK
-- --flags-----------------------------------------------------------------------------------
  ,tab.IS_ENABLED                      AS IS_ENABLED
  ,tab.is_taxable                      AS IS_TAXABLE
  ,tab.DO_AUTO_APPLY                   AS DO_AUTO_APPLY
  ,tab.REQUIRE_APPROVAL                AS REQUIRE_APPROVAL
-- --Dates--------------.--------------------------------------------------------------------
  ,to_timestamp_tz(tab.CREATED_AT)     AS CREATED_AT  
  ,to_timestamp_tz(tab.UPDATED_AT)     AS UPDATED_AT
-- --names, options, etc---------------------------------------------------------------------
  ,tab.short_name                      AS STANDARDDISCOUNTSHORTNAME
  ,tab.receipt_name                    AS RECEIPT_NAME
  ,tab.open_limit                      AS OPEN_LIMIT
  ,tab.type                            AS DISCOUNTTYPE
  ,tab.application                     AS DISCOUNTAPPLICATION
  ,tab.fixed_value                     AS FIXED_VALUE
  ,tab.MIN_CHECK_AMOUNT                AS MIN_CHECK_AMOUNT              
  ,tab.MAX_CHECK_AMOUNT                AS MAX_CHECK_AMOUNT
-- ------------------------------------------------------------------------------------------
FROM DATALANDING.POSAPI_PUBLIC_STANDARD_DISCOUNT     tab
;"
VIEW,DATAADMIN,SURCHARGECHEQUEBYITEM_FACT,"create or replace view SURCHARGECHEQUEBYITEM_FACT(
	SURCHARGECHEQUEBYITEM_FACT_PK,
	SURCHARGECHEQUEBYITEM_FACT_NK,
	SURCHARGENAME,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	CHEQUE_FACT_FK,
	DAYPART_DIM_FK,
	EMPLOYEE_DIM_FK,
	LOCATION_DIM_FK,
	SURCHARGE_DIM_NK,
	ITEM_FACT_FK,
	IS_AUTOAPPLIED,
	IS_GRATUITY,
	IS_TAXABLE,
	IS_TRAINING,
	IS_PRINTONRECEIPT,
	CREATED_AT,
	FISCAL_DATE,
	OPENED_AT,
	UPDATED_AT,
	STATUS,
	CHEQUENUMBER,
	SURCHARGE_TYPE,
	ITEM_ID,
	MENUITEM_DIM_FK,
	MENUITEMNAME_DIM_FK,
	SURCHARGE_QUANTITY,
	SURCHARGE_AMOUNT,
	SURCHARGE_APPLIEDAMOUNT,
	ITEM_QUANTITY,
	TOTAL_ITEMS_ON_CHECK,
	ITEM_ROW_NUMBER,
	AMOUNT_SINGLE_ITEM_BASE_ALLOCATION,
	AMOUNT_CHECK_REMAINDER,
	AMOUNT_ALLOCATED_ITEM_SURCHARGE,
	APPLIED_SINGLE_ITEM_BASE_ALLOCATION,
	APPLIED_CHECK_REMAINDER,
	APPLIED_ALLOCATED_ITEM_SURCHARGE
) as 
SELECT
--keys---------------------------------------------------------------------------------------
    S.SURCHARGE_FACT_PK || '.' || ITM.ITEM_FACT_PK                    AS SURCHARGECHEQUEBYITEM_FACT_PK
   ,S.SURCHARGE_FACT_NK || '.' || ITM.ITEM_FACT_NK                    AS SURCHARGECHEQUEBYITEM_FACT_NK

--name---------------------------------------------------------------------------------------
   ,S.SURCHARGENAME                                                   AS SURCHARGENAME

--data warehouse rows------------------------------------------------------------------------
   ,S.DW_STARTDATE                                                    AS DW_STARTDATE
   ,S.DW_ENDDATE                                                      AS DW_ENDDATE
   ,S.DW_ISDELETED                                                    AS DW_ISDELETED
   ,S.DW_ISCURRENTROW                                                 AS DW_ISCURRENTROW

--CDC Meta data-------------------------------------------------------------------------------
   ,S.MTLN_CDC_LAST_CHANGE_TYPE                                       AS MTLN_CDC_LAST_CHANGE_TYPE
   ,S.MTLN_CDC_LAST_COMMIT_TIMESTAMP                                  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
   ,S.MTLN_CDC_SEQUENCE_NUMBER                                        AS MTLN_CDC_SEQUENCE_NUMBER
   ,S.MTLN_CDC_LOAD_BATCH_ID                                          AS MTLN_CDC_LOAD_BATCH_ID
   ,S.MTLN_CDC_LOAD_TIMESTAMP                                         AS MTLN_CDC_LOAD_TIMESTAMP
   ,S.MTLN_CDC_PROCESSED_DATE_HOUR                                    AS MTLN_CDC_PROCESSED_DATE_HOUR
   ,S.MTLN_CDC_SRC_VERSION                                            AS MTLN_CDC_SRC_VERSION
   ,S.MTLN_CDC_FILENAME                                               AS MTLN_CDC_FILENAME
   ,S.MTLN_CDC_FILEPATH                                               AS MTLN_CDC_FILEPATH
   ,S.MTLN_CDC_SRC_DATABASE                                           AS MTLN_CDC_SRC_DATABASE
   ,S.MTLN_CDC_SRC_SCHEMA                                             AS MTLN_CDC_SRC_SCHEMA
   ,S.MTLN_CDC_SRC_TABLE                                              AS MTLN_CDC_SRC_TABLE

--foreign keys-------------------------------------------------------------------------------
   ,S.CHEQUE_FACT_FK                                                  AS CHEQUE_FACT_FK
   ,S.DAYPART_DIM_FK                                                  AS DAYPART_DIM_FK
   ,S.EMPLOYEE_DIM_FK                                                 AS EMPLOYEE_DIM_FK
   ,S.LOCATION_DIM_FK                                                 AS LOCATION_DIM_FK
   ,S.SURCHARGE_DIM_NK                                                AS SURCHARGE_DIM_NK
   ,ITM.ITEM_FACT_NK                                                  AS ITEM_FACT_FK

--flags--------------------------------------------------------------------------------------
   ,S.IS_AUTOAPPLIED                                                  AS IS_AUTOAPPLIED
   ,S.IS_GRATUITY                                                     AS IS_GRATUITY
   ,S.IS_TAXABLE                                                      AS IS_TAXABLE
   ,S.IS_TRAINING                                                     AS IS_TRAINING
   ,S.IS_PRINTONRECEIPT                                               AS IS_PRINTONRECEIPT

--Dates--------------.------------------------------------------------------------------------
   ,S.CREATED_AT                                                      AS CREATED_AT
   ,S.FISCAL_DATE                                                     AS FISCAL_DATE
   ,S.OPENED_AT                                                       AS OPENED_AT
   ,S.UPDATED_AT                                                      AS UPDATED_AT

--names, options, etc-------------------------------------------------------------------------
   ,S.STATUS                                                          AS STATUS

--name---------------------------------------------------------------------------------------
   ,S.CHEQUENUMBER                                                    AS CHEQUENUMBER
   ,S.SURCHARGE_TYPE                                                  AS SURCHARGE_TYPE
   ,ITM.ITEM_ID                                                       AS ITEM_ID
   ,ITM.MENUITEM_DIM_FK                                               AS MENUITEM_DIM_FK
   ,ITM.MENUITEMNAME_DIM_FK                                           AS MENUITEMNAME_DIM_FK

--Counts and Amounts--------------------------------------------------------------------------
   ,S.QUANTITY                                                                             AS SURCHARGE_QUANTITY
   ,S.AMOUNT                                                                               AS SURCHARGE_AMOUNT
   ,S.APPLIEDAMOUNT                                                                        AS SURCHARGE_APPLIEDAMOUNT
    --common aux columns
    ,ITM.QUANTITY                                                                          AS ITEM_QUANTITY 
    ,SUM(ITM.QUANTITY) OVER (
        PARTITION BY S.CHEQUE_FACT_FK 
            , S.SURCHARGENAME
            , S.MTLN_CDC_SEQUENCE_NUMBER
            , S.MTLN_CDC_SRC_VERSION, S.MTLN_CDC_FILENAME
    )                                                                                      AS TOTAL_ITEMS_ON_CHECK
    ,ROW_NUMBER() OVER (
        PARTITION BY S.CHEQUE_FACT_FK
            , S.SURCHARGENAME
            , S.MTLN_CDC_SEQUENCE_NUMBER
            , S.MTLN_CDC_SRC_VERSION
            , S.MTLN_CDC_FILENAME
        ORDER BY ITM.ITEM_ID
     )                                                                                      AS ITEM_ROW_NUMBER
    --amount
    ,ROUND(S.AMOUNT / TOTAL_ITEMS_ON_CHECK, 2)                                              AS AMOUNT_SINGLE_ITEM_BASE_ALLOCATION
    ,S.AMOUNT - (AMOUNT_SINGLE_ITEM_BASE_ALLOCATION * TOTAL_ITEMS_ON_CHECK)                 AS AMOUNT_CHECK_REMAINDER 
    ,(AMOUNT_SINGLE_ITEM_BASE_ALLOCATION * ITM.QUANTITY) +
        CASE
            WHEN ITEM_ROW_NUMBER = 1 THEN AMOUNT_CHECK_REMAINDER
            ELSE 0
        END                                                                                 AS AMOUNT_ALLOCATED_ITEM_SURCHARGE

    --applied amount
    ,ROUND(S.APPLIEDAMOUNT / TOTAL_ITEMS_ON_CHECK, 2)                                       AS APPLIED_SINGLE_ITEM_BASE_ALLOCATION
    ,S.APPLIEDAMOUNT - (APPLIED_SINGLE_ITEM_BASE_ALLOCATION * TOTAL_ITEMS_ON_CHECK)         AS APPLIED_CHECK_REMAINDER
    ,(APPLIED_SINGLE_ITEM_BASE_ALLOCATION * ITM.QUANTITY) +
        CASE
            WHEN ITEM_ROW_NUMBER = 1 THEN APPLIED_CHECK_REMAINDER
            ELSE 0
        END                                                                                 AS APPLIED_ALLOCATED_ITEM_SURCHARGE

FROM DATAADMIN.SURCHARGE_FACT                                                               S
INNER JOIN DATAADMIN.ITEM_FACT                                                              ITM
ON S.CHEQUE_FACT_FK = ITM.CHEQUE_FACT_FK
    AND S.MTLN_CDC_SEQUENCE_NUMBER = ITM.MTLN_CDC_SEQUENCE_NUMBER
    AND S.MTLN_CDC_SRC_VERSION = ITM.MTLN_CDC_SRC_VERSION
    AND S.MTLN_CDC_FILENAME = ITM.MTLN_CDC_FILENAME
    AND ITM.ITEMSTATUS IN ('Added', 'Sent')
    --filters for debugging
    -- AND S.STATUS IN ('Enabled')
    -- AND itm.DW_ISCURRENTROW
    -- AND itm.cheque_fact_fk = 53366
    -- AND itm.item_fact_nk = '412426.daaa4f96-19e8-4a1c-8410-0dd12181d062'
    -- AND S.DW_ISCURRENTROW

--===========================================================================================
--End of View
--============================================================================================

/*
-- USAGE AND VALIDATIONS
;
--sum amounts of surcharge_fact that have any item
--
WITH aux as (
select MTLN_CDC_SEQUENCE_NUMBER, CHEQUE_FACT_FK, MTLN_CDC_SRC_VERSION, MTLN_CDC_FILENAME from DATAADMIN.ITEM_FACT 
group by MTLN_CDC_SEQUENCE_NUMBER, CHEQUE_FACT_FK, MTLN_CDC_SRC_VERSION, MTLN_CDC_FILENAME
)
SELECT
    SUM(S.amount) AS fact_total_amount,
    SUM(S.appliedamount) AS fact_total_appliedamount
  FROM
    DATAADMIN.SURCHARGE_FACT S
  left join aux itf 
    ON S.CHEQUE_FACT_FK = itf.CHEQUE_FACT_FK 
    AND S.MTLN_CDC_SEQUENCE_NUMBER = itf.MTLN_CDC_SEQUENCE_NUMBER
    AND S.MTLN_CDC_SRC_VERSION = itf.MTLN_CDC_SRC_VERSION
    AND S.MTLN_CDC_FILENAME = itf.MTLN_CDC_FILENAME
  WHERE
     not itf.CHEQUE_FACT_FK is null
;

--then sum the amounts on the view: they should match the amounts from last query
SELECT
    SUM(AMOUNT_ALLOCATED_ITEM_SURCHARGE) AS item_total_amount,
    SUM(APPLIED_ALLOCATED_ITEM_SURCHARGE) AS item_total_appliedamount
  FROM
    DATAADMIN.SURCHARGECHEQUEBYITEM_FACT_DEBUG
;

-- identify surcharges with different item count
SELECT
  s.CHEQUE_FACT_FK,
  s.MTLN_CDC_SEQUENCE_NUMBER,
  s.MTLN_CDC_SRC_VERSION,
  s.MTLN_CDC_FILENAME,
  s.TOTAL_ITEMS_ON_CHECK AS VIEW_TOTAL_ITEMS,
  i.ACTUAL_TOTAL_ITEMS_ON_CHECK AS FACT_TOTAL_ITEMS,
  (s.TOTAL_ITEMS_ON_CHECK - i.ACTUAL_TOTAL_ITEMS_ON_CHECK) as DIFFERENCE
FROM
  (SELECT DISTINCT
      CHEQUE_FACT_FK,
      MTLN_CDC_SEQUENCE_NUMBER,
      MTLN_CDC_SRC_VERSION,
      MTLN_CDC_FILENAME,
      TOTAL_ITEMS_ON_CHECK
    FROM
      DATAADMIN.SURCHARGECHEQUEBYITEM_FACT_DEBUG
    WHERE 1=1
    --filters for debugging
    -- AND DW_ISCURRENTROW
    -- AND CHEQUE_FACT_FK = 53366 
    -- AND MTLN_CDC_SEQUENCE_NUMBER = 53525472632
  ) s
  -- LEFT JOIN (
  INNER JOIN (
    SELECT
      CHEQUE_FACT_FK,
      MTLN_CDC_SEQUENCE_NUMBER,
      MTLN_CDC_SRC_VERSION,
      MTLN_CDC_FILENAME,
      SUM(QUANTITY) AS ACTUAL_TOTAL_ITEMS_ON_CHECK
    FROM
      PRD_HOSPENG_REPORTING.DATAADMIN.ITEM_FACT
    WHERE ITEMSTATUS in ('Added', 'Sent') 
    --filters for debugging
    -- AND CHEQUE_FACT_FK = 53366 AND MTLN_CDC_SEQUENCE_NUMBER = 53525472632 AND DW_ISCURRENTROW
    GROUP BY
      CHEQUE_FACT_FK,
      MTLN_CDC_SEQUENCE_NUMBER,
      MTLN_CDC_SRC_VERSION,
      MTLN_CDC_FILENAME
  ) i 
  ON s.CHEQUE_FACT_FK = i.CHEQUE_FACT_FK
  AND s.MTLN_CDC_SEQUENCE_NUMBER = i.MTLN_CDC_SEQUENCE_NUMBER
  AND s.MTLN_CDC_SRC_VERSION = i.MTLN_CDC_SRC_VERSION
  AND s.MTLN_CDC_FILENAME = i.MTLN_CDC_FILENAME
WHERE
  VIEW_TOTAL_ITEMS != FACT_TOTAL_ITEMS
  -- AND s.CHEQUE_FACT_FK IN (<check>)
ORDER BY
  DIFFERENCE DESC;
;
*/
;"
VIEW,DATAADMIN_DEBUG,DISCOUNTITEM_FACT,"create or replace view DISCOUNTITEM_FACT(
	DISCOUNTITEM_FACT_PK,
	DISCOUNTITEM_FACT_NK,
	DISCOUNTNAME,
	DW_STARTDATE,
	FISCALDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	CHEQUE_FACT_FK,
	DAYPART_DIM_FK,
	EMPLOYEE_DIM_FK_AS_ADDED_BY,
	EMPLOYEE_DIM_FK_AS_APPROVED_BY,
	EMPLOYEE_DIM_FK,
	LOCATION_DIM_FK,
	ITEM_FACT_FK,
	STANDARDDISCOUNT_DIM_FK,
	DO_AUTOAPPLY,
	IS_TRAINING,
	ADDED_AT,
	CREATED_AT,
	FISCAL_DATE,
	OPENED_AT,
	UPDATED_AT,
	APPLICATION,
	STATUS,
	CHEQUESTATUS,
	DISCOUNTREASON,
	DISCOUNTLEVEL,
	RECEIPTNAME,
	PROMOCODE,
	PROMODESCRIPTION,
	REVENUECENTERNAME,
	ROUNDINGMETHOD,
	CHEQUENUMBER,
	ITEM_ID,
	PROMOCODE_ID,
	DISCOUNT_TYPE,
	DISCOUNT_PERCENT,
	APPLIED_AMOUNT,
	DISCOUNT_AMOUNT,
	VALUE,
	DISCOUNT,
	DISCOUNTCHECK,
	DISCOUNTITEM,
	GROSS,
	NET
) as
--============================================================================================
SELECT 
TO_VARCHAR(CHK.ID) || '.'  ||replace(ITM.VALUE:id,'""','') || '.' || TO_CHAR(DIS.value:id)                        
                                                                          AS DISCOUNTITEM_FACT_PK
--natural keys------------------------------------------------------------------------------
  ,TO_VARCHAR(CHK.ID) || '.'  ||replace(ITM.VALUE:id,'""','') || '.' || TO_CHAR(DIS.value:id)                     
                                                                          AS DISCOUNTITEM_FACT_NK
--name---------------------------------------------------------------------------------------
   ,TO_CHAR(DIS.value:id)                                                 AS DISCOUNTNAME
--data warehouse rows--------------------------------------------------------------------------
   ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY TO_VARCHAR(CHK.ID) || '.' || TO_CHAR(DIS.value:id) ORDER BY CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION
      ,CHK.MTLN_CDC_FILENAME)),6))
                                                                           AS DW_STARTDATE 
     ,TO_CHAR(TRY_PARSE_JSON(CHK.info):fiscalDate)::DATE                   AS FISCALDATE                                                                           
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY TO_VARCHAR(CHK.ID) || '.' || TO_CHAR(DIS.value:id) ORDER BY CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION,CHK.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY TO_VARCHAR(CHK.ID) || '.' || TO_CHAR(DIS.value:id) ORDER BY 
    CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION
   ,CHK.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                                           AS DW_ENDDATE          
  
  ,CASE WHEN CHK.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                               AS DW_ISDELETED               
  ,CASE WHEN RANK() OVER(PARTITION BY TO_VARCHAR(CHK.ID) || '.' || TO_CHAR(DIS.value:id) ORDER BY  
    CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,CHK.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,CHK.MTLN_CDC_SRC_VERSION DESC
   ,CHK.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                                           AS DW_ISCURRENTROW     
--CDC Meta data-------------------------------------------------------------------------------
  ,CHK.MTLN_CDC_LAST_CHANGE_TYPE                     AS MTLN_CDC_LAST_CHANGE_TYPE
  ,CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP                AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,CHK.MTLN_CDC_SEQUENCE_NUMBER                      AS MTLN_CDC_SEQUENCE_NUMBER
  ,CHK.MTLN_CDC_LOAD_BATCH_ID                        AS MTLN_CDC_LOAD_BATCH_ID
  ,CHK.MTLN_CDC_LOAD_TIMESTAMP                       AS MTLN_CDC_LOAD_TIMESTAMP
  ,CHK.MTLN_CDC_PROCESSED_DATE_HOUR                  AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,CHK.MTLN_CDC_SRC_VERSION                          AS MTLN_CDC_SRC_VERSION
  ,CHK.MTLN_CDC_FILENAME                             AS MTLN_CDC_FILENAME
  ,CHK.MTLN_CDC_FILEPATH                             AS MTLN_CDC_FILEPATH
  ,CHK.MTLN_CDC_SRC_DATABASE                         AS MTLN_CDC_SRC_DATABASE
  ,CHK.MTLN_CDC_SRC_SCHEMA                           AS MTLN_CDC_SRC_SCHEMA
  ,CHK.MTLN_CDC_SRC_TABLE                            AS MTLN_CDC_SRC_TABLE
--foreign keys-------------------------------------------------------------------------------
  ,IFNULL(CHK.ID,-1)                                            AS CHEQUE_FACT_FK 
  ,IFNULL(CHK.day_part_id,-1)                                   AS DAYPART_DIM_FK  

  ,IFNULL(DIS.value:adddedByEmployeeId,-1)::NUMBER              AS EMPLOYEE_DIM_FK_AS_ADDED_BY
  ,IFNULL(DIS.value:approvedByEmployeeId,-1)::NUMBER            AS EMPLOYEE_DIM_FK_AS_APPROVED_BY
  ,IFNULL(CHK.EMPLOYEE_ID,-1)                                   AS EMPLOYEE_DIM_FK
  ,IFNULL(CHK.LOCATION_ID,-1)                                   AS LOCATION_DIM_FK 
  ,CHK.ID || '.'  ||replace(ITM.VALUE:id,'""','')                AS ITEM_FACT_FK
  -- ,IFNULL(TO_VARCHAR(CHK.ID) || '.' 
  -- || TO_VARCHAR(DIS.value:itemId),-1)                           AS ITEM_DIM_FK
  ,IFNULL(TRY_TO_NUMBER(TO_VARCHAR(DIS.value:standardDiscountId)),-1)  
                                                                AS STANDARDDISCOUNT_DIM_FK
--flags---------------------------------------------------------------------------------------
  ,CASE REPLACE(DIS.value:doAutoApply,'""','') 
    WHEN 'false' THEN FALSE
    WHEN 'true'  THEN TRUE ELSE NULL END             AS DO_AUTOAPPLY
   ,CHK.IS_TRAINING                                  AS IS_TRAINING  
--Dates--------------.------------------------------------------------------------------------
  ,to_timestamp(to_varchar(DIS.value:addedAt))       AS ADDED_AT
  ,to_timestamp_tz(CHK.CREATED_AT)                   AS CREATED_AT 
  -- ,TO_DATE('20' || CHK.FISCAL_DATE_INT,'YYYY-MM-DD')   AS FISCAL_DATE 
   ,TO_DATE(TO_CHAR(TRY_PARSE_JSON(CHK.info):fiscalDate),'YYYY-MM-DD')   AS FISCAL_DATE 
  ,to_timestamp_tz(CHK.OPENED_AT)                    AS OPENED_AT 
  ,to_timestamp_tz(CHK.UPDATED_AT)                   AS UPDATED_AT
--names, options, etc-------------------------------------------------------------------------
  ,IFNULL(REPLACE(DIS.value:application,'""',''),'None')                                     AS APPLICATION
  ,IFNULL(REPLACE(DIS.value:status,'""',''),'None')                                          AS STATUS
  ,CHK.STATUS                                                                               AS CHEQUESTATUS  
  ,IFNULL(UPPER(REPLACE(DIS.value:reason,'""','')),'None')                                   AS DISCOUNTREASON
  ,'Item'                                                                                   AS DISCOUNTLEVEL  
  ,IFNULL(REPLACE(DIS.value:receiptName,'""','') ,'None')                                    AS RECEIPTNAME
  ,IFNULL(REPLACE(DIS.value:promoCode,'""',''),'None')                                       AS PROMOCODE
  ,IFNULL(REPLACE(DIS.value:promoDescription,'""',''),'None')                                AS PROMODESCRIPTION
  ,IFNULL(replace(TRY_PARSE_JSON(CHK.info):revenueCenterName,'""','') ,'None')               AS REVENUECENTERNAME
  ,IFNULL(replace(TRY_PARSE_JSON(CHK.info):taxSettings:roundingMethod,'""',''),'None')       AS ROUNDINGMETHOD
--name---------------------------------------------------------------------------------------
  ,CHK.NUMBER                                                                AS CHEQUENUMBER  
  ,TRY_TO_NUMBER(TO_VARCHAR(DIS.value:itemID))                               AS ITEM_ID
  ,TRY_TO_NUMBER(TO_VARCHAR(DIS.
  value:promoCodeId))                                                        AS PROMOCODE_ID
  ,REPLACE(DIS.value:type,'""','')                                            AS DISCOUNT_TYPE
--Counts and Amounts--------------------------------------------------------------------------
,CASE WHEN REPLACE(DIS.value:type,'""','') = 'Percent'
   THEN to_char(REPLACE(DIS.value:value,'""',''))
   ELSE 0 END ::NUMBER(38,4)                     
                                                                             AS DISCOUNT_PERCENT
,TO_CHAR(DIS.value:appliedValue) ::NUMBER(38,4)                              AS APPLIED_AMOUNT

,CASE WHEN REPLACE(DIS.value:type,'""','') = 'Amount' 
     THEN to_char(REPLACE(DIS.value:value,'""',''))
   END::NUMBER(38,4)                  
                                                                              AS DISCOUNT_AMOUNT

   
  ,to_char(REPLACE(DIS.value:value,'""',''))::NUMBER(38,4)  
                                                                              AS VALUE

    
  ,TO_CHAR(TRY_PARSE_JSON(CHK.balance):discount)::NUMBER(38,4)                AS DISCOUNT
  ,TO_CHAR(TRY_PARSE_JSON(CHK.balance):discountCheck)::NUMBER(38,4)           AS DISCOUNTCHECK
  ,TO_CHAR(TRY_PARSE_JSON(CHK.balance):discountItem)::NUMBER(38,4)            AS DISCOUNTITEM
  ,TO_CHAR(TRY_PARSE_JSON(CHK.balance):gross)::NUMBER(38,4)                   AS GROSS
  ,TO_CHAR(TRY_PARSE_JSON(CHK.balance):net)::NUMBER(38,4)                     AS NET
----------------------------------------------------------------------------------------------
FROM (
    -- This inner subquery selects and filters the raw data first.
    SELECT *
    FROM DATALANDING.POSAPI_PUBLIC_CHEQUE
    QUALIFY
        -- This first condition is your original filter. We keep it to exclude truncated records.
        NOT COALESCE(TRUNCATED, FALSE)
        -- This second condition uses our new logic to find and exclude the corrupt records.
        -- The entire block must NOT be true for a row to be included.
        AND NOT (
            -- Condition 1: The current row has a bad `created_at` date.
            (EXTRACT(YEAR FROM TRY_TO_TIMESTAMP(created_at)) < 1999 OR TRY_TO_TIMESTAMP(created_at) IS NULL)
            AND
            -- Condition 2: The current row is a delete operation ('d').
            MTLN_CDC_LAST_CHANGE_TYPE = 'd'
            AND
            -- Condition 3: The *next* row (ordered chronologically) is the `truncated = true` update.
            LEAD(truncated, 1, false) OVER (PARTITION BY id ORDER BY mtln_cdc_sequence_number DESC) = true
            AND
            LEAD(mtln_cdc_last_change_type, 1, '') OVER (PARTITION BY id ORDER BY mtln_cdc_sequence_number DESC) = 'u'
        )
)                                        CHK 
   ,LATERAL FLATTEN(INPUT => 
    TRY_PARSE_JSON( '{ITEMS:' || CHK.ITEMS || '}' ), PATH => 'ITEMS')
                                                                             ITM                                                                                                              
    ,LATERAL FLATTEN(INPUT => 
    TRY_PARSE_JSON('{discounts:' || TRY_PARSE_JSON(ITM.value):discounts || '}'), PATH => 'discounts')
                                                                             DIS
WHERE TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):discount), 38, 4) > 0
;"
VIEW,DATAADMIN_DEBUG,TAX_FACT,"create or replace view TAX_FACT(
	TAX_FACT_PK,
	TAX_FACT_NK,
	TAXRATENAME,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	CHEQUE_FACT_FK,
	DAYPART_DIM_FK,
	EMPLOYEE_DIM_FK,
	ITEM_FACT_FK,
	LOCATION_DIM_FK,
	MENUITEM_DIM_FK,
	MENUITEMNAME_DIM_FK,
	ORDERTYPE_DIM_FK,
	TAX_RATE_ID,
	IS_TRAINING,
	IS_TAX_INCLUDED,
	CLOSED_AT,
	CREATED_AT,
	FISCAL_DATE,
	OPENED_AT,
	UPDATED_AT,
	CHECKSTATUS,
	ITEMSTATUS,
	REVENUECENTERNAME,
	ROUNDINGMETHOD,
	CHEQUENUMBER,
	ITEM_ID,
	CHECKTOTALINCLUSIVETAX,
	CHECKTOTALTAX,
	AMOUNT,
	PERCENT
) as
--============================================================================================
SELECT  
TO_VARCHAR(CHK.ID) || '.'  ||replace(ITM.VALUE:id,'""','') || '.' || TO_CHAR(TAX.index)                        
                                                                             AS TAX_FACT_PK
--natural keys------------------------------------------------------------------------------
  ,TO_VARCHAR(CHK.ID) || '.'  ||replace(ITM.VALUE:id,'""','') || '.' || TO_CHAR(TAX.index)                     
                                                                             AS TAX_FACT_NK
--name---------------------------------------------------------------------------------------
 , REPLACE(TAX.value:taxRateName,'""','')                                     AS TAXRATENAME
-- --data warehouse rows--------------------------------------------------------------------------
   ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY 
      
     TO_VARCHAR(CHK.ID) || '.'  ||replace(ITM.VALUE:id,'""','') || '.' || TO_CHAR(TAX.index)
      
       ORDER BY CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION
      ,CHK.MTLN_CDC_FILENAME)),6))
                                                                             AS DW_STARTDATE       
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY 
    
    TO_VARCHAR(CHK.ID) || '.'  ||replace(ITM.VALUE:id,'""','') || '.' || TO_CHAR(TAX.index)
    
     ORDER BY CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION,CHK.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (
    
    PARTITION BY 
    TO_VARCHAR(CHK.ID) || '.'  ||replace(ITM.VALUE:id,'""','') || '.' || TO_CHAR(TAX.index)
    
     ORDER BY 
    CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION
   ,CHK.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                                           AS DW_ENDDATE          
  
  ,CASE WHEN CHK.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                               AS DW_ISDELETED               
  ,CASE WHEN RANK() OVER(
  PARTITION BY 
   TO_VARCHAR(CHK.ID) || '.'  ||replace(ITM.VALUE:id,'""','') || '.' || TO_CHAR(TAX.index)
  
  ORDER BY  
    CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,CHK.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,CHK.MTLN_CDC_SRC_VERSION DESC
   ,CHK.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                                           AS DW_ISCURRENTROW     
--CDC Meta data-------------------------------------------------------------------------------
  ,CHK.MTLN_CDC_LAST_CHANGE_TYPE                     AS MTLN_CDC_LAST_CHANGE_TYPE
  ,CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP                AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,CHK.MTLN_CDC_SEQUENCE_NUMBER                      AS MTLN_CDC_SEQUENCE_NUMBER
  ,CHK.MTLN_CDC_LOAD_BATCH_ID                        AS MTLN_CDC_LOAD_BATCH_ID
  ,CHK.MTLN_CDC_LOAD_TIMESTAMP                       AS MTLN_CDC_LOAD_TIMESTAMP
  ,CHK.MTLN_CDC_PROCESSED_DATE_HOUR                  AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,CHK.MTLN_CDC_SRC_VERSION                          AS MTLN_CDC_SRC_VERSION
  ,CHK.MTLN_CDC_FILENAME                             AS MTLN_CDC_FILENAME
  ,CHK.MTLN_CDC_FILEPATH                             AS MTLN_CDC_FILEPATH
  ,CHK.MTLN_CDC_SRC_DATABASE                         AS MTLN_CDC_SRC_DATABASE
  ,CHK.MTLN_CDC_SRC_SCHEMA                           AS MTLN_CDC_SRC_SCHEMA
  ,CHK.MTLN_CDC_SRC_TABLE                            AS MTLN_CDC_SRC_TABLE
-- --foreign keys-------------------------------------------------------------------------------
  ,IFNULL(CHK.ID,-1)                                 AS CHEQUE_FACT_FK 
  ,IFNULL(CHK.day_part_id,-1)                        AS DAYPART_DIM_FK  
  ,IFNULL(CHK.EMPLOYEE_ID,-1)                        AS EMPLOYEE_DIM_FK
  ,CHK.ID || '.'  || replace(ITM.VALUE:id,'""','')    AS ITEM_FACT_FK
  ,IFNULL(CHK.LOCATION_ID,-1)                        AS LOCATION_DIM_FK  
  -- ,IFNULL(TO_NUMBER(replace(replace(split_part(
  --   replace(ITM.value:menuItem:path,'',''),'.',2),'{',''),'}','') ),-1)
  --                                                   AS MENUGROUP_DIM_FK
  ,IFNULL(TO_NUMBER(ITM.value:menuItem:menuItemId),-1)       
                                                     AS MENUITEM_DIM_FK     
  ,IFNULL(TO_NUMBER(ITM.value:menuItem:menuItemNameId),-1)   
                                                     AS MENUITEMNAME_DIM_FK
  ,IFNULL(CHK.order_type_id,-1)                      AS ORDERTYPE_DIM_FK                                                
  ,TAX.value:taxRateId::NUMBER(38,0)                 AS TAX_RATE_ID  



-- --flags---------------------------------------------------------------------------------------
   ,CHK.IS_TRAINING::BOOLEAN                         AS IS_TRAINING 
   ,TAX.value:isTaxIncluded::BOOLEAN                 AS IS_TAX_INCLUDED
-- --Dates--------------.------------------------------------------------------------------------
  ,to_timestamp_tz(CHK.closed_at)                    AS CLOSED_AT
  ,to_timestamp_tz(CHK.CREATED_AT)                   AS CREATED_AT 
  ,TO_DATE(TO_CHAR(TRY_PARSE_JSON(CHK.info):fiscalDate))   AS FISCAL_DATE 
  ,to_timestamp_tz(CHK.OPENED_AT)                    AS OPENED_AT 
  ,to_timestamp_tz(CHK.UPDATED_AT)                   AS UPDATED_AT
--names, options, etc-------------------------------------------------------------------------
  ,CHK.STATUS                                        AS CHECKSTATUS
  ,replace(ITM.value:status,'""','')                  AS ITEMSTATUS
  ,IFNULL(replace(TRY_PARSE_JSON(CHK.info):revenueCenterName,'""','') ,'None')               
                                                     AS REVENUECENTERNAME
  ,IFNULL(replace(TRY_PARSE_JSON(CHK.info):taxSettings:roundingMethod,'""',''),'None')       
                                                     AS ROUNDINGMETHOD
-- --name---------------------------------------------------------------------------------------
  ,CHK.NUMBER                                                                AS CHEQUENUMBER  
  ,replace(ITM.VALUE:id,'""','')                                              AS ITEM_ID
--Counts and Amounts--------------------------------------------------------------------------
 ,TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):inclusiveTax), 38,4)     AS CHECKTOTALINCLUSIVETAX
 ,TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):tax), 38,4)              AS CHECKTOTAlTAX
 ,TAX.value:tax::NUMBER(38,4)                                                AS AMOUNT
 ,TAX.value:percent::NUMBER(38,4)                                            AS PERCENT
----------------------------------------------------------------------------------------------
FROM (
    -- This inner subquery selects and filters the raw data first.
    SELECT *
    FROM DATALANDING.POSAPI_PUBLIC_CHEQUE
    QUALIFY
        -- This first condition is your original filter. We keep it to exclude truncated records.
        NOT COALESCE(TRUNCATED, FALSE)
        -- This second condition uses our new logic to find and exclude the corrupt records.
        -- The entire block must NOT be true for a row to be included.
        AND NOT (
            -- Condition 1: The current row has a bad `created_at` date.
            (EXTRACT(YEAR FROM TRY_TO_TIMESTAMP(created_at)) < 1999 OR TRY_TO_TIMESTAMP(created_at) IS NULL)
            AND
            -- Condition 2: The current row is a delete operation ('d').
            MTLN_CDC_LAST_CHANGE_TYPE = 'd'
            AND
            -- Condition 3: The *next* row (ordered chronologically) is the `truncated = true` update.
            LEAD(truncated, 1, false) OVER (PARTITION BY id ORDER BY mtln_cdc_sequence_number DESC) = true
            AND
            LEAD(mtln_cdc_last_change_type, 1, '') OVER (PARTITION BY id ORDER BY mtln_cdc_sequence_number DESC) = 'u'
        )
)                       CHK 
    ,LATERAL FLATTEN(INPUT => 
    TRY_PARSE_JSON( '{ITEMS:' || CHK.ITEMS || '}' ), PATH => 'ITEMS')
                                                               ITM 
  ,LATERAL FLATTEN(INPUT => 
    TRY_PARSE_JSON('{taxes:' || TRY_PARSE_JSON(ITM.value):taxes || '}'), PATH => 'taxes')
                                                               TAX 
;"
VIEW,DATAADMIN_DEBUG,CHEQUE_FACT,"create or replace view CHEQUE_FACT(
	CHEQUE_FACT_PK,
	CHEQUE_FACT_NK,
	CHEQUENUMBER,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	DAYPART_DIM_FK,
	EMPLOYEE_DIM_FK,
	LOCATION_DIM_FK,
	ORDERTYPE_DIM_FK,
	ORGANIZATION_DIM_FK,
	SHIFT_DIM_FK,
	TAXSETTINGS_DIM_FK,
	REVENUECENTER_DIM_FK,
	VOIDREASON_DIM_FK,
	HAS_DISCOUNT,
	IS_TRAINING,
	IS_VOID,
	HAS_TRACKTAXESONCOMP,
	FISCAL_DATE_INT,
	FISCAL_DATE,
	OPENED_AT,
	BEGIN_PREP_AT,
	CLOSED_AT,
	SCHEDULED_AT,
	CREATED_AT,
	UPDATED_AT,
	UUID,
	AUDIT,
	STATUS,
	ROUNDINGMETHOD,
	COMBINEDRECEIPTNAME,
	RECEIPTOPTION,
	TAXTRACKING,
	REVENUECENTERNAME,
	REVENUECENTERID,
	STATUS_REASON_ID,
	CHECK_ID,
	TABLE_NAME,
	FEES,
	GIFTCARDS,
	GRATUITIES,
	PARTY_COUNT,
	DISCOUNT_COUNT,
	PAYMENT_COUNT,
	DISCOUNT,
	DISCOUNTCHECK,
	DISCOUNTITEM,
	GROSS,
	INCLUSIVETAX,
	NET,
	PAID,
	SURCHARGE,
	TAX,
	TIP,
	TOTAL,
	UNPAID
) as
--============================================================================================
--SELECT * FROM CHEQUE_FACT ORDER BY SHIFT_DIM_FK DESC;
-----------------------------------------------------------------------------------------------
SELECT 
--primary keys--------------------------------------------------------------------------------
  CHK.ID                                                     AS CHEQUE_FACT_PK
--natural keys--------------------------------------------------------------------------------
  ,CHK.ID                                                    AS CHEQUE_FACT_NK
--name----------------------------------------------------------------------------------------
  ,CHK.NUMBER                                                AS CHEQUENUMBER
--data warehouse rows-------------------------------------------------------------------------            
 ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY CHK.ID ORDER BY CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION
      ,CHK.MTLN_CDC_FILENAME)),6))
                                                            AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY CHK.ID ORDER BY CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION,CHK.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY CHK.ID ORDER BY 
    CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION
   ,CHK.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN CHK.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY CHK.ID ORDER BY  
    CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,CHK.MTLN_CDC_SEQUENCE_NUMBER DESC
   ,CHK.MTLN_CDC_SRC_VERSION DESC
   ,CHK.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END                              AS DW_ISCURRENTROW     --REQUIRED
--CDC Meta data---------------------------------------------------------------------------------
  ,CHK.MTLN_CDC_LAST_CHANGE_TYPE       AS MTLN_CDC_LAST_CHANGE_TYPE
  ,CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP  AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,CHK.MTLN_CDC_SEQUENCE_NUMBER        AS MTLN_CDC_SEQUENCE_NUMBER
  ,CHK.MTLN_CDC_LOAD_BATCH_ID          AS MTLN_CDC_LOAD_BATCH_ID
  ,CHK.MTLN_CDC_LOAD_TIMESTAMP         AS MTLN_CDC_LOAD_TIMESTAMP
  ,CHK.MTLN_CDC_PROCESSED_DATE_HOUR    AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,CHK.MTLN_CDC_SRC_VERSION            AS MTLN_CDC_SRC_VERSION
  ,CHK.MTLN_CDC_FILENAME               AS MTLN_CDC_FILENAME
  ,CHK.MTLN_CDC_FILEPATH               AS MTLN_CDC_FILEPATH
  ,CHK.MTLN_CDC_SRC_DATABASE           AS MTLN_CDC_SRC_DATABASE
  ,CHK.MTLN_CDC_SRC_SCHEMA             AS MTLN_CDC_SRC_SCHEMA
  ,CHK.MTLN_CDC_SRC_TABLE              AS MTLN_CDC_SRC_TABLE
--foreign keys-------------------------------------------------------------------------------
  ,IFNULL(CHK.day_part_id,-1)                     AS Daypart_DIM_FK       
  ,IFNULL(CHK.employee_id,-1)                     AS Employee_DIM_FK      
  ,IFNULL(CHK.location_id,-1)                     AS Location_DIM_FK     
  ,IFNULL(CHK.order_type_id,-1)                   AS Ordertype_DIM_FK  
  ,IFNULL(TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.info):orgId),38,0),-1)   
                                                  AS Organization_DIM_FK  
  ,IFNULL(TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.info):shiftId),38,0),-1)
                                                  AS Shift_DIM_FK
  ,IFNULL(TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.info):taxSettings:taxSettingsId),38,4),-1)
                                                  AS Taxsettings_DIM_FK
  ,IFNULL(TO_NUMBER(replace(TRY_PARSE_JSON(CHK.info):revenueCenterId,'""','')),-1)        
                                                  AS REVENUECENTER_DIM_FK 
                                                                   
   ,IFNULL(CASE WHEN CHK.status = 'Voided' 
     THEN CHK.status_reason_id ELSE -1 
     END,-1)                                       AS VoidReason_DIM_FK
--flags---------------------------------------------------------------------------------------
  ,CASE WHEN TRY_PARSE_JSON(CHK.balance):discount > 0 
      THEN TRUE ELSE FALSE END         AS HAS_DISCOUNT 
  ,CHK.IS_TRAINING                     AS IS_TRAINING 
  ,CASE WHEN CHK.STATUS = 'Voided'
      THEN TRUE ELSE FALSE END         AS IS_VOID      
  ,CASE UPPER(TO_CHAR(TRY_PARSE_JSON(CHK.info):taxSettings:trackTaxesOnComps)) 
    WHEN 'TRUE'
    THEN TRUE WHEN 'FALSE' THEN FALSE END

                                       AS HAS_TRACKTAXESONCOMP 
 
--Dates--------------.------------------------------------------------------------------------
  ,CHK.FISCAL_DATE_INT                 AS FISCAL_DATE_INT
  ,TO_CHAR(TRY_PARSE_JSON(CHK.info):fiscalDate)::DATE   
                                       AS FISCAL_DATE                                    
  ,To_timestamp_tz(CHK.opened_at)      AS OPENED_AT
  ,To_timestamp_tz(CHK.begin_prep_at)  AS BEGIN_PREP_AT
  ,To_timestamp_tz(CHK.closed_at)      AS CLOSED_AT
  ,To_timestamp_tz(CHK.scheduled_at)   AS SCHEDULED_AT
  ,To_timestamp_tz(CHK.created_at)     AS CREATED_AT
  ,To_timestamp_tz(CHK.updated_at)     AS UPDATED_AT
--names, options, etc-------------------------------------------------------------------------
  ,CHK.UUID                                                                   AS UUID
  ,CHK.AUDIT                                                                  AS AUDIT
  ,CHK.STATUS                                                                 AS STATUS
  ,replace(TRY_PARSE_JSON(CHK.info):taxSettings:roundingMethod,'""','')        AS ROUNDINGMETHOD
  ,replace(TRY_PARSE_JSON(CHK.info):taxSettings:combinedReceiptName,'""','')   AS COMBINEDRECEIPTNAME
  ,replace(TRY_PARSE_JSON(CHK.info):taxSettings:receiptOption,'""','')         AS RECEIPTOPTION
  ,replace(TRY_PARSE_JSON(CHK.info):taxSettings:taxTracking,'""','')           AS TAXTRACKING  
  ,replace(TRY_PARSE_JSON(CHK.info):revenueCenterName,'""','')                 AS REVENUECENTERNAME
  ,TO_NUMBER(replace(TRY_PARSE_JSON(CHK.info):revenueCenterId,'""',''))        AS REVENUECENTERID
  ,CHK.status_reason_id                                                       AS STATUS_REASON_ID
  ,CHK.ID                                                                     AS CHECK_ID
  ,REPLACE(TRY_PARSE_JSON(chk.info):tableName,'""','')                         AS TABLE_NAME
--Counts and Amounts--------------------------------------------------------------------------

  ,TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):fees), 38,4)             AS FEES
  ,TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):giftcards), 38,4)        AS GIFTCARDS
  ,TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):gratuities), 38,4)       AS GRATUITIES

  ,TRY_PARSE_JSON(chk.info):partySize::number(38,4)                           AS PARTY_COUNT
  ,regexp_count( (TRY_PARSE_JSON(chk.info):discounts) , '""id"":' ,1 )          AS DISCOUNT_COUNT
  ,regexp_count( TO_CHAR(CHK.PAYMENTS) , '""id"":' ,1 )                         AS PAYMENT_COUNT
  ,TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):discount), 38,4)         AS DISCOUNT
  ,TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):discountCheck), 38,4)    AS DISCOUNTCHECK
  ,TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):discountItem), 38,4)     AS DISCOUNTITEM
  ,TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):gross), 38,4)            AS GROSS
  ,TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):inclusiveTax), 38,4)     AS INCLUSIVETAX
  ,TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):net), 38,4)              AS NET
  ,TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):paid), 38,4)             AS PAID
  ,TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):surcharge), 38,4)        AS SURCHARGE
  ,TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):tax), 38,4)              AS TAX
  ,TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):tip), 38,4)              AS TIP
  ,TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):total), 38,4)            AS TOTAL
  ,TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):unpaid), 38,4)           AS UNPAID
----------------------------------------------------------------------------------------------
FROM (
    -- This inner subquery selects and filters the raw data first.
    SELECT *
    FROM DATALANDING.POSAPI_PUBLIC_CHEQUE
    QUALIFY
        -- This first condition is your original filter. We keep it to exclude truncated records.
        NOT COALESCE(TRUNCATED, FALSE)
        -- This second condition uses our new logic to find and exclude the corrupt records.
        -- The entire block must NOT be true for a row to be included.
        AND NOT (
            -- Condition 1: The current row has a bad `created_at` date.
            (EXTRACT(YEAR FROM TRY_TO_TIMESTAMP(created_at)) < 1999 OR TRY_TO_TIMESTAMP(created_at) IS NULL)
            AND
            -- Condition 2: The current row is a delete operation ('d').
            MTLN_CDC_LAST_CHANGE_TYPE = 'd'
            AND
            -- Condition 3: The *next* row (ordered chronologically) is the `truncated = true` update.
            LEAD(truncated, 1, false) OVER (PARTITION BY id ORDER BY mtln_cdc_sequence_number DESC) = true
            AND
            LEAD(mtln_cdc_last_change_type, 1, '') OVER (PARTITION BY id ORDER BY mtln_cdc_sequence_number DESC) = 'u'
        )
) CHK
-- WHERE
--     id = 19180
;
--============================================================================================

;"
VIEW,DATAADMIN_DEBUG,ITEM_FACT,"create or replace view ITEM_FACT(
	ITEM_FACT_PK,
	ITEM_FACT_NK,
	COMBINEDNAME,
	DW_STARTDATE,
	DW_ENDDATE,
	DW_ISDELETED,
	DW_ISCURRENTROW,
	MTLN_CDC_LAST_CHANGE_TYPE,
	MTLN_CDC_LAST_COMMIT_TIMESTAMP,
	MTLN_CDC_SEQUENCE_NUMBER,
	MTLN_CDC_LOAD_BATCH_ID,
	MTLN_CDC_LOAD_TIMESTAMP,
	MTLN_CDC_PROCESSED_DATE_HOUR,
	MTLN_CDC_SRC_VERSION,
	MTLN_CDC_FILENAME,
	MTLN_CDC_FILEPATH,
	MTLN_CDC_SRC_DATABASE,
	MTLN_CDC_SRC_SCHEMA,
	MTLN_CDC_SRC_TABLE,
	CHEQUE_FACT_FK,
	DAYPART_DIM_FK,
	EMPLOYEE_DIM_FK,
	LOCATION_DIM_FK,
	ORDERTYPE_DIM_FK,
	MENUITEM_DIM_FK,
	MENUITEMNAME_DIM_FK,
	VOIDREASON_DIM_FK,
	VARIANT_DIM_FK,
	HASMODIFIERS,
	IS_TRAINING,
	IS_VOID,
	FISCAL_DATE_INT,
	FISCAL_DATE,
	OPENED_AT,
	BEGIN_PREP_AT,
	CLOSED_AT,
	SCHEDULED_AT,
	CREATED_AT,
	UPDATED_AT,
	SPLITBY,
	ITEMSTATUS,
	CHECKSTATUS,
	STATUSREASON_ID,
	STATUSREASON,
	MODIFIERS,
	NOTE,
	DESCRIPTION,
	NAME,
	PATH,
	VARIANTNAME,
	REVENUECENTERNAME,
	CHECK_ID,
	EMPLOYEE_ID,
	ITEM_ID,
	LOCATION_ID,
	REVENUECENTER_ID,
	ORDER_TYPE_ID,
	CHEQUENUMBER,
	APPLIEDAMOUNT,
	QUANTITY,
	REPORTQUANTITY,
	BASEPRICE,
	INCLUSIVETAX,
	TAB,
	DISCOUNTCHECK,
	DISCOUNTITEM,
	PRICE,
	GROSS,
	NET,
	TAX,
	TOTAL,
	CHECKGROSS,
	CHECKTOTAL
) as
--===========================================================================================
SELECT
--primary keys-------------------------------------------------------------------------------
   CHK.ID || '.'  ||replace(ITM.VALUE:id,'""','')--THIS PK IS TEXT BEreCAUSE OF ITEM GUID
                                                              AS ITEM_FACT_PK
--natural keys-f------------------------------------------------------------------------------
  ,CHK.ID || '.'  ||replace(ITM.VALUE:id,'""','')              AS ITEM_FACT_NK
--name---------------------------------------------------------------------------------------
    ,replace(ITM.value:menuItem:combinedName,'','')                 
                                                              AS COMBINEDNAME
--data warehouse rows------------------------------------------------------------------------
 ,TO_TIMESTAMP(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP))),23)
    ||  RIGHT('00000' || TO_CHAR(RANK() OVER (
      PARTITION BY  CHK.ID || '.'  ||replace(ITM.VALUE:id,'""','') ORDER BY CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP
      ,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION
      ,CHK.MTLN_CDC_FILENAME)),6))
                                                               AS DW_STARTDATE       --REQUIRED
   ,TIMESTAMPADD(NANOSECOND,-1,TO_TIMESTAMP(
    IFNULL(LEFT(TO_CHAR(TO_TIMESTAMP(TO_CHAR(LEAD(CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP) 
    OVER (PARTITION BY  CHK.ID || '.'  ||replace(ITM.VALUE:id,'""','') ORDER BY CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP
    ,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION,CHK.MTLN_CDC_FILENAME) ))),23)
    || RIGHT('00000' || TO_CHAR(RANK() OVER (PARTITION BY  CHK.ID || '.'  ||replace(ITM.VALUE:id,'""','') ORDER BY 
    CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP,CHK.MTLN_CDC_SEQUENCE_NUMBER,CHK.MTLN_CDC_SRC_VERSION
   ,CHK.MTLN_CDC_FILENAME) +1),6),'9999-09-09 09:09:09.000') ))
                                                              AS DW_ENDDATE          --REQUIRED
  
  ,CASE WHEN CHK.MTLN_CDC_LAST_CHANGE_TYPE ='d' 
    THEN TRUE ELSE FALSE END                                  AS DW_ISDELETED        --REQUIRED       
  ,CASE WHEN RANK() OVER(PARTITION BY  CHK.ID || '.'  ||replace(ITM.VALUE:id,'""','') ORDER BY  
    CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP DESC
   ,CHK.MTLN_CDC_SEQUENCE_NUMBER DESc
   ,CHK.MTLN_CDC_SRC_VERSION DESC
   ,CHK.MTLN_CDC_FILENAME DESC) = 1
        THEN TRUE ELSE FALSE END        AS DW_ISCURRENTROW     --REQUIRED
--CDC Meta data------------------------------------------------------------------------------
  ,CHK.MTLN_CDC_LAST_CHANGE_TYPE        AS MTLN_CDC_LAST_CHANGE_TYPE
  ,CHK.MTLN_CDC_LAST_COMMIT_TIMESTAMP   AS MTLN_CDC_LAST_COMMIT_TIMESTAMP
  ,CHK.MTLN_CDC_SEQUENCE_NUMBER         AS MTLN_CDC_SEQUENCE_NUMBER
  ,CHK.MTLN_CDC_LOAD_BATCH_ID           AS MTLN_CDC_LOAD_BATCH_ID
  ,CHK.MTLN_CDC_LOAD_TIMESTAMP          AS MTLN_CDC_LOAD_TIMESTAMP
  ,CHK.MTLN_CDC_PROCESSED_DATE_HOUR     AS MTLN_CDC_PROCESSED_DATE_HOUR
  ,CHK.MTLN_CDC_SRC_VERSION             AS MTLN_CDC_SRC_VERSION
  ,CHK.MTLN_CDC_FILENAME                AS MTLN_CDC_FILENAME
  ,CHK.MTLN_CDC_FILEPATH                AS MTLN_CDC_FILEPATH
  ,CHK.MTLN_CDC_SRC_DATABASE            AS MTLN_CDC_SRC_DATABASE
  ,CHK.MTLN_CDC_SRC_SCHEMA              AS MTLN_CDC_SRC_SCHEMA
  ,CHK.MTLN_CDC_SRC_TABLE               AS MTLN_CDC_SRC_TABLE
-- --foreign keys-------------------------------------------------------------------------------
  ,IFNULL(CHK.ID,-1)                    AS CHEQUE_FACT_FK      --one checque,many items
  ,IFNULL(CHK.day_part_id,-1)           AS DAYPART_DIM_FK  
  ,IFNULL(CHK.employee_id,-1)           AS EMPLOYEE_DIM_FK     
  ,IFNULL(CHK.location_id,-1)           AS LOCATION_DIM_FK  
  ,IFNULL(CHK.order_type_id,-1)         AS ORDERTYPE_DIM_FK  

  -- ,IFNULL(TO_NUMBER(replace(replace(split_part(
  --   replace(ITM.value:menuItem:path,'',''),'.',2),'{',''),'}','') ),-1)
  --                                       AS MENUGROUP_DIM_FK
  ,IFNULL(TO_NUMBER(ITM.value:menuItem:menuItemId),-1)       
                                        AS MENUITEM_DIM_FK     
  ,IFNULL(TO_NUMBER(ITM.value:menuItem:menuItemNameId),-1)   
                                        AS MENUITEMNAME_DIM_FK 
  ,IFNULL(CASE WHEN replace(ITM.value:status,'""','') 
     = 'Voided' 
    THEN TO_NUMBER(replace(ITM.value:statusReasonId,'""',''),38,0 )
    ELSE -1 END,-1)                     AS VoidReason_DIM_FK
  ,IFNULL(TO_NUMBER(replace(ITM.value:menuItem:variantId,'','')),-1)       
                                        AS VARIANT_DIM_FK      
-- --flags---------------------------------------------------------------------------------------
  ,CASE ITM.value:modifiers
    WHEN NULL THEN FALSE
    ELSE TRUE END                        AS HASMODIFIERS 
 ,CHK.IS_TRAINING                        AS IS_TRAINING
 ,CASE WHEN replace(ITM.value:status,'""','')
   = 'Voided' THEN TRUE ELSE FALSE END   AS IS_VOID
-- --Dates--------------.-----------------------------------------------------------------------
  ,CHK.FISCAL_DATE_INT                 AS FISCAL_DATE_INT                    
  ,TO_CHAR(TRY_PARSE_JSON(CHK.info):fiscalDate)::DATE   
                                       AS FISCAL_DATE              
  ,to_timestamp_tz(CHK.opened_at)      AS OPENED_AT
  ,to_timestamp_tz(CHK.begin_prep_at)  AS BEGIN_PREP_AT
  ,to_timestamp_tz(CHK.closed_at)      AS CLOSED_AT
  ,to_timestamp_tz(CHK.scheduled_at)   AS SCHEDULED_AT
  ,to_timestamp_tz(CHK.created_at)     AS CREATED_AT
  ,to_timestamp_tz(CHK.UPDATED_AT)     AS UPDATED_AT
-- --names,etc---------------------------------------------------------------------------------------
  ,TO_NUMBER(ITM.value:splitBy  )                              AS SPLITBY
  ,replace(ITM.value:status,'""','')                            AS ITEMSTATUS
  ,CHK.STATUS                                                  AS CHECKSTATUS
  ,replace(ITM.value:statusReasonId,'""','')                    AS STATUSREASON_ID
  ,ifnull(replace(ITM.value:statusReason,'""',''),'None')       AS STATUSREASON
  ,replace(ITM.value:modifiers,'""','')                         AS MODIFIERS
  ,ifnull(replace(ITM.value:note,'""',''),' ')                  AS NOTE
  ,replace(ITM.value:menuItem:description,'','')               AS DESCRIPTION
  ,replace(ITM.value:menuItem:name,'','')                      AS NAME
  ,replace(ITM.value:menuItem:path,'','')                      AS PATH    
  ,ifnull(replace(ITM.value:menuItem:variantName,'',''),' ')   AS VARIANTNAME
  ,replace(TRY_PARSE_JSON(CHk.info):revenueCenterName,'""','')  AS REVENUECENTERNAME
  ,CHK.ID                                                      AS CHECK_ID
  ,CHK.EMPLOYEE_ID                                             AS EMPLOYEE_ID  
  ,replace(ITM.VALUE:id,'""','')                                AS ITEM_ID
  ,CHK.LOCATION_ID                                             AS LOCATION_ID
  ,TO_NUMBER(replace(TRY_PARSE_JSON(CHK.info):revenueCenterId,'""',''))    AS REVENUECENTER_ID  
  ,CHK.ORDER_TYPE_ID                                           AS ORDER_TYPE_ID
  ,CHK.NUMBER                                                  AS CHEQUENUMBER
-- --counts and amounts--------------------------------------------------------------------------------
  ,CAST(ITM.value:appliedAmount AS DECIMAL(38,4))              AS APPLIEDAMOUNT
  ,CAST(ITM.value:quantity AS DECIMAL(38,4))                   AS QUANTITY
  ,IFNULL(CAST(ITM.value:reportQuantity AS DECIMAL(38,4)),1)   AS REPORTQUANTITY
  ,CAST(ITM.value:basePrice AS DECIMAL(38,4))                  AS BASEPRICE
  ,CAST(ITM.value:inclusiveTax AS DECIMAL(38,4))               AS INCLUSIVETAX
  ,CAST(ITM.value:discount AS DECIMAL(38,4))                   AS TAB
  ,CAST(ITM.value:discountCheck AS DECIMAL(38,4))              AS DISCOUNTCHECK
  ,CAST(ITM.value:discountItem AS DECIMAL(38,4))               AS DISCOUNTITEM
  ,CAST(ITM.value:menuItem:price AS DECIMAL(38,4))             AS PRICE
  ,CAST(ITM.value:gross AS DECIMAL(38,4))                      AS GROSS  
  ,CAST(ITM.value:net AS DECIMAL(38,4))                        AS NET  
  ,CAST(ITM.value:tax AS DECIMAL(38,4))                        AS TAX
  ,CAST(ITM.value:total AS DECIMAL(38,4))                      AS TOTAL 
  ,TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):gross), 38, 4)           
                                                               AS CHECKGROSS
 ,TRY_TO_NUMBER(TO_CHAR(TRY_PARSE_JSON(CHK.balance):total), 38, 4)           
                                                               AS CHECKTOTAL                                                               
  -------------------------------------------------------------------------------------
FROM (
    -- This inner subquery selects and filters the raw data first.
    SELECT *
    FROM DATALANDING.POSAPI_PUBLIC_CHEQUE
    QUALIFY
        -- This first condition is your original filter. We keep it to exclude truncated records.
        NOT COALESCE(TRUNCATED, FALSE)
        -- This second condition uses our new logic to find and exclude the corrupt records.
        -- The entire block must NOT be true for a row to be included.
        AND NOT (
            -- Condition 1: The current row has a bad `created_at` date.
            (EXTRACT(YEAR FROM TRY_TO_TIMESTAMP(created_at)) < 1999 OR TRY_TO_TIMESTAMP(created_at) IS NULL)
            AND
            -- Condition 2: The current row is a delete operation ('d').
            MTLN_CDC_LAST_CHANGE_TYPE = 'd'
            AND
            -- Condition 3: The *next* row (ordered chronologically) is the `truncated = true` update.
            LEAD(truncated, 1, false) OVER (PARTITION BY id ORDER BY mtln_cdc_sequence_number DESC) = true
            AND
            LEAD(mtln_cdc_last_change_type, 1, '') OVER (PARTITION BY id ORDER BY mtln_cdc_sequence_number DESC) = 'u'
        )
)   CHK
    ,LATERAL FLATTEN(INPUT => 
    TRY_PARSE_JSON( '{ITEMS:' || CHK.ITEMS || '}' ), PATH => 'ITEMS')
                                                               ITM                                                           
                                                        
;"
VIEW,DATAWAREHOUSE,DW_ALLTABLES,"create or replace view DW_ALLTABLES(
	TABLE_NAME,
	HASDATAWAREHOUSETABLE,
	VIEW_COLUMN_COUNT,
	DW_COLUMN_COUNT,
	FK_COUNT
) as
--============================================================================================
--call DEV_HOSPENG_REPORTING.PUBLIC.UTILITY_DEPENDENCIES()
select t.table_name                                                                                  as table_name
,MAX(CASE WHEN t.table_type = 'BASE TABLE' and t.table_schema = 'DATAWAREHOUSE' THEN TRUE ELSE FALSE END)
                                                                                                     as HasDatawarehouseTable
,SUM(case when t.table_schema = 'POSTGRES_PUBLIC' and t.table_type = 'VIEW' then 1 else 0 end)       as view_column_count
,SUM(case when t.table_schema = 'DATAWAREHOUSE' and t.table_type = 'BASE TABLE' then 1 else 0 end)   as dw_column_count
,sum(case when t.table_schema = 'POSTGRES_PUBLIC' and t.table_type = 'VIEW' AND c.column_name like '%_FK%' 
                                   THEN 1 ELSE 0 END)                                                                                                                                                                                            as fk_count
      from information_schema.tables t
      inner join information_schema.columns c
          on t.table_schema     = c.table_schema
            and t.table_name    = c.table_name
            and ((t.table_type = 'VIEW' and  t.table_schema = 'POSTGRES_PUBLIC')
                   or (t.table_type = 'BASE TABLE' and  t.table_schema = 'DATAWAREHOUSE'))
            and t.table_type    IN ('VIEW','BASE TABLE')
            and t.table_name NOT LIKE 'DW_%'
 group by t.table_name
 order by t.table_name
 ;"
VIEW,DATAWAREHOUSE,REPORT_REPORTUSE,"create or replace view REPORT_REPORTUSE(
	""Report Name"",
	""Start Date"",
	""Start Time"",
	""End Time"",
	""Query Tag"",
	""Bytes Scanned"",
	""Rows Produced"",
	""Query Text"",
	""Execution Status"",
	""Error Message"",
	""Compilation Time"",
	""Execution Time"",
	""Total Elapsed Time""
) as
--======================================================================
SELECT REPLACE(ARRAY_TO_STRING(ARRAY_SLICE(STRTOK_TO_ARRAY(QRY.QUERY_TAG, '/')
  , 1, 2), '.'),'report_','')						as ""Report Name""
,TO_DATE(QRY.START_TIME)							as ""Start Date"" 
,QRY.START_TIME										as ""Start Time""
,QRY.END_TIME								        as ""End Time""
,QRY.QUERY_TAG										as ""Query Tag""
,QRY.BYTES_SCANNED									as ""Bytes Scanned""
,QRY.ROWS_PRODUCED									as ""Rows Produced""
,QRY.QUERY_TEXT										as ""Query Text""
,QRY.EXECUTION_STATUS								as ""Execution Status""
--,COALESCE(QRY.ERROR_CODE,0.00,'99.9')				as ""Error Code""
,COALESCE(QRY.ERROR_MESSAGE,'None')					as ""Error Message""
,QRY.COMPILATION_TIME								as ""Compilation Time""
,QRY.EXECUTION_TIME									as ""Execution Time""
,QRY.TOTAL_ELAPSED_TIME								as ""Total Elapsed Time""
	FROM TABLE(INFORMATION_SCHEMA.QUERY_HISTORY_BY_USER(
		USER_NAME => 'APP_AIRBYTE_HOSPENG'
        --NOTE:  we have default time of 7 days to keep this history
        --,END_TIME_RANGE_START=>to_timestamp_ltz('2022-02-23 12:00:00.000 -0000')
        --,END_TIME_RANGE_END=>to_timestamp_ltz('2023-12-12 12:00:00.000 -0000')
    ))                                                             QRY
WHERE QRY.QUERY_TYPE = 'SELECT'
  AND QRY.QUERY_TAG LIKE 'REPORT%'
ORDER BY QRY.START_TIME;"
VIEW,DATAWAREHOUSE_HOLD,DW_ALLTABLES,"create or replace view DW_ALLTABLES(
	TABLE_NAME,
	HASDATAWAREHOUSETABLE,
	VIEW_COLUMN_COUNT,
	DW_COLUMN_COUNT,
	FK_COUNT
) as
--============================================================================================
--call DEV_HOSPENG_REPORTING.PUBLIC.UTILITY_DEPENDENCIES()
select t.table_name                                                                                  as table_name
,MAX(CASE WHEN t.table_type = 'BASE TABLE' and t.table_schema = 'DATAWAREHOUSE' THEN TRUE ELSE FALSE END)
                                                                                                     as HasDatawarehouseTable
,SUM(case when t.table_schema = 'POSTGRES_PUBLIC' and t.table_type = 'VIEW' then 1 else 0 end)       as view_column_count
,SUM(case when t.table_schema = 'DATAWAREHOUSE' and t.table_type = 'BASE TABLE' then 1 else 0 end)   as dw_column_count
,sum(case when t.table_schema = 'POSTGRES_PUBLIC' and t.table_type = 'VIEW' AND c.column_name like '%_FK%' 
                                   THEN 1 ELSE 0 END)                                                                                                                                                                                            as fk_count
      from information_schema.tables t
      inner join information_schema.columns c
          on t.table_schema     = c.table_schema
            and t.table_name    = c.table_name
            and ((t.table_type = 'VIEW' and  t.table_schema = 'POSTGRES_PUBLIC')
                   or (t.table_type = 'BASE TABLE' and  t.table_schema = 'DATAWAREHOUSE'))
            and t.table_type    IN ('VIEW','BASE TABLE')
            and t.table_name NOT LIKE 'DW_%'
 group by t.table_name
 order by t.table_name
 ;"
VIEW,DATAWAREHOUSE_HOLD,REPORT_REPORTUSE,"create or replace view REPORT_REPORTUSE(
	""Report Name"",
	""Start Date"",
	""Start Time"",
	""End Time"",
	""Query Tag"",
	""Bytes Scanned"",
	""Rows Produced"",
	""Query Text"",
	""Execution Status"",
	""Error Message"",
	""Compilation Time"",
	""Execution Time"",
	""Total Elapsed Time""
) as
--======================================================================
SELECT REPLACE(ARRAY_TO_STRING(ARRAY_SLICE(STRTOK_TO_ARRAY(QRY.QUERY_TAG, '/')
  , 1, 2), '.'),'report_','')						as ""Report Name""
,TO_DATE(QRY.START_TIME)							as ""Start Date"" 
,QRY.START_TIME										as ""Start Time""
,QRY.END_TIME								        as ""End Time""
,QRY.QUERY_TAG										as ""Query Tag""
,QRY.BYTES_SCANNED									as ""Bytes Scanned""
,QRY.ROWS_PRODUCED									as ""Rows Produced""
,QRY.QUERY_TEXT										as ""Query Text""
,QRY.EXECUTION_STATUS								as ""Execution Status""
--,COALESCE(QRY.ERROR_CODE,0.00,'99.9')				as ""Error Code""
,COALESCE(QRY.ERROR_MESSAGE,'None')					as ""Error Message""
,QRY.COMPILATION_TIME								as ""Compilation Time""
,QRY.EXECUTION_TIME									as ""Execution Time""
,QRY.TOTAL_ELAPSED_TIME								as ""Total Elapsed Time""
	FROM TABLE(INFORMATION_SCHEMA.QUERY_HISTORY_BY_USER(
		USER_NAME => 'APP_AIRBYTE_HOSPENG'
        --NOTE:  we have default time of 7 days to keep this history
        --,END_TIME_RANGE_START=>to_timestamp_ltz('2022-02-23 12:00:00.000 -0000')
        --,END_TIME_RANGE_END=>to_timestamp_ltz('2023-12-12 12:00:00.000 -0000')
    ))                                                             QRY
WHERE QRY.QUERY_TYPE = 'SELECT'
  AND QRY.QUERY_TAG LIKE 'REPORT%'
ORDER BY QRY.START_TIME;"
VIEW,DATAWAREHOUSE_OLD,REPORT_REPORTUSE,"create or replace view REPORT_REPORTUSE(
	""Report Name"",
	""Start Date"",
	""Start Time"",
	""End Time"",
	""Query Tag"",
	""Bytes Scanned"",
	""Rows Produced"",
	""Query Text"",
	""Execution Status"",
	""Error Message"",
	""Compilation Time"",
	""Execution Time"",
	""Total Elapsed Time""
) as
--======================================================================
SELECT REPLACE(ARRAY_TO_STRING(ARRAY_SLICE(STRTOK_TO_ARRAY(QRY.QUERY_TAG, '/')
  , 1, 2), '.'),'report_','')						as ""Report Name""
,TO_DATE(QRY.START_TIME)							as ""Start Date"" 
,QRY.START_TIME										as ""Start Time""
,QRY.END_TIME								        as ""End Time""
,QRY.QUERY_TAG										as ""Query Tag""
,QRY.BYTES_SCANNED									as ""Bytes Scanned""
,QRY.ROWS_PRODUCED									as ""Rows Produced""
,QRY.QUERY_TEXT										as ""Query Text""
,QRY.EXECUTION_STATUS								as ""Execution Status""
--,COALESCE(QRY.ERROR_CODE,0.00,'99.9')				as ""Error Code""
,COALESCE(QRY.ERROR_MESSAGE,'None')					as ""Error Message""
,QRY.COMPILATION_TIME								as ""Compilation Time""
,QRY.EXECUTION_TIME									as ""Execution Time""
,QRY.TOTAL_ELAPSED_TIME								as ""Total Elapsed Time""
	FROM TABLE(INFORMATION_SCHEMA.QUERY_HISTORY_BY_USER(
		USER_NAME => 'APP_AIRBYTE_HOSPENG'
        --NOTE:  we have default time of 7 days to keep this history
        --,END_TIME_RANGE_START=>to_timestamp_ltz('2022-02-23 12:00:00.000 -0000')
        --,END_TIME_RANGE_END=>to_timestamp_ltz('2023-12-12 12:00:00.000 -0000')
    ))                                                             QRY
WHERE QRY.QUERY_TYPE = 'SELECT'
  AND QRY.QUERY_TAG LIKE 'REPORT%'
ORDER BY QRY.START_TIME;"
VIEW,DATAWAREHOUSE_OLD,DW_ALLTABLES,"create or replace view DW_ALLTABLES(
	TABLE_NAME,
	HASDATAWAREHOUSETABLE,
	VIEW_COLUMN_COUNT,
	DW_COLUMN_COUNT,
	FK_COUNT
) as
--============================================================================================
--call DEV_HOSPENG_REPORTING.PUBLIC.UTILITY_DEPENDENCIES()
select t.table_name                                                                                  as table_name
,MAX(CASE WHEN t.table_type = 'BASE TABLE' and t.table_schema = 'DATAWAREHOUSE' THEN TRUE ELSE FALSE END)
                                                                                                     as HasDatawarehouseTable
,SUM(case when t.table_schema = 'POSTGRES_PUBLIC' and t.table_type = 'VIEW' then 1 else 0 end)       as view_column_count
,SUM(case when t.table_schema = 'DATAWAREHOUSE' and t.table_type = 'BASE TABLE' then 1 else 0 end)   as dw_column_count
,sum(case when t.table_schema = 'POSTGRES_PUBLIC' and t.table_type = 'VIEW' AND c.column_name like '%_FK%' 
                                   THEN 1 ELSE 0 END)                                                                                                                                                                                            as fk_count
      from information_schema.tables t
      inner join information_schema.columns c
          on t.table_schema     = c.table_schema
            and t.table_name    = c.table_name
            and ((t.table_type = 'VIEW' and  t.table_schema = 'POSTGRES_PUBLIC')
                   or (t.table_type = 'BASE TABLE' and  t.table_schema = 'DATAWAREHOUSE'))
            and t.table_type    IN ('VIEW','BASE TABLE')
            and t.table_name NOT LIKE 'DW_%'
 group by t.table_name
 order by t.table_name
 ;"
VIEW,DATAWAREHOUSE_TEMP,REPORT_REPORTUSE,"create or replace view REPORT_REPORTUSE(
	""Report Name"",
	""Start Date"",
	""Start Time"",
	""End Time"",
	""Query Tag"",
	""Bytes Scanned"",
	""Rows Produced"",
	""Query Text"",
	""Execution Status"",
	""Error Message"",
	""Compilation Time"",
	""Execution Time"",
	""Total Elapsed Time""
) as
--======================================================================
SELECT REPLACE(ARRAY_TO_STRING(ARRAY_SLICE(STRTOK_TO_ARRAY(QRY.QUERY_TAG, '/')
  , 1, 2), '.'),'report_','')						as ""Report Name""
,TO_DATE(QRY.START_TIME)							as ""Start Date"" 
,QRY.START_TIME										as ""Start Time""
,QRY.END_TIME								        as ""End Time""
,QRY.QUERY_TAG										as ""Query Tag""
,QRY.BYTES_SCANNED									as ""Bytes Scanned""
,QRY.ROWS_PRODUCED									as ""Rows Produced""
,QRY.QUERY_TEXT										as ""Query Text""
,QRY.EXECUTION_STATUS								as ""Execution Status""
--,COALESCE(QRY.ERROR_CODE,0.00,'99.9')				as ""Error Code""
,COALESCE(QRY.ERROR_MESSAGE,'None')					as ""Error Message""
,QRY.COMPILATION_TIME								as ""Compilation Time""
,QRY.EXECUTION_TIME									as ""Execution Time""
,QRY.TOTAL_ELAPSED_TIME								as ""Total Elapsed Time""
	FROM TABLE(INFORMATION_SCHEMA.QUERY_HISTORY_BY_USER(
		USER_NAME => 'APP_AIRBYTE_HOSPENG'
        --NOTE:  we have default time of 7 days to keep this history
        --,END_TIME_RANGE_START=>to_timestamp_ltz('2022-02-23 12:00:00.000 -0000')
        --,END_TIME_RANGE_END=>to_timestamp_ltz('2023-12-12 12:00:00.000 -0000')
    ))                                                             QRY
WHERE QRY.QUERY_TYPE = 'SELECT'
  AND QRY.QUERY_TAG LIKE 'REPORT%'
ORDER BY QRY.START_TIME;"
VIEW,DATAWAREHOUSE_TEMP,DW_ALLTABLES,"create or replace view DW_ALLTABLES(
	TABLE_NAME,
	HASDATAWAREHOUSETABLE,
	VIEW_COLUMN_COUNT,
	DW_COLUMN_COUNT,
	FK_COUNT
) as
--============================================================================================
--call DEV_HOSPENG_REPORTING.PUBLIC.UTILITY_DEPENDENCIES()
select t.table_name                                                                                  as table_name
,MAX(CASE WHEN t.table_type = 'BASE TABLE' and t.table_schema = 'DATAWAREHOUSE' THEN TRUE ELSE FALSE END)
                                                                                                     as HasDatawarehouseTable
,SUM(case when t.table_schema = 'POSTGRES_PUBLIC' and t.table_type = 'VIEW' then 1 else 0 end)       as view_column_count
,SUM(case when t.table_schema = 'DATAWAREHOUSE' and t.table_type = 'BASE TABLE' then 1 else 0 end)   as dw_column_count
,sum(case when t.table_schema = 'POSTGRES_PUBLIC' and t.table_type = 'VIEW' AND c.column_name like '%_FK%' 
                                   THEN 1 ELSE 0 END)                                                                                                                                                                                            as fk_count
      from information_schema.tables t
      inner join information_schema.columns c
          on t.table_schema     = c.table_schema
            and t.table_name    = c.table_name
            and ((t.table_type = 'VIEW' and  t.table_schema = 'POSTGRES_PUBLIC')
                   or (t.table_type = 'BASE TABLE' and  t.table_schema = 'DATAWAREHOUSE'))
            and t.table_type    IN ('VIEW','BASE TABLE')
            and t.table_name NOT LIKE 'DW_%'
 group by t.table_name
 order by t.table_name
 ;"
VIEW,TEST_READER,ITEM_SALES_VIEW,"ERROR: SQL compilation error:
Object does not exist, or operation cannot be performed."
VIEW,TEST_READER,ORDER_SUMMARY_VIEW,"ERROR: SQL compilation error:
Object does not exist, or operation cannot be performed."
