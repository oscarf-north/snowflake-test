CREATE OR REPLACE PROCEDURE "SP_STAGELOADVOIDCHECKBYITEM_FACT"("VALIDATE_DATE" BOOLEAN)
RETURNS TABLE ()
LANGUAGE SQL
EXECUTE AS OWNER
AS 'DECLARE res resultset;
      --validate_date boolean := TRUE;
      errorCount_res resultset;
      highwater int := IFNULL((SELECT MAX(MTLN_CDC_SEQUENCE_NUMBER) FROM DATAWAREHOUSE_TEMP.VOIDCHECKBYITEM_FACT),0);
  BEGIN
    res := (
       INSERT INTO DATAWAREHOUSE_TEMP.VOIDCHECKBYITEM_FACT(   
          VOIDCHECKBYITEM_FACT_NK, 
          CHEQUENUMBER, 
          DW_STARTDATE, 
          DW_ENDDATE, 
          DW_ISDELETED, 
          DW_RANGESTART, 
          DW_RANGEEND, 
          DW_ISCURRENTROW, 
          MTLN_CDC_LAST_CHANGE_TYPE, 
          MTLN_CDC_LAST_COMMIT_TIMESTAMP, 
          MTLN_CDC_SEQUENCE_NUMBER, 
          MTLN_CDC_LOAD_BATCH_ID, 
          MTLN_CDC_LOAD_TIMESTAMP, 
          MTLN_CDC_PROCESSED_DATE_HOUR, 
          MTLN_CDC_SRC_VERSION, 
          MTLN_CDC_FILENAME, 
          MTLN_CDC_FILEPATH, 
          MTLN_CDC_SRC_DATABASE, 
          MTLN_CDC_SRC_SCHEMA, 
          MTLN_CDC_SRC_TABLE, 
          CHEQUE_FACT_FK, 
          DAYPART_DIM_FK, 
          EMPLOYEE_DIM_FK, 
          ITEM_FACT_FK, 
          LOCATION_DIM_FK, 
          MENUITEM_DIM_FK, 
          MENUITEMNAME_DIM_FK, 
          ORDERTYPE_DIM_FK, 
          ORGANIZATION_DIM_FK, 
          REVENUECENTER_DIM_FK, 
          SHIFT_DIM_FK, 
          TAXSETTINGS_DIM_FK, 
          VARIANT_DIM_FK, 
          VOIDREASON_DIM_FK, 
          HAS_DISCOUNT, 
          IS_TRAINING, 
          IS_VOID, 
          HAS_TRACKTAXESONCOMP, 
          FISCAL_DATE_INT, 
          FISCAL_DATE, 
          OPENED_AT, 
          BEGIN_PREP_AT, 
          CLOSED_AT, 
          SCHEDULED_AT, 
          CREATED_AT, 
          UPDATED_AT, 
          UUID, 
          AUDIT, 
          ROUNDINGMETHOD, 
          COMBINEDRECEIPTNAME, 
          RECEIPTOPTION, 
          TAXTRACKING, 
          REVENUECENTERNAME, 
          REVENUECENTERID, 
          STATUS_REASON_ID, 
          CHECK_ID, 
          TABLE_NAME, 
          STATUS, 
          ITEM_ID, 
          ITEMSTATUS, 
          CHECKGROSS, 
          CHECKTOTAL, 
          PRICE, 
          QUANTITY, 
          GROSS, 
          VOID_LEVEL, 
          TOTAL_NON_VOIDED_QUANTITY_ON_CHECK, 
          NON_VOIDED_ITEM_ROW_NUMBER, 
          ALLOCATED_ITEM_VOID 
) 
 SELECT   VOIDCHECKBYITEM_FACT_NK  as   VOIDCHECKBYITEM_FACT_NK,  
   CHEQUENUMBER  as   CHEQUENUMBER,  
   DW_STARTDATE  as   DW_STARTDATE,  
   DW_ENDDATE  as   DW_ENDDATE,  
   DW_ISDELETED  as   DW_ISDELETED,  
   :highwater  as   DW_RANGESTART,  
   MAX(MTLN_CDC_SEQUENCE_NUMBER) OVER(PARTITION BY 1)  as   DW_RANGEEND,  
   DW_ISCURRENTROW  as   DW_ISCURRENTROW,  
   MTLN_CDC_LAST_CHANGE_TYPE  as   MTLN_CDC_LAST_CHANGE_TYPE,  
   MTLN_CDC_LAST_COMMIT_TIMESTAMP  as   MTLN_CDC_LAST_COMMIT_TIMESTAMP,  
   MTLN_CDC_SEQUENCE_NUMBER  as   MTLN_CDC_SEQUENCE_NUMBER,  
   MTLN_CDC_LOAD_BATCH_ID  as   MTLN_CDC_LOAD_BATCH_ID,  
   MTLN_CDC_LOAD_TIMESTAMP  as   MTLN_CDC_LOAD_TIMESTAMP,  
   MTLN_CDC_PROCESSED_DATE_HOUR  as   MTLN_CDC_PROCESSED_DATE_HOUR,  
   MTLN_CDC_SRC_VERSION  as   MTLN_CDC_SRC_VERSION,  
   MTLN_CDC_FILENAME  as   MTLN_CDC_FILENAME,  
   MTLN_CDC_FILEPATH  as   MTLN_CDC_FILEPATH,  
   MTLN_CDC_SRC_DATABASE  as   MTLN_CDC_SRC_DATABASE,  
   MTLN_CDC_SRC_SCHEMA  as   MTLN_CDC_SRC_SCHEMA,  
   MTLN_CDC_SRC_TABLE  as   MTLN_CDC_SRC_TABLE,  
   CHEQUE_FACT_FK  as   CHEQUE_FACT_FK,  
   DAYPART_DIM_FK  as   DAYPART_DIM_FK,  
   EMPLOYEE_DIM_FK  as   EMPLOYEE_DIM_FK,  
   ITEM_FACT_FK  as   ITEM_FACT_FK,  
   LOCATION_DIM_FK  as   LOCATION_DIM_FK,  
   MENUITEM_DIM_FK  as   MENUITEM_DIM_FK,  
   MENUITEMNAME_DIM_FK  as   MENUITEMNAME_DIM_FK,  
   ORDERTYPE_DIM_FK  as   ORDERTYPE_DIM_FK,  
   ORGANIZATION_DIM_FK  as   ORGANIZATION_DIM_FK,  
   REVENUECENTER_DIM_FK  as   REVENUECENTER_DIM_FK,  
   SHIFT_DIM_FK  as   SHIFT_DIM_FK,  
   TAXSETTINGS_DIM_FK  as   TAXSETTINGS_DIM_FK,  
   VARIANT_DIM_FK  as   VARIANT_DIM_FK,  
   VOIDREASON_DIM_FK  as   VOIDREASON_DIM_FK,  
   HAS_DISCOUNT  as   HAS_DISCOUNT,  
   IS_TRAINING  as   IS_TRAINING,  
   IS_VOID  as   IS_VOID,  
   HAS_TRACKTAXESONCOMP  as   HAS_TRACKTAXESONCOMP,  
   FISCAL_DATE_INT  as   FISCAL_DATE_INT,  
   FISCAL_DATE  as   FISCAL_DATE,  
   OPENED_AT  as   OPENED_AT,  
   BEGIN_PREP_AT  as   BEGIN_PREP_AT,  
   CLOSED_AT  as   CLOSED_AT,  
   SCHEDULED_AT  as   SCHEDULED_AT,  
   CREATED_AT  as   CREATED_AT,  
   UPDATED_AT  as   UPDATED_AT,  
   UUID  as   UUID,  
   AUDIT  as   AUDIT,  
   ROUNDINGMETHOD  as   ROUNDINGMETHOD,  
   COMBINEDRECEIPTNAME  as   COMBINEDRECEIPTNAME,  
   RECEIPTOPTION  as   RECEIPTOPTION,  
   TAXTRACKING  as   TAXTRACKING,  
   REVENUECENTERNAME  as   REVENUECENTERNAME,  
   REVENUECENTERID  as   REVENUECENTERID,  
   STATUS_REASON_ID  as   STATUS_REASON_ID,  
   CHECK_ID  as   CHECK_ID,  
   TABLE_NAME  as   TABLE_NAME,  
   STATUS  as   STATUS,  
   ITEM_ID  as   ITEM_ID,  
   ITEMSTATUS  as   ITEMSTATUS,  
   CHECKGROSS  as   CHECKGROSS,  
   CHECKTOTAL  as   CHECKTOTAL,  
   PRICE  as   PRICE,  
   QUANTITY  as   QUANTITY,  
   GROSS  as   GROSS,  
   VOID_LEVEL  as   VOID_LEVEL,  
   TOTAL_NON_VOIDED_QUANTITY_ON_CHECK  as   TOTAL_NON_VOIDED_QUANTITY_ON_CHECK,  
   NON_VOIDED_ITEM_ROW_NUMBER  as   NON_VOIDED_ITEM_ROW_NUMBER,  
   ALLOCATED_ITEM_VOID  as   ALLOCATED_ITEM_VOID 
  FROM DATAADMIN.VOIDCHECKBYITEM_FACT
     WHERE MTLN_CDC_SEQUENCE_NUMBER > :highwater);

 
 --======================================================================================================================== 

 
--========================================================================================================================
CALL SP_UpdateDWTable( ''DATASTAGE'', ''VOIDCHECKBYITEM_FACT'');
IF (validate_date = TRUE)  THEN  errorCount_res := (CALL DATAADMIN.SP_ValidateDWDates(''p'',''VOIDCHECKBYITEM_FACT'',''COUNT''));
END IF;
return table(errorCount_res); END';