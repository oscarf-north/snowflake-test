CREATE OR REPLACE PROCEDURE "SP_STAGELOADITEM_FACT"("VALIDATE_DATE" BOOLEAN)
RETURNS TABLE ()
LANGUAGE SQL
EXECUTE AS OWNER
AS 'DECLARE res resultset;
      --validate_date boolean := TRUE;
      errorCount_res resultset;
      highwater int := IFNULL((SELECT MAX(MTLN_CDC_SEQUENCE_NUMBER) FROM DATAWAREHOUSE_TEMP.ITEM_FACT),0);
  BEGIN
    res := (
       INSERT INTO DATAWAREHOUSE_TEMP.ITEM_FACT(   
          ITEM_FACT_NK, 
          COMBINEDNAME, 
          DW_STARTDATE, 
          DW_ENDDATE, 
          DW_ISDELETED, 
          DW_RANGESTART, 
          DW_RANGEEND, 
          DW_ISCURRENTROW, 
          MTLN_CDC_LAST_CHANGE_TYPE, 
          MTLN_CDC_LAST_COMMIT_TIMESTAMP, 
          MTLN_CDC_SEQUENCE_NUMBER, 
          MTLN_CDC_LOAD_BATCH_ID, 
          MTLN_CDC_LOAD_TIMESTAMP, 
          MTLN_CDC_PROCESSED_DATE_HOUR, 
          MTLN_CDC_SRC_VERSION, 
          MTLN_CDC_FILENAME, 
          MTLN_CDC_FILEPATH, 
          MTLN_CDC_SRC_DATABASE, 
          MTLN_CDC_SRC_SCHEMA, 
          MTLN_CDC_SRC_TABLE, 
          CHEQUE_FACT_FK, 
          DAYPART_DIM_FK, 
          EMPLOYEE_DIM_FK, 
          LOCATION_DIM_FK, 
          ORDERTYPE_DIM_FK, 
          MENUITEM_DIM_FK, 
          MENUITEMNAME_DIM_FK, 
          VOIDREASON_DIM_FK, 
          VARIANT_DIM_FK, 
          HASMODIFIERS, 
          IS_TRAINING, 
          IS_VOID, 
          FISCAL_DATE_INT, 
          FISCAL_DATE, 
          OPENED_AT, 
          BEGIN_PREP_AT, 
          CLOSED_AT, 
          SCHEDULED_AT, 
          CREATED_AT, 
          UPDATED_AT, 
          SPLITBY, 
          ITEMSTATUS, 
          CHECKSTATUS, 
          STATUSREASON_ID, 
          STATUSREASON, 
          MODIFIERS, 
          NOTE, 
          DESCRIPTION, 
          NAME, 
          PATH, 
          VARIANTNAME, 
          REVENUECENTERNAME, 
          CHECK_ID, 
          EMPLOYEE_ID, 
          ITEM_ID, 
          LOCATION_ID, 
          REVENUECENTER_ID, 
          ORDER_TYPE_ID, 
          CHEQUENUMBER, 
          APPLIEDAMOUNT, 
          QUANTITY, 
          REPORTQUANTITY, 
          BASEPRICE, 
          INCLUSIVETAX, 
          TAB, 
          DISCOUNTCHECK, 
          DISCOUNTITEM, 
          PRICE, 
          GROSS, 
          NET, 
          TAX, 
          TOTAL, 
          CHECKGROSS, 
          CHECKTOTAL 
) 
 SELECT   ITEM_FACT_NK  as   ITEM_FACT_NK,  
   COMBINEDNAME  as   COMBINEDNAME,  
   DW_STARTDATE  as   DW_STARTDATE,  
   DW_ENDDATE  as   DW_ENDDATE,  
   DW_ISDELETED  as   DW_ISDELETED,  
   :highwater  as   DW_RANGESTART,  
   MAX(MTLN_CDC_SEQUENCE_NUMBER) OVER(PARTITION BY 1)  as   DW_RANGEEND,  
   DW_ISCURRENTROW  as   DW_ISCURRENTROW,  
   MTLN_CDC_LAST_CHANGE_TYPE  as   MTLN_CDC_LAST_CHANGE_TYPE,  
   MTLN_CDC_LAST_COMMIT_TIMESTAMP  as   MTLN_CDC_LAST_COMMIT_TIMESTAMP,  
   MTLN_CDC_SEQUENCE_NUMBER  as   MTLN_CDC_SEQUENCE_NUMBER,  
   MTLN_CDC_LOAD_BATCH_ID  as   MTLN_CDC_LOAD_BATCH_ID,  
   MTLN_CDC_LOAD_TIMESTAMP  as   MTLN_CDC_LOAD_TIMESTAMP,  
   MTLN_CDC_PROCESSED_DATE_HOUR  as   MTLN_CDC_PROCESSED_DATE_HOUR,  
   MTLN_CDC_SRC_VERSION  as   MTLN_CDC_SRC_VERSION,  
   MTLN_CDC_FILENAME  as   MTLN_CDC_FILENAME,  
   MTLN_CDC_FILEPATH  as   MTLN_CDC_FILEPATH,  
   MTLN_CDC_SRC_DATABASE  as   MTLN_CDC_SRC_DATABASE,  
   MTLN_CDC_SRC_SCHEMA  as   MTLN_CDC_SRC_SCHEMA,  
   MTLN_CDC_SRC_TABLE  as   MTLN_CDC_SRC_TABLE,  
   CHEQUE_FACT_FK  as   CHEQUE_FACT_FK,  
   DAYPART_DIM_FK  as   DAYPART_DIM_FK,  
   EMPLOYEE_DIM_FK  as   EMPLOYEE_DIM_FK,  
   LOCATION_DIM_FK  as   LOCATION_DIM_FK,  
   ORDERTYPE_DIM_FK  as   ORDERTYPE_DIM_FK,  
   MENUITEM_DIM_FK  as   MENUITEM_DIM_FK,  
   MENUITEMNAME_DIM_FK  as   MENUITEMNAME_DIM_FK,  
   VOIDREASON_DIM_FK  as   VOIDREASON_DIM_FK,  
   VARIANT_DIM_FK  as   VARIANT_DIM_FK,  
   HASMODIFIERS  as   HASMODIFIERS,  
   IS_TRAINING  as   IS_TRAINING,  
   IS_VOID  as   IS_VOID,  
   FISCAL_DATE_INT  as   FISCAL_DATE_INT,  
   FISCAL_DATE  as   FISCAL_DATE,  
   OPENED_AT  as   OPENED_AT,  
   BEGIN_PREP_AT  as   BEGIN_PREP_AT,  
   CLOSED_AT  as   CLOSED_AT,  
   SCHEDULED_AT  as   SCHEDULED_AT,  
   CREATED_AT  as   CREATED_AT,  
   UPDATED_AT  as   UPDATED_AT,  
   SPLITBY  as   SPLITBY,  
   ITEMSTATUS  as   ITEMSTATUS,  
   CHECKSTATUS  as   CHECKSTATUS,  
   STATUSREASON_ID  as   STATUSREASON_ID,  
   STATUSREASON  as   STATUSREASON,  
   MODIFIERS  as   MODIFIERS,  
   NOTE  as   NOTE,  
   DESCRIPTION  as   DESCRIPTION,  
   NAME  as   NAME,  
   PATH  as   PATH,  
   VARIANTNAME  as   VARIANTNAME,  
   REVENUECENTERNAME  as   REVENUECENTERNAME,  
   CHECK_ID  as   CHECK_ID,  
   EMPLOYEE_ID  as   EMPLOYEE_ID,  
   ITEM_ID  as   ITEM_ID,  
   LOCATION_ID  as   LOCATION_ID,  
   REVENUECENTER_ID  as   REVENUECENTER_ID,  
   ORDER_TYPE_ID  as   ORDER_TYPE_ID,  
   CHEQUENUMBER  as   CHEQUENUMBER,  
   APPLIEDAMOUNT  as   APPLIEDAMOUNT,  
   QUANTITY  as   QUANTITY,  
   REPORTQUANTITY  as   REPORTQUANTITY,  
   BASEPRICE  as   BASEPRICE,  
   INCLUSIVETAX  as   INCLUSIVETAX,  
   TAB  as   TAB,  
   DISCOUNTCHECK  as   DISCOUNTCHECK,  
   DISCOUNTITEM  as   DISCOUNTITEM,  
   PRICE  as   PRICE,  
   GROSS  as   GROSS,  
   NET  as   NET,  
   TAX  as   TAX,  
   TOTAL  as   TOTAL,  
   CHECKGROSS  as   CHECKGROSS,  
   CHECKTOTAL  as   CHECKTOTAL 
  FROM DATAADMIN.ITEM_FACT
     WHERE MTLN_CDC_SEQUENCE_NUMBER > :highwater);

 
 --======================================================================================================================== 

 
--========================================================================================================================
CALL SP_UpdateDWTable( ''DATASTAGE'', ''ITEM_FACT'');
IF (validate_date = TRUE)  THEN  errorCount_res := (CALL DATAADMIN.SP_ValidateDWDates(''p'',''ITEM_FACT'',''COUNT''));
END IF;
return table(errorCount_res); END';