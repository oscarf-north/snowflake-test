CREATE OR REPLACE PROCEDURE "SP_STAGELOADDISCOUNTITEM_FACT"("VALIDATE_DATE" BOOLEAN)
RETURNS TABLE ()
LANGUAGE SQL
EXECUTE AS OWNER
AS 'DECLARE res resultset;
      --validate_date boolean := TRUE;
      errorCount_res resultset;
      highwater int := IFNULL((SELECT MAX(MTLN_CDC_SEQUENCE_NUMBER) FROM DATAWAREHOUSE_TEMP.DISCOUNTITEM_FACT),0);
  BEGIN
    res := (
       INSERT INTO DATAWAREHOUSE_TEMP.DISCOUNTITEM_FACT(   
          DISCOUNTITEM_FACT_NK, 
          DISCOUNTNAME, 
          DW_STARTDATE, 
          FISCALDATE, 
          DW_ENDDATE, 
          DW_RANGESTART, 
          DW_RANGEEND, 
          DW_ISDELETED, 
          DW_ISCURRENTROW, 
          MTLN_CDC_LAST_CHANGE_TYPE, 
          MTLN_CDC_LAST_COMMIT_TIMESTAMP, 
          MTLN_CDC_SEQUENCE_NUMBER, 
          MTLN_CDC_LOAD_BATCH_ID, 
          MTLN_CDC_LOAD_TIMESTAMP, 
          MTLN_CDC_PROCESSED_DATE_HOUR, 
          MTLN_CDC_SRC_VERSION, 
          MTLN_CDC_FILENAME, 
          MTLN_CDC_FILEPATH, 
          MTLN_CDC_SRC_DATABASE, 
          MTLN_CDC_SRC_SCHEMA, 
          MTLN_CDC_SRC_TABLE, 
          CHEQUE_FACT_FK, 
          DAYPART_DIM_FK, 
          EMPLOYEE_DIM_FK_AS_ADDED_BY, 
          EMPLOYEE_DIM_FK_AS_APPROVED_BY, 
          EMPLOYEE_DIM_FK, 
          LOCATION_DIM_FK, 
          ITEM_FACT_FK, 
          STANDARDDISCOUNT_DIM_FK, 
          DO_AUTOAPPLY, 
          IS_TRAINING, 
          ADDED_AT, 
          CREATED_AT, 
          FISCAL_DATE, 
          OPENED_AT, 
          UPDATED_AT, 
          APPLICATION, 
          STATUS, 
          CHEQUESTATUS, 
          DISCOUNTREASON, 
          DISCOUNTLEVEL, 
          RECEIPTNAME, 
          PROMOCODE, 
          PROMODESCRIPTION, 
          REVENUECENTERNAME, 
          ROUNDINGMETHOD, 
          CHEQUENUMBER, 
          ITEM_ID, 
          PROMOCODE_ID, 
          DISCOUNT_TYPE, 
          DISCOUNT_PERCENT, 
          APPLIED_AMOUNT, 
          DISCOUNT_AMOUNT, 
          VALUE, 
          DISCOUNT, 
          DISCOUNTCHECK, 
          DISCOUNTITEM, 
          GROSS, 
          NET 
) 
 SELECT   DISCOUNTITEM_FACT_NK  as   DISCOUNTITEM_FACT_NK,  
   DISCOUNTNAME  as   DISCOUNTNAME,  
   DW_STARTDATE  as   DW_STARTDATE,  
   FISCALDATE  as   FISCALDATE,  
   DW_ENDDATE  as   DW_ENDDATE,  
   :highwater  as   DW_RANGESTART,  
   MAX(MTLN_CDC_SEQUENCE_NUMBER) OVER(PARTITION BY 1)  as   DW_RANGEEND,  
   DW_ISDELETED  as   DW_ISDELETED,  
   DW_ISCURRENTROW  as   DW_ISCURRENTROW,  
   MTLN_CDC_LAST_CHANGE_TYPE  as   MTLN_CDC_LAST_CHANGE_TYPE,  
   MTLN_CDC_LAST_COMMIT_TIMESTAMP  as   MTLN_CDC_LAST_COMMIT_TIMESTAMP,  
   MTLN_CDC_SEQUENCE_NUMBER  as   MTLN_CDC_SEQUENCE_NUMBER,  
   MTLN_CDC_LOAD_BATCH_ID  as   MTLN_CDC_LOAD_BATCH_ID,  
   MTLN_CDC_LOAD_TIMESTAMP  as   MTLN_CDC_LOAD_TIMESTAMP,  
   MTLN_CDC_PROCESSED_DATE_HOUR  as   MTLN_CDC_PROCESSED_DATE_HOUR,  
   MTLN_CDC_SRC_VERSION  as   MTLN_CDC_SRC_VERSION,  
   MTLN_CDC_FILENAME  as   MTLN_CDC_FILENAME,  
   MTLN_CDC_FILEPATH  as   MTLN_CDC_FILEPATH,  
   MTLN_CDC_SRC_DATABASE  as   MTLN_CDC_SRC_DATABASE,  
   MTLN_CDC_SRC_SCHEMA  as   MTLN_CDC_SRC_SCHEMA,  
   MTLN_CDC_SRC_TABLE  as   MTLN_CDC_SRC_TABLE,  
   CHEQUE_FACT_FK  as   CHEQUE_FACT_FK,  
   DAYPART_DIM_FK  as   DAYPART_DIM_FK,  
   EMPLOYEE_DIM_FK_AS_ADDED_BY  as   EMPLOYEE_DIM_FK_AS_ADDED_BY,  
   EMPLOYEE_DIM_FK_AS_APPROVED_BY  as   EMPLOYEE_DIM_FK_AS_APPROVED_BY,  
   EMPLOYEE_DIM_FK  as   EMPLOYEE_DIM_FK,  
   LOCATION_DIM_FK  as   LOCATION_DIM_FK,  
   ITEM_FACT_FK  as   ITEM_FACT_FK,  
   STANDARDDISCOUNT_DIM_FK  as   STANDARDDISCOUNT_DIM_FK,  
   DO_AUTOAPPLY  as   DO_AUTOAPPLY,  
   IS_TRAINING  as   IS_TRAINING,  
   ADDED_AT  as   ADDED_AT,  
   CREATED_AT  as   CREATED_AT,  
   FISCAL_DATE  as   FISCAL_DATE,  
   OPENED_AT  as   OPENED_AT,  
   UPDATED_AT  as   UPDATED_AT,  
   APPLICATION  as   APPLICATION,  
   STATUS  as   STATUS,  
   CHEQUESTATUS  as   CHEQUESTATUS,  
   DISCOUNTREASON  as   DISCOUNTREASON,  
   DISCOUNTLEVEL  as   DISCOUNTLEVEL,  
   RECEIPTNAME  as   RECEIPTNAME,  
   PROMOCODE  as   PROMOCODE,  
   PROMODESCRIPTION  as   PROMODESCRIPTION,  
   REVENUECENTERNAME  as   REVENUECENTERNAME,  
   ROUNDINGMETHOD  as   ROUNDINGMETHOD,  
   CHEQUENUMBER  as   CHEQUENUMBER,  
   ITEM_ID  as   ITEM_ID,  
   PROMOCODE_ID  as   PROMOCODE_ID,  
   DISCOUNT_TYPE  as   DISCOUNT_TYPE,  
   DISCOUNT_PERCENT  as   DISCOUNT_PERCENT,  
   APPLIED_AMOUNT  as   APPLIED_AMOUNT,  
   DISCOUNT_AMOUNT  as   DISCOUNT_AMOUNT,  
   VALUE  as   VALUE,  
   DISCOUNT  as   DISCOUNT,  
   DISCOUNTCHECK  as   DISCOUNTCHECK,  
   DISCOUNTITEM  as   DISCOUNTITEM,  
   GROSS  as   GROSS,  
   NET  as   NET 
  FROM DATAADMIN.DISCOUNTITEM_FACT
     WHERE MTLN_CDC_SEQUENCE_NUMBER > :highwater);

 
 --======================================================================================================================== 

 
--========================================================================================================================
CALL SP_UpdateDWTable( ''DATASTAGE'', ''DISCOUNTITEM_FACT'');
IF (validate_date = TRUE)  THEN  errorCount_res := (CALL DATAADMIN.SP_ValidateDWDates(''p'',''DISCOUNTITEM_FACT'',''COUNT''));
END IF;
return table(errorCount_res); END';